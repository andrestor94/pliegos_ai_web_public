{% extends "base.html" %}
{% block title %}Usuarios conectados ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  .ua-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .ua-head .hero-title{ margin:0; }

  .avatar{
    width:38px; height:38px; border-radius:999px; display:grid; place-items:center;
    font-weight:700; background:linear-gradient(135deg, var(--accent-a), var(--accent-b));
    color:#fff; box-shadow:0 6px 16px rgba(139,92,246,.28);
  }
  .status-dot{
    width:10px; height:10px; border-radius:50%; background:#10b981; display:inline-block;
    box-shadow:0 0 0 3px rgba(16,185,129,.15);
  }
  .ua-card{ display:flex; align-items:center; gap:12px; }
  .ua-meta{ color:var(--muted); font-size:.9rem; }
  .ua-chip{ border:1px solid var(--border); border-radius:999px; padding:.2rem .55rem; font-size:.8rem; color:#475569; background:#fff; }
  .ua-list .cardx{ transition:transform .08s ease, box-shadow .2s ease; }
  .ua-list .cardx:hover{ transform:translateY(-1px); box-shadow:0 16px 36px rgba(20,15,55,.14); }

  .ua-actions{ display:flex; gap:6px; align-items:center; margin-left:auto; }
  .ua-actions .btn{ border-radius:10px; }

  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .toolbar .form-control, .toolbar .form-select, .toolbar .btn{ border-radius:10px; }

  .hl{ background:#fff3bf; border-radius:3px; padding:0 .15em; }

  /* skeleton */
  .skeleton{ border:1px solid var(--border); border-radius:14px; padding:12px; position:relative; overflow:hidden; }
  .sk-bar{ height:12px; background:rgba(148,163,184,.25); border-radius:6px; margin:.35rem 0; }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent, rgba(180,190,210,.2), transparent);
    animation: shimmer 1.1s infinite;
  }
  @keyframes shimmer{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }

  @media (prefers-color-scheme: dark){
    .ua-chip{ background:#0b1220; }
  }
</style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="ua-head mb-3">
    <h1 class="hero-title"><i class="bi bi-people me-2"></i> Usuarios conectados</h1>
    <a href="/" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
  </div>

  <div class="cardx mb-3">
    <div class="d-flex align-items-center justify-content-between">
      <div class="title d-flex align-items-center gap-2">
        <i class="bi bi-activity"></i> Presencia
        <span id="countChip" class="ua-chip">0 en l√≠nea</span>
        <span id="ipChip" class="ua-chip d-none">‚Äî IPs</span>
        <span class="ua-chip"><span class="status-dot"></span> En l√≠nea</span>
      </div>
      <div class="toolbar">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="filterInput" class="form-control form-control-sm" placeholder="Filtrar por nombre o email‚Ä¶">
        </div>
        <select id="minutesSel" class="form-select form-select-sm" title="Ventana de presencia">
          <option value="5" selected>√ölt. 5 min</option>
          <option value="10">√ölt. 10 min</option>
          <option value="15">√ölt. 15 min</option>
          <option value="30">√ölt. 30 min</option>
          <option value="60">√ölt. 60 min</option>
        </select>
        <select id="sortSel" class="form-select form-select-sm" title="Ordenar por">
          <option value="seen_desc" selected>Orden: √∫ltimo visto</option>
          <option value="name_asc">Orden: nombre (A‚ÜíZ)</option>
        </select>
        <div class="form-check ms-1">
          <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
          <label class="form-check-label small" for="autoRefresh">Auto-refresh</label>
        </div>
        <button id="btnRefresh" class="btn btn-outline-secondary btn-sm">
          <span class="btn-txt"><i class="bi bi-arrow-clockwise"></i> Refrescar</span>
          <span class="spinner-border spinner-border-sm d-none" aria-hidden="true"></span>
        </button>
        <button id="btnCopy" class="btn btn-outline-primary btn-sm" title="Copiar lista"><i class="bi bi-clipboard"></i></button>
        <button id="btnCsv" class="btn btn-outline-primary btn-sm" title="Exportar CSV"><i class="bi bi-filetype-csv"></i></button>
      </div>
    </div>
    <div class="small text-muted mt-2" id="lastUpd">‚Äî</div>
  </div>

  <div id="uaList" class="ua-list grid" role="list" aria-live="polite">
    <!-- JS -->
  </div>

  {% if not items or items|length == 0 %}
    <div class="cardx mt-3"><div class="text-muted">No hay usuarios activos ahora.</div></div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ===== Datos iniciales del servidor (opcional) =====
  const INITIAL = {{ (items or []) | tojson }};

  // ===== DOM =====
  const uaList      = document.getElementById('uaList');
  const filter      = document.getElementById('filterInput');
  const minutesSel  = document.getElementById('minutesSel');
  const sortSel     = document.getElementById('sortSel');
  const countChip   = document.getElementById('countChip');
  const ipChip      = document.getElementById('ipChip');
  const lastUpd     = document.getElementById('lastUpd');
  const btnRefresh  = document.getElementById('btnRefresh');

  // ===== Helpers =====
  const esc = (s)=> (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  const LS = { get(k,d){ try{ const v=localStorage.getItem(k); return v==null?d:JSON.parse(v);}catch(_){return d;} }, set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){}} };

  function initials(nameOrMail){
    const s = (nameOrMail||'').trim();
    if(!s) return '??';
    if(s.includes(' ')){
      const p = s.split(' ').filter(Boolean);
      return (p[0][0]||'').toUpperCase() + (p[p.length-1][0]||'').toUpperCase();
    }
    if(s.includes('@')) return (s[0]||'?').toUpperCase();
    return s.slice(0,2).toUpperCase();
  }
  function timeAgo(iso){
    try{
      const d = new Date(iso);
      const sec = Math.max(0, Math.round((Date.now()-d.getTime())/1000));
      if(sec < 60) return `${sec}s`;
      const m = Math.floor(sec/60);
      if(m < 60) return `${m}m`;
      const h = Math.floor(m/60);
      return `${h}h`;
    }catch{ return '‚Äî'; }
  }
  function fmtLocal(iso){
    try{ const d=new Date(iso); return isNaN(d)?'‚Äî':d.toLocaleString(); }catch{ return '‚Äî'; }
  }
  function mark(text, term){
    if(!term) return esc(text);
    const re = new RegExp('('+term.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+')','ig');
    return esc(text).replace(re, '<mark class="hl">$1</mark>');
  }

  // ===== Estado =====
  const state = {
    items: Array.isArray(INITIAL) ? INITIAL : [],
    minutes: parseInt(LS.get('ua.minutes', minutesSel.value),10)||5,
    sort: LS.get('ua.sort', sortSel.value),
    lastFetch: null,
    auto: LS.get('ua.auto', true)
  };

  // Prefs -> UI
  minutesSel.value = String(state.minutes);
  sortSel.value = state.sort;
  document.getElementById('autoRefresh').checked = !!state.auto;

  // ===== Render =====
  function render(items){
    if(!uaList) return;
    const qRaw = (filter?.value||'').trim();
    const q = qRaw.toLowerCase();

    // sorting
    const sorted = [...items].sort((a,b)=>{
      if(state.sort === 'name_asc'){
        const A=(a.nombre||a.email||'').toLowerCase();
        const B=(b.nombre||b.email||'').toLowerCase();
        return A.localeCompare(B);
      }
      // default: seen_desc
      const da = new Date(a.last_seen||0).getTime();
      const db = new Date(b.last_seen||0).getTime();
      return db - da;
    });

    const filtered = sorted.filter(u => !q || (String(u.nombre||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q)));
    uaList.innerHTML = '';

    if(!filtered.length){
      uaList.innerHTML = '<div class="cardx"><div class="text-muted">Sin coincidencias con el filtro.</div></div>';
    }else{
      const frag = document.createDocumentFragment();
      filtered.forEach(u=>{
        const card = document.createElement('div');
        card.className = 'cardx col-12';
        const uaTitle = esc(u.ua||'');
        const name = u.nombre || u.email || '';
        const email = u.email || '';
        card.setAttribute('role','listitem');
        card.innerHTML = `
          <div class="ua-card">
            <div class="avatar" title="${esc(name)}">${initials(name)}</div>
            <div class="flex-grow-1">
              <div><strong>${mark(name, qRaw)}</strong> ${email ? `<span class="ua-meta">¬∑ ${mark(email, qRaw)}</span>`:''}</div>
              <div class="ua-meta"><span class="status-dot"></span> activo hace ${timeAgo(u.last_seen)} <span class="text-muted">(${fmtLocal(u.last_seen)})</span></div>
            </div>
            <div class="text-end small ua-meta d-none d-md-block">
              <div>${esc(u.ip||'')}</div>
              <div class="text-truncate" style="max-width:280px" title="${uaTitle}">${uaTitle || '‚Äî'}</div>
            </div>
            <div class="ua-actions">
              ${email ? `<a class="btn btn-sm btn-outline-primary" href="/chat?to=${encodeURIComponent(email)}" title="Abrir chat">üí¨</a>` : ''}
              ${email ? `<button class="btn btn-sm btn-outline-secondary act-copy" data-email="${esc(email)}" title="Copiar email">üìã</button>` : ''}
              ${email ? `<a class="btn btn-sm btn-outline-secondary" href="mailto:${encodeURIComponent(email)}" title="Enviar email">‚úâÔ∏è</a>` : ''}
            </div>
          </div>`;
        frag.appendChild(card);
      });
      uaList.appendChild(frag);
    }

    // KPIs: contador + IPs √∫nicas + last updated
    countChip.textContent = `${filtered.length} en l√≠nea`;
    const ips = new Set(filtered.map(u=>u.ip).filter(Boolean));
    if(ips.size){ ipChip.classList.remove('d-none'); ipChip.textContent = `${ips.size} IP${ips.size!==1?'s':''}`; }
    else ipChip.classList.add('d-none');

    if(state.lastFetch){
      const secs = Math.max(0, Math.round((Date.now()-state.lastFetch)/1000));
      lastUpd.textContent = `Actualizado hace ${secs}s ¬∑ Ventana: ${state.minutes} min`;
    }
  }

  // Skeleton
  function showSkeleton(n=4){
    uaList.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(let i=0;i<n;i++){
      const sk = document.createElement('div');
      sk.className = 'skeleton';
      sk.innerHTML = `
        <div class="sk-bar" style="width:28%; height:16px"></div>
        <div class="sk-bar" style="width:52%"></div>
        <div class="sk-bar" style="width:38%"></div>`;
      frag.appendChild(sk);
    }
    uaList.appendChild(frag);
  }

  // ===== API =====
  async function fetchOnline(){
    try{
      const r = await fetch(`/presence/online?minutes=${encodeURIComponent(state.minutes)}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return Array.isArray(j.items) ? j.items : [];
    }catch{
      (window.showToast||console.error)({title:'Presencia', body:'No se pudo consultar el servidor.', icon:'exclamation-triangle'});
      return [];
    }
  }

  // ===== Acciones =====
  function toggleBtnLoading(btn, loading){
    const sp = btn.querySelector('.spinner-border');
    const txt= btn.querySelector('.btn-txt');
    if(sp && txt){
      sp.classList.toggle('d-none', !loading);
      txt.classList.toggle('d-none', loading);
      btn.disabled = !!loading;
    }
  }

  const doRefresh = async ()=>{
    showSkeleton(3);
    toggleBtnLoading(btnRefresh, true);
    try{
      if(document.hidden){ // si la pesta√±a est√° oculta, esperamos al volver para no desperdiciar
        return;
      }
      const items = await fetchOnline();
      state.items = items;
      state.lastFetch = Date.now();
      render(items);
    }finally{
      toggleBtnLoading(btnRefresh, false);
    }
  };

  // CSV & Copy (respeta filtro y orden visibles)
  function currentVisible(){
    const q = (filter?.value||'').trim().toLowerCase();
    const arr = [...state.items];
    // ordenar igual que render
    arr.sort((a,b)=>{
      if(state.sort === 'name_asc'){
        const A=(a.nombre||a.email||'').toLowerCase();
        const B=(b.nombre||b.email||'').toLowerCase();
        return A.localeCompare(B);
      }
      return new Date(b.last_seen||0) - new Date(a.last_seen||0);
    });
    return arr.filter(u => !q || (String(u.nombre||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q)));
  }

  function downloadCSV(rows, name){
    const escv=v=>`"${String(v??'').replace(/"/g,'""')}"`;
    const csv = rows.map(r=>r.map(escv).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }
  document.getElementById('btnCsv').addEventListener('click', ()=>{
    const visible = currentVisible();
    const rows = [['Nombre','Email','IP','√öltimo visto (local)','Agente','Ventana (min)']];
    visible.forEach(u=>{
      rows.push([u.nombre||u.email||'', u.email||'', u.ip||'', u.last_seen? new Date(u.last_seen).toLocaleString():'', u.ua||'', state.minutes]);
    });
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    downloadCSV(rows, `usuarios_activos_${stamp}.csv`);
  });
  document.getElementById('btnCopy').addEventListener('click', async ()=>{
    try{
      const lines = currentVisible().map(u=> `${u.nombre||u.email||'-'} ¬∑ ${u.email||'-'} ¬∑ ${u.ip||'-'} ¬∑ ${u.last_seen?new Date(u.last_seen).toLocaleString():'-'}`);
      await navigator.clipboard.writeText(lines.join('\n'));
      (window.showToast||console.log)({title:'Copiado', body:'Lista copiada al portapapeles.', icon:'clipboard'});
    }catch(_){
      (window.showToast||console.error)({title:'Error', body:'No se pudo copiar.', icon:'exclamation-triangle'});
    }
  });

  // Delegaci√≥n de acciones por tarjeta
  uaList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.act-copy');
    if(!btn) return;
    const email = btn.dataset.email || '';
    try{
      await navigator.clipboard.writeText(email);
      (window.showToast||console.log)({title:'Email copiado', body:email, icon:'clipboard'});
    }catch(_){}
  });

  // ===== Persistencia en URL hash (q, m, s, a) =====
  function syncHash(){
    const h = new URLSearchParams();
    const q = (filter?.value||'').trim();
    if(q) h.set('q', q);
    if(state.minutes !== 5) h.set('m', String(state.minutes));
    if(state.sort !== 'seen_desc') h.set('s', state.sort);
    if(!state.auto) h.set('a','0');
    location.hash = h.toString();
  }
  function hydrateFromHash(){
    try{
      const h = new URLSearchParams(location.hash.replace(/^#/,''));
      const q = h.get('q') || '';
      const m = parseInt(h.get('m')||'',10);
      const s = h.get('s') || '';
      const a = h.get('a') || '';
      if(q){ filter.value = q; }
      if(!Number.isNaN(m) && m){ state.minutes = m; minutesSel.value = String(m); }
      if(s){ state.sort = s; sortSel.value = s; }
      state.auto = (a !== '0');
      document.getElementById('autoRefresh').checked = state.auto;
    }catch(_){}
  }

  // ===== UI events =====
  btnRefresh.addEventListener('click', doRefresh);
  minutesSel.addEventListener('change', async ()=>{
    state.minutes = parseInt(minutesSel.value,10)||5;
    LS.set('ua.minutes', state.minutes);
    syncHash();
    await doRefresh();
  });
  sortSel.addEventListener('change', ()=>{
    state.sort = sortSel.value;
    LS.set('ua.sort', state.sort);
    syncHash();
    render(state.items);
  });
  filter?.addEventListener('input', debounce(()=>{ render(state.items); syncHash(); }, 160));

  // Auto refresh
  const autoChk = document.getElementById('autoRefresh');
  let timer = null, ticker = null;
  function setAuto(){
    if(timer){ clearInterval(timer); timer=null; }
    if(ticker){ clearInterval(ticker); ticker=null; }
    if(autoChk.checked){
      timer = setInterval(doRefresh, 20_000);
      // contador "hace Xs"
      ticker = setInterval(()=>{
        if(state.lastFetch) lastUpd.textContent = `Actualizado hace ${Math.max(0, Math.round((Date.now()-state.lastFetch)/1000))}s ¬∑ Ventana: ${state.minutes} min`;
      }, 1000);
    }
  }
  autoChk.addEventListener('change', ()=>{
    state.auto = autoChk.checked; LS.set('ua.auto', state.auto); syncHash(); setAuto();
  });
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && state.auto) doRefresh(); });

  // Atajo: "/" enfoca el filtro
  window.addEventListener('keydown', (e)=>{
    if(e.key==='/' && !e.ctrlKey && !e.metaKey && !e.altKey){
      const t = e.target; const typing = t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable);
      if(typing) return;
      e.preventDefault(); filter?.focus();
    }
  });

  // ===== Init =====
  (async function init(){
    hydrateFromHash();

    if(Array.isArray(INITIAL) && INITIAL.length){
      state.lastFetch = Date.now();
      render(INITIAL);
    }else{
      showSkeleton(4);
    }
    await doRefresh();
    setAuto();
  })();
</script>
{% endblock %}
