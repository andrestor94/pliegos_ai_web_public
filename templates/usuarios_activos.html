{% extends "base.html" %}
{% block title %}Usuarios conectados – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  .ua-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .ua-head .hero-title{ margin:0; }

  .avatar{
    width:36px; height:36px; border-radius:999px; display:grid; place-items:center;
    font-weight:700; background:linear-gradient(135deg, var(--accent-a), var(--accent-b));
    color:#fff; box-shadow:0 6px 16px rgba(139,92,246,.28);
  }
  .status-dot{
    width:10px; height:10px; border-radius:50%; background:#10b981; display:inline-block;
    box-shadow:0 0 0 3px rgba(16,185,129,.15);
  }
  .ua-card{ display:flex; align-items:center; gap:12px; }
  .ua-meta{ color:var(--muted); font-size:.9rem; }
  .ua-chip{ border:1px solid var(--border); border-radius:999px; padding:.2rem .55rem; font-size:.8rem; color:#475569; background:#fff; }
  .ua-list .cardx{ transition:transform .08s ease, box-shadow .2s ease; }
  .ua-list .cardx:hover{ transform:translateY(-1px); box-shadow:0 16px 36px rgba(20,15,55,.14); }

  @media (prefers-color-scheme: dark){
    .ua-chip{ background:#0b1220; }
  }
</style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="ua-head mb-3">
    <h1 class="hero-title"><i class="bi bi-people me-2"></i> Usuarios conectados</h1>
    <a href="/" class="btn btn-outline-secondary btn-sm">← Volver</a>
  </div>

  <div class="cardx mb-3">
    <div class="d-flex align-items-center justify-content-between">
      <div class="title"><i class="bi bi-activity me-2"></i> Presencia en tiempo (≈5 min)</div>
      <div class="d-flex align-items-center gap-2">
        <input id="filterInput" class="form-control form-control-sm" placeholder="Filtrar por nombre o email…" style="max-width:260px">
        <span class="ua-chip"><span class="status-dot"></span> En línea</span>
      </div>
    </div>
  </div>

  <div id="uaList" class="ua-list grid">
    <!-- Se llena por JS -->
  </div>

  {% if not items or items|length == 0 %}
    <div class="cardx mt-3"><div class="text-muted">No hay usuarios activos ahora.</div></div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Datos iniciales del servidor
  const INITIAL = {{ (items or []) | tojson }};
  const uaList  = document.getElementById('uaList');
  const filter  = document.getElementById('filterInput');

  function initials(nameOrMail){
    const s = (nameOrMail||'').trim();
    if(!s) return '??';
    if(s.includes(' ')){
      const p = s.split(' ').filter(Boolean);
      return (p[0][0]||'').toUpperCase() + (p[p.length-1][0]||'').toUpperCase();
    }
    if(s.includes('@')) return s[0].toUpperCase();
    return s.slice(0,2).toUpperCase();
  }

  function timeAgo(iso){
    try{
      const d = new Date(iso);
      const sec = Math.max(0, Math.round((Date.now()-d.getTime())/1000));
      if(sec < 60) return `${sec}s`;
      const m = Math.floor(sec/60);
      if(m < 60) return `${m}m`;
      const h = Math.floor(m/60);
      return `${h}h`;
    }catch{ return '—'; }
  }

  function render(items){
    if(!uaList) return;
    const q = (filter?.value||'').toLowerCase().trim();
    uaList.innerHTML = '';

    const grid = document.createDocumentFragment();

    items
      .filter(u => !q || (String(u.nombre||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q)))
      .forEach(u=>{
        const card = document.createElement('div');
        card.className = 'cardx col-12';
        card.innerHTML = `
          <div class="ua-card">
            <div class="avatar" title="${(u.nombre||u.email||'').replace(/"/g,'&quot;')}">${initials(u.nombre||u.email)}</div>
            <div class="flex-grow-1">
              <div><strong>${(u.nombre||u.email||'').replace(/</g,'&lt;')}</strong> <span class="ua-meta">· ${(u.email||'').replace(/</g,'&lt;')}</span></div>
              <div class="ua-meta"><span class="status-dot"></span> activo hace ${timeAgo(u.last_seen)}</div>
            </div>
            <div class="text-end small ua-meta d-none d-md-block">
              <div>${(u.ip||'').replace(/</g,'&lt;')}</div>
              <div class="text-truncate" style="max-width:320px">${(u.ua||'').replace(/</g,'&lt;')}</div>
            </div>
          </div>`;
        grid.appendChild(card);
      });

    uaList.appendChild(grid);

    if(!items.length){
      uaList.innerHTML = '<div class="cardx"><div class="text-muted">No hay usuarios activos ahora.</div></div>';
    }
  }

  async function fetchOnline(){
    try{
      const r = await fetch('/presence/online');
      const j = await r.json();
      return Array.isArray(j.items) ? j.items : [];
    }catch{ return []; }
  }

  // Inicial
  render(INITIAL);

  // Filtro
  filter?.addEventListener('input', async ()=>{
    const items = await fetchOnline();
    render(items);
  });

  // Poll cada 20s
  setInterval(async ()=>{
    const items = await fetchOnline();
    render(items);
  }, 20_000);
</script>
{% endblock %}
