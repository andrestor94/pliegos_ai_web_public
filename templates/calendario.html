{% extends "base.html" %}

{% block title %}Calendario · Suizo Argentina{% endblock %}

{% block extra_head %}
  <!-- FullCalendar 6 -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js" defer></script>

  <style>
    /* Integración visual con el theme */
    #calWrap { position: relative; }
    #calendar{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:14px 14px 64px; /* espacio inferior para los controles flotantes */
      position: relative; z-index: 1;
    }
    .fc .fc-toolbar-title{ font-weight:700; color:#0f172a; }
    .fc .fc-button{ border-radius:10px; }
    .fc-theme-standard .fc-scrollgrid{ border-radius:12px; overflow:hidden; }

    /* Controles externos (abajo izq / abajo der) */
    .cal-ctrl-left, .cal-ctrl-right{
      position:absolute; bottom:12px; display:flex; gap:8px;
      z-index: 10; pointer-events: auto;
    }
    .cal-ctrl-left{ left:12px; }
    .cal-ctrl-right{ right:12px; }
    .cal-ctrl-left .btn, .cal-ctrl-right .btn{ border-radius:10px; }
    .btn.is-active{
      border-color: var(--brand-300, #5274ce) !important;
      box-shadow: 0 0 0 4px rgba(82,116,206,.15);
    }

    .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .dot{ width:12px; height:12px; border-radius:999px; display:inline-block; }

    @media (max-width: 575.98px){
      #calendar{ padding-bottom: 88px; } /* más espacio para controles en mobile */
      .cal-ctrl-left{ left:10px; bottom:10px; }
      .cal-ctrl-right{ right:10px; bottom:10px; }
    }
    [data-theme="dark"] #calendar{ background:var(--panel); }
  </style>
{% endblock %}

{% block content %}
  <div class="grid">
    <section class="cardx col-12">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <h5 class="title mb-0"><i class="bi bi-calendar-event"></i> Calendario</h5>
        <div class="ms-auto legend">
          <span class="dot" style="background:#0ea5e9"></span><small class="muted">General</small>
          <span class="dot" style="background:#22c55e"></span><small class="muted">Incidencias</small>
          <span class="dot" style="background:#f59e0b"></span><small class="muted">Pliegos</small>
        </div>
      </div>
    </section>

    <section class="col-12">
      <div id="calWrap">
        <div id="calendar" aria-label="Calendario de eventos"></div>

        <!-- Controles externos -->
        <div class="cal-ctrl-left" role="group" aria-label="Cambiar vista">
          <button type="button" class="btn btn-outline-primary is-active" data-cal-view="dayGridMonth">Mes</button>
          <button type="button" class="btn btn-outline-primary" data-cal-view="timeGridWeek">Semana</button>
          <button type="button" class="btn btn-outline-primary" data-cal-view="listWeek">Lista</button>
        </div>
        <div class="cal-ctrl-right" role="group" aria-label="Navegación">
          <button type="button" class="btn btn-outline-primary" aria-label="Anterior" data-cal-nav="prev"><i class="bi bi-chevron-left"></i></button>
          <button type="button" class="btn btn-outline-primary" data-cal-nav="today">Hoy</button>
          <button type="button" class="btn btn-outline-primary" aria-label="Siguiente" data-cal-nav="next"><i class="bi bi-chevron-right"></i></button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal: Nuevo evento -->
  <div class="modal fade" id="modalNuevoEvt" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:14px;">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Título</label>
            <input id="evtTitle" class="form-control" placeholder="Reunión / Entrega...">
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea id="evtDesc" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Tipo</label>
            <select id="evtTipo" class="form-select">
              <option value="#0ea5e9">General</option>
              <option value="#22c55e">Incidencia</option>
              <option value="#f59e0b">Pliegos</option>
            </select>
          </div>
          <div class="form-text" id="evtRangeTxt"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="evtCreateBtn" class="btn btn-primary">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Detalle/editar -->
  <div class="modal fade" id="modalDetalleEvt" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:14px;">
        <div class="modal-header">
          <h5 class="modal-title">Detalle del evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Título</label>
            <input id="evtTitleE" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea id="evtDescE" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Color</label>
            <input id="evtColorE" type="color" class="form-control form-control-color" value="#0ea5e9">
          </div>
          <div class="form-text" id="evtTimeInfo"></div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button id="evtDelBtn" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Eliminar</button>
          <div>
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button id="evtSaveBtn" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Helpers ===== */
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function toIsoOrNull(d){ return d ? new Date(d).toISOString() : null; }
  function showToast({title="Aviso", body="", icon="info"}){
    const cont=document.getElementById('toastContainer'); if(!cont) return;
    const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
    el.innerHTML=`<div class="toast-header"><i class="bi bi-${icon} me-1"></i><strong class="me-auto">${title}</strong><small>Ahora</small><button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button></div><div class="toast-body">${body}</div>`;
    cont.appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast',()=>el.remove());
  }

  /* ===== API ===== */
  async function fetchEventos(){
    try{
      const r = await fetch('/calendario/eventos');
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      showToast({title:'Calendario', body:'No se pudo cargar del servidor. Mostrando ejemplo.', icon:'exclamation-triangle'});
      const now = new Date();
      const yyyy = now.getFullYear(), mm = String(now.getMonth()+1).padStart(2,'0'), dd = String(now.getDate()).padStart(2,'0');
      return [{ id:'demo-1', title:'Evento demo', start:`${yyyy}-${mm}-${dd}T10:00:00`, end:`${yyyy}-${mm}-${dd}T11:00:00`, color:'#0ea5e9', description:'Solo ejemplo', allDay:false }];
    }
  }
  async function crearEvento(payload){
    const r = await fetch('/calendario/eventos',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!r.ok) throw new Error('No se pudo crear el evento');
    return await r.json();
  }
  async function actualizarEvento(id, payload){
    const r = await fetch(`/calendario/eventos/${encodeURIComponent(id)}`,{method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!r.ok) throw new Error('No se pudo actualizar el evento');
    return await r.json().catch(()=> ({}));
  }
  async function eliminarEvento(id){
    const r = await fetch(`/calendario/eventos/${encodeURIComponent(id)}`,{method:'DELETE'});
    if(!r.ok) throw new Error('No se pudo eliminar el evento');
  }

  /* ===== Modales ===== */
  let _selectCtx = null;
  function openNuevoModal(info){
    _selectCtx = info;
    document.getElementById('evtTitle').value = '';
    document.getElementById('evtDesc').value = '';
    document.getElementById('evtTipo').value = '#0ea5e9';
    document.getElementById('evtRangeTxt').textContent = `Rango: ${info.startStr}${info.endStr ? ' → '+info.endStr : ''}`;
    new bootstrap.Modal(document.getElementById('modalNuevoEvt')).show();
  }
  function openDetalleModal(evt){
    document.getElementById('evtTitleE').value = evt.title || '';
    document.getElementById('evtDescE').value  = evt.extendedProps?.description || '';
    const col = evt.backgroundColor || evt.borderColor || '#0ea5e9';
    document.getElementById('evtColorE').value = col;
    document.getElementById('evtTimeInfo').textContent =
      `${evt.start?.toLocaleString()}${evt.end ? ' → '+evt.end.toLocaleString() : ''}`;
    const modal = document.getElementById('modalDetalleEvt');
    modal.dataset.eventId = evt.id;
    new bootstrap.Modal(modal).show();
  }

  /* ===== Calendar ===== */
  let calendar;
  async function initCalendar(){
    const initialEvents = await fetchEventos();
    const el = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(el, {
      height: 'auto',
      locale: 'es',
      firstDay: 1,
      nowIndicator: true,
      weekNumbers: true,
      expandRows: true,
      initialView: 'dayGridMonth',
      headerToolbar: false,   /* usamos controles externos */
      buttonText: { today:'Hoy', month:'Mes', week:'Semana', day:'Día', list:'Lista' },
      selectable: true,
      selectMirror: true,
      select: (info)=> openNuevoModal(info),
      eventClick: (arg)=> openDetalleModal(arg.event),
      editable: true,
      eventDrop: async (arg)=>{
        try{
          await actualizarEvento(arg.event.id, {
            start: toIsoOrNull(arg.event.start),
            end:   toIsoOrNull(arg.event.end),
            allDay: arg.event.allDay
          });
          showToast({title:'Evento movido', body:arg.event.title, icon:'check2-circle'});
        }catch(e){ arg.revert(); showToast({title:'Error', body:'No se pudo mover', icon:'exclamation-triangle'}); }
      },
      eventResize: async (arg)=>{
        try{
          await actualizarEvento(arg.event.id, {
            start: toIsoOrNull(arg.event.start),
            end:   toIsoOrNull(arg.event.end)
          });
          showToast({title:'Duración actualizada', body:arg.event.title, icon:'check2-circle'});
        }catch(e){ arg.revert(); showToast({title:'Error', body:'No se pudo cambiar duración', icon:'exclamation-triangle'}); }
      },
      events: initialEvents,
      eventDidMount: (info)=>{
        const color = info.event.backgroundColor || info.event.color || '#0ea5e9';
        info.el.style.borderRadius = '8px';
        info.el.style.borderColor = color;
        if (info.event.extendedProps?.description){
          new bootstrap.Tooltip(info.el, { title: info.event.extendedProps.description, placement:'top' });
        }
      }
    });
    calendar.render();

    /* Exponer instancia para controles externos */
    el.__fcCalendar = calendar;
    window.AppCalendar = calendar;
    window.__calendar = calendar;

    /* Resaltar botón activo al iniciar */
    markActive(calendar.view.type);
  }

  /* === Wiring de controles externos === */
  function markActive(viewName){
    const btns = document.querySelectorAll('[data-cal-view]');
    btns.forEach(b => b.classList.toggle('is-active', b.getAttribute('data-cal-view') === viewName));
  }

  document.addEventListener('click', (ev) => {
    const viewBtn = ev.target.closest('[data-cal-view]');
    const navBtn  = ev.target.closest('[data-cal-nav]');
    if (!viewBtn && !navBtn) return;
    ev.preventDefault();

    const cal = window.AppCalendar || document.getElementById('calendar').__fcCalendar;
    if (!cal) return;

    if (viewBtn) {
      const view = viewBtn.getAttribute('data-cal-view');
      if (view) {
        cal.changeView(view);
        markActive(view);
      }
      return;
    }
    if (navBtn) {
      const nav = navBtn.getAttribute('data-cal-nav');
      switch (nav) {
        case 'today': cal.today(); break;
        case 'prev' : cal.prev();  break;
        case 'next' : cal.next();  break;
      }
    }
  });

  // Sincroniza el highlight si la vista cambia por otro lado
  document.addEventListener('DOMContentLoaded', () => {
    const cal = window.AppCalendar || document.getElementById('calendar').__fcCalendar;
    if (!cal) return;
    cal.on('viewDidMount', (arg) => markActive(arg.view.type));
  });

  /* ===== Init ===== */
  (async function(){ await initCalendar(); })();
</script>
{% endblock %}
