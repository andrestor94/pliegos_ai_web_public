{% extends "base.html" %}

{% block title %}Calendario · Suizo Argentina{% endblock %}

{% block extra_head %}
  <!-- FullCalendar 6 -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

  <style>
    /* Ajustes visuales para integrarse al theme */
    #calendar{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:14px;
    }
    .fc .fc-toolbar-title{ font-weight:700; color:#0f172a; }
    .fc .fc-button{ border-radius:10px; }
    .fc-theme-standard .fc-scrollgrid{ border-radius:12px; overflow:hidden; }

    .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .dot{ width:12px; height:12px; border-radius:999px; display:inline-block; }
  </style>
{% endblock %}

{% block content %}
  <div class="grid">
    <section class="cardx col-12">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <h5 class="title mb-0"><i class="bi bi-calendar-event"></i> Calendario</h5>
        <div class="ms-auto legend">
          <span class="dot" style="background:#0ea5e9"></span><small class="muted">General</small>
          <span class="dot" style="background:#22c55e"></span><small class="muted">Incidencias</small>
          <span class="dot" style="background:#f59e0b"></span><small class="muted">Pliegos</small>
        </div>
      </div>
    </section>

    <section class="col-12">
      <div id="calendar" aria-label="Calendario de eventos"></div>
    </section>
  </div>

  <!-- Modal: Nuevo evento -->
  <div class="modal fade" id="modalNuevoEvt" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:14px;">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Título</label>
            <input id="evtTitle" class="form-control" placeholder="Reunión / Entrega...">
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea id="evtDesc" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Tipo</label>
            <select id="evtTipo" class="form-select">
              <option value="#0ea5e9">General</option>
              <option value="#22c55e">Incidencia</option>
              <option value="#f59e0b">Pliegos</option>
            </select>
          </div>
          <div class="form-text" id="evtRangeTxt"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="evtCreateBtn" class="btn btn-primary">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Detalle/editar -->
  <div class="modal fade" id="modalDetalleEvt" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:14px;">
        <div class="modal-header">
          <h5 class="modal-title">Detalle del evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Título</label>
            <input id="evtTitleE" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea id="evtDescE" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Color</label>
            <input id="evtColorE" type="color" class="form-control form-control-color" value="#0ea5e9">
          </div>
          <div class="form-text" id="evtTimeInfo"></div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button id="evtDelBtn" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Eliminar</button>
          <div>
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button id="evtSaveBtn" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Helpers ===== */
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function toIsoOrNull(d){ return d ? new Date(d).toISOString() : null; }
  function showToast({title="Aviso", body="", icon="info"}){
    const cont=document.getElementById('toastContainer'); if(!cont) return;
    const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
    el.innerHTML=`<div class="toast-header"><i class="bi bi-${icon} me-1"></i><strong class="me-auto">${title}</strong><small>Ahora</small><button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button></div><div class="toast-body">${body}</div>`;
    cont.appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast',()=>el.remove());
  }

  /* ===== API ===== */
  async function fetchEventos(){
    try{
      const r = await fetch('/calendario/eventos');
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      showToast({title:'Calendario', body:'No se pudo cargar del servidor. Mostrando ejemplo.', icon:'exclamation-triangle'});
      const now = new Date();
      const yyyy = now.getFullYear(), mm = String(now.getMonth()+1).padStart(2,'0'), dd = String(now.getDate()).padStart(2,'0');
      return [{ id:'demo-1', title:'Evento demo', start:`${yyyy}-${mm}-${dd}T10:00:00`, end:`${yyyy}-${mm}-${dd}T11:00:00`, color:'#0ea5e9', description:'Solo ejemplo', allDay:false }];
    }
  }
  async function crearEvento(payload){
    const r = await fetch('/calendario/eventos',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!r.ok) throw new Error('No se pudo crear el evento');
    return await r.json();
  }
  async function actualizarEvento(id, payload){
    const r = await fetch(`/calendario/eventos/${encodeURIComponent(id)}`,{method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!r.ok) throw new Error('No se pudo actualizar el evento');
    return await r.json().catch(()=> ({}));
  }
  async function eliminarEvento(id){
    const r = await fetch(`/calendario/eventos/${encodeURIComponent(id)}`,{method:'DELETE'});
    if(!r.ok) throw new Error('No se pudo eliminar el evento');
  }

  /* ===== Modales ===== */
  let _selectCtx = null;  // guarda el rango seleccionado para el modal "nuevo"
  function openNuevoModal(info){
    _selectCtx = info;
    document.getElementById('evtTitle').value = '';
    document.getElementById('evtDesc').value = '';
    document.getElementById('evtTipo').value = '#0ea5e9';
    document.getElementById('evtRangeTxt').textContent = `Rango: ${info.startStr}${info.endStr ? ' → '+info.endStr : ''}`;
    new bootstrap.Modal(document.getElementById('modalNuevoEvt')).show();
  }

  function openDetalleModal(evt){
    document.getElementById('evtTitleE').value = evt.title || '';
    document.getElementById('evtDescE').value  = evt.extendedProps?.description || '';
    const col = evt.backgroundColor || evt.borderColor || '#0ea5e9';
    document.getElementById('evtColorE').value = col;
    document.getElementById('evtTimeInfo').textContent =
      `${evt.start?.toLocaleString()}${evt.end ? ' → '+evt.end.toLocaleString() : ''}`;
    // Guardamos referencia en dataset para handlers
    const modal = document.getElementById('modalDetalleEvt');
    modal.dataset.eventId = evt.id;
    new bootstrap.Modal(modal).show();
  }

  /* ===== Calendar ===== */
  let calendar;
  async function initCalendar(){
    const initialEvents = await fetchEventos();
    const el = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(el, {
      height: 'auto',
      locale: 'es',
      firstDay: 1,
      nowIndicator: true,
      weekNumbers: true,
      expandRows: true,
      initialView: 'dayGridMonth',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
      buttonText: { today:'Hoy', month:'Mes', week:'Semana', day:'Día', list:'Lista' },
      selectable: true,
      selectMirror: true,
      select: (info)=> openNuevoModal(info),
      eventClick: (arg)=> openDetalleModal(arg.event),
      editable: true,
      eventDrop: async (arg)=>{
        try{
          await actualizarEvento(arg.event.id, {
            start: toIsoOrNull(arg.event.start),
            end:   toIsoOrNull(arg.event.end),
            allDay: arg.event.allDay
          });
          showToast({title:'Evento movido', body:arg.event.title, icon:'check2-circle'});
        }catch(e){ arg.revert(); showToast({title:'Error', body:'No se pudo mover', icon:'exclamation-triangle'}); }
      },
      eventResize: async (arg)=>{
        try{
          await actualizarEvento(arg.event.id, {
            start: toIsoOrNull(arg.event.start),
            end:   toIsoOrNull(arg.event.end)
          });
          showToast({title:'Duración actualizada', body:arg.event.title, icon:'check2-circle'});
        }catch(e){ arg.revert(); showToast({title:'Error', body:'No se pudo cambiar duración', icon:'exclamation-triangle'}); }
      },
      events: initialEvents,
      eventDidMount: (info)=>{
        const color = info.event.backgroundColor || info.event.color || '#0ea5e9';
        info.el.style.borderRadius = '8px';
        info.el.style.borderColor = color;
        if (info.event.extendedProps?.description){
          new bootstrap.Tooltip(info.el, { title: info.event.extendedProps.description, placement:'top' });
        }
      }
    });
    calendar.render();
  }

  // Crear evento desde modal
  document.getElementById('evtCreateBtn')?.addEventListener('click', async ()=>{
    if(!_selectCtx) return;
    const title = document.getElementById('evtTitle').value.trim();
    const description = document.getElementById('evtDesc').value.trim();
    const color = document.getElementById('evtTipo').value;
    if(!title){ showToast({title:'Falta título', body:'El evento necesita un título.', icon:'exclamation-triangle'}); return; }
    try{
      const created = await crearEvento({
        title, description, start:_selectCtx.startStr, end:_selectCtx.endStr || null, allDay:_selectCtx.allDay, color
      });
      calendar.addEvent({ ...created });
      showToast({title:'Evento creado', body:title, icon:'check2-circle'});
    }catch(e){ showToast({title:'Error', body:e.message||'No se pudo crear', icon:'exclamation-triangle'}); }
    bootstrap.Modal.getInstance(document.getElementById('modalNuevoEvt'))?.hide();
  });

  // Guardar/Eliminar desde modal detalle
  document.getElementById('evtSaveBtn')?.addEventListener('click', async ()=>{
    const modal = document.getElementById('modalDetalleEvt');
    const id = modal.dataset.eventId;
    const evt = calendar.getEventById(id);
    if(!evt) return;
    const title = document.getElementById('evtTitleE').value.trim();
    const description = document.getElementById('evtDescE').value.trim();
    const color = document.getElementById('evtColorE').value;
    try{
      await actualizarEvento(id, { title, description, color });
      evt.setProp('title', title);
      evt.setExtendedProp('description', description);
      evt.setProp('backgroundColor', color);
      evt.setProp('borderColor', color);
      showToast({title:'Evento actualizado', body:title, icon:'check2-circle'});
      bootstrap.Modal.getInstance(modal)?.hide();
    }catch(e){ showToast({title:'Error', body:e.message||'No se pudo actualizar', icon:'exclamation-triangle'}); }
  });

  document.getElementById('evtDelBtn')?.addEventListener('click', async ()=>{
    const modal = document.getElementById('modalDetalleEvt');
    const id = modal.dataset.eventId;
    const evt = calendar.getEventById(id);
    if(!evt) return;
    if(!confirm('¿Eliminar este evento?')) return;
    try{
      await eliminarEvento(id);
      const title = evt.title;
      evt.remove();
      showToast({title:'Evento eliminado', body:title, icon:'trash'});
      bootstrap.Modal.getInstance(modal)?.hide();
    }catch(e){ showToast({title:'Error', body:e.message||'No se pudo eliminar', icon:'exclamation-triangle'}); }
  });

  /* ===== Init ===== */
  (async function(){
    await initCalendar();
  })();
</script>
{% endblock %}
