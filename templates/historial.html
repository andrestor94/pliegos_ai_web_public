{% extends "base.html" %}
{% block title %}Historial de AnÃ¡lisis â€“ Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  .hist-head{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .hist-head .count{ color:#667085; }
  .hist-search{ display:flex; gap:8px; margin-left:auto; }
  .hist-card{
    background:#fff; border:1px solid var(--border); border-radius:14px;
    padding:16px; margin-bottom:14px; box-shadow:0 4px 16px rgba(4,67,105,.08);
  }
  .hist-card .meta{ color:#667085; }
  .hist-card .acciones .btn{ margin-right:8px; }
  .empty-state{
    display:none; text-align:center; color:#6b7280;
    background:var(--bg-soft); border:1px dashed var(--border);
    border-radius:14px; padding:16px;
  }
  mark.highlight{ background:#fff3bf; padding:0 .15em; border-radius:4px; }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:1000px;">
  <div class="hist-head my-3">
    <h2 class="m-0">ðŸ“š Historial de AnÃ¡lisis</h2>
    <span class="count">({{ historial|length }} Ã­tems)</span>
    <div class="hist-search ms-auto">
      <input id="busqueda" class="form-control" placeholder="Buscarâ€¦ (archivo, usuario, fecha)">
      <button id="btnLimpiar" class="btn btn-outline-secondary">Limpiar</button>
    </div>
  </div>

  <div id="contenedor-historial">
    {% for item in historial %}
    <div class="hist-card"
         data-archivo="{{ item.nombre_archivo | e }}"
         data-usuario="{{ item.usuario | e }}"
         data-fecha="{{ item.fecha_legible | e }}">
      <p class="mb-1"><strong>ðŸ“„ Archivo:</strong> <span class="campo-archivo">{{ item.nombre_archivo }}</span></p>
      <p class="mb-1 meta"><strong>ðŸ•“ Fecha:</strong> <span class="campo-fecha">{{ item.fecha_legible }}</span></p>
      <p class="mb-0 meta"><strong>ðŸ‘¤ Usuario:</strong> <span class="campo-usuario">{{ item.usuario }}</span></p>
      <div class="acciones mt-3">
        <a href="/descargar/{{ item.nombre_archivo }}" class="btn btn-sm btn-success">
          <i class="bi bi-download me-1"></i> Descargar PDF
        </a>
        <button class="btn btn-sm btn-outline-danger"
                onclick="eliminar('{{ item.timestamp }}')">
          <i class="bi bi-trash"></i> Eliminar
        </button>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="sinResultados" class="empty-state">
    <i class="bi bi-search"></i> No se encontraron resultados para el tÃ©rmino ingresado.
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ===== Helpers =====
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  const $q = document.getElementById('busqueda');
  const $btnLimpiar = document.getElementById('btnLimpiar');
  const $empty = document.getElementById('sinResultados');
  const items = () => Array.from(document.querySelectorAll('#contenedor-historial .hist-card'));

  function clearHighlights(el){
    el.querySelectorAll('mark.highlight').forEach(m=>{
      m.replaceWith(document.createTextNode(m.textContent));
    });
  }
  function highlight(el, term){
    if(!term) return;
    const re = new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig');
    ['.campo-archivo','.campo-usuario','.campo-fecha'].forEach(sel=>{
      const node = el.querySelector(sel); if(!node) return;
      node.innerHTML = escapeHtml(node.textContent).replace(re,'<mark class="highlight">$1</mark>');
    });
  }

  let debounceId=null;
  function filtrar(){
    const term = ($q.value||'').trim().toLowerCase();
    let visibles = 0;
    items().forEach(box=>{
      clearHighlights(box);
      const hay = (box.dataset.archivo + ' ' + box.dataset.usuario + ' ' + box.dataset.fecha)
                  .toLowerCase()
                  .includes(term);
      box.style.display = hay ? 'block' : 'none';
      if(hay){ visibles++; highlight(box, term); }
    });
    $empty.style.display = visibles ? 'none' : 'block';
  }
  $q.addEventListener('input', ()=>{ clearTimeout(debounceId); debounceId = setTimeout(filtrar, 180); });
  $btnLimpiar.addEventListener('click', ()=>{ $q.value=''; filtrar(); });

  // ===== Eliminar item =====
  async function eliminar(timestamp){
    if(!confirm('Â¿Seguro que deseas eliminar este anÃ¡lisis?')) return;
    try{
      const r = await fetch(`/eliminar/${timestamp}`, { method:'DELETE' });
      if(!r.ok) throw new Error('No se pudo eliminar');
      // quitar del DOM y refrescar filtro
      const card = document.querySelector(`.hist-card button[onclick*="${timestamp}"]`)?.closest('.hist-card');
      if(card) card.remove();
      filtrar();
      // showToast viene de base.html
      showToast({title:'Eliminado', body:'El anÃ¡lisis fue eliminado.', icon:'trash'});
    }catch(e){
      showToast({title:'Error', body:'No se pudo eliminar.', icon:'exclamation-triangle'});
    }
  }
  window.eliminar = eliminar; // expone para los botones inline

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', filtrar);
</script>
{% endblock %}
