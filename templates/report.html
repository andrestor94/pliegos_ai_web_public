
{% extends "base.html" %}
{% block title %}Informe – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ===== Vista específica del informe (alineada al theme) ===== */
  .report-actions .btn{ border-radius:10px; }
  .report-kv{ display:grid; grid-template-columns: 180px 1fr; gap:10px 16px; }
  .report-kv .k{ color:var(--text-2); }
  .report-kv .v{ color:var(--text-1); font-weight:600; }
  .report-section + .report-section{ margin-top:18px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .table thead{ background:var(--bg-soft); position:sticky; top:0; z-index:1; }
  html[data-theme="dark"] .table thead{ background:#0f172a; }
  .badge-doc{
    background:#e8efff; color:#1e40af; border:1px solid #cfe0ff; border-radius:999px; padding:.15rem .5rem; font-weight:600;
  }
  html[data-theme="dark"] .badge-doc{ background:#0e223b; color:#93c5fd; border-color:#1f3b61; }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .toolbar .form-control, .toolbar .form-select{ border-radius:10px; }

  .highlight{ background:#fff3bf; border-radius:3px; padding:0 .15em; }

  /* Cabeceras ordenables */
  th.sortable{ cursor:pointer; user-select:none; white-space:nowrap; }
  th.sortable .bi{ opacity:.35; margin-left:.25rem; }
  th.sortable.active .bi{ opacity:1; }

  /* Impresión */
  @media print{
    header, .fab, .report-actions, .notif-fab, .toast-container, .tools-row{ display:none!important; }
    main.container{ max-width: 100%!important; margin:0!important; }
    .card{ box-shadow:none!important; border:1px solid var(--border); }
    .table thead{ position:static; }
  }
</style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="hero-title mb-0"><i class="bi bi-file-earmark-text me-2"></i> Informe de Licitación</h1>
    <div class="report-actions d-flex gap-2">
      <a href="/" class="btn btn-outline-secondary btn-sm">← Volver</a>
      <button class="btn btn-outline-secondary btn-sm" id="btnCopy"><i class="bi bi-clipboard"></i> Copiar</button>
      <button class="btn btn-outline-primary btn-sm" onclick="descargarJSON()" title="Descargar JSON"><i class="bi bi-braces"></i> JSON</button>
      <button class="btn btn-outline-primary btn-sm" id="btnCsv" title="Exportar ítems CSV"><i class="bi bi-filetype-csv"></i> Ítems CSV</button>
      <button class="btn btn-primary btn-sm" onclick="window.print()" title="Imprimir / PDF"><i class="bi bi-printer"></i> Imprimir</button>
    </div>
  </div>

  <!-- Herramientas -->
  <div class="tools-row card card-clean shadow-hover mb-3">
    <div class="card-body">
      <div class="toolbar">
        <div class="input-group" style="max-width:280px;">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="filterItems" class="form-control form-control-sm" placeholder="Filtrar ítems… (descr./unidad)">
        </div>

        <div class="input-group" style="width:auto;">
          <span class="input-group-text"><i class="bi bi-translate"></i></span>
          <select id="localeSel" class="form-select form-select-sm" style="width:auto">
            <option value="es-AR" selected>Formato: es-AR</option>
            <option value="en-US">Formato: en-US</option>
          </select>
        </div>

        <div class="input-group" style="width:auto;">
          <span class="input-group-text"><i class="bi bi-currency-exchange"></i></span>
          <select id="currencySel" class="form-select form-select-sm" style="width:auto" title="Moneda para formateo">
            <option value="ARS" selected>ARS</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>

        <div class="ms-auto small text-muted" id="itemsInfo">—</div>
      </div>
    </div>
  </div>

  <div class="card card-clean shadow-hover" id="reportCard">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Resumen</strong>
      <span class="small text-muted" id="genHint"></span>
    </div>
    <div class="card-body">
      <div class="report-kv">
        <div class="k">Tipo</div><div class="v">{{ data.tipo or '—' }}</div>
        <div class="k">Objeto</div><div class="v" id="vObjeto">{{ data.objeto or '—' }}</div>
        <div class="k">Organismo</div><div class="v">{{ data.organismo or '—' }}</div>
        <div class="k">Presupuesto</div><div class="v" id="vPresupuesto">{{ data.presupuesto or '—' }}</div>
        <div class="k">Fecha</div><div class="v">{{ data.fecha or '—' }}</div>
        {% if data.expediente %}
          <div class="k">Expediente</div><div class="v">{{ data.expediente }}</div>
        {% endif %}
        {% if data.ubicacion %}
          <div class="k">Ubicación</div><div class="v">{{ data.ubicacion }}</div>
        {% endif %}
      </div>

      {% if data.resumen %}
      <div class="report-section">
        <label class="form-label text-muted">Resumen / Observaciones</label>
        <div id="resumenBox" class="p-3 rounded-3 border mono" style="background:var(--bg-soft); white-space:pre-wrap;">{{ data.resumen }}</div>
      </div>
      {% endif %}

      {% if data.documentos %}
      <div class="report-section">
        <label class="form-label text-muted">Documentos</label>
        <div class="d-flex flex-wrap gap-2">
          {% for d in data.documentos %}
            <a href="{{ d.url or d.href or '#' }}" target="_blank" rel="noopener" class="badge-doc text-decoration-none">{{ d.nombre or d.titulo or ('Documento ' ~ loop.index) }}</a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if data.items and data.items|length > 0 %}
      <div class="report-section">
        <div class="d-flex align-items-center justify-content-between">
          <label class="form-label text-muted mb-0">Ítems</label>
          <div class="small text-muted" id="totalsBadge">—</div>
        </div>
        <div class="table-responsive">
          <table class="table align-middle" id="itemsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="idx" style="width:64px"># <i class="bi bi-arrow-down-up"></i></th>
                <th class="sortable" data-sort="desc">Descripción <i class="bi bi-arrow-down-up"></i></th>
                <th class="sortable text-nowrap" data-sort="unidad">Unidad <i class="bi bi-arrow-down-up"></i></th>
                <th class="sortable text-end text-nowrap" data-sort="cantidad">Cantidad <i class="bi bi-arrow-down-up"></i></th>
                <th class="sortable text-end text-nowrap" data-sort="precio">Precio Ref. <i class="bi bi-arrow-down-up"></i></th>
              </tr>
            </thead>
            <tbody>
              {% for it in data.items %}
              <tr>
                <td class="text-muted td-idx">{{ it.id or loop.index }}</td>
                <td class="campo-desc">{{ it.descripcion or it.desc or '—' }}</td>
                <td class="text-nowrap campo-un">{{ it.unidad or it.u or '—' }}</td>
                <td class="text-end campo-cant">{{ it.cantidad or it.cant or '—' }}</td>
                <td class="text-end campo-precio">{{ it.precio or it.precio_ref or '—' }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Totales</th>
                <th class="text-end" id="tCant">—</th>
                <th class="text-end" id="tMonto">—</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      {% endif %}

      {% if data.contacto or data.consultas %}
      <div class="report-section">
        <label class="form-label text-muted">Contacto</label>
        <div id="contactoBox">{{ data.contacto or data.consultas }}</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- FAB Chat OpenAI (de base.html) -->
<button class="btn btn-primary fab" onclick="toggleAiWidget()"><i class="bi bi-robot me-2"></i>Chat OpenAI</button>
{% endblock %}

{% block extra_scripts %}
{% if data %}<script id="reportData" type="application/json">{{ data|tojson }}</script>{% endif %}
<script>
  /* ========= Helpers ========= */
  const $ = (s,sc)=> (sc||document).querySelector(s);
  const $$ = (s,sc)=> Array.from((sc||document).querySelectorAll(s));
  const escapeHtml = (s)=> (s??'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const LS = { get(k,d){ try{ const v=localStorage.getItem(k); return v==null?d:JSON.parse(v);}catch(_){return d;} }, set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){}} };

  // Parseo robusto de números humanos (1.234,56 | 1,234.56 | 1234,56 | 1234.56 | $ 1.234,56 ARS | US$ 1,234.56)
  function parseNum(v){
    if(v==null) return NaN;
    if(typeof v==='number') return v;
    let s = String(v).trim();
    if(!s) return NaN;
    s = s.replace(/[^\d.,\-]/g,''); // quita símbolos/currency
    if(!s) return NaN;
    const hasDot = s.includes('.'), hasCom = s.includes(',');
    if(hasDot && hasCom){
      // el separador decimal suele ser el último que aparece
      const lastDot = s.lastIndexOf('.');
      const lastCom = s.lastIndexOf(',');
      const dec = lastDot > lastCom ? '.' : ',';
      const grp = dec === '.' ? ',' : '.';
      s = s.replaceAll(grp,'').replace(dec,'.');
      return Number(s);
    }else if(hasCom){
      const parts = s.split(',');
      if(parts.length>2){
        const dec = parts.pop();
        s = parts.join('') + '.' + dec;
      }else if(parts.length===2){
        // si la parte derecha tiene 3 dígitos, es miles; si 1-2, es decimal
        s = parts[1].length===3 ? (parts.join('')) : (parts[0]+'.'+parts[1]);
      }
      return Number(s);
    }else if(hasDot){
      const parts = s.split('.');
      if(parts.length>2){
        const dec = parts.pop();
        s = parts.join('') + '.' + dec;
      } // si es único punto, JS parsea bien
      return Number(s);
    }
    return Number(s);
  }
  const sum = (arr)=> arr.reduce((a,b)=> a+(Number.isFinite(b)?b:0), 0);

  // Linkificar texto simple (URLs / emails) preservando seguridad
  function linkify(el){
    if(!el) return;
    const txt = el.textContent;
    const urlRE = /\b(https?:\/\/[^\s]+)\b/gi;
    const mailRE= /\b([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})\b/g;
    let html = escapeHtml(txt).replace(urlRE, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    html = html.replace(mailRE, '<a href="mailto:$1">$1</a>');
    el.innerHTML = html;
  }

  // CSV genérico
  function downloadCSV(rows, name){
    const esc = v=> `"${String(v??'').replace(/"/g,'""')}"`;
    const csv = rows.map(r=> r.map(esc).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }

  // ===== Copiar informe (solo texto útil) =====
  $('#btnCopy')?.addEventListener('click', async ()=>{
    try{
      const el = $('#reportCard').cloneNode(true);
      el.querySelectorAll('button, .form-label, .table tfoot').forEach(n=> n.remove?.());
      await navigator.clipboard.writeText(el.innerText.trim());
      (window.showToast||console.log)({title:'Copiado', body:'Contenido copiado al portapapeles.', icon:'clipboard'});
    }catch(_){
      (window.showToast||console.error)({title:'Error', body:'No se pudo copiar.', icon:'exclamation-triangle'});
    }
  });

  // ===== Export JSON bruto =====
  function descargarJSON(){
    try{
      const el = document.getElementById('reportData');
      const raw = el ? el.textContent : '{}';
      const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `informe_licitacion_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a);
      a.click(); a.remove(); URL.revokeObjectURL(url);
      (window.showToast||console.log)({title:'Descarga iniciada', body:'Exportado como JSON.', icon:'download'});
    }catch(e){
      (window.showToast||console.error)({title:'Error', body:'No se pudo exportar el JSON.', icon:'exclamation-triangle'});
    }
  }
  window.descargarJSON = descargarJSON;

  // ===== Formateo / totales / filtro =====
  const localeSel   = $('#localeSel');
  const currencySel = $('#currencySel');
  let currentLocale  = LS.get('report.locale', 'es-AR');
  let currentCurrency= LS.get('report.currency','ARS');

  // Persistencia de preferencias
  (function restorePrefs(){
    if(localeSel)   localeSel.value   = currentLocale;
    if(currencySel) currencySel.value = currentCurrency;
  })();

  function nf(opts){ try{ return new Intl.NumberFormat(currentLocale, opts); }catch(_){ return new Intl.NumberFormat('es-AR', opts); } }

  // Detección simple de moneda desde presupuesto o precios
  (function detectCurrency(){
    const pres = $('#vPresupuesto')?.textContent || '';
    const prices = $$('#itemsTable .campo-precio').map(td=> td.textContent).join(' ');
    const bag = (pres + ' ' + prices).toUpperCase();
    if(/USD|US\$|U\$S/.test(bag)) currentCurrency='USD';
    else if(/EUR|€/.test(bag)) currentCurrency='EUR';
    else if(/\$/.test(bag)) currentCurrency='ARS';
    if(currencySel) currencySel.value = currentCurrency;
  })();

  function recompute(){
    const rows = $$('#itemsTable tbody tr').filter(tr => tr.style.display!=='none');
    const cant = rows.map(tr => parseNum($('.campo-cant', tr)?.dataset.raw || $('.campo-cant', tr)?.textContent));
    const precio= rows.map(tr => parseNum($('.campo-precio', tr)?.dataset.raw || $('.campo-precio', tr)?.textContent));
    const totCant = sum(cant);
    const totMonto = sum(rows.map((_,i)=> (Number.isFinite(cant[i]) && Number.isFinite(precio[i])) ? cant[i]*precio[i] : 0));
    $('#tCant').textContent  = Number.isFinite(totCant) ? nf({maximumFractionDigits:2}).format(totCant) : '—';
    $('#tMonto').textContent = Number.isFinite(totMonto) ? nf({style:'currency', currency:currentCurrency, maximumFractionDigits:2}).format(totMonto) : '—';
    $('#totalsBadge').textContent = (Number.isFinite(totCant)||Number.isFinite(totMonto))
      ? `Ítems: ${rows.length} · Cantidad total: ${$('#tCant').textContent} · Monto estimado: ${$('#tMonto').textContent}`
      : `Ítems: ${rows.length}`;
    $('#itemsInfo').textContent = `Mostrando ${rows.length} ítems`;
  }

  // Re-formatea columnas numéricas al cambiar locale/moneda (no altera valores de fuente)
  function reformatNums(){
    $$('#itemsTable tbody tr').forEach(tr=>{
      const c = $('.campo-cant', tr);
      const p = $('.campo-precio', tr);
      const nv = parseNum(c?.dataset.raw || c?.textContent);
      const pv = parseNum(p?.dataset.raw || p?.textContent);
      if(c){ if(!c.dataset.raw) c.dataset.raw = c.textContent.trim(); c.textContent = Number.isFinite(nv) ? nf({maximumFractionDigits:2}).format(nv) : c.dataset.raw; }
      if(p){ if(!p.dataset.raw) p.dataset.raw = p.textContent.trim(); p.textContent = Number.isFinite(pv) ? nf({style:'currency', currency:currentCurrency, maximumFractionDigits:2}).format(pv) : p.dataset.raw; }
    });
    recompute();
  }

  function clearHighlights(){
    $$('#itemsTable .highlight').forEach(m=> m.replaceWith(document.createTextNode(m.textContent)));
  }
  function highlightCell(el, term){
    const txt = el.textContent;
    const re = new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig');
    el.innerHTML = escapeHtml(txt).replace(re,'<mark class="highlight">$1</mark>');
  }
  function applyFilter(){
    const term = ($('#filterItems')?.value || '').trim().toLowerCase();
    clearHighlights();
    $$('#itemsTable tbody tr').forEach(tr=>{
      const desc = $('.campo-desc', tr)?.textContent.toLowerCase() || '';
      const uni  = $('.campo-un', tr)?.textContent.toLowerCase() || '';
      const show = !term || desc.includes(term) || uni.includes(term);
      tr.style.display = show ? '' : 'none';
      if(show && term){
        highlightCell($('.campo-desc', tr), term);
        highlightCell($('.campo-un', tr), term);
      }
    });
    recompute();
  }

  // ===== Export CSV de ítems visibles (respeta filtro / orden actual) =====
  $('#btnCsv')?.addEventListener('click', ()=>{
    const head = ['#','Descripción','Unidad','Cantidad','PrecioRef'];
    const rows = [head];
    $$('#itemsTable tbody tr').forEach(tr=>{
      if(tr.style.display==='none') return; // respeta el filtro
      rows.push([
        tr.querySelector('.td-idx')?.innerText.trim() || '',
        $('.campo-desc', tr)?.innerText.trim() || '',
        $('.campo-un', tr)?.innerText.trim() || '',
        $('.campo-cant', tr)?.dataset.raw || $('.campo-cant', tr)?.innerText.trim() || '',
        $('.campo-precio', tr)?.dataset.raw || $('.campo-precio', tr)?.innerText.trim() || ''
      ]);
    });
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    downloadCSV(rows, `items_informe_${stamp}.csv`);
  });

  // ===== Ordenación por columnas =====
  const STATE = { order: { by: 'idx', dir: 'asc' } };

  function getRowsAsObjs(){
    return $$('#itemsTable tbody tr').map(tr => ({
      tr,
      idx: parseNum(tr.querySelector('.td-idx')?.textContent),
      desc: tr.querySelector('.campo-desc')?.textContent.trim() || '',
      unidad: tr.querySelector('.campo-un')?.textContent.trim() || '',
      cantidad: parseNum(tr.querySelector('.campo-cant')?.dataset.raw || tr.querySelector('.campo-cant')?.textContent),
      precio: parseNum(tr.querySelector('.campo-precio')?.dataset.raw || tr.querySelector('.campo-precio')?.textContent)
    }));
  }

  function sortRows(){
    const tbody = $('#itemsTable tbody');
    const items = getRowsAsObjs();
    const { by, dir } = STATE.order;
    items.sort((a,b)=>{
      const d = dir==='asc' ? 1 : -1;
      if(by==='desc' || by==='unidad'){
        return a[by].localeCompare(b[by]) * d;
      }else{
        const av = Number.isFinite(a[by]) ? a[by] : (by==='idx'?Number.MAX_SAFE_INTEGER:NaN);
        const bv = Number.isFinite(b[by]) ? b[by] : (by==='idx'?Number.MAX_SAFE_INTEGER:NaN);
        if(!Number.isFinite(av) && !Number.isFinite(bv)) return 0;
        if(!Number.isFinite(av)) return 1*d;
        if(!Number.isFinite(bv)) return -1*d;
        return (av - bv) * d;
      }
    });
    // Reensamblar DOM
    const frag = document.createDocumentFragment();
    items.forEach(x => frag.appendChild(x.tr));
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    // Marcar th activo
    $$('#itemsTable thead th.sortable').forEach(th=>{
      const active = th.dataset.sort === by;
      th.classList.toggle('active', active);
      const icon = th.querySelector('.bi');
      if(icon){
        icon.className = dir==='asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
      }
    });
  }

  $$('#itemsTable thead th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const by = th.dataset.sort;
      if(STATE.order.by === by){
        STATE.order.dir = STATE.order.dir==='asc' ? 'desc' : 'asc';
      }else{
        STATE.order.by = by;
        STATE.order.dir = (by==='desc' || by==='unidad') ? 'asc' : 'asc';
      }
      sortRows();
      applyFilter(); // mantiene filtro y recalcula totales
    });
  });

  // ===== Boot =====
  (function init(){
    // Fecha de generación (cliente)
    const hint = $('#genHint'); if(hint){ hint.textContent = 'Generado: ' + new Date().toLocaleString(); }

    // Linkificar resumen/contacto si están
    linkify($('#resumenBox'));
    linkify($('#contactoBox'));

    // Preparar datos raw y computar
    $$('#itemsTable tbody tr').forEach(tr=>{
      const c = $('.campo-cant', tr); const p = $('.campo-precio', tr);
      if(c) c.dataset.raw = c.textContent.trim();
      if(p) p.dataset.raw = p.textContent.trim();
    });

    // Preferencias persistidas
    currentLocale   = $('#localeSel')?.value || currentLocale;
    currentCurrency = $('#currencySel')?.value || currentCurrency;

    reformatNums();
    sortRows(); // arranca con orden por índice asc

    // Atajo: "/" o "f" enfoca el filtro
    window.addEventListener('keydown', (e)=>{
      if(['/', 'f', 'F'].includes(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey){
        const t = e.target; const isTyping = t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable);
        if(isTyping) return;
        e.preventDefault(); $('#filterItems')?.focus();
      }
    });
  })();

  // Listeners de UI
  $('#filterItems')?.addEventListener('input', ()=>{ clearTimeout(window.__t); window.__t=setTimeout(applyFilter,150); });
  $('#localeSel')?.addEventListener('change', (e)=>{ currentLocale = e.target.value || 'es-AR'; LS.set('report.locale', currentLocale); reformatNums(); });
  $('#currencySel')?.addEventListener('change', (e)=>{ currentCurrency = e.target.value || 'ARS'; LS.set('report.currency', currentCurrency); reformatNums(); });
</script>
{% endblock %}
