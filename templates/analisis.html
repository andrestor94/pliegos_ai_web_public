{% extends "base.html" %}
{% block title %}Análisis de pliegos — Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ====== Scoped a análisis (respetando el theme global) ====== */
  .analisis .panel-muted{
    background: var(--muted);
    border: 1px solid var(--bs-border-color, var(--border));
    border-radius: 12px;
  }
  .analisis .rich-text{
    overflow-wrap: anywhere;
  }
  .analisis .dropzone{
    transition: box-shadow .18s cubic-bezier(0.22,1,0.36,1), transform .18s, border-color .18s;
    cursor: pointer;
  }
  .analisis .dropzone:hover,
  .analisis .dropzone:focus-within{
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
    border-color: var(--brand-300);
  }
  .analisis .segmented .btn{ padding:.35rem .8rem; }
  .analisis .segmented .btn.is-active,
  .analisis .segmented .btn.active{
    border-color: var(--brand-300) !important;
    box-shadow: 0 0 0 4px rgba(var(--ring-color), .18);
  }
  .analisis .file-badge{
    display:inline-block; padding:.15rem .5rem; border-radius:999px;
    border:1px solid var(--bs-border-color, var(--border)); font-weight:600; font-size:.8rem;
    background: var(--chip-bg); color: var(--chip-text);
  }
  .analisis .kbd{ padding:.05rem .35rem; border-radius:6px; border:1px solid var(--bs-border-color, var(--border)); background:var(--surface); }
  @media (max-width: 575.98px){
    .analisis .segmented{ width:100%; justify-content:space-between; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-3 analisis">
  <h1 class="hero-title mb-3">
    <i class="bi bi-file-earmark-text me-2"></i> Análisis de pliegos
  </h1>

  <!-- En mobile apila; en desktop 2 columnas (1.2fr | .8fr) -->
  <div class="split">
    <!-- ======================================= -->
    <!-- Columna izquierda: Carga + Config + Resultados -->
    <!-- ======================================= -->
    <section class="card-clean shadow-hover">
      <div class="card-body">
        <!-- 1) Carga de archivos -->
        <h2 class="h6 mb-2">1) Cargar archivos (PDF / DOCX / Imágenes)</h2>
        <div id="dzArea" class="dropzone mb-3" tabindex="0" aria-label="Zona para arrastrar y soltar archivos">
          Arrastrá y soltá aquí o
          <label class="btn btn-sm btn-primary ms-1 mb-0">
            Seleccionar
            <input id="filesInput" type="file" name="files" multiple hidden
                   accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.webp,.tiff,.tif"/>
          </label>
          <div class="small subtle mt-2">
            También podés pegar con <span class="kbd">Ctrl</span>+<span class="kbd">V</span> imágenes copiadas del portapapeles.
          </div>
        </div>

        <!-- Lista de archivos seleccionados -->
        <div class="table-wrap mb-4" id="filesWrap" style="display:none;">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th style="min-width:220px;">Archivo</th>
                <th>Peso</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th style="min-width:120px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="filesTbody"></tbody>
          </table>
        </div>

        <!-- 2) Configuración de análisis -->
        <h2 class="h6 mb-2">2) Configuración</h2>
        <form id="cfgForm" class="row g-2 input-compact">
          <div class="col-md-4">
            <label class="form-label" for="outType">Tipo de salida</label>
            <select id="outType" class="form-select">
              <option value="resumen">Resumen ejecutivo</option>
              <option value="exhaustivo" selected>Informe exhaustivo</option>
              <option value="tabla_requisitos">Tabla de requisitos</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="lang">Idioma</label>
            <select id="lang" class="form-select">
              <option value="es" selected>Español</option>
              <option value="en">Inglés</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="ocrMode">OCR / Escaneados</label>
            <select id="ocrMode" class="form-select">
              <option value="auto" selected>Automático</option>
              <option value="forzar">Forzar OCR</option>
              <option value="off">Sin OCR</option>
            </select>
          </div>
        </form>

        <!-- 3) Controles -->
        <div class="d-flex flex-wrap gap-2 mt-3">
          <button id="analyzeBtn" class="btn btn-primary" disabled>
            <span class="btn-label"><i class="bi bi-cpu me-1"></i> Analizar</span>
            <span id="analyzeSpin" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
          <button id="exportPdfBtn" class="btn btn-outline-primary" disabled>
            <span class="btn-label"><i class="bi bi-filetype-pdf me-1"></i> Generar PDF</span>
            <span id="pdfSpin" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
          <button id="clearBtn" class="btn btn-outline-secondary">
            <i class="bi bi-trash3 me-1"></i> Limpiar
          </button>
        </div>

        <hr class="my-4"/>

        <!-- 4) Resultados -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 m-0">Resultados</h2>
          <div class="segmented" role="tablist" aria-label="Cambiar vista de resultados">
            <button class="btn btn-sm btn-light active" data-view="texto" type="button" role="tab" aria-selected="true">Texto</button>
            <button class="btn btn-sm btn-light" data-view="estructura" type="button" role="tab" aria-selected="false">Estructura</button>
            <button class="btn btn-sm btn-light" data-view="tablas" type="button" role="tab" aria-selected="false">Tablas</button>
          </div>
        </div>

        <!-- Vista: Texto -->
        <div id="view-texto" class="h-pane-55" style="display:block;">
          <div id="textoOut" class="small rich-text" aria-live="polite"></div>
        </div>

        <!-- Vista: Estructura (acordeón) -->
        <div id="view-estructura" class="h-pane-55" style="display:none;">
          <div class="accordion" id="accEstructura" role="tablist" aria-label="Estructura del pliego">
            <!-- Secciones generadas por JS -->
          </div>
        </div>

        <!-- Vista: Tablas -->
        <div id="view-tablas" class="h-pane-55" style="display:none;">
          <div class="table-wrap">
            <table class="table table-sm" id="tablaRequisitos">
              <thead>
                <tr>
                  <th>Ítem</th>
                  <th>Requisito</th>
                  <th>Referencia (pág./anexo)</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Filas renderizadas por JS -->
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- ======================================= -->
    <!-- Columna derecha: Chat / Log -->
    <!-- ======================================= -->
    <aside class="card-clean shadow-hover">
      <div class="card-body">
        <h2 class="h6 mb-2">Chat de análisis</h2>
        <div id="chatBox" class="panel-muted p-2 h-pane-55">
          <!-- Mensajes -->
          <div class="small text-muted">Sin mensajes aún.</div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <input id="chatInput" class="form-control" placeholder="Escribí una consulta sobre los archivos…"/>
          <button id="chatSend" class="btn btn-primary" type="button"><i class="bi bi-send"></i></button>
        </div>

        <hr class="my-3"/>

        <h2 class="h6 mb-2">Bitácora</h2>
        <div id="logBox" class="panel-muted small p-2 h-pane-50" style="white-space:pre-wrap;"></div>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* ===== Helpers UI ===== */
const $ = (s,sc)=> (sc||document).querySelector(s);
const $$ = (s,sc)=> Array.from((sc||document).querySelectorAll(s));
const fmtBytes = n=>{
  if(!Number.isFinite(n)) return '—';
  const u=['B','KB','MB','GB']; let i=0;
  while(n>=1024 && i<u.length-1){ n/=1024; i++; }
  return `${n.toFixed(i?1:0)} ${u[i]}`;
};
function log(msg){ const el=$("#logBox"); if(!el) return; const t=new Date().toLocaleTimeString(); el.textContent += `[${t}] ${msg}\n`; el.scrollTop=el.scrollHeight; }
function toast(t,b,icon){ if(window.showToast) showToast({title:t, body:b||'', icon: icon || 'info'}); }

/* ===== Drag & drop / file input ===== */
const dz = $("#dzArea");
const filesInput = $("#filesInput");
const filesWrap = $("#filesWrap");
const filesTbody = $("#filesTbody");
const analyzeBtn = $("#analyzeBtn");
const exportPdfBtn = $("#exportPdfBtn");
const clearBtn = $("#clearBtn");
const analyzeSpin = $("#analyzeSpin");
const pdfSpin = $("#pdfSpin");

let files = []; // {file, id, status}

const MAX_FILE_MB = 40; // límite front opcional para UX
const ALLOWED = /\.(pdf|docx?|png|jpe?g|webp|tiff?)$/i;

function refreshFilesUI(){
  if(!files.length){
    filesWrap.style.display='none';
    analyzeBtn.disabled=true;
    exportPdfBtn.disabled=true;
    filesTbody.innerHTML='';
    return;
  }
  filesWrap.style.display='';
  analyzeBtn.disabled=false;
  filesTbody.innerHTML = files.map((f,i)=>`
    <tr>
      <td>${f.file.name}</td>
      <td>${fmtBytes(f.file.size)}</td>
      <td>${(f.file.type||'').split('/').pop().toUpperCase() || f.file.name.split('.').pop().toUpperCase()}</td>
      <td>
        <span class="file-badge">
          ${f.status ? f.status : 'pendiente'}
        </span>
      </td>
      <td class="d-flex gap-1">
        <button class="btn btn-sm btn-outline-secondary" data-idx="${i}" data-act="preview" type="button" aria-label="Previsualizar ${f.file.name}">
          <i class="bi bi-eye"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" data-idx="${i}" data-act="remove" type="button" aria-label="Quitar ${f.file.name}">
          <i class="bi bi-x"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

function addFiles(list){
  let added = 0, skipped = 0;
  for(const f of list){
    if(!f) continue;
    if(!ALLOWED.test(f.name)){
      skipped++; continue;
    }
    if(f.size > MAX_FILE_MB*1024*1024){
      skipped++; continue;
    }
    files.push({file:f, id:crypto.randomUUID(), status:'pendiente'});
    added++;
  }
  if(added) log(`Agregados ${added} archivo(s).`);
  if(skipped) toast('Archivos omitidos', `${skipped} no cumplen tipo/tamaño (${MAX_FILE_MB} MB).`, 'exclamation-triangle');
  refreshFilesUI();
}

filesInput?.addEventListener('change', e=> addFiles(e.target.files||[]));

["dragenter","dragover"].forEach(ev=> dz.addEventListener(ev, e=>{
  e.preventDefault(); e.stopPropagation(); dz.classList.add('border-brand');
}));
["dragleave","drop"].forEach(ev=> dz.addEventListener(ev, e=>{
  e.preventDefault(); e.stopPropagation(); dz.classList.remove('border-brand');
}));
dz.addEventListener('drop', e=>{ addFiles(e.dataTransfer.files||[]); });
dz.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); filesInput?.click(); }});

document.addEventListener('paste', e=>{
  const items = e.clipboardData?.items||[];
  const imgs = [];
  for(const it of items){
    if(it.kind==='file'){ const f=it.getAsFile(); if(f) imgs.push(f); }
  }
  if(imgs.length){ addFiles(imgs); log(`Pegaste ${imgs.length} archivo(s) desde el portapapeles.`); }
});

/* Acciones fila */
filesTbody?.addEventListener('click', e=>{
  const btn = e.target.closest('button[data-act]');
  if(!btn) return;
  const idx = +btn.dataset.idx;
  const act = btn.dataset.act;
  if(Number.isNaN(idx) || !files[idx]) return;

  if(act==='remove'){
    files.splice(idx,1);
    refreshFilesUI();
  }else if(act==='preview'){
    // Hookea tu visor/endpoint si lo tenés (PDF viewer, etc.)
    log(`Previsualizar: ${files[idx].file.name}`);
  }
});

/* ===== Vistas de resultados (segmented) ===== */
const viewBtns = $$('[data-view]');
const views = {
  texto: $("#view-texto"),
  estructura: $("#view-estructura"),
  tablas: $("#view-tablas")
};
viewBtns.forEach(b=> b.addEventListener('click', ()=>{
  viewBtns.forEach(x=>{ x.classList.remove('active','is-active'); x.setAttribute('aria-selected','false'); });
  b.classList.add('active','is-active'); b.setAttribute('aria-selected','true');
  const v = b.dataset.view;
  Object.entries(views).forEach(([k,el])=> el.style.display = (k===v)?'block':'none');
}));

/* ===== Botones principales ===== */
clearBtn?.addEventListener('click', ()=>{
  files = [];
  $("#textoOut").innerHTML = '';
  $("#accEstructura").innerHTML = '';
  $("#tablaRequisitos tbody").innerHTML = '';
  filesInput.value='';
  refreshFilesUI();
  log('Se limpió la lista y los resultados.');
});

analyzeBtn?.addEventListener('click', async ()=>{
  if(!files.length) return;
  analyzeBtn.disabled = true;
  analyzeSpin.classList.remove('d-none');
  exportPdfBtn.disabled = true;
  log('Iniciando análisis…');

  // Envío al backend (ajustá la URL a tu endpoint real)
  const fd = new FormData();
  files.forEach(f => fd.append('files', f.file, f.file.name));
  fd.append('out_type', $("#outType").value);
  fd.append('lang', $("#lang").value);
  fd.append('ocr', $("#ocrMode").value);

  files = files.map(f => ({...f, status:'procesando'}));
  refreshFilesUI();

  try{
    const res = await fetch('/analizar', { method:'POST', body: fd }); // <-- ajustá ruta si es necesario
    if(!res.ok) throw new Error('Error en el análisis');
    const data = await res.json();

    // Esperamos:
    // data.texto_html, data.estructura (array de secciones), data.tabla (array de filas)
    $("#textoOut").innerHTML = data.texto_html || '<div class="text-muted">Sin contenido.</div>';

    // Estructura → acordeón
    const acc = $("#accEstructura");
    acc.innerHTML = (data.estructura||[]).map((sec,i)=>`
      <div class="accordion-item">
        <h2 class="accordion-header" id="h${i}">
          <button class="accordion-button ${i?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#c${i}" aria-controls="c${i}">
            ${sec.titulo ? sec.titulo : ('Sección '+(i+1))}
          </button>
        </h2>
        <div id="c${i}" class="accordion-collapse collapse ${i===0?'show':''}" data-bs-parent="#accEstructura">
          <div class="accordion-body small">${sec.html || ''}</div>
        </div>
      </div>
    `).join('');

    // Tablas → requisitos
    const tb = $("#tablaRequisitos tbody");
    tb.innerHTML = (data.tabla||[]).map((row,idx)=>`
      <tr>
        <td>${row.item ?? (idx+1)}</td>
        <td>${row.requisito ?? ''}</td>
        <td>${row.referencia ?? ''}</td>
        <td>${row.obs ?? ''}</td>
      </tr>
    `).join('');

    // Actualiza estados de archivo
    files = files.map(f => ({...f, status:'ok'}));
    refreshFilesUI();

    exportPdfBtn.disabled = false;
    log('Análisis finalizado correctamente.');
  }catch(err){
    files = files.map(f => ({...f, status:'error'}));
    refreshFilesUI();
    log('Error: ' + (err?.message || 'desconocido'));
    toast('Error', 'No se pudo completar el análisis.', 'exclamation-triangle');
  }finally{
    analyzeBtn.disabled = false;
    analyzeSpin.classList.add('d-none');
  }
});

exportPdfBtn?.addEventListener('click', async ()=>{
  exportPdfBtn.disabled = true;
  pdfSpin.classList.remove('d-none');
  log('Generando PDF…');
  try{
    // Enviá ids/resultado si tu backend lo requiere. Ejemplo básico:
    const payload = {
      html: $("#textoOut").innerHTML,
      estructura: $("#accEstructura").innerHTML,
      tabla_html: $("#view-tablas").innerHTML
    };
    const res = await fetch('/generar-pdf', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('No se pudo generar el PDF');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='analisis.pdf'; a.click();
    URL.revokeObjectURL(url);
    log('PDF generado.');
  }catch(err){
    log('Error al generar PDF: ' + (err?.message||'desconocido'));
    toast('Error', 'No se pudo generar el PDF.', 'exclamation-triangle');
  }finally{
    exportPdfBtn.disabled = false;
    pdfSpin.classList.add('d-none');
  }
});

/* ===== Chat simple (front) ===== */
const chatBox = $("#chatBox");
const chatInput = $("#chatInput");
$("#chatSend")?.addEventListener('click', sendChat);
chatInput?.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
});
function appendMsg(who, text){
  const wrap = document.createElement('div');
  wrap.className = 'mb-2';
  wrap.innerHTML = `<div class="small ${who==='ai'?'text-brand':'text-body'}"><b>${who==='ai'?'IA':'Yo'}:</b> ${escapeHtml(text)}</div>`;
  chatBox.appendChild(wrap); chatBox.scrollTop = chatBox.scrollHeight;
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
async function sendChat(){
  const txt = (chatInput.value||'').trim(); if(!txt) return;
  appendMsg('me', txt);
  chatInput.value='';
  try{
    // Endpoint de chat para esta vista (ajustá a tu backend real)
    const r = await fetch('/api/chat-analisis', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: txt })
    });
    const j = await r.json().catch(()=> ({}));
    const reply = j.reply || j.respuesta || j.text || 'Sin respuesta.';
    appendMsg('ai', reply);
  }catch(_){
    appendMsg('ai', 'Error al contactar el chat.');
  }
}
</script>
{% endblock %}
