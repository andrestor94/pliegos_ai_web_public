{% extends "base.html" %}
{% block title %}Notificaciones ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ====== Mapeo de variables a tu tema global ====== */
  :root{
    --bg-soft: #f6f7fe;
    --text: var(--ink);
    --text-1: var(--ink);
    --text-2: var(--muted);
    --brand: var(--accent-a);
  }
  [data-theme="dark"]{
    --bg-soft: #0f172a;
    --brand: #a78bfa;
  }

  /* ‚Äî‚Äî‚Äî Estilos espec√≠ficos de la vista ‚Äî‚Äî‚Äî */
  .card-clean{ border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); }
  .shadow-hover{ transition: box-shadow .15s ease; }
  .shadow-hover:hover{ box-shadow: 0 14px 34px rgba(16,24,40,.16); }

  .toolbar{ gap:.5rem; }
  .toolbar .form-control, .toolbar .form-select{ border-radius:10px; }

  .notif-item{
    display:grid; grid-template-columns: 28px 1fr auto; gap:10px;
    padding:12px; border-bottom:1px solid var(--border);
  }
  .notif-item:last-child{ border-bottom:none; }
  .notif-item.unread{ background:var(--bg-soft); }
  .notif-title{ font-weight:600; color:var(--text); }
  .notif-meta{ font-size:.82rem; color:var(--text-2); }
  .notif-body{ color:var(--text-1); }
  .badge-kind{
    background:#e3ecf5; color:var(--brand);
    border:1px solid #b6d1ea; border-radius:999px; padding:.15rem .5rem; font-size:.72rem;
  }
  [data-theme="dark"] .badge-kind{
    background:#0e223b; border-color:#1f3b61;
  }
  .actions .btn{ border-radius:8px!important; }

  .empty{ color:var(--text-2); padding:18px; text-align:center; }

  .skeleton{
    position:relative; overflow:hidden; border-bottom:1px solid var(--border);
    padding:12px;
  }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent, rgba(180,190,210,.22), transparent);
    animation: shimmer 1.1s infinite;
  }
  .sk-bar{ height:12px; background:rgba(148,163,184,.25); border-radius:6px; margin:6px 0; }
  @keyframes shimmer{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }

  @media (max-width:700px){
    .notif-item{ grid-template-columns: 24px 1fr; }
    .notif-item .actions{ grid-column: 1 / -1; display:flex; gap:.5rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="hero-title mb-0">üîî Notificaciones</h1>
    <a href="/" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
  </div>

  <!-- Filtros / acciones -->
  <div class="card card-clean shadow-hover mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center toolbar">
        <div class="col-sm-6">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="search" type="text" class="form-control" placeholder="Buscar por t√≠tulo o contenido‚Ä¶">
          </div>
        </div>
        <div class="col-sm-3">
          <select id="filterUnread" class="form-select">
            <option value="all">Todas</option>
            <option value="unread">Solo no le√≠das</option>
          </select>
        </div>
        <div class="col-sm-3 d-flex gap-2 justify-content-sm-end">
          <button id="btnMarkSelected" class="btn btn-outline-success btn-sm" disabled>
            <i class="bi bi-check2-all"></i> Marcar selecci√≥n
          </button>
          <button id="btnMarkAll" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-check2-square"></i> Marcar todas
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista -->
  <div class="card card-clean shadow-hover">
    <div class="card-body p-0">
      <div id="list" role="list"><!-- items --></div>
      <div class="p-2 border-top d-flex justify-content-between align-items-center">
        <div class="small text-muted" id="counter">0 mostradas</div>
        <button id="loadMore" class="btn btn-outline-secondary btn-sm">Cargar m√°s</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Helpers m√≠nimos (nos apoyamos en base.html para showToast y estilos)
  const escapeHtml = (s)=> (s??'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const $ = (sel)=> document.querySelector(sel);

  // Debounce simple
  function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

  // Estado de la vista
  const state = {
    q: '',
    onlyUnread: false,
    limit: 20,
    offset: 0,
    loading: false,
    done: false,
    selected: new Set(),
    totalShown: 0
  };

  // Prefill desde la URL
  (function hydrateFromURL(){
    const usp = new URLSearchParams(location.search);
    state.q = (usp.get('q')||'').trim();
    state.onlyUnread = usp.get('only_unread') === '1';
    if(state.q) $('#search').value = state.q;
    $('#filterUnread').value = state.onlyUnread ? 'unread' : 'all';
  })();

  function syncURL(){
    const usp = new URLSearchParams();
    if(state.q) usp.set('q', state.q);
    if(state.onlyUnread) usp.set('only_unread', '1');
    const qs = usp.toString();
    const newUrl = qs ? (`${location.pathname}?`+qs) : location.pathname;
    history.replaceState(null, '', newUrl);
  }

  function renderCounter(){
    $('#counter').textContent = `${state.totalShown} mostradas${state.onlyUnread ? ' (no le√≠das)' : ''}`;
  }
  function checkboxChanged(id, checked){
    if(checked) state.selected.add(id); else state.selected.delete(id);
    $('#btnMarkSelected').disabled = state.selected.size === 0;
  }

  function renderSkeleton(n=3){
    const list = $('#list');
    list.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(let i=0;i<n;i++){
      const sk = document.createElement('div');
      sk.className='skeleton';
      sk.innerHTML = `
        <div class="sk-bar" style="width:38%; height:14px"></div>
        <div class="sk-bar" style="width:82%"></div>
        <div class="sk-bar" style="width:56%"></div>
      `;
      frag.appendChild(sk);
    }
    list.appendChild(frag);
  }

  function renderList(items, append){
    const list = $('#list');
    if(!append) list.innerHTML = '';
    if(!items || !items.length){
      if(!append) list.innerHTML = '<div class="empty">No hay notificaciones con esos criterios.</div>';
      return;
    }
    const frag = document.createDocumentFragment();
    items.forEach(n=>{
      const id = n.id ?? n._id ?? String(Math.random());
      const div = document.createElement('div');
      div.className = 'notif-item' + (!n.leida ? ' unread' : '');
      div.setAttribute('role','listitem');
      div.innerHTML = `
        <div class="form-check mt-1">
          <input class="form-check-input" type="checkbox" id="chk_${id}">
        </div>
        <div>
          <div class="d-flex align-items-center gap-2">
            <div class="notif-title">${escapeHtml(n.titulo || 'Notificaci√≥n')}</div>
            ${n.tipo ? `<span class="badge-kind">${escapeHtml(n.tipo)}</span>` : ''}
          </div>
          <div class="notif-body">${escapeHtml(n.cuerpo || '')}</div>
          <div class="notif-meta">${escapeHtml(n.fecha_legible || '')} ${n.origen ? `‚Ä¢ ${escapeHtml(n.origen)}` : ''}</div>
        </div>
        <div class="actions d-flex align-items-start gap-1">
          ${!n.leida ? `<button class="btn btn-sm btn-outline-success" data-action="read">Marcar le√≠da</button>` : ''}
          <button class="btn btn-sm btn-outline-danger" data-action="delete" title="Eliminar"><i class="bi bi-trash"></i></button>
        </div>
      `;

      // Eventos: checkbox selecci√≥n
      const chk = div.querySelector(`#chk_${CSS.escape(id)}`);
      chk.addEventListener('change', (e)=> checkboxChanged(id, e.target.checked));

      // Eventos: acciones item
      div.querySelector('.actions').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.action === 'read'){
          await markIdsAsRead([id]);
          div.classList.remove('unread');
          btn.remove();
        }else if(btn.dataset.action === 'delete'){
          if(!confirm('¬øEliminar esta notificaci√≥n?')) return;
          try{
            // Si tu backend no soporta borrar, pod√©s ocultar este bot√≥n.
            const r = await fetch('/notificaciones/eliminar',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id })});
            if(!r.ok) throw new Error();
            div.remove();
            state.totalShown = Math.max(0, state.totalShown - 1);
            renderCounter();
            (window.showToast||console.log)({title:'Notificaci√≥n eliminada', icon:'trash'});
          }catch(_){
            (window.showToast||console.error)({title:'Error', body:'No se pudo eliminar.', icon:'exclamation-triangle'});
          }
        }
      });

      frag.appendChild(div);
    });
    list.appendChild(frag);
  }

  async function fetchList({append=false}={}){
    if(state.loading || state.done) return;
    state.loading = true;
    $('#loadMore').disabled = true; $('#loadMore').textContent = 'Cargando‚Ä¶';
    if(!append && state.offset === 0) renderSkeleton(4);
    try{
      const params = new URLSearchParams({
        limit: String(state.limit),
        offset: String(state.offset)
      });
      if(state.q) params.set('q', state.q);
      if(state.onlyUnread) params.set('only_unread','1');

      const r = await fetch(`/notificaciones?${params.toString()}`, { headers:{'Accept':'application/json'} });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      const items = data.items || data.lista || [];
      renderList(items, append);
      state.offset += items.length;
      state.totalShown += items.length;
      if(items.length < state.limit) state.done = true;
      $('#loadMore').style.display = state.done ? 'none' : 'inline-block';
      renderCounter();
    }catch(e){
      if(!append) $('#list').innerHTML = '<div class="empty">No se pudieron cargar las notificaciones.</div>';
    }finally{
      state.loading = false;
      $('#loadMore').disabled = false; $('#loadMore').textContent = 'Cargar m√°s';
    }
  }

  async function reloadList(resetOffset){
    if(resetOffset){
      state.offset = 0; state.done = false; state.totalShown = 0;
      state.selected.clear(); $('#btnMarkSelected').disabled = true;
    }
    await fetchList({append:false});
  }

  async function markIdsAsRead(ids){
    try{
      const r = await fetch('/notificaciones/marcar-leidas',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids })
      });
      if(!r.ok) throw new Error();
      (window.showToast||console.log)({title:'Listo', body:(ids.length>1? 'Notificaciones marcadas' : 'Notificaci√≥n marcada'), icon:'check2-circle'});
      state.selected.clear(); $('#btnMarkSelected').disabled = true;
      // Actualizar campanita global (base.html)
      if(typeof window.refreshNotif === 'function') await window.refreshNotif();
      else if(typeof window.fetchNotifs === 'function') await window.fetchNotifs();
    }catch(_){
      (window.showToast||console.error)({title:'Error', body:'No se pudieron marcar como le√≠das.', icon:'exclamation-triangle'});
    }
  }

  async function markAllAsRead(){
    try{
      await fetch('/notificaciones/marcar-leidas',{method:'POST'});
      (window.showToast||console.log)({title:'Notificaciones', body:'Marcadas como le√≠das', icon:'check2-circle'});
      if(typeof window.refreshNotif === 'function') await window.refreshNotif();
      else if(typeof window.fetchNotifs === 'function') await window.fetchNotifs();
      await reloadList(true);
    }catch(_){
      (window.showToast||console.error)({title:'Error', body:'No se pudieron marcar todas.', icon:'exclamation-triangle'});
    }
  }

  // Eventos UI
  document.addEventListener('DOMContentLoaded', ()=>{
    const onSearch = debounce(()=>{ state.q = $('#search').value.trim(); syncURL(); reloadList(true); }, 300);
    $('#search').addEventListener('input', onSearch);

    $('#filterUnread').addEventListener('change', ()=>{
      state.onlyUnread = $('#filterUnread').value === 'unread';
      syncURL();
      reloadList(true);
    });
    $('#loadMore').addEventListener('click', ()=> fetchList({append:true}));
    $('#btnMarkAll').addEventListener('click', async ()=>{ if(confirm('¬øMarcar todas las notificaciones actuales como le√≠das?')) await markAllAsRead(); });
    $('#btnMarkSelected').addEventListener('click', async ()=>{
      if(state.selected.size){
        await markIdsAsRead([...state.selected]);
        await reloadList(true);
      }
    });
  });

  // Init (base.html ya carga nav, chat IA, campanita, etc.)
  window.onload = async ()=>{
    await reloadList(true);
  };
</script>
{% endblock %}
