{% extends "base.html" %}
{% block title %}Notificaciones ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ====== Mapeo de variables a tu tema global ====== */
  :root{
    --bg-soft: #f6f7fe;
    --text: var(--ink);
    --text-1: var(--ink);
    --text-2: var(--muted);
    --brand: var(--accent-a);
  }
  [data-theme="dark"]{
    --bg-soft: #0f172a;
    --brand: #a78bfa;
  }

  /* ‚Äî‚Äî‚Äî Estilos espec√≠ficos de la vista ‚Äî‚Äî‚Äî */
  .card-clean{ border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); background: var(--surface); }
  .shadow-hover{ transition: box-shadow .15s ease; }
  .shadow-hover:hover{ box-shadow: 0 14px 34px rgba(16,24,40,.16); }

  .toolbar{ gap:.5rem; }
  .toolbar .form-control, .toolbar .form-select{ border-radius:10px; }

  .notif-toolbar-extra{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  .notif-toolbar-extra .form-check{ margin:0 .25rem 0 0; }

  .notif-item{
    display:grid; grid-template-columns: 28px 1fr auto; gap:10px;
    padding:12px; border-bottom:1px solid var(--border);
  }
  .notif-item:last-child{ border-bottom:none; }
  .notif-item.unread{ background:var(--bg-soft); }
  .notif-title{ font-weight:600; color:var(--text); }
  .notif-meta{ font-size:.82rem; color:var(--text-2); }
  .notif-body{ color:var(--text-1); }
  .badge-kind{
    background:#e3ecf5; color:var(--brand);
    border:1px solid #b6d1ea; border-radius:999px; padding:.15rem .5rem; font-size:.72rem;
  }
  [data-theme="dark"] .badge-kind{
    background:#0e223b; border-color:#1f3b61;
  }
  .actions .btn{ border-radius:8px!important; }

  .empty{ color:var(--text-2); padding:18px; text-align:center; }

  .skeleton{
    position:relative; overflow:hidden; border-bottom:1px solid var(--border);
    padding:12px;
  }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent, rgba(180,190,210,.22), transparent);
    animation: shimmer 1.1s infinite;
  }
  .sk-bar{ height:12px; background:rgba(148,163,184,.25); border-radius:6px; margin:6px 0; }
  @keyframes shimmer{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }

  .muted{ color:var(--text-2); }
  .soft-pill{ border-radius:999px; border:1px solid var(--border); background:var(--bg-soft); padding:.2rem .5rem; font-size:.8rem; }

  @media (max-width:700px){
    .notif-item{ grid-template-columns: 24px 1fr; }
    .notif-item .actions{ grid-column: 1 / -1; display:flex; gap:.5rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="hero-title mb-0">üîî Notificaciones</h1>
    <a href="/" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
  </div>

  <!-- Filtros / acciones -->
  <div class="card card-clean shadow-hover mb-3" role="region" aria-label="Barra de filtros">
    <div class="card-body">
      <div class="row g-2 align-items-center toolbar">
        <div class="col-lg-5">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="search" type="text" class="form-control" placeholder="Buscar por t√≠tulo o contenido‚Ä¶" aria-label="Buscar">
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <select id="filterUnread" class="form-select" aria-label="Filtro de lectura">
            <option value="all">Todas</option>
            <option value="unread">Solo no le√≠das</option>
          </select>
        </div>
        <div class="col-6 col-lg-2">
          <select id="pageSize" class="form-select" aria-label="Tama√±o de p√°gina">
            <option value="10">10 por p√°gina</option>
            <option value="20" selected>20 por p√°gina</option>
            <option value="50">50 por p√°gina</option>
          </select>
        </div>
        <div class="col-lg-3 d-flex gap-2 justify-content-lg-end">
          <button id="btnRefresh" class="btn btn-outline-secondary btn-sm" title="Actualizar">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
          </button>
          <button id="btnExport" class="btn btn-outline-secondary btn-sm" title="Exportar CSV">
            <i class="bi bi-download"></i> Exportar
          </button>
          <button id="btnMarkSelected" class="btn btn-outline-success btn-sm" disabled>
            <i class="bi bi-check2-all"></i> Marcar selecci√≥n
          </button>
          <button id="btnMarkAll" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-check2-square"></i> Marcar todas
          </button>
        </div>
      </div>

      <div class="notif-toolbar-extra mt-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="selAllPage">
          <label class="form-check-label" for="selAllPage">Seleccionar todo (lista mostrada)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
          <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
        </div>
        <span class="soft-pill" id="counter">0 mostradas</span>
      </div>
    </div>
  </div>

  <!-- Lista -->
  <div class="card card-clean shadow-hover" role="region" aria-label="Listado de notificaciones">
    <div class="card-body p-0">
      <div id="list" role="list" aria-live="polite"><!-- items --></div>
      <div class="p-2 border-top d-flex justify-content-between align-items-center">
        <div class="small muted" id="footHint">Desplazate para cargar m√°s</div>
        <div class="d-flex gap-2">
          <button id="loadMore" class="btn btn-outline-secondary btn-sm">Cargar m√°s</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sentinela para autoload -->
  <div id="sentinel" class="py-1" aria-hidden="true"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ===== Helpers m√≠nimos =====
  const escapeHtml = (s)=> (s??'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const $ = (sel)=> document.querySelector(sel);
  function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }
  const fmtRel = (()=>{ // relative time helper
    try{
      const rtf = new Intl.RelativeTimeFormat('es', { numeric:'auto' });
      return (iso)=>{
        if(!iso) return '';
        const d = new Date(iso); const diff = (d - new Date())/1000; // seconds
        const abs = Math.abs(diff);
        const units = [
          ['year',  31536000],
          ['month', 2592000],
          ['week',  604800],
          ['day',   86400],
          ['hour',  3600],
          ['minute',60],
          ['second',1]
        ];
        for(const [u, s] of units){
          if(abs >= s || u==='second'){
            return rtf.format(Math.round(diff/s), u);
          }
        }
        return '';
      };
    }catch(_){ return ()=>''; }
  })();

  const LS = {
    get(k, d){ try{ const v=localStorage.getItem(k); return v==null?d:JSON.parse(v);}catch(_){return d;} },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} }
  };

  // ===== Estado global =====
  const state = {
    q: '',
    onlyUnread: false,
    limit: 20,
    offset: 0,
    loading: false,
    done: false,
    selected: new Set(),
    pageIds: [],     // ids mostrados en el render actual (para "seleccionar todo")
    totalShown: 0,
    autoTimer: null,
    cache: []        // items cargados (para export)
  };

  // Prefill desde la URL
  (function hydrateFromURL(){
    const usp = new URLSearchParams(location.search);
    state.q = (usp.get('q')||'').trim();
    state.onlyUnread = usp.get('only_unread') === '1';
    if(state.q) $('#search').value = state.q;
    $('#filterUnread').value = state.onlyUnread ? 'unread' : 'all';
    const savedAuto = LS.get('notif.autoRefresh', true);
    $('#autoRefresh').checked = !!savedAuto;
  })();

  function syncURL(){
    const usp = new URLSearchParams();
    if(state.q) usp.set('q', state.q);
    if(state.onlyUnread) usp.set('only_unread', '1');
    const qs = usp.toString();
    const newUrl = qs ? (`${location.pathname}?`+qs) : location.pathname;
    history.replaceState(null, '', newUrl);
  }

  function renderCounter(){
    $('#counter').textContent = `${state.totalShown} mostradas${state.onlyUnread ? ' (no le√≠das)' : ''}`;
  }

  function checkboxChanged(id, checked){
    if(checked) state.selected.add(id); else state.selected.delete(id);
    $('#btnMarkSelected').disabled = state.selected.size === 0;
  }

  function renderSkeleton(n=4){
    const list = $('#list'); list.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(let i=0;i<n;i++){
      const sk = document.createElement('div');
      sk.className='skeleton';
      sk.innerHTML = `
        <div class="sk-bar" style="width:38%; height:14px"></div>
        <div class="sk-bar" style="width:82%"></div>
        <div class="sk-bar" style="width:56%"></div>
      `;
      frag.appendChild(sk);
    }
    list.appendChild(frag);
  }

  function renderList(items, append){
    const list = $('#list');
    // Re-render parcial: mantenemos lo existente si append, pero "seleccionar todo (lista mostrada)"
    // debe aplicar a la tanda que se ve tras este render ‚Üí pageIds = ids de este render, no acumulados.
    state.pageIds = [];
    if(!append){ list.innerHTML = ''; $('#selAllPage').checked = false; }
    if(!items || !items.length){
      if(!append && state.offset===0) list.innerHTML = '<div class="empty">No hay notificaciones con esos criterios.</div>';
      return;
    }
    const frag = document.createDocumentFragment();
    items.forEach(n=>{
      const id = String(n.id ?? n._id ?? crypto.randomUUID());
      state.pageIds.push(id);
      const div = document.createElement('div');
      div.className = 'notif-item' + (!n.leida ? ' unread' : '');
      div.setAttribute('role','listitem');
      div.dataset.id = id;
      div.innerHTML = `
        <div class="form-check mt-1">
          <input class="form-check-input" type="checkbox" id="chk_${id}">
        </div>
        <div>
          <div class="d-flex align-items-center gap-2">
            <div class="notif-title">${escapeHtml(n.titulo || 'Notificaci√≥n')}</div>
            ${n.tipo ? `<span class="badge-kind">${escapeHtml(n.tipo)}</span>` : ''}
          </div>
          <div class="notif-body">${escapeHtml(n.cuerpo || '')}</div>
          <div class="notif-meta">${escapeHtml(n.fecha_legible || '')} ${n.origen ? `‚Ä¢ ${escapeHtml(n.origen)}` : ''} ${n.fecha_iso ? `‚Ä¢ ${escapeHtml(fmtRel(n.fecha_iso))}` : ''}</div>
        </div>
        <div class="actions d-flex align-items-start gap-1">
          ${!n.leida ? `<button class="btn btn-sm btn-outline-success" data-action="read">Marcar le√≠da</button>` : ''}
          <button class="btn btn-sm btn-outline-danger" data-action="delete" title="Eliminar"><i class="bi bi-trash"></i></button>
        </div>
      `;

      // Selecci√≥n
      const chk = div.querySelector(`#chk_${CSS.escape(id)}`);
      chk.addEventListener('change', (e)=> checkboxChanged(id, e.target.checked));

      // Acciones por item
      div.querySelector('.actions').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.action === 'read'){
          // Optimista
          div.classList.remove('unread'); btn.disabled=true;
          try{
            await markIdsAsRead([id]);
            btn.remove();
          }catch(_){
            btn.disabled=false; div.classList.add('unread');
            (window.showToast||console.error)({title:'Error', body:'No se pudo marcar.', icon:'exclamation-triangle'});
          }
        }else if(btn.dataset.action === 'delete'){
          if(!confirm('¬øEliminar esta notificaci√≥n?')) return;
          try{
            const r = await fetch('/notificaciones/eliminar',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id })});
            if(!r.ok) throw new Error();
            div.remove();
            state.totalShown = Math.max(0, state.totalShown - 1);
            state.selected.delete(id);
            // limpiar de cache para export
            state.cache = state.cache.filter(x => String(x.id ?? x._id) !== id);
            renderCounter();
            (window.showToast||console.log)({title:'Notificaci√≥n eliminada', icon:'trash'});
          }catch(_){
            (window.showToast||console.error)({title:'Error', body:'No se pudo eliminar.', icon:'exclamation-triangle'});
          }
        }
      });

      frag.appendChild(div);
    });
    if(append) list.appendChild(frag); else list.innerHTML = '', list.appendChild(frag);
  }

  async function fetchList({append=false}={}){
    if(state.loading || state.done) return;
    state.loading = true;
    $('#loadMore').disabled = true; $('#loadMore').textContent = 'Cargando‚Ä¶';
    if(!append && state.offset === 0) renderSkeleton(4);
    try{
      const params = new URLSearchParams({
        limit: String(state.limit),
        offset: String(state.offset)
      });
      if(state.q) params.set('q', state.q);
      if(state.onlyUnread) params.set('only_unread','1');

      const r = await fetch(`/notificaciones?${params.toString()}`, { headers:{'Accept':'application/json'} });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      const items = data.items || data.lista || [];
      // Cache para export
      state.cache = append ? state.cache.concat(items) : items.slice();
      renderList(items, append);
      state.offset += items.length;
      state.totalShown += items.length;
      if(items.length < state.limit) state.done = true;
      $('#loadMore').style.display = state.done ? 'none' : 'inline-block';
      $('#footHint').textContent = state.done ? 'No hay m√°s resultados' : 'Desplazate para cargar m√°s';
      renderCounter();
    }catch(e){
      if(!append) $('#list').innerHTML = '<div class="empty">No se pudieron cargar las notificaciones.</div>';
    }finally{
      state.loading = false;
      $('#loadMore').disabled = false; $('#loadMore').textContent = 'Cargar m√°s';
    }
  }

  async function reloadList(resetOffset){
    if(resetOffset){
      state.offset = 0; state.done = false; state.totalShown = 0;
      state.selected.clear(); $('#btnMarkSelected').disabled = true;
      state.cache = [];
    }
    await fetchList({append:false});
  }

  async function markIdsAsRead(ids){
    if(!ids || !ids.length) return;
    try{
      const r = await fetch('/notificaciones/marcar-leidas',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids })
      });
      if(!r.ok) throw new Error();
      (window.showToast||console.log)({title:'Listo', body:(ids.length>1? 'Notificaciones marcadas' : 'Notificaci√≥n marcada'), icon:'check2-circle'});
      state.selected.clear(); $('#btnMarkSelected').disabled = true;
      // Actualizar campanita global (base.html)
      if(typeof window.refreshNotif === 'function') await window.refreshNotif();
      else if(typeof window.fetchNotifs === 'function') await window.fetchNotifs();
    }catch(_){
      (window.showToast||console.error)({title:'Error', body:'No se pudieron marcar como le√≠das.', icon:'exclamation-triangle'});
      throw _;
    }
  }

  async function markAllAsRead(){
    try{
      await fetch('/notificaciones/marcar-leidas',{method:'POST'});
      (window.showToast||console.log)({title:'Notificaciones', body:'Marcadas como le√≠das', icon:'check2-circle'});
      if(typeof window.refreshNotif === 'function') await window.refreshNotif();
      else if(typeof window.fetchNotifs === 'function') await window.fetchNotifs();
      await reloadList(true);
    }catch(_){
      (window.showToast||console.error)({title:'Error', body:'No se pudieron marcar todas.', icon:'exclamation-triangle'});
    }
  }

  function exportCSV(){
    const rows = state.cache || [];
    if(!rows.length){
      (window.showToast||console.log)({title:'Exportar', body:'No hay resultados cargados para exportar.', icon:'exclamation-triangle'});
      return;
    }
    const headers = ['id','titulo','cuerpo','tipo','origen','fecha_iso','fecha_legible','leida'];
    const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
    const lines = [headers.map(esc).join(',')];
    rows.forEach(n=>{
      lines.push([
        n.id ?? n._id ?? '',
        n.titulo ?? '',
        n.cuerpo ?? '',
        n.tipo ?? '',
        n.origen ?? '',
        n.fecha_iso ?? '',
        n.fecha_legible ?? '',
        (n.leida ? '1':'0')
      ].map(esc).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `notificaciones_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 500);
  }

  // ===== Seleccionar todo (lista mostrada) =====
  $('#selAllPage').addEventListener('change', (e)=>{
    const check = e.target.checked;
    state.pageIds.forEach(id=>{
      const box = document.getElementById(`chk_${CSS.escape(id)}`);
      if(box){ box.checked = check; checkboxChanged(id, check); }
    });
  });

  // ===== Eventos UI =====
  document.addEventListener('DOMContentLoaded', ()=>{
    const onSearch = debounce(()=>{ state.q = $('#search').value.trim(); syncURL(); state.offset=0; state.done=false; state.totalShown=0; reloadList(true); }, 300);
    $('#search').addEventListener('input', onSearch);

    $('#filterUnread').addEventListener('change', ()=>{
      state.onlyUnread = $('#filterUnread').value === 'unread';
      syncURL();
      state.offset=0; state.done=false; state.totalShown=0;
      reloadList(true);
    });

    $('#pageSize').addEventListener('change', ()=>{
      const v = parseInt($('#pageSize').value,10)||20;
      state.limit = v;
      state.offset=0; state.done=false; state.totalShown=0;
      reloadList(true);
    });

    $('#loadMore').addEventListener('click', ()=> fetchList({append:true}));
    $('#btnMarkAll').addEventListener('click', async ()=>{ if(confirm('¬øMarcar todas las notificaciones actuales como le√≠das?')) await markAllAsRead(); });
    $('#btnMarkSelected').addEventListener('click', async ()=>{
      if(state.selected.size){
        await markIdsAsRead([...state.selected]);
        await reloadList(true);
      }
    });
    $('#btnRefresh').addEventListener('click', ()=> reloadList(true));
    $('#btnExport').addEventListener('click', exportCSV);

    // Auto-refresh (persistido)
    $('#autoRefresh').addEventListener('change', ()=>{
      LS.set('notif.autoRefresh', $('#autoRefresh').checked);
      if($('#autoRefresh').checked) startAuto(); else stopAuto();
    });
  });

  // ===== Auto-load al hacer scroll (IntersectionObserver) =====
  const io = new IntersectionObserver((entries)=>{
    for(const ent of entries){
      if(ent.isIntersecting && !state.loading && !state.done){
        fetchList({append:true});
      }
    }
  }, {rootMargin: '256px 0px'});
  io.observe(document.getElementById('sentinel'));

  // ===== Auto-refresh (20s) =====
  function startAuto(){
    stopAuto();
    state.autoTimer = setInterval(()=>{
      // Mantiene filtros, resetea paginaci√≥n para traer novedades arriba
      state.offset = 0; state.done = false; state.totalShown = 0; state.cache = [];
      reloadList(true);
    }, 20000);
  }
  function stopAuto(){ if(state.autoTimer){ clearInterval(state.autoTimer); state.autoTimer=null; } }

  // ===== Init =====
  (async ()=>{
    state.limit = parseInt($('#pageSize').value,10)||20;
    await reloadList(true);
    if($('#autoRefresh').checked) startAuto();
  })();
</script>
{% endblock %}
