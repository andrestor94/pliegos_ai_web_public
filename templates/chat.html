{% extends "base.html" %}
{% block title %}Chat interno – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  :root{
    --text: var(--ink, #0f1222);
    --text-2: var(--muted, #667085);
    --card: var(--panel, #ffffff);
    --bg: #f6f7fe;
    --bg-soft: #eef2ff;
    --bg-strong: #e4e9ff;
    --brand: #2563eb;
    --brand-soft: #e8f0ff;
    --border-strong: #d9def0;
    --border: var(--border-strong, #e5e9f2);
    --shadow: 0 8px 24px rgba(2,6,23,.06);
  }

  .chat-app{ display:grid; grid-template-columns: 320px 1fr; gap:16px; }
  @media (max-width: 900px){ .chat-app{ grid-template-columns: 1fr; } }

  .chat-panel{ background: var(--card); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; border:1px solid var(--border); }
  .chat-panel .chat-title{ margin:0; padding:14px 16px; color: var(--brand); border-bottom: 1px solid var(--border); font-weight:600; }

  .chat-hilos{ display:flex; flex-direction:column; }
  .chat-hilos .top { padding:12px; border-bottom:1px solid var(--border); }
  .chat-auto-wrap{ position:relative; }
  .chat-auto-list{ position:absolute; z-index:1000; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:12px; margin-top:.25rem; list-style:none; padding:.25rem 0; display:none; max-height:280px; overflow:auto; box-shadow:var(--shadow); }
  .chat-auto-li{ padding:.5rem .75rem; cursor:pointer; }
  .chat-auto-li .nm{ font-weight:600; }
  .chat-auto-li .em{ font-size:.85rem; color:var(--text-2); }
  .chat-auto-li.active, .chat-auto-li:hover{ background:var(--bg-soft); }

  .chat-hilos-list { overflow:auto; }
  .chat-hilo-item { position:relative; padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; gap:8px; align-items:center; }
  .chat-hilo-item:hover{ background:var(--bg-soft); }
  .chat-hilo-item.active{ background:var(--bg-strong); }
  .chat-hilo-item .info { flex:1; min-width:0; }
  .chat-hilo-item .nombre{ font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chat-hilo-item .fecha{ font-size:12px; color:var(--text-2); }
  .chat-hilo-item .btn-del{ border:none; background:transparent; font-size:18px; line-height:1; opacity:.7; }
  .chat-hilo-item .btn-del:hover{ opacity:1; }

  .hilo-badge{ position:relative; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; line-height:20px; text-align:center; margin-left:6px; user-select:none; display:inline-block; }
  .hilo-badge.hidden{ display:none; }

  .chat-window{ display:flex; flex-direction:column; }
  .chat-head { padding:8px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
  .chat-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-soft); border-radius:999px; font-size:14px;}
  .chat-body { flex:1; overflow:auto; padding:16px; background:var(--bg); }
  .chat-msg { max-width: 70%; margin-bottom:12px; padding:10px 12px; border-radius:14px; background:#fff; box-shadow: 0 2px 8px rgba(0,0,0,.04);}
  .chat-msg.me { margin-left:auto; background:var(--brand-soft); }
  .chat-msg .meta{ font-size:12px; color:var(--text-2); margin-bottom:4px;}
  .chat-empty { color:var(--text-2); padding:16px; }

  .chat-input { border-top:1px solid var(--border); padding:10px; background:#fff; display:flex; gap:8px; align-items:flex-start; }
  .chat-btn-icon{ display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:10px; }

  .chat-chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; padding:0 12px 8px; }
  .chat-chip-file{ display:inline-flex; align-items:center; gap:8px; padding:5px 8px; background:var(--bg-soft); border-radius:999px; font-size:12px; }
  .chat-chip-file button{ border:none; background:transparent; line-height:1; font-size:14px; }
  .chat-chip-thumb{ width:26px; height:26px; border-radius:6px; object-fit:cover; background:#fff; border:1px solid var(--border); }

  /* Tips / estados */
  .tip { font-size:12px; color:var(--text-2); }
  .status-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; background:#22c55e; }
  .status-off{ background:#94a3b8; }

  /* Toasts */
  .toast-area{ position:fixed; right:16px; bottom:16px; z-index: 3000; display:flex; flex-direction:column; gap:10px; }
  .toast{ background:#111827; color:#fff; padding:10px 12px; border-radius:12px; box-shadow: var(--shadow); min-width: 220px; max-width: 340px; }
  .toast .t{ font-weight:600; margin-bottom:4px; }
  .toast .x{ float:right; border:none; background:transparent; color:#fff; opacity:.7; }
  .toast .x:hover{ opacity:1; }

  /* Toggle sonido */
  .sound-wrap{ display:flex; align-items:center; gap:8px; }
  .sound-toggle{ display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; }
  .sound-toggle input{ accent-color: var(--brand); cursor:pointer; }
  .sound-vol{ width:120px; height:6px; }
  @media (max-width: 480px){ .sound-vol{ width:80px; } }

  /* Drag & drop sobre la ventana de chat */
  .drop-hint{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(37,99,235,.08); border:2px dashed #93c5fd; border-radius:12px; font-weight:600; color:#1e3a8a; }
  .drop-hint.show{ display:flex; }
</style>
{% endblock %}

{% block content %}
<div class="grid">
  <section class="col-12">
    <div class="chat-app">

      <!-- Sidebar: Hilos -->
      <aside class="chat-panel chat-hilos">
        <h5 class="chat-title">Conversaciones</h5>
        <div class="top">
          <div class="chat-auto-wrap">
            <div class="input-group">
              <span class="input-group-text">@</span>
              <input id="nuevoPara" type="text" class="form-control" placeholder="Nombre o email..." autocomplete="off" />
              <button id="btnAbrir" class="btn btn-primary">Abrir</button>
            </div>
            <ul id="sugs" class="chat-auto-list" role="listbox" aria-label="Sugerencias"></ul>
            <div class="tip mt-2">Atajo: <kbd>Ctrl</kbd>+<kbd>K</kbd> para buscar usuario</div>
          </div>
        </div>
        <div id="listaHilos" class="chat-hilos-list"></div>
      </aside>

      <!-- Ventana principal -->
      <section class="chat-panel chat-window" id="chatWindow">
        <div class="chat-head">
          <span class="status-dot status-off" id="wsDot" title="Estado en vivo"></span>
          <div class="chat-chip">Conversando con: <strong id="conEmail">—</strong></div>
          <button id="btnEliminarChat" class="btn btn-sm btn-outline-danger ms-2" title="Eliminar chat (ocultar)">🗑</button>
          <button id="btnRefrescar" class="btn btn-sm btn-outline-secondary ms-auto">Refrescar</button>

          <span id="noLeidosWrap" class="chat-chip ms-2" title="Mensajes no leídos">
            🔔 <span id="noLeidosBadge" class="badge bg-secondary rounded-pill">0</span>
          </span>

          <!-- Toggle sonido -->
          <span class="chat-chip sound-wrap">
            <label class="sound-toggle" title="Silenciar/Activar sonido">
              <input type="checkbox" id="muteToggle">
              <span id="muteLabel">🔊 Sonido</span>
            </label>
            <input id="volRange" class="sound-vol" type="range" min="0" max="100" step="1" title="Volumen">
          </span>

          <span class="chat-chip d-none d-md-inline" title="Tu usuario"><span id="yoEmail">...</span></span>
        </div>

        <div id="chatBody" class="chat-body" aria-live="polite">
          <div class="chat-empty">Seleccioná una conversación o creá una nueva desde la izquierda.</div>
        </div>
        <div class="drop-hint" id="dropHint">Soltá archivos para adjuntar…</div>

        <div class="chat-input">
          <textarea id="inputMsg" rows="1" class="form-control" placeholder="Escribí un mensaje… (Enter envía, Shift+Enter salto de línea)"></textarea>
          <button id="btnPick" class="btn btn-outline-secondary chat-btn-icon" title="Elegir archivos">📎</button>
          <input id="inputFiles" type="file" multiple hidden />
          <button id="btnEnviar" class="btn btn-primary">Enviar</button>
        </div>
        <div id="chips" class="chat-chips"></div>

        <div class="tip px-3 pb-3">Podés pegar imágenes desde el portapapeles. Tamaño máximo total por mensaje configurable en backend.</div>
      </section>

    </div>
  </section>
</div>

<!-- Área de toasts y audios de notificación -->
<div class="toast-area" id="toastArea" aria-live="polite" aria-atomic="true"></div>
<audio id="notif-msg"   src="/static/sounds/notification-message.mp3" preload="auto"></audio>
<audio id="notif-alert" src="/static/sounds/notification-alert.mp3"   preload="auto"></audio>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Helpers ===== */
  function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  // Urlify seguro: primero escapamos, luego enlazamos patrones http(s)
  function urlifySafe(plain){
    const esc = escapeHtml(plain);
    const rx = /\bhttps?:\/\/[^\s<>'"]+/g;
    return esc.replace(rx, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
  }
  async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
  async function postJSON(url,data){
    const r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    let payload=null; try{ payload=await r.json(); }catch(_){}
    if(!r.ok) throw new Error(payload?.error || ('HTTP '+r.status));
    return payload;
  }

  /* ===== Notificación sonora / toasts ===== */
  const MUTE_KEY = 'chat.muted';
  const VOL_KEY  = 'chat.volume';
  const $mute = document.getElementById('muteToggle');
  const $muteLabel = document.getElementById('muteLabel');
  const $vol = document.getElementById('volRange');

  function getMuted(){ return localStorage.getItem(MUTE_KEY) === '1'; }
  function setMuted(v){ localStorage.setItem(MUTE_KEY, v ? '1' : '0'); updateMuteUI(); }
  function getVolume(){ const v = parseInt(localStorage.getItem(VOL_KEY)||'85',10); return isNaN(v) ? 85 : Math.min(100, Math.max(0, v)); }
  function setVolume(v){ localStorage.setItem(VOL_KEY, String(v)); applyVolume(); }

  function updateMuteUI(){
    const muted = getMuted();
    $mute.checked = muted;
    $muteLabel.textContent = muted ? '🔇 Silenciado' : '🔊 Sonido';
  }
  function applyVolume(){
    const vol = getVolume()/100;
    const audios = [document.getElementById('notif-msg'), document.getElementById('notif-alert')];
    audios.forEach(a => { if(a){ a.volume = vol; } });
    $vol.value = String(getVolume());
  }

  let soundUnlocked = false;
  function unlockSoundOnce(){
    if(soundUnlocked) return;
    const a1 = document.getElementById('notif-msg');
    const a2 = document.getElementById('notif-alert');
    [a1,a2].forEach(a=>{
      if(!a) return;
      a.muted = false;
      a.play().then(()=>{ a.pause(); soundUnlocked = true; }).catch(()=>{});
    });
  }
  window.addEventListener('pointerdown', unlockSoundOnce, { once: true });

  function playNotif(kind){ // kind: 'msg' | 'alert'
    if(getMuted()) return;
    const id = kind === 'alert' ? 'notif-alert' : 'notif-msg';
    const a = document.getElementById(id);
    if(!a) return;
    a.currentTime = 0;
    a.play().catch(()=>{});
  }

  function toast(title, body){
    const area = document.getElementById('toastArea');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<button class="x" aria-label="Cerrar">&times;</button>
                    <div class="t">${escapeHtml(title||'Notificación')}</div>
                    <div class="b">${escapeHtml(body||'')}</div>`;
    el.querySelector('.x').onclick = ()=> el.remove();
    area.appendChild(el);
    setTimeout(()=> el.remove(), 5000);
  }

  $mute.addEventListener('change', () => setMuted($mute.checked));
  $vol.addEventListener('input',  () => setVolume(parseInt($vol.value,10)||0));
  updateMuteUI(); applyVolume();

  /* ===== Config adjuntos ===== */
  let CONFIG = { allowed_ext: ['pdf','png','jpg','jpeg','gif','webp','txt','csv','xlsx','xls','docx','doc','pptx'], max_files: 10, max_total_mb: 50 };
  (async function(){
    try{ const r = await fetch('/chat/config'); if(r.ok){ const cfg=await r.json(); if(cfg?.allowed_ext) CONFIG=cfg; } }catch(e){}
  })();
  function extPermitida(name){ const ext=(name.split('.').pop()||'').toLowerCase(); return CONFIG.allowed_ext.includes(ext); }
  function isImage(name){ return /\.(png|jpg|jpeg|gif|webp)$/i.test(name); }

  /* ===== Estado ===== */
  let yo = null, con = null, refresco = null, refrescoNoLeidos = null, refrescoHilos = null;
  let selectedFiles = [];
  const DRAFT_KEY = (email)=> `chat.draft.${email||'__none__'}`;

  /* ===== Sidebar: hilos ===== */
  function setActiveHilo(email){
    document.querySelectorAll('.chat-hilo-item').forEach(el=> el.classList.toggle('active', el.dataset.email === email));
  }
  function renderHilos(hilos){
    const cont = document.getElementById('listaHilos');
    cont.innerHTML = '';
    if(!hilos?.length){ cont.innerHTML = '<div class="p-3 text-muted">Sin conversaciones aún.</div>'; return; }
    hilos.forEach(h=>{
      const div = document.createElement('div');
      div.className = 'chat-hilo-item';
      div.dataset.email = h.con;
      const unread = Number(h?.no_leidos || 0);
      div.innerHTML = `
        <div class="info">
          <div class="nombre">
            ${escapeHtml(h.con)}
            <span class="hilo-badge ${unread>0?'':'hidden'}" aria-label="${unread} mensajes no leídos">${unread>99?'99+':unread}</span>
          </div>
          <div class="fecha">${h.ultima_fecha || ''}</div>
        </div>
        <button class="btn-del" title="Eliminar chat (ocultar)" aria-label="Eliminar">🗑</button>
      `;
      div.querySelector('.info').onclick = () => abrirChat(h.con);
      div.querySelector('.btn-del').onclick = async (ev) => { ev.stopPropagation(); await ocultar(h.con); };
      cont.appendChild(div);
    });
    setActiveHilo(con);
  }

  const $input = document.getElementById('nuevoPara');
  const $sugs  = document.getElementById('sugs');
  let sugItems = [], sugIdx = -1, debounceId = null;
  const debounce = (fn,ms)=>{ clearTimeout(debounceId); debounceId=setTimeout(fn,ms); };

  async function buscar(term){
    term=(term||'').trim();
    if(!term){ sugItems=[]; renderSugs(); return; }
    try{ const data = await getJSON(`/api/usuarios?term=${encodeURIComponent(term)}`); sugItems = data.items || []; sugIdx = sugItems.length ? 0 : -1; renderSugs(); }
    catch{ sugItems=[]; renderSugs(); }
  }
  function renderSugs(){
    $sugs.innerHTML = '';
    if(!sugItems.length){ $sugs.style.display='none'; return; }
    sugItems.forEach((it,i)=>{
      const li=document.createElement('li');
      li.className = 'chat-auto-li' + (i===sugIdx?' active':'' );
      li.role='option';
      li.innerHTML = `<div class="nm">${escapeHtml(it.nombre || '(Sin nombre)')}</div><div class="em">${escapeHtml(it.email)}</div>`;
      li.onclick = ()=> seleccionarSugerencia(i);
      $sugs.appendChild(li);
    });
    $sugs.style.display='block';
  }
  function seleccionarSugerencia(i){
    if(i<0 || i>=sugItems.length) return;
    const email=sugItems[i].email; $input.value=email; $sugs.style.display='none'; abrirChat(email);
  }
  $input.addEventListener('input', e=> debounce(()=> buscar(e.target.value),160));
  $input.addEventListener('keydown', (e)=>{
    if($sugs.style.display==='none') return;
    if(e.key==='ArrowDown'){ e.preventDefault(); sugIdx=Math.min(sugIdx+1, sugItems.length-1); renderSugs(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); sugIdx=Math.max(sugIdx-1, 0); renderSugs(); }
    else if(e.key==='Enter'){ if(sugIdx>=0){ e.preventDefault(); seleccionarSugerencia(sugIdx); } }
    else if(e.key==='Escape'){ $sugs.style.display='none'; }
  });
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.chat-auto-wrap')) $sugs.style.display='none'; });

  /* ===== Mensajes ===== */
  function renderMensajes(mensajes){
    const body = document.getElementById('chatBody');
    const atBottom = (body.scrollTop + body.clientHeight + 40) >= body.scrollHeight;
    body.innerHTML = '';
    if(!mensajes?.length){ body.innerHTML = '<div class="chat-empty">No hay mensajes aún. ¡Escribí el primero!</div>'; return; }
    mensajes.forEach(m=>{
      const div = document.createElement('div');
      div.className = 'chat-msg' + (m.de === yo ? ' me' : '');
      const meta = `<div class="meta">${escapeHtml(m.de)} • ${m.fecha}</div>`;
      const txt  = m.texto ? `<div class="txt">${urlifySafe(m.texto)}</div>` : '';
      let adj = '';
      if (m.adjuntos?.length){
        adj = '<div class="mt-2">';
        m.adjuntos.forEach(a=>{
          const url = `/chat/adjunto/${encodeURIComponent(a.filename)}`;
          const isImg = /\.(png|jpg|jpeg|gif|webp)$/i.test(a.filename);
          if(isImg){
            adj += `<div class="mb-2"><a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="${escapeHtml(a.original)}" style="max-width:220px; border-radius:10px; display:block;"></a><small class="text-muted">${escapeHtml(a.original)}${a.size ? ' • ' + Math.round(a.size/1024) + ' KB' : ''}</small></div>`;
          }else{
            adj += `<div class="mb-1">📎 <a href="${url}" target="_blank" rel="noopener">${escapeHtml(a.original)}</a>${a.size ? `<small class="text-muted"> • ${Math.round(a.size/1024)} KB</small>` : ''}</div>`;
          }
        });
        adj += '</div>';
      }
      div.innerHTML = meta + txt + adj;
      body.appendChild(div);
    });
    if(atBottom) body.scrollTop = body.scrollHeight;
  }

  async function cargarYo(){ const info = await getJSON('/usuario-actual'); yo = info.usuario || 'Desconocido'; document.getElementById('yoEmail').textContent = yo; }
  async function cargarHilos(){ try{ const data = await getJSON('/chat/hilos'); renderHilos(data.hilos || []); } catch(e){ console.error(e); alert('No se pudieron cargar los hilos.'); } }
  async function cargarMensajes(){
    if(!con) return;
    try{
      const data = await getJSON(`/chat/mensajes?con=${encodeURIComponent(con)}&limit=100`);
      renderMensajes(data.mensajes || []);
      await marcarLeidos(con);
      await cargarNoLeidos();
      await cargarHilos();
    }catch(e){ console.error(e); alert('No se pudieron cargar los mensajes.'); }
  }

  async function abrirChat(email){
    try{
      await postJSON('/chat/abrir', { con: email });
      con = email; document.getElementById('conEmail').textContent = con;
      setActiveHilo(con);
      // restaurar borrador si existe
      const draft = localStorage.getItem(DRAFT_KEY(con));
      if(draft){ document.getElementById('inputMsg').value = draft; autoResize(); }
      await marcarLeidos(con);
      await cargarMensajes();
      await cargarHilos();
      iniciarAutoRefresh();
    }catch(e){ console.error(e); alert('No se pudo abrir el chat.'); }
  }
  async function ocultar(email){
    if(!email) return;
    if(!confirm('¿Eliminar chat? Esto solo lo ocultará de tu lista, no borra mensajes.')) return;
    try{
      await postJSON('/chat/ocultar', { con: email });
      if(con === email){
        con=null; document.getElementById('conEmail').textContent='—';
        document.getElementById('chatBody').innerHTML='<div class="chat-empty">Seleccioná una conversación o creá una nueva desde la izquierda.</div>';
        localStorage.removeItem(DRAFT_KEY(email));
        if(refresco) clearInterval(refresco);
      }
      await cargarHilos(); await cargarNoLeidos();
    }catch(e){ console.error(e); alert('No se pudo eliminar el chat.'); }
  }
  async function marcarLeidos(remitente){ if(!remitente) return; try{ await postJSON('/chat/marcar-leidos', { de: remitente }); }catch(e){} }

  /* ===== Envío ===== */
  const $files = document.getElementById('inputFiles');
  const $chips = document.getElementById('chips');
  const $btnPick = document.getElementById('btnPick');

  $btnPick.onclick = () => $files.click();
  $files.addEventListener('change', ()=>{ addFiles([...( $files.files || [] )]); $files.value=''; });

  // Drag & drop sobre el panel
  const $window = document.getElementById('chatWindow');
  const $dropHint = document.getElementById('dropHint');
  ;['dragenter','dragover'].forEach(ev => $window.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $dropHint.classList.add('show'); }));
  ;['dragleave','drop'].forEach(ev => $window.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $dropHint.classList.remove('show'); }));
  $window.addEventListener('drop', (e)=>{ const fl = [...(e.dataTransfer?.files||[])]; if(fl.length) addFiles(fl); });

  // Pegar imágenes/archivos
  document.addEventListener('paste', (e)=>{
    const items = e.clipboardData?.items||[];
    const files = [];
    for(const it of items){
      if(it.kind==='file'){ const f=it.getAsFile(); if(f) files.push(f); }
    }
    if(files.length) addFiles(files);
  });

  function addFiles(files){
    for(const f of files){
      if(!extPermitida(f.name)){ alert(`Tipo no permitido: ${f.name}`); continue; }
      if(selectedFiles.length >= CONFIG.max_files){ alert(`Máximo ${CONFIG.max_files} archivos por mensaje.`); break; }
      selectedFiles.push(f);
    }
    limitTotal(); renderChips();
  }
  function limitTotal(){
    const maxBytes = CONFIG.max_total_mb*1024*1024;
    while(selectedFiles.reduce((a,b)=>a+b.size,0) > maxBytes){ selectedFiles.pop(); }
  }
  function renderChips(){
    $chips.innerHTML=''; if(!selectedFiles.length) return;
    selectedFiles.forEach((f, idx)=>{
      const chip=document.createElement('span'); chip.className='chat-chip-file';
      if(isImage(f.name)){
        const img=document.createElement('img'); img.className='chat-chip-thumb'; img.alt=f.name;
        const fr=new FileReader(); fr.onload=e=> img.src=e.target.result; fr.readAsDataURL(f); chip.appendChild(img);
      }
      const label=document.createElement('span'); label.innerHTML=`${escapeHtml(f.name)} <small class="muted">${Math.round(f.size/1024)} KB</small>`;
      const btn=document.createElement('button'); btn.title='Quitar'; btn.setAttribute('aria-label','Quitar'); btn.innerHTML='&times;';
      btn.onclick=()=>{ selectedFiles.splice(idx,1); renderChips(); };
      chip.appendChild(label); chip.appendChild(btn); $chips.appendChild(chip);
    });
  }

  async function enviar(){
    const input=document.getElementById('inputMsg');
    const texto=(input.value||'').trim();
    if(!con){ alert('Elegí un contacto o buscá uno con @.'); return; }
    if(selectedFiles.length){ await enviarArchivos(texto); return; }
    if(!texto) return;
    try{
      await postJSON('/chat/enviar', { para: con, texto });
      input.value=''; localStorage.removeItem(DRAFT_KEY(con)); autoResize();
      await cargarMensajes(); await cargarHilos();
    }catch(e){ console.error(e); alert('No se pudo enviar el mensaje.'); }
  }
  async function enviarArchivos(texto){
    if(!con){ alert('Elegí un contacto antes de enviar.'); return; }
    const fd=new FormData();
    fd.append('para', con);
    fd.append('texto', texto || '');
    selectedFiles.forEach(f => fd.append('archivos', f));
    toggleSending(true);
    try{
      const resp=await fetch('/chat/enviar-archivos', { method:'POST', body: fd });
      if(!resp.ok){
        let msg=''; try{ msg=(await resp.json()).error||''; }catch(_){}
        if(!msg){ try{ msg=await resp.text(); }catch(_){} }
        throw new Error(msg || 'No se pudo enviar los adjuntos.');
      }
      selectedFiles=[]; renderChips(); document.getElementById('inputMsg').value=''; localStorage.removeItem(DRAFT_KEY(con)); autoResize();
      await cargarMensajes(); await cargarHilos();
    }catch(e){ console.error(e); alert(e.message || 'No se pudo enviar los adjuntos.'); }
    finally{ toggleSending(false); }
  }
  function toggleSending(sending){ const btn=document.getElementById('btnEnviar'); btn.disabled=sending; btn.textContent = sending ? 'Enviando…' : 'Enviar'; }

  document.getElementById('btnEnviar').onclick = enviar;
  // Enter envía, Shift+Enter hace salto de línea, Ctrl/Cmd+Enter también envía
  const $msg = document.getElementById('inputMsg');
  function autoResize(){ $msg.style.height='auto'; $msg.style.height = Math.min(160, $msg.scrollHeight) + 'px'; }
  $msg.addEventListener('input', ()=>{ autoResize(); if(con) localStorage.setItem(DRAFT_KEY(con), $msg.value); });
  $msg.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); enviar(); return; }
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); enviar(); }
  });

  document.getElementById('btnRefrescar').onclick = ()=> { cargarMensajes(); cargarHilos(); };
  document.getElementById('btnAbrir').onclick = ()=>{ const email = $input.value.trim(); if(!email) return; abrirChat(email); };
  document.getElementById('btnEliminarChat').onclick = ()=> ocultar(con);

  // Atajo global: Ctrl+K para foco en buscador
  window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $input.focus(); } });

  /* ===== No leídos & auto refresh ===== */
  async function cargarNoLeidos(){
    try{
      const data = await getJSON('/chat/no-leidos');
      const n = (data && typeof data.no_leidos === 'number') ? data.no_leidos : 0;
      const badge = document.getElementById('noLeidosBadge');
      badge.textContent = n;
      badge.classList.toggle('bg-danger', n > 0);
      badge.classList.toggle('bg-secondary', n === 0);
      document.title = (n > 0 ? `(${n}) ` : '') + 'Chat interno – Suizo Argentina';

      const chatBadge = parent?.document?.getElementById?.('chatBadge') || document.getElementById('chatBadge');
      if(chatBadge){
        chatBadge.textContent = n>99?'99+':String(n);
        chatBadge.style.display = n>0 ? 'inline-block' : 'none';
      }
    }catch(e){}
  }
  function iniciarAutoRefresh(){ if(refresco) clearInterval(refresco); refresco = setInterval(cargarMensajes, 5000); }
  function iniciarAutoNoLeidos(){
    if(refrescoNoLeidos) clearInterval(refrescoNoLeidos);
    refrescoNoLeidos = setInterval(()=>{ cargarNoLeidos(); }, 10000);
    if(refrescoHilos) clearInterval(refrescoHilos);
    refrescoHilos = setInterval(()=>{ cargarHilos(); }, 12000);
  }

  /* ===== WebSocket: notificaciones en vivo ===== */
  let ws = null, wsTries = 0, wsPingTimer = null;
  function wsUrl(){
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    return `${proto}://${location.host}/ws`;
  }
  function connectWS(){
    try{
      ws = new WebSocket(wsUrl());
      ws.onopen = () => {
        wsTries = 0;
        document.getElementById('wsDot').classList.remove('status-off');
        if(wsPingTimer) clearInterval(wsPingTimer);
        wsPingTimer = setInterval(()=>{ try{ ws?.send('ping'); }catch(_){ } }, 25000);
      };
      ws.onmessage = async (ev) => {
        let msg = {};
        try{ msg = JSON.parse(ev.data||'{}'); }catch(_){}
        if(!msg.event) return;

        if(msg.event === 'chat:new_message'){
          playNotif('msg');
          if(con && msg.from === con){ await cargarMensajes(); }
          await cargarNoLeidos(); await cargarHilos();
        }
        if(msg.event === 'alert:new'){
          playNotif('alert');
          toast(msg.title || 'Alerta', msg.body || '');
        }
      };
      ws.onerror = () => { try{ ws.close(); }catch(_){ } };
      ws.onclose = () => {
        document.getElementById('wsDot').classList.add('status-off');
        if(wsPingTimer) clearInterval(wsPingTimer);
        const ms = Math.min(30000, (2 ** Math.min(wsTries++, 6)) * 500);
        setTimeout(connectWS, ms);
      };
    }catch(e){ setTimeout(connectWS, 3000); }
  }

  /* ===== Boot ===== */
  (async ()=>{
    await cargarYo();
    await cargarHilos();
    await cargarNoLeidos();
    iniciarAutoNoLeidos();
    connectWS();
  })();
</script>
{% endblock %}
