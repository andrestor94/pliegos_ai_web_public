{% extends "base.html" %}
{% block title %}Chat interno ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* Usa los tokens globales del theme de base.html */
  .chat-app{ display:grid; grid-template-columns: 320px 1fr; gap:16px; }
  @media (max-width: 900px){ .chat-app{ grid-template-columns: 1fr; } }

  .chat-panel{
    background: var(--surface);
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    border:1px solid var(--bs-border-color, var(--border));
  }
  .chat-panel .chat-title{
    margin:0; padding:14px 16px;
    color: var(--brand-500);
    border-bottom:1px solid var(--bs-border-color, var(--border));
    font-weight:600;
  }

  .chat-hilos{ display:flex; flex-direction:column; }
  .chat-hilos .top { padding:12px; border-bottom:1px solid var(--bs-border-color, var(--border)); }
  .chat-auto-wrap{ position:relative; }
  .chat-auto-list{
    position:absolute; z-index:1000; top:100%; left:0; right:0;
    background:var(--surface);
    border:1px solid var(--bs-border-color, var(--border));
    border-radius:12px; margin-top:.25rem; list-style:none; padding:.25rem 0;
    display:none; max-height:280px; overflow:auto; box-shadow:var(--shadow-sm);
  }
  .chat-auto-li{ padding:.5rem .75rem; cursor:pointer; }
  .chat-auto-li .nm{ font-weight:600; color:var(--text); }
  .chat-auto-li .em{ font-size:.85rem; color:var(--text-2); }
  .chat-auto-li.active, .chat-auto-li:hover{ background:var(--muted); }

  .chat-hilos-list { overflow:auto; }
  .chat-hilo-item {
    position:relative; padding:10px 12px;
    border-bottom:1px solid var(--bs-border-color, var(--border));
    cursor:pointer; display:flex; gap:8px; align-items:center;
  }
  .chat-hilo-item:hover{ background:var(--muted); }
  .chat-hilo-item.active{ background: color-mix(in srgb, var(--brand-100) 40%, transparent); }
  .chat-hilo-item .info { flex:1; min-width:0; }
  .chat-hilo-item .nombre{ font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chat-hilo-item .fecha{ font-size:12px; color:var(--text-2); }
  .chat-hilo-item .btn-del{ border:none; background:transparent; font-size:18px; line-height:1; opacity:.7; }
  .chat-hilo-item .btn-del:hover{ opacity:1; }

  .hilo-badge{ position:relative; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; line-height:20px; text-align:center; margin-left:6px; user-select:none; display:inline-block; }
  .hilo-badge.hidden{ display:none; }

  .chat-window{ display:flex; flex-direction:column; }
  .chat-head {
    padding:8px 12px; border-bottom:1px solid var(--bs-border-color, var(--border));
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    background: var(--surface);
  }
  .chat-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--muted); border-radius:999px; font-size:14px;}
  .chat-body { flex:1; overflow:auto; padding:16px; background: var(--app-bg, #f6f7fb); position:relative; }
  .chat-msg {
    max-width: 70%; margin-bottom:12px; padding:10px 12px; border-radius:14px;
    background:var(--surface); box-shadow: var(--shadow-xs);
    border:1px solid var(--bs-border-color, var(--border));
  }
  .chat-msg.me { margin-left:auto; background: var(--brand-50); border-color: color-mix(in srgb, var(--brand-500) 20%, var(--border)); }
  .chat-msg .meta{ font-size:12px; color:var(--text-2); margin-bottom:4px;}
  .chat-empty { color:var(--text-2); padding:16px; }

  .msg-date-divider{
    text-align:center; margin:10px 0 14px; position:relative; color:var(--text-2); font-size:12px;
  }
  .msg-date-divider::before{
    content:''; position:absolute; left:0; right:0; top:50%; height:1px;
    background: var(--bs-border-color, var(--border));
  }
  .msg-date-divider span{
    position:relative; background:var(--app-bg, #f6f7fb); padding:0 .5rem;
  }

  .chat-input {
    border-top:1px solid var(--bs-border-color, var(--border));
    padding:10px; background:var(--surface); display:flex; gap:8px; align-items:flex-start;
  }
  .chat-btn-icon{ display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:10px; }
  .chat-input .form-control{ border-radius:10px; }

  .chat-chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; padding:0 12px 8px; }
  .chat-chip-file{
    display:inline-flex; align-items:center; gap:8px; padding:5px 8px; background:var(--muted); border:1px dashed var(--bs-border-color, var(--border));
    border-radius:999px; font-size:12px;
  }
  .chat-chip-file button{ border:none; background:transparent; line-height:1; font-size:14px; }
  .chat-chip-thumb{ width:26px; height:26px; border-radius:6px; object-fit:cover; background:#fff; border:1px solid var(--bs-border-color, var(--border)); }

  .tip { font-size:12px; color:var(--text-2); }
  .status-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; background:#22c55e; }
  .status-off{ background:#94a3b8; }

  .toast-area{ position:fixed; right:16px; bottom:16px; z-index: 3000; display:flex; flex-direction:column; gap:10px; }
  .toast{ background:#111827; color:#fff; padding:10px 12px; border-radius:12px; box-shadow: var(--shadow); min-width: 220px; max-width: 340px; }
  .toast .t{ font-weight:600; margin-bottom:4px; }
  .toast .x{ float:right; border:none; background:transparent; color:#fff; opacity:.7; }
  .toast .x:hover{ opacity:1; }

  .sound-wrap{ display:flex; align-items:center; gap:8px; }
  .sound-toggle{ display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; }
  .sound-toggle input{ accent-color: var(--brand-500); cursor:pointer; }
  .sound-vol{ width:120px; height:6px; }
  @media (max-width: 480px){ .sound-vol{ width:80px; } }

  .drop-hint{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(37,99,235,.08); border:2px dashed #93c5fd; border-radius:12px; font-weight:600; color:#1e3a8a; }
  .drop-hint.show{ display:flex; }

  /* Scroll-to-bottom bot√≥n */
  .scroll-bottom{
    position:absolute; right:12px; bottom:12px; z-index:5;
    border:1px solid var(--bs-border-color, var(--border));
    background:var(--surface); border-radius:999px; padding:6px 10px; box-shadow:var(--shadow-xs);
    display:none;
  }
  .scroll-bottom.show{ display:inline-flex; align-items:center; gap:6px; }

  /* Barra de progreso de adjuntos */
  .send-progress{ width:100%; height:6px; border-radius:999px; background:var(--muted); overflow:hidden; }
  .send-progress > div{ height:100%; width:0%; background: var(--brand-500); transition: width .2s ease; }

  /* Focus visible */
  .chat-panel :is(button, a, input, textarea):focus-visible{
    outline: 2px solid var(--brand-300);
    outline-offset: 2px;
  }
</style>
{% endblock %}

{% block content %}
<div class="grid">
  <section class="col-12">
    <div class="chat-app">

      <!-- Sidebar: Hilos -->
      <aside class="chat-panel chat-hilos">
        <h5 class="chat-title">Conversaciones</h5>
        <div class="top">
          <div class="chat-auto-wrap">
            <div class="input-group">
              <span class="input-group-text" aria-hidden="true">@</span>
              <input id="nuevoPara" type="text" class="form-control" placeholder="Nombre o email..." autocomplete="off" aria-label="Buscar usuario por nombre o email" />
              <button id="btnAbrir" class="btn btn-primary" type="button">Abrir</button>
            </div>
            <ul id="sugs" class="chat-auto-list" role="listbox" aria-label="Sugerencias"></ul>
            <div class="tip mt-2">Atajo: <kbd>Ctrl</kbd>+<kbd>K</kbd> para buscar usuario</div>
          </div>
        </div>
        <div id="listaHilos" class="chat-hilos-list" role="list" aria-label="Conversaciones"></div>
      </aside>

      <!-- Ventana principal -->
      <section class="chat-panel chat-window" id="chatWindow" aria-label="Ventana de chat">
        <div class="chat-head">
          <span class="status-dot status-off" id="wsDot" title="Estado en vivo"></span>
          <div class="chat-chip">Conversando con: <strong id="conEmail">‚Äî</strong></div>
          <button id="btnEliminarChat" class="btn btn-sm btn-outline-danger ms-2" title="Eliminar chat (ocultar)" type="button">üóë</button>
          <button id="btnRefrescar" class="btn btn-sm btn-outline-secondary ms-auto" type="button">Refrescar</button>

          <span id="noLeidosWrap" class="chat-chip ms-2" title="Mensajes no le√≠dos">
            üîî <span id="noLeidosBadge" class="badge bg-secondary rounded-pill">0</span>
          </span>

          <!-- Toggle sonido -->
          <span class="chat-chip sound-wrap" title="Notificaciones de sonido">
            <label class="sound-toggle">
              <input type="checkbox" id="muteToggle">
              <span id="muteLabel">üîä Sonido</span>
            </label>
            <input id="volRange" class="sound-vol" type="range" min="0" max="100" step="1" title="Volumen">
          </span>

          <span class="chat-chip d-none d-md-inline" title="Tu usuario"><span id="yoEmail">...</span></span>
        </div>

        <div id="chatBody" class="chat-body" aria-live="polite">
          <div class="chat-empty">Seleccion√° una conversaci√≥n o cre√° una nueva desde la izquierda.</div>
          <button id="scrollBtn" class="scroll-bottom" type="button" title="Bajar al final">‚¨áÔ∏è Nuevos</button>
        </div>
        <div class="drop-hint" id="dropHint">Solt√° archivos para adjuntar‚Ä¶</div>

        <div class="chat-input">
          <textarea id="inputMsg" rows="1" class="form-control" placeholder="Escrib√≠ un mensaje‚Ä¶ (Enter env√≠a, Shift+Enter salto de l√≠nea)" aria-label="Mensaje"></textarea>
          <button id="btnPick" class="btn btn-outline-secondary chat-btn-icon" type="button" title="Elegir archivos" aria-label="Elegir archivos">üìé</button>
          <input id="inputFiles" type="file" multiple hidden />
          <button id="btnEnviar" class="btn btn-primary" type="button">Enviar</button>
        </div>
        <div id="chips" class="chat-chips"></div>
        <div id="sendProgress" class="px-3 pb-3" style="display:none">
          <div class="send-progress" aria-hidden="true"><div id="sendProgBar"></div></div>
        </div>

        <div class="tip px-3 pb-3">Pod√©s pegar im√°genes desde el portapapeles. Tama√±o m√°ximo total por mensaje configurable en backend.</div>
      </section>

    </div>
  </section>
</div>

<!-- √Årea de toasts y audios de notificaci√≥n -->
<div class="toast-area" id="toastArea" aria-live="polite" aria-atomic="true"></div>
<audio id="notif-msg"   src="/static/sounds/notification-message.mp3" preload="auto"></audio>
<audio id="notif-alert" src="/static/sounds/notification-alert.mp3"   preload="auto"></audio>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Helpers ===== */
  function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  // Urlify seguro: primero escapamos, luego enlazamos http(s)
  function urlifySafe(plain){
    const esc = escapeHtml(plain);
    const rx = /\bhttps?:\/\/[^\s<>'"]+/g;
    return esc.replace(rx, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
  }
  async function getJSON(url){ const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
  async function postJSON(url,data){
    const r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    let payload=null; try{ payload=await r.json(); }catch(_){}
    if(!r.ok) throw new Error(payload?.error || ('HTTP '+r.status));
    return payload;
  }
  const showToast = window.showToast || ((opts)=>{ // fallback m√≠nimo al de base
    const area = document.getElementById('toastArea');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<button class="x" aria-label="Cerrar">&times;</button>
                    <div class="t">${escapeHtml(opts?.title||'Notificaci√≥n')}</div>
                    <div class="b">${escapeHtml(opts?.body||'')}</div>`;
    el.querySelector('.x').onclick = ()=> el.remove();
    area.appendChild(el);
    setTimeout(()=> el.remove(), 4000);
  });

  /* ===== Notificaci√≥n sonora ===== */
  const MUTE_KEY = 'chat.muted';
  const VOL_KEY  = 'chat.volume';
  const $mute = document.getElementById('muteToggle');
  const $muteLabel = document.getElementById('muteLabel');
  const $vol = document.getElementById('volRange');

  function getMuted(){ return localStorage.getItem(MUTE_KEY) === '1'; }
  function setMuted(v){ localStorage.setItem(MUTE_KEY, v ? '1' : '0'); updateMuteUI(); }
  function getVolume(){ const v = parseInt(localStorage.getItem(VOL_KEY)||'85',10); return isNaN(v) ? 85 : Math.min(100, Math.max(0, v)); }
  function setVolume(v){ localStorage.setItem(VOL_KEY, String(v)); applyVolume(); }

  function updateMuteUI(){
    const muted = getMuted();
    $mute.checked = muted;
    $muteLabel.textContent = muted ? 'üîá Silenciado' : 'üîä Sonido';
  }
  function applyVolume(){
    const vol = getVolume()/100;
    [document.getElementById('notif-msg'), document.getElementById('notif-alert')]
      .forEach(a => { if(a){ a.volume = vol; } });
    $vol.value = String(getVolume());
  }
  let soundUnlocked = false;
  function unlockSoundOnce(){
    if(soundUnlocked) return;
    const a1 = document.getElementById('notif-msg');
    const a2 = document.getElementById('notif-alert');
    [a1,a2].forEach(a=>{
      if(!a) return;
      a.muted = false;
      a.play().then(()=>{ a.pause(); soundUnlocked = true; }).catch(()=>{});
    });
  }
  window.addEventListener('pointerdown', unlockSoundOnce, { once: true });
  function playNotif(kind){
    if(getMuted()) return;
    const id = kind === 'alert' ? 'notif-alert' : 'notif-msg';
    const a = document.getElementById(id);
    if(!a) return;
    a.currentTime = 0;
    a.play().catch(()=>{});
  }
  $mute.addEventListener('change', () => setMuted($mute.checked));
  $vol.addEventListener('input',  () => setVolume(parseInt($vol.value,10)||0));
  updateMuteUI(); applyVolume();

  /* ===== Config adjuntos ===== */
  let CONFIG = { allowed_ext: ['pdf','png','jpg','jpeg','gif','webp','txt','csv','xlsx','xls','docx','doc','pptx'], max_files: 10, max_total_mb: 50, max_text: 5000 };
  (async function(){
    try{
      const r = await fetch('/chat/config'); if(r.ok){
        const cfg = await r.json();
        CONFIG = { ...CONFIG, ...cfg };
      }
    }catch(e){}
  })();
  function extPermitida(name){ const ext=(name.split('.').pop()||'').toLowerCase(); return CONFIG.allowed_ext.includes(ext); }
  function isImage(name){ return /\.(png|jpg|jpeg|gif|webp)$/i.test(name); }

  /* ===== Estado ===== */
  let yo = null, con = null, refresco = null, refrescoNoLeidos = null, refrescoHilos = null;
  let selectedFiles = [];
  const DRAFT_KEY = (email)=> `chat.draft.${email||'__none__'}`;

  /* ===== Sidebar: hilos ===== */
  function setActiveHilo(email){
    document.querySelectorAll('.chat-hilo-item').forEach(el=> el.classList.toggle('active', el.dataset.email === email));
  }
  function renderHilos(hilos){
    const cont = document.getElementById('listaHilos');
    cont.innerHTML = '';
    if(!hilos?.length){ cont.innerHTML = '<div class="p-3 text-muted">Sin conversaciones a√∫n.</div>'; return; }
    hilos.forEach(h=>{
      const div = document.createElement('div');
      div.className = 'chat-hilo-item';
      div.dataset.email = h.con;
      const unread = Number(h?.no_leidos || 0);
      div.innerHTML = `
        <div class="info">
          <div class="nombre">
            ${escapeHtml(h.con)}
            <span class="hilo-badge ${unread>0?'':'hidden'}" aria-label="${unread} mensajes no le√≠dos">${unread>99?'99+':unread}</span>
          </div>
          <div class="fecha">${escapeHtml(h.ultima_fecha || '')}</div>
        </div>
        <button class="btn-del" title="Eliminar (ocultar) chat" aria-label="Eliminar">üóë</button>
      `;
      div.querySelector('.info').onclick = () => abrirChat(h.con);
      div.querySelector('.btn-del').onclick = async (ev) => { ev.stopPropagation(); await ocultar(h.con); };
      cont.appendChild(div);
    });
    setActiveHilo(con);
  }

  const $input = document.getElementById('nuevoPara');
  const $sugs  = document.getElementById('sugs');
  let sugItems = [], sugIdx = -1, debounceId = null;
  const debounce = (fn,ms)=>{ clearTimeout(debounceId); debounceId=setTimeout(fn,ms); };

  async function buscar(term){
    term=(term||'').trim();
    if(!term){ sugItems=[]; renderSugs(); return; }
    try{
      const data = await getJSON(`/api/usuarios?term=${encodeURIComponent(term)}`);
      sugItems = data.items || []; sugIdx = sugItems.length ? 0 : -1; renderSugs();
    }catch{
      sugItems=[]; renderSugs();
    }
  }
  function renderSugs(){
    $sugs.innerHTML = '';
    if(!sugItems.length){ $sugs.style.display='none'; return; }
    sugItems.forEach((it,i)=>{
      const li=document.createElement('li');
      li.className = 'chat-auto-li' + (i===sugIdx?' active':'' );
      li.role='option';
      li.innerHTML = `<div class="nm">${escapeHtml(it.nombre || '(Sin nombre)')}</div><div class="em">${escapeHtml(it.email)}</div>`;
      li.onclick = ()=> seleccionarSugerencia(i);
      $sugs.appendChild(li);
    });
    $sugs.style.display='block';
  }
  function seleccionarSugerencia(i){
    if(i<0 || i>=sugItems.length) return;
    const email=sugItems[i].email; $input.value=email; $sugs.style.display='none'; abrirChat(email);
  }
  $input.addEventListener('input', e=> debounce(()=> buscar(e.target.value),160));
  $input.addEventListener('keydown', (e)=>{
    if($sugs.style.display==='none'){
      if(e.key==='Enter'){ e.preventDefault(); const email = $input.value.trim(); if(email) abrirChat(email); }
      return;
    }
    if(e.key==='ArrowDown'){ e.preventDefault(); sugIdx=Math.min(sugIdx+1, sugItems.length-1); renderSugs(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); sugIdx=Math.max(sugIdx-1, 0); renderSugs(); }
    else if(e.key==='Enter'){ if(sugIdx>=0){ e.preventDefault(); seleccionarSugerencia(sugIdx); } }
    else if(e.key==='Escape'){ $sugs.style.display='none'; }
  });
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.chat-auto-wrap')) $sugs.style.display='none'; });

  /* ===== Render mensajes ===== */
  function dayKey(iso){ try{ return (new Date(iso)).toISOString().slice(0,10); }catch{ return ''; } }

  function renderMensajes(mensajes){
    const body = document.getElementById('chatBody');
    const atBottom = (body.scrollTop + body.clientHeight + 40) >= body.scrollHeight;
    body.innerHTML = '';
    if(!mensajes?.length){
      body.innerHTML = '<div class="chat-empty">No hay mensajes a√∫n. ¬°Escrib√≠ el primero!</div>';
      return;
    }
    let lastDay = '';
    mensajes.forEach(m=>{
      const dk = dayKey(m.fecha_iso || m.fecha);
      if(dk && dk !== lastDay){
        const divi = document.createElement('div');
        divi.className = 'msg-date-divider';
        const d = new Date(m.fecha_iso || m.fecha);
        divi.innerHTML = `<span>${d.toLocaleDateString()}</span>`;
        body.appendChild(divi);
        lastDay = dk;
      }
      const div = document.createElement('div');
      div.className = 'chat-msg' + (m.de === yo ? ' me' : '');
      const meta = `<div class="meta">${escapeHtml(m.de)} ‚Ä¢ ${escapeHtml(m.fecha)}</div>`;
      const txt  = m.texto ? `<div class="txt">${urlifySafe(m.texto)}</div>` : '';
      let adj = '';
      if (m.adjuntos?.length){
        adj = '<div class="mt-2">';
        m.adjuntos.forEach(a=>{
          const url = `/chat/adjunto/${encodeURIComponent(a.filename)}`;
          const isImg = /\.(png|jpg|jpeg|gif|webp)$/i.test(a.filename);
          if(isImg){
            adj += `<div class="mb-2"><a href="${url}" target="_blank" rel="noopener"><img loading="lazy" src="${url}" alt="${escapeHtml(a.original)}" style="max-width:220px; border-radius:10px; display:block;"></a><small class="text-muted">${escapeHtml(a.original)}${a.size ? ' ‚Ä¢ ' + Math.round(a.size/1024) + ' KB' : ''}</small></div>`;
          }else{
            adj += `<div class="mb-1">üìé <a href="${url}" target="_blank" rel="noopener">${escapeHtml(a.original)}</a>${a.size ? `<small class="text-muted"> ‚Ä¢ ${Math.round(a.size/1024)} KB</small>` : ''}</div>`;
          }
        });
        adj += '</div>';
      }
      div.innerHTML = meta + txt + adj;
      body.appendChild(div);
    });

    // bot√≥n "bajar" si no est√°s al final
    const $btn = document.getElementById('scrollBtn');
    if(atBottom){ body.scrollTop = body.scrollHeight; $btn.classList.remove('show'); }
    else { $btn.classList.add('show'); }
  }

  // Scroll detector
  (function(){
    const body = document.getElementById('chatBody');
    const btn = document.getElementById('scrollBtn');
    body.addEventListener('scroll', ()=>{
      const atBottom = (body.scrollTop + body.clientHeight + 40) >= body.scrollHeight;
      btn.classList.toggle('show', !atBottom);
    });
    btn.addEventListener('click', ()=>{ body.scrollTop = body.scrollHeight; btn.classList.remove('show'); });
  })();

  async function cargarYo(){ const info = await getJSON('/usuario-actual'); yo = info.usuario || 'Desconocido'; document.getElementById('yoEmail').textContent = yo; }
  async function cargarHilos(){ try{ const data = await getJSON('/chat/hilos'); renderHilos(data.hilos || []); } catch(e){ console.error(e); showToast({title:'Chat', body:'No se pudieron cargar los hilos', icon:'exclamation-triangle'}); } }
  async function cargarMensajes(){
    if(!con) return;
    try{
      const data = await getJSON(`/chat/mensajes?con=${encodeURIComponent(con)}&limit=200`);
      renderMensajes(data.mensajes || []);
      await marcarLeidos(con);
      await cargarNoLeidos();
      await cargarHilos();
    }catch(e){ console.error(e); showToast({title:'Chat', body:'No se pudieron cargar los mensajes', icon:'exclamation-triangle'}); }
  }

  async function abrirChat(email){
    try{
      await postJSON('/chat/abrir', { con: email });
      con = email; document.getElementById('conEmail').textContent = con;
      setActiveHilo(con);
      const draft = localStorage.getItem(DRAFT_KEY(con));
      const $msg = document.getElementById('inputMsg');
      if(draft){ $msg.value = draft; autoResize(); }
      $msg.focus();
      await marcarLeidos(con);
      await cargarMensajes();
      await cargarHilos();
      iniciarAutoRefresh();
      refreshPresence();
    }catch(e){ console.error(e); showToast({title:'Chat', body:'No se pudo abrir el chat', icon:'exclamation-triangle'}); }
  }
  async function ocultar(email){
    if(!email) return;
    if(!confirm('¬øEliminar chat? Esto solo lo ocultar√° de tu lista, no borra mensajes.')) return;
    try{
      await postJSON('/chat/ocultar', { con: email });
      if(con === email){
        con=null; document.getElementById('conEmail').textContent='‚Äî';
        document.getElementById('chatBody').innerHTML='<div class="chat-empty">Seleccion√° una conversaci√≥n o cre√° una nueva desde la izquierda.</div>';
        localStorage.removeItem(DRAFT_KEY(email));
        if(refresco) clearInterval(refresco);
      }
      await cargarHilos(); await cargarNoLeidos();
    }catch(e){ console.error(e); showToast({title:'Chat', body:'No se pudo eliminar el chat', icon:'exclamation-triangle'}); }
  }
  async function marcarLeidos(remitente){ if(!remitente) return; try{ await postJSON('/chat/marcar-leidos', { de: remitente }); }catch(e){} }

  /* ===== Env√≠o ===== */
  const $files = document.getElementById('inputFiles');
  const $chips = document.getElementById('chips');
  const $btnPick = document.getElementById('btnPick');
  const $sendProg = document.getElementById('sendProgress');
  const $sendBar  = document.getElementById('sendProgBar');

  $btnPick.onclick = () => $files.click();
  $files.addEventListener('change', ()=>{ addFiles([...( $files.files || [] )]); $files.value=''; });

  // Drag & drop sobre el panel
  const $window = document.getElementById('chatWindow');
  const $dropHint = document.getElementById('dropHint');
  ;['dragenter','dragover'].forEach(ev => $window.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $dropHint.classList.add('show'); }));
  ;['dragleave','drop'].forEach(ev => $window.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $dropHint.classList.remove('show'); }));
  $window.addEventListener('drop', (e)=>{ const fl = [...(e.dataTransfer?.files||[])]; if(fl.length) addFiles(fl); });

  // Pegar im√°genes/archivos
  document.addEventListener('paste', (e)=>{
    const items = e.clipboardData?.items||[];
    const files = [];
    for(const it of items){
      if(it.kind==='file'){ const f=it.getAsFile(); if(f) files.push(f); }
    }
    if(files.length) addFiles(files);
  });

  function addFiles(files){
    for(const f of files){
      if(!extPermitida(f.name)){ alert(`Tipo no permitido: ${f.name}`); continue; }
      if(selectedFiles.length >= CONFIG.max_files){ alert(`M√°ximo ${CONFIG.max_files} archivos por mensaje.`); break; }
      selectedFiles.push(f);
    }
    limitTotal(); renderChips();
  }
  function limitTotal(){
    const maxBytes = CONFIG.max_total_mb*1024*1024;
    while(selectedFiles.reduce((a,b)=>a+b.size,0) > maxBytes){ selectedFiles.pop(); }
  }
  function renderChips(){
    $chips.innerHTML=''; if(!selectedFiles.length) return;
    selectedFiles.forEach((f, idx)=>{
      const chip=document.createElement('span'); chip.className='chat-chip-file';
      if(isImage(f.name)){
        const img=document.createElement('img'); img.className='chat-chip-thumb'; img.alt=f.name;
        const fr=new FileReader(); fr.onload=e=> img.src=e.target.result; fr.readAsDataURL(f); chip.appendChild(img);
      }
      const label=document.createElement('span'); label.innerHTML=`${escapeHtml(f.name)} <small class="muted">${Math.round(f.size/1024)} KB</small>`;
      const btn=document.createElement('button'); btn.title='Quitar'; btn.setAttribute('aria-label','Quitar'); btn.innerHTML='&times;';
      btn.onclick=()=>{ selectedFiles.splice(idx,1); renderChips(); };
      chip.appendChild(label); chip.appendChild(btn); $chips.appendChild(chip);
    });
  }

  let sending = false;
  async function enviar(){
    if(sending) return;
    const input=document.getElementById('inputMsg');
    let texto=(input.value||'').trim();
    if(!con){ alert('Eleg√≠ un contacto o busc√° uno con @.'); return; }
    if(texto.length > CONFIG.max_text){
      showToast({title:'Mensaje demasiado largo', body:`M√°ximo ${CONFIG.max_text} caracteres.`});
      return;
    }
    if(selectedFiles.length){ await enviarArchivos(texto); return; }
    if(!texto) return;
    try{
      sending = true;
      document.getElementById('btnEnviar').disabled = true;
      await postJSON('/chat/enviar', { para: con, texto });
      input.value=''; localStorage.removeItem(DRAFT_KEY(con)); autoResize();
      await cargarMensajes(); await cargarHilos();
    }catch(e){ console.error(e); showToast({title:'Chat', body:'No se pudo enviar el mensaje', icon:'exclamation-triangle'}); }
    finally{
      sending = false;
      document.getElementById('btnEnviar').disabled = false;
    }
  }

  // Env√≠o con progreso usando XHR (para adjuntos)
  async function enviarArchivos(texto){
    if(!con){ alert('Eleg√≠ un contacto antes de enviar.'); return; }
    const fd=new FormData();
    fd.append('para', con);
    fd.append('texto', texto || '');
    selectedFiles.forEach(f => fd.append('archivos', f));
    toggleSending(true);
    $sendProg.style.display='block'; $sendBar.style.width='0%';
    try{
      await new Promise((resolve, reject)=>{
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/chat/enviar-archivos');
        xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ $sendBar.style.width = ((e.loaded/e.total)*100).toFixed(0)+'%'; } };
        xhr.onload = ()=>{ (xhr.status>=200 && xhr.status<300) ? resolve() : reject(new Error(xhr.responseText||'Error')); };
        xhr.onerror = ()=> reject(new Error('Red'));
        xhr.send(fd);
      });
      selectedFiles=[]; renderChips(); document.getElementById('inputMsg').value=''; localStorage.removeItem(DRAFT_KEY(con)); autoResize();
      await cargarMensajes(); await cargarHilos();
    }catch(e){ console.error(e); alert('No se pudo enviar los adjuntos.'); }
    finally{
      toggleSending(false);
      setTimeout(()=>{ $sendProg.style.display='none'; $sendBar.style.width='0%'; }, 500);
    }
  }
  function toggleSending(s){ const btn=document.getElementById('btnEnviar'); btn.disabled=s; btn.textContent = s ? 'Enviando‚Ä¶' : 'Enviar'; }

  document.getElementById('btnEnviar').onclick = enviar;
  // Enter env√≠a, Shift+Enter salto, Ctrl/Cmd+Enter tambi√©n
  const $msg = document.getElementById('inputMsg');
  function autoResize(){ $msg.style.height='auto'; $msg.style.height = Math.min(160, $msg.scrollHeight) + 'px'; }
  $msg.addEventListener('input', ()=>{ autoResize(); if(con) localStorage.setItem(DRAFT_KEY(con), $msg.value); });
  $msg.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); enviar(); return; }
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); enviar(); }
  });

  document.getElementById('btnRefrescar').onclick = ()=> { cargarMensajes(); cargarHilos(); };
  document.getElementById('btnAbrir').onclick = ()=>{ const email = $input.value.trim(); if(!email) return; abrirChat(email); };
  document.getElementById('btnEliminarChat').onclick = ()=> ocultar(con);

  // Atajo global: Ctrl+K para foco en buscador
  window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $input.focus(); } });

  /* ===== No le√≠dos & auto refresh ===== */
  async function cargarNoLeidos(){
    try{
      const data = await getJSON('/chat/no-leidos');
      const n = (data && typeof data.no_leidos === 'number') ? data.no_leidos : 0;
      const badge = document.getElementById('noLeidosBadge');
      badge.textContent = n>99?'99+':String(n);
      badge.classList.toggle('bg-danger', n > 0);
      badge.classList.toggle('bg-secondary', n === 0);
      document.title = (n > 0 ? `(${n}) ` : '') + 'Chat interno ‚Äì Suizo Argentina';

      const chatBadge = parent?.document?.getElementById?.('chatBadge') || document.getElementById('chatBadge');
      if(chatBadge){
        chatBadge.textContent = n>99?'99+':String(n);
        chatBadge.style.display = n>0 ? 'inline-block' : 'none';
      }
    }catch(e){}
  }
  function iniciarAutoRefresh(){ if(refresco) clearInterval(refresco); refresco = setInterval(cargarMensajes, 5000); }
  function iniciarAutoNoLeidos(){
    if(refrescoNoLeidos) clearInterval(refrescoNoLeidos);
    refrescoNoLeidos = setInterval(()=>{ cargarNoLeidos(); }, 10000);
    if(refrescoHilos) clearInterval(refrescoHilos);
    refrescoHilos = setInterval(()=>{ cargarHilos(); }, 12000);
  }

  /* ===== Presencia (mejora visual) ===== */
  async function refreshPresence(){
    try{
      const r = await getJSON('/presence/online?minutes=5'); // backend existente en otras vistas
      const list = Array.isArray(r.items) ? r.items : [];
      const online = !!(con && list.find(u=>u.email===con));
      const dot = document.getElementById('wsDot');
      dot.classList.toggle('status-off', !online);
      dot.title = online ? 'En l√≠nea' : 'Desconectado';
    }catch(_){}
  }
  setInterval(refreshPresence, 15000);

  /* ===== WebSocket: notificaciones en vivo (con reconexi√≥n) ===== */
  let ws = null, wsTries = 0, wsPingTimer = null;
  function wsUrl(){
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    return `${proto}://${location.host}/ws`;
  }
  function connectWS(){
    try{
      ws = new WebSocket(wsUrl());
      ws.onopen = () => {
        wsTries = 0;
        document.getElementById('wsDot').classList.remove('status-off');
        if(wsPingTimer) clearInterval(wsPingTimer);
        wsPingTimer = setInterval(()=>{ try{ ws?.send('ping'); }catch(_){ } }, 25000);
      };
      ws.onmessage = async (ev) => {
        let msg = {};
        try{ msg = JSON.parse(ev.data||'{}'); }catch(_){}
        if(!msg.event) return;

        if(msg.event === 'chat:new_message'){
          playNotif('msg');
          if(con && msg.from === con){ await cargarMensajes(); }
          await cargarNoLeidos(); await cargarHilos();
        }
        if(msg.event === 'alert:new'){
          playNotif('alert');
          showToast({title: msg.title || 'Alerta', body: msg.body || ''});
        }
      };
      ws.onerror = () => { try{ ws.close(); }catch(_){ } };
      ws.onclose = () => {
        document.getElementById('wsDot').classList.add('status-off');
        if(wsPingTimer) clearInterval(wsPingTimer);
        const ms = Math.min(30000, (2 ** Math.min(wsTries++, 6)) * 500);
        setTimeout(connectWS, ms);
      };
    }catch(e){ setTimeout(connectWS, 3000); }
  }

  /* ===== Offline/Online hint ===== */
  window.addEventListener('offline', ()=> showToast({title:'Sin conexi√≥n', body:'Est√°s offline. Los nuevos mensajes no se cargar√°n.'}));
  window.addEventListener('online',  ()=> { showToast({title:'Conectado', body:'Volviste a estar online.'}); cargarMensajes(); });

  /* ===== Boot ===== */
  (async ()=>{
    await cargarYo();
    await cargarHilos();
    await cargarNoLeidos();
    iniciarAutoNoLeidos();
    connectWS();
  })();
</script>
{% endblock %}
