<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chat interno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{ --azul:#044369; --bg:#f4f7fb; --card:#ffffff; --gris:#e9eef5; }
    body{ background: var(--bg); }
    .app { height: 100vh; display: flex; flex-direction: column; }
    .chat-wrap { flex:1; display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; }
    .panel { background: var(--card); border-radius: 14px; box-shadow: 0 6px 20px rgba(4,67,105,.08); overflow: hidden;}
    .panel h5{ padding:14px 16px; margin:0; color: var(--azul); border-bottom:1px solid var(--gris); }
    /* Hilos */
    .hilos { display:flex; flex-direction:column; height:100%; }
    .hilos-list { overflow:auto; }
    .item-hilo { padding:10px 12px; border-bottom:1px solid var(--gris); cursor:pointer; display:flex; gap:8px; align-items:center; }
    .item-hilo:hover{ background:#f7faff; }
    .item-hilo.active{ background:#e9f2ff; }
    .item-hilo .info { flex:1; min-width:0; }
    .item-hilo .nombre{ font-weight:600; color:#223; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-hilo .fecha{ font-size:12px; color:#666; }
    .item-hilo .btn-del{ border:none; background:transparent; font-size:18px; line-height:1; opacity:.7; }
    .item-hilo .btn-del:hover{ opacity:1; }
    /* Mensajes */
    .chat { display:flex; flex-direction:column; height:100%; }
    .chat-head { padding:8px 16px; border-bottom:1px solid var(--gris); display:flex; align-items:center; gap:8px; }
    .chat-body { flex:1; overflow:auto; padding:16px; background:#f9fbff;}
    .msg { max-width: 70%; margin-bottom:10px; padding:10px 12px; border-radius:12px; background:#fff; box-shadow: 0 2px 8px rgba(0,0,0,.04);}
    .msg.you { margin-left:auto; background:#dff0ff;}
    .msg .meta{ font-size:12px; color:#666; margin-bottom:4px;}
    .chat-input { border-top:1px solid var(--gris); padding:10px; background:#fff; display:flex; gap:8px; align-items:flex-start; }
    .chat-input input[type="text"] { border-radius:10px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef5ff; border-radius:999px; font-size:14px;}
    .empty { color:#667; padding:16px; }
    @media (max-width: 900px){ .chat-wrap{ grid-template-columns: 1fr; } }
    /* Autocompletar */
    .auto-wrap{ position:relative; }
    .auto-list{ position:absolute; z-index:1000; top:100%; left:0; right:0; background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin-top:.25rem; list-style:none; padding:.25rem 0; display:none; max-height:280px; overflow:auto; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    .auto-li{ padding:.5rem .75rem; cursor:pointer; }
    .auto-li .nm{ font-weight:600; }
    .auto-li .em{ font-size:.85rem; color:#6b7280; }
    .auto-li.active, .auto-li:hover{ background:#f3f4f6; }
    /* Badge no le√≠dos */
    .badge-pill{ border-radius:999px; }
    /* Adjuntos m√∫ltiples */
    .dz{ flex:1; min-height:42px; border:1px dashed #b9c6d8; border-radius:10px; background:#fafcff; padding:8px 10px; color:#51647a; display:flex; align-items:center; gap:8px; cursor:pointer; }
    .dz.dragover{ background:#eef6ff; border-color:#85aee6; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; padding:0 12px 8px; }
    .chip-file{ display:inline-flex; align-items:center; gap:8px; padding:5px 8px; background:#eef5ff; border-radius:999px; font-size:12px; }
    .chip-file button{ border:none; background:transparent; line-height:1; font-size:14px; }
    .chip-thumb{ width:26px; height:26px; border-radius:6px; object-fit:cover; background:#fff; border:1px solid #dbe3ee; }
    .muted{ color:#6b7280; }
    .btn-icon{ display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:10px; }
    .totals{ font-size:12px; color:#6b7280; padding:0 12px 10px; }
  </style>
</head>
<body>
<div class="app">
  <nav class="navbar navbar-light bg-white shadow-sm px-3">
    <a href="/" class="navbar-brand">‚Üê Volver</a>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="noLeidosWrap" class="chip" title="Mensajes no le√≠dos">
        üîî <span id="noLeidosBadge" class="badge bg-danger badge-pill">0</span>
      </span>
      <span class="chip"><span id="yoEmail">...</span></span>
    </div>
  </nav>

  <div class="chat-wrap">
    <!-- Panel Hilos -->
    <div class="panel hilos">
      <h5>Conversaciones</h5>
      <div class="p-3 border-bottom auto-wrap">
        <div class="input-group">
          <span class="input-group-text">@</span>
          <input id="nuevoPara" type="text" class="form-control" placeholder="nombre o email..." autocomplete="off" />
          <button id="btnAbrir" class="btn btn-primary">Abrir</button>
        </div>
        <ul id="sugs" class="auto-list"></ul>
      </div>
      <div id="listaHilos" class="hilos-list"></div>
    </div>

    <!-- Panel Chat -->
    <div class="panel chat">
      <div class="chat-head">
        <div class="chip">Conversando con: <strong id="conEmail">‚Äî</strong></div>
        <button id="btnEliminarChat" class="btn btn-sm btn-outline-danger ms-2" title="Eliminar chat (ocultar)">üóë</button>
        <button id="btnRefrescar" class="btn btn-sm btn-outline-secondary ms-auto">Refrescar</button>
      </div>
      <div id="chatBody" class="chat-body">
        <div class="empty">Seleccion√° una conversaci√≥n o cre√° una nueva desde la izquierda.</div>
      </div>

      <!-- Input + adjuntos -->
      <div class="chat-input">
        <input id="inputMsg" type="text" class="form-control" placeholder="Escribe un mensaje..." />

        <!-- Dropzone + input multiple -->
        <div id="drop" class="dz" title="Clic o arrastr√° archivos">
          <span id="dzHint">üìé Adjuntar‚Ä¶</span>
          <input id="inputFiles" type="file" multiple style="display:none" />
        </div>
        <button id="btnPick" class="btn btn-outline-secondary btn-icon" title="Elegir archivos">üìé</button>
        <button id="btnEnviar" class="btn btn-primary">Enviar</button>
      </div>
      <div id="chips" class="chips"></div>
      <div id="totals" class="totals"></div>
    </div>
  </div>
</div>

<script>
  // --- Estado ---
  let yo = null;
  let con = null; // email del contacto seleccionado
  let refresco = null;
  let refrescoNoLeidos = null;

  // === Config (se carga desde backend) ===
  let CONFIG = {
    allowed_ext: ['pdf','png','jpg','jpeg','gif','webp','txt','csv','xlsx','xls','docx','doc','pptx'],
    max_files: 10,
    max_total_mb: 50
  };

  async function cargarConfig(){
    try{
      const r = await fetch('/chat/config');
      if(r.ok){
        const cfg = await r.json();
        if(cfg && Array.isArray(cfg.allowed_ext)){
          CONFIG = cfg;
        }
      }
    }catch(_){}
    // hint din√°mico
    const hint = document.getElementById('dzHint');
    hint.innerHTML = `üìé Adjuntar‚Ä¶ <span class="muted">(m√°x. ${CONFIG.max_files} archivos / ${CONFIG.max_total_mb} MB totales)</span>`;
  }

  function extPermitida(name){
    const ext = (name.split('.').pop() || '').toLowerCase();
    return CONFIG.allowed_ext.includes(ext);
  }
  function isImage(name){
    return /\.(png|jpg|jpeg|gif|webp)$/i.test(name);
  }

  // === Estado de selecci√≥n de archivos ===
  let selectedFiles = []; // Array<File>

  // --- Utils fetch ---
  async function getJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error("Error HTTP " + r.status);
    return r.json();
  }
  async function postJSON(url, data){
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    if(!r.ok){
      let msg = '';
      try{ msg = (await r.json()).error || ''; }catch(_){}
      if(!msg){ try{ msg = await r.text(); }catch(_){} }
      throw new Error(msg || ('Error HTTP ' + r.status));
    }
    return r.json();
  }

  // --- UI helpers ---
  function setActiveHilo(email){
    document.querySelectorAll('.item-hilo').forEach(el=>{
      el.classList.toggle('active', el.dataset.email === email);
    });
  }
  function renderHilos(hilos){
    const cont = document.getElementById('listaHilos');
    cont.innerHTML = '';
    if(!hilos || !hilos.length){
      cont.innerHTML = '<div class="p-3 text-muted">Sin conversaciones a√∫n.</div>';
      return;
    }
    hilos.forEach(h=>{
      const div = document.createElement('div');
      div.className = 'item-hilo';
      div.dataset.email = h.con;
      div.innerHTML = `
        <div class="info">
          <div class="nombre">${escapeHtml(h.con)}</div>
          <div class="fecha">${h.ultima_fecha || ''}</div>
        </div>
        <button class="btn-del" title="Eliminar chat (ocultar)" aria-label="Eliminar">üóë</button>
      `;
      div.querySelector('.info').onclick = () => abrirChat(h.con);
      div.querySelector('.btn-del').onclick = async (ev) => {
        ev.stopPropagation();
        await ocultar(h.con);
      };
      cont.appendChild(div);
    });
    setActiveHilo(con);
  }

  // ===== Render mensajes + adjuntos =====
  function renderMensajes(mensajes){
    const body = document.getElementById('chatBody');
    body.innerHTML = '';
    if(!mensajes || !mensajes.length){
      body.innerHTML = '<div class="empty">No hay mensajes a√∫n. ¬°Escribe el primero!</div>';
      return;
    }
    mensajes.forEach(m=>{
      const div = document.createElement('div');
      div.className = 'msg' + (m.de === yo ? ' you' : '');
      const meta = `<div class="meta">${escapeHtml(m.de)} ‚Ä¢ ${m.fecha}</div>`;
      const txt  = m.texto ? `<div class="txt">${escapeHtml(m.texto)}</div>` : '';
      // Adjuntos
      let adj = '';
      if (m.adjuntos && m.adjuntos.length){
        adj = '<div class="mt-2">';
        m.adjuntos.forEach(a=>{
          const url = `/chat/adjunto/${encodeURIComponent(a.filename)}`;
          const isImg = /\.(png|jpg|jpeg|gif|webp)$/i.test(a.filename);
          if(isImg){
            adj += `
              <div class="mb-2">
                <a href="${url}" target="_blank" rel="noopener">
                  <img src="${url}" alt="${escapeHtml(a.original)}" style="max-width:220px; border-radius:10px; display:block;">
                </a>
                <small class="text-muted">${escapeHtml(a.original)}${a.size ? ' ‚Ä¢ ' + Math.round(a.size/1024) + ' KB' : ''}</small>
              </div>`;
          }else{
            adj += `
              <div class="mb-1">
                üìé <a href="${url}" target="_blank" rel="noopener">${escapeHtml(a.original)}</a>
                ${a.size ? `<small class="text-muted"> ‚Ä¢ ${Math.round(a.size/1024)} KB</small>` : ''}
              </div>`;
          }
        });
        adj += '</div>';
      }
      div.innerHTML = meta + txt + adj;
      body.appendChild(div);
    });
    body.scrollTop = body.scrollHeight;
  }

  function escapeHtml(str){
    return (str || '').toString().replace(/[&<>"']/g, s => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]
    ));
  }

  // --- Autocompletar (live, /api/usuarios?term=) ---
  const $input = document.getElementById('nuevoPara');
  const $sugs  = document.getElementById('sugs');
  let sugItems = [];
  let sugIdx = -1;
  let debounceId = null;

  function debounce(fn, ms){ clearTimeout(debounceId); debounceId = setTimeout(fn, ms); }

  async function buscar(term){
    term = (term || '').trim();
    if(!term){ sugItems=[]; renderSugs(); return; }
    try{
      const data = await getJSON(`/api/usuarios?term=${encodeURIComponent(term)}`);
      sugItems = data.items || [];
      sugIdx = sugItems.length ? 0 : -1;
      renderSugs();
    }catch(e){ sugItems=[]; renderSugs(); }
  }

  function renderSugs(){
    $sugs.innerHTML = '';
    if(!sugItems.length){ $sugs.style.display='none'; return; }
    sugItems.forEach((it, i)=>{
      const li = document.createElement('li');
      li.className = 'auto-li' + (i===sugIdx?' active':'');
      li.innerHTML = `<div class="nm">${escapeHtml(it.nombre || '(Sin nombre)')}</div>
                      <div class="em">${escapeHtml(it.email)}</div>`;
      li.onclick = ()=> seleccionarSugerencia(i);
      $sugs.appendChild(li);
    });
    $sugs.style.display='block';
  }

  function seleccionarSugerencia(i){
    if(i<0 || i>=sugItems.length) return;
    const email = sugItems[i].email;
    $input.value = email;
    $sugs.style.display='none';
    abrirChat(email);
  }

  $input.addEventListener('input', (e)=> debounce(()=> buscar(e.target.value), 160));
  $input.addEventListener('keydown', (e)=>{
    if($sugs.style.display==='none') return;
    if(e.key==='ArrowDown'){ e.preventDefault(); sugIdx = Math.min(sugIdx+1, sugItems.length-1); renderSugs(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); sugIdx = Math.max(sugIdx-1, 0); renderSugs(); }
    else if(e.key==='Enter'){ if(sugIdx>=0){ e.preventDefault(); seleccionarSugerencia(sugIdx); } }
    else if(e.key==='Escape'){ $sugs.style.display='none'; }
  });
  document.addEventListener('click', (e)=>{
    if(!e.target.closest('.auto-wrap')) $sugs.style.display='none';
  });

  // --- L√≥gica principal ---
  async function cargarYo(){
    const info = await getJSON('/usuario-actual');
    yo = info.usuario || 'Desconocido';
    document.getElementById('yoEmail').textContent = yo;
  }

  async function cargarHilos(){
    try{
      const data = await getJSON('/chat/hilos');
      renderHilos(data.hilos || []);
    }catch(e){
      console.error(e);
      alert('No se pudieron cargar los hilos. ¬øEst√°s logueado?');
    }
  }

  async function cargarMensajes(){
    if(!con) return;
    try{
      const data = await getJSON(`/chat/mensajes?con=${encodeURIComponent(con)}`);
      renderMensajes(data.mensajes || []);
      await marcarLeidos(con);
      await cargarNoLeidos();
    }catch(e){
      console.error(e);
      alert('No se pudieron cargar los mensajes.');
    }
  }

  async function enviar(){
    const input = document.getElementById('inputMsg');
    const texto = (input.value || '').trim();
    if(!con){
      alert('Eleg√≠ un contacto o busc√° uno con @.');
      return;
    }
    // Si hay archivos seleccionados, enviamos todo por /chat/enviar-archivos
    if(selectedFiles.length){
      await enviarArchivos(texto);
      return;
    }
    if(!texto) return;
    try{
      await postJSON('/chat/enviar', { para: con, texto });
      input.value = '';
      await cargarMensajes();
      await cargarHilos();
    }catch(e){
      console.error(e);
      alert('No se pudo enviar el mensaje.');
    }
  }

  // ====== Adjuntos m√∫ltiples ======
  const $files = document.getElementById('inputFiles');
  const $drop  = document.getElementById('drop');
  const $chips = document.getElementById('chips');
  const $btnPick = document.getElementById('btnPick');
  const $totals = document.getElementById('totals');

  $btnPick.onclick = () => $files.click();
  $drop.onclick = () => $files.click();

  // Drag & Drop
  ;['dragenter','dragover'].forEach(ev=>{
    $drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add('dragover'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    $drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove('dragover'); });
  });
  $drop.addEventListener('drop', (e)=>{
    const files = [...(e.dataTransfer?.files || [])];
    if(!files.length) return;
    addFiles(files);
  });

  // Input change
  $files.addEventListener('change', ()=>{
    addFiles([...( $files.files || [] )]);
    // reset input para permitir volver a seleccionar los mismos nombres
    $files.value = '';
  });

  function addFiles(files){
    for(const f of files){
      if(!extPermitida(f.name)){
        alert(`Tipo no permitido: ${f.name}`);
        continue;
      }
      if(selectedFiles.length >= CONFIG.max_files){
        alert(`M√°ximo ${CONFIG.max_files} archivos por mensaje.`);
        break;
      }
      selectedFiles.push(f);
    }
    // Validar peso total
    limitTotal();
    renderChips();
    renderTotals();
  }

  function limitTotal(){
    const maxBytes = CONFIG.max_total_mb*1024*1024;
    while(selectedFiles.reduce((a,b)=>a+b.size,0) > maxBytes){
      selectedFiles.pop(); // quita el √∫ltimo agregado
    }
  }

  function renderTotals(){
    if(!selectedFiles.length){ $totals.textContent = ''; return; }
    const total = selectedFiles.reduce((a,b)=>a+b.size,0);
    const mb = (total/1024/1024);
    $totals.textContent = `Archivos seleccionados: ${selectedFiles.length} ‚Ä¢ Total: ${mb.toFixed(2)} MB (l√≠mite ${CONFIG.max_total_mb} MB)`;
  }

  function renderChips(){
    $chips.innerHTML = '';
    if(!selectedFiles.length) return;
    selectedFiles.forEach((f, idx)=>{
      const chip = document.createElement('span');
      chip.className = 'chip-file';
      // mini preview si es imagen
      if(isImage(f.name)){
        const img = document.createElement('img');
        img.className = 'chip-thumb';
        img.alt = f.name;
        // genera thumbnail con FileReader
        const fr = new FileReader();
        fr.onload = e => { img.src = e.target.result; };
        fr.readAsDataURL(f);
        chip.appendChild(img);
      }
      const label = document.createElement('span');
      label.innerHTML = `${escapeHtml(f.name)} <small class="muted">${Math.round(f.size/1024)} KB</small>`;
      const btn = document.createElement('button');
      btn.title = 'Quitar';
      btn.setAttribute('aria-label','Quitar');
      btn.innerHTML = '&times;';
      btn.onclick = ()=>{
        selectedFiles.splice(idx,1);
        renderChips();
        renderTotals();
      };
      chip.appendChild(label);
      chip.appendChild(btn);
      $chips.appendChild(chip);
    });
  }

  async function enviarArchivos(texto){
    if(!con){ alert('Eleg√≠ un contacto antes de enviar.'); return; }
    const fd = new FormData();
    fd.append('para', con);
    fd.append('texto', texto || '');
    selectedFiles.forEach(f => fd.append('archivos', f));

    toggleSending(true);
    try{
      const resp = await fetch('/chat/enviar-archivos', { method:'POST', body: fd });
      if(!resp.ok){
        let msg = '';
        try{ msg = (await resp.json()).error || ''; }catch(_){}
        if(!msg){ try{ msg = await resp.text(); }catch(_){ } }
        throw new Error(msg || 'No se pudo enviar los adjuntos.');
      }
      // limpiar estado
      selectedFiles = [];
      renderChips();
      renderTotals();
      document.getElementById('inputMsg').value = '';
      await cargarMensajes();
      await cargarHilos();
    }catch(e){
      console.error(e);
      alert(e.message || 'No se pudo enviar los adjuntos.');
    }finally{
      toggleSending(false);
    }
  }

  function toggleSending(sending){
    const btn = document.getElementById('btnEnviar');
    btn.disabled = sending;
    btn.textContent = sending ? 'Enviando‚Ä¶' : 'Enviar';
  }

  async function abrirChat(email){
    try{
      await postJSON('/chat/abrir', { con: email });
      con = email;
      document.getElementById('conEmail').textContent = con;
      setActiveHilo(con);
      await marcarLeidos(con);
      await cargarMensajes();
      await cargarHilos();
      iniciarAutoRefresh();
    }catch(e){
      console.error(e);
      alert('No se pudo abrir el chat.');
    }
  }

  async function ocultar(email){
    if(!email) return;
    if(!confirm('¬øEliminar chat? Esto solo lo ocultar√° de tu lista, no borra mensajes.')) return;
    try{
      await postJSON('/chat/ocultar', { con: email });
      if(con === email){
        con = null;
        document.getElementById('conEmail').textContent = '‚Äî';
        document.getElementById('chatBody').innerHTML = '<div class="empty">Seleccion√° una conversaci√≥n o cre√° una nueva desde la izquierda.</div>';
        if(refresco) clearInterval(refresco);
      }
      await cargarHilos();
      await cargarNoLeidos();
    }catch(e){
      console.error(e);
      alert('No se pudo eliminar el chat.');
    }
  }

  async function marcarLeidos(remitente){
    if(!remitente) return;
    try{
      await postJSON('/chat/marcar-leidos', { de: remitente });
    }catch(e){
      console.warn('No se pudieron marcar le√≠dos:', e?.message || e);
    }
  }

  function iniciarAutoRefresh(){
    if(refresco) clearInterval(refresco);
    refresco = setInterval(cargarMensajes, 5000);
  }

  // --- Badge global de no le√≠dos ---
  async function cargarNoLeidos(){
    try{
      const data = await getJSON('/chat/no-leidos');
      const n = (data && typeof data.no_leidos === 'number') ? data.no_leidos : 0;
      const badge = document.getElementById('noLeidosBadge');
      badge.textContent = n;
      badge.classList.toggle('bg-danger', n > 0);
      badge.classList.toggle('bg-secondary', n === 0);
      document.title = (n > 0 ? `(${n}) ` : '') + 'Chat interno';
    }catch(e){
      // silencioso
    }
  }
  function iniciarAutoNoLeidos(){
    if(refrescoNoLeidos) clearInterval(refrescoNoLeidos);
    refrescoNoLeidos = setInterval(cargarNoLeidos, 10000);
  }

  // --- Eventos ---
  document.getElementById('btnEnviar').onclick = enviar;
  document.getElementById('inputMsg').addEventListener('keypress', (e)=>{ if(e.key === 'Enter') enviar(); });
  document.getElementById('btnRefrescar').onclick = ()=> { cargarMensajes(); cargarHilos(); };
  document.getElementById('btnAbrir').onclick = ()=>{
    const email = $input.value.trim();
    if(!email) return;
    abrirChat(email);
  };
  document.getElementById('btnEliminarChat').onclick = ()=> ocultar(con);

  // --- Init ---
  (async ()=>{
    await cargarConfig();   // <- primero l√≠mites desde backend
    await cargarYo();
    await cargarHilos();
    await cargarNoLeidos();
    iniciarAutoNoLeidos();
  })();
</script>
</body>
</html>
