{% extends "base.html" %}
{% block title %}Chat interno â€“ Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  .app { min-height: calc(100vh - var(--navbar-h,56px)); display:flex; flex-direction:column; }
  .chat-wrap { flex:1; display:grid; grid-template-columns: 320px 1fr; gap:16px; }
  @media (max-width: 900px){ .chat-wrap{ grid-template-columns: 1fr; } }

  .panel { background: var(--card); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
  .panel .panel-title{ margin:0; padding:14px 16px; color: var(--brand); border-bottom: 1px solid var(--border); font-weight:600; }

  /* Hilos */
  .hilos { display:flex; flex-direction:column; }
  .hilos .top { padding:12px; border-bottom:1px solid var(--border); }
  .auto-wrap{ position:relative; }
  .auto-list{ position:absolute; z-index:1000; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:12px; margin-top:.25rem; list-style:none; padding:.25rem 0; display:none; max-height:280px; overflow:auto; box-shadow:var(--shadow); }
  .auto-li{ padding:.5rem .75rem; cursor:pointer; }
  .auto-li .nm{ font-weight:600; }
  .auto-li .em{ font-size:.85rem; color:var(--text-2); }
  .auto-li.active, .auto-li:hover{ background:var(--bg-soft); }

  .hilos-list { overflow:auto; }
  .item-hilo { padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; gap:8px; align-items:center; }
  .item-hilo:hover{ background:var(--bg-soft); }
  .item-hilo.active{ background:var(--bg-strong); }
  .item-hilo .info { flex:1; min-width:0; }
  .item-hilo .nombre{ font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .item-hilo .fecha{ font-size:12px; color:var(--text-2); }
  .item-hilo .btn-del{ border:none; background:transparent; font-size:18px; line-height:1; opacity:.7; }
  .item-hilo .btn-del:hover{ opacity:1; }

  /* Chat */
  .chat { display:flex; flex-direction:column; }
  .chat-head { padding:8px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-soft); border-radius:999px; font-size:14px;}
  .chat-body { flex:1; overflow:auto; padding:16px; background:var(--bg); border-radius:0; }
  .msg { max-width: 70%; margin-bottom:12px; padding:10px 12px; border-radius:14px; background:#fff; box-shadow: 0 2px 8px rgba(0,0,0,.04);}
  .msg.you { margin-left:auto; background:var(--brand-soft); }
  .msg .meta{ font-size:12px; color:var(--text-2); margin-bottom:4px;}
  .empty { color:var(--text-2); padding:16px; }

  .chat-input { border-top:1px solid var(--border); padding:10px; background:#fff; display:flex; gap:8px; align-items:flex-start; }
  .btn-icon{ display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:10px; }

  /* Adjuntos mÃºltiples */
  .dz{ flex:1; min-height:42px; border:1px dashed var(--border-strong); border-radius:12px; background:var(--bg-soft); padding:8px 10px; color:var(--text-2); display:flex; align-items:center; gap:8px; cursor:pointer; }
  .dz.dragover{ background:#eef6ff; border-color:#85aee6; }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; padding:0 12px 8px; }
  .chip-file{ display:inline-flex; align-items:center; gap:8px; padding:5px 8px; background:var(--bg-soft); border-radius:999px; font-size:12px; }
  .chip-file button{ border:none; background:transparent; line-height:1; font-size:14px; }
  .chip-thumb{ width:26px; height:26px; border-radius:6px; object-fit:cover; background:#fff; border:1px solid var(--border); }
  .totals{ font-size:12px; color:var(--text-2); padding:0 12px 10px; }
</style>
{% endblock %}

{% block content %}
<div class="app">
  <div class="chat-wrap">
    <!-- Sidebar: Hilos -->
    <aside class="panel hilos">
      <h5 class="panel-title">Conversaciones</h5>
      <div class="top">
        <div class="auto-wrap">
          <div class="input-group">
            <span class="input-group-text">@</span>
            <input id="nuevoPara" type="text" class="form-control" placeholder="Nombre o email..." autocomplete="off" />
            <button id="btnAbrir" class="btn btn-primary">Abrir</button>
          </div>
          <ul id="sugs" class="auto-list" role="listbox" aria-label="Sugerencias"></ul>
        </div>
      </div>
      <div id="listaHilos" class="hilos-list"></div>
    </aside>

    <!-- Main: Chat -->
    <section class="panel chat">
      <div class="chat-head">
        <div class="chip">Conversando con: <strong id="conEmail">â€”</strong></div>
        <button id="btnEliminarChat" class="btn btn-sm btn-outline-danger ms-2" title="Eliminar chat (ocultar)">ðŸ—‘</button>
        <button id="btnRefrescar" class="btn btn-sm btn-outline-secondary ms-auto">Refrescar</button>
        <span id="noLeidosWrap" class="chip ms-2" title="Mensajes no leÃ­dos">
          ðŸ”” <span id="noLeidosBadge" class="badge bg-secondary rounded-pill">0</span>
        </span>
        <span class="chip d-none d-md-inline"><span id="yoEmail">...</span></span>
      </div>

      <div id="chatBody" class="chat-body">
        <div class="empty">SeleccionÃ¡ una conversaciÃ³n o creÃ¡ una nueva desde la izquierda.</div>
      </div>

      <div class="chat-input">
        <input id="inputMsg" type="text" class="form-control" placeholder="Escribe un mensaje..." />
        <div id="drop" class="dz" title="Clic o arrastrÃ¡ archivos">
          <span id="dzHint">ðŸ“Ž Adjuntarâ€¦</span>
          <input id="inputFiles" type="file" multiple style="display:none" />
        </div>
        <button id="btnPick" class="btn btn-outline-secondary btn-icon" title="Elegir archivos">ðŸ“Ž</button>
        <button id="btnEnviar" class="btn btn-primary">Enviar</button>
      </div>
      <div id="chips" class="chips"></div>
      <div id="totals" class="totals"></div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Helpers UI ===== */
  function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  // Navbar user state
  (async function getUsuario(){
    try{
      const r = await fetch("/usuario-actual");
      const d = await r.json();
      const el = document.getElementById("usuario-nombre");
      if(el) el.textContent = `ðŸ‘¤ ${d.usuario}`;
      document.getElementById("admin-link-desktop")?.classList.toggle("d-none", (d.rol||'').toLowerCase()!=="admin");
      document.getElementById("admin-link-mobile")?.classList.toggle("d-none", (d.rol||'').toLowerCase()!=="admin");
    }catch(e){}
  })();

  // Close offcanvas on nav click
  document.addEventListener('click', (e)=>{
    const link = e.target.closest('.offcanvas .nav-link-mobile, .offcanvas .btn, .offcanvas .dropdown-item');
    if (!link) return;
    const offcanvasEl = document.getElementById('menuOffcanvas');
    if (!offcanvasEl) return;
    const offcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
    if (offcanvas) offcanvas.hide();
  });
  function logout(){ fetch("/logout", { method: "POST" }).then(() => window.location.href = "/login"); }

  /* ===== Config adjuntos desde backend ===== */
  let CONFIG = { allowed_ext: ['pdf','png','jpg','jpeg','gif','webp','txt','csv','xlsx','xls','docx','doc','pptx'], max_files: 10, max_total_mb: 50 };
  (async function cargarConfig(){
    try{
      const r = await fetch('/chat/config');
      if(r.ok){
        const cfg = await r.json();
        if(cfg?.allowed_ext) CONFIG = cfg;
      }
    }catch(e){}
    document.getElementById('dzHint').innerHTML = `ðŸ“Ž Adjuntarâ€¦ <span class="muted">(mÃ¡x. ${CONFIG.max_files} archivos / ${CONFIG.max_total_mb} MB totales)</span>`;
  })();
  function extPermitida(name){ const ext=(name.split('.').pop()||'').toLowerCase(); return CONFIG.allowed_ext.includes(ext); }
  function isImage(name){ return /\.(png|jpg|jpeg|gif|webp)$/i.test(name); }

  /* ===== Estado global ===== */
  let yo = null, con = null, refresco = null, refrescoNoLeidos = null;
  let selectedFiles = [];

  async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
  async function postJSON(url,data){
    const r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    let payload=null; try{ payload=await r.json(); }catch(_){}
    if(!r.ok) throw new Error(payload?.error || ('HTTP '+r.status));
    return payload;
  }

  /* ===== Sidebar: hilos y autocompletar ===== */
  function setActiveHilo(email){
    document.querySelectorAll('.item-hilo').forEach(el=> el.classList.toggle('active', el.dataset.email === email));
  }
  function renderHilos(hilos){
    const cont = document.getElementById('listaHilos');
    cont.innerHTML = '';
    if(!hilos?.length){ cont.innerHTML = '<div class="p-3 text-muted">Sin conversaciones aÃºn.</div>'; return; }
    hilos.forEach(h=>{
      const div = document.createElement('div');
      div.className = 'item-hilo';
      div.dataset.email = h.con;
      div.innerHTML = `
        <div class="info">
          <div class="nombre">${escapeHtml(h.con)}</div>
          <div class="fecha">${h.ultima_fecha || ''}</div>
        </div>
        <button class="btn-del" title="Eliminar chat (ocultar)" aria-label="Eliminar">ðŸ—‘</button>
      `;
      div.querySelector('.info').onclick = () => abrirChat(h.con);
      div.querySelector('.btn-del').onclick = async (ev) => { ev.stopPropagation(); await ocultar(h.con); };
      cont.appendChild(div);
    });
    setActiveHilo(con);
  }

  const $input = document.getElementById('nuevoPara');
  const $sugs  = document.getElementById('sugs');
  let sugItems = [], sugIdx = -1, debounceId = null;
  const debounce = (fn,ms)=>{ clearTimeout(debounceId); debounceId=setTimeout(fn,ms); };

  async function buscar(term){
    term=(term||'').trim();
    if(!term){ sugItems=[]; renderSugs(); return; }
    try{ const data = await getJSON(`/api/usuarios?term=${encodeURIComponent(term)}`); sugItems = data.items || []; sugIdx = sugItems.length ? 0 : -1; renderSugs(); }
    catch{ sugItems=[]; renderSugs(); }
  }
  function renderSugs(){
    $sugs.innerHTML = '';
    if(!sugItems.length){ $sugs.style.display='none'; return; }
    sugItems.forEach((it,i)=>{
      const li=document.createElement('li');
      li.className = 'auto-li' + (i===sugIdx?' active':'' );
      li.role='option';
      li.innerHTML = `<div class="nm">${escapeHtml(it.nombre || '(Sin nombre)')}</div><div class="em">${escapeHtml(it.email)}</div>`;
      li.onclick = ()=> seleccionarSugerencia(i);
      $sugs.appendChild(li);
    });
    $sugs.style.display='block';
  }
  function seleccionarSugerencia(i){
    if(i<0 || i>=sugItems.length) return;
    const email=sugItems[i].email; $input.value=email; $sugs.style.display='none'; abrirChat(email);
  }
  $input.addEventListener('input', e=> debounce(()=> buscar(e.target.value),160));
  $input.addEventListener('keydown', (e)=>{
    if($sugs.style.display==='none') return;
    if(e.key==='ArrowDown'){ e.preventDefault(); sugIdx=Math.min(sugIdx+1, sugItems.length-1); renderSugs(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); sugIdx=Math.max(sugIdx-1, 0); renderSugs(); }
    else if(e.key==='Enter'){ if(sugIdx>=0){ e.preventDefault(); seleccionarSugerencia(sugIdx); } }
    else if(e.key==='Escape'){ $sugs.style.display='none'; }
  });
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.auto-wrap')) $sugs.style.display='none'; });

  /* ===== Chat: mensajes ===== */
  function renderMensajes(mensajes){
    const body = document.getElementById('chatBody');
    body.innerHTML = '';
    if(!mensajes?.length){ body.innerHTML = '<div class="empty">No hay mensajes aÃºn. Â¡Escribe el primero!</div>'; return; }
    mensajes.forEach(m=>{
      const div = document.createElement('div');
      div.className = 'msg' + (m.de === yo ? ' you' : '');
      const meta = `<div class="meta">${escapeHtml(m.de)} â€¢ ${m.fecha}</div>`;
      const txt  = m.texto ? `<div class="txt">${escapeHtml(m.texto)}</div>` : '';
      let adj = '';
      if (m.adjuntos?.length){
        adj = '<div class="mt-2">';
        m.adjuntos.forEach(a=>{
          const url = `/chat/adjunto/${encodeURIComponent(a.filename)}`;
          const isImg = /\.(png|jpg|jpeg|gif|webp)$/i.test(a.filename);
          if(isImg){
            adj += `<div class="mb-2"><a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="${escapeHtml(a.original)}" style="max-width:220px; border-radius:10px; display:block;"></a><small class="text-muted">${escapeHtml(a.original)}${a.size ? ' â€¢ ' + Math.round(a.size/1024) + ' KB' : ''}</small></div>`;
          }else{
            adj += `<div class="mb-1">ðŸ“Ž <a href="${url}" target="_blank" rel="noopener">${escapeHtml(a.original)}</a>${a.size ? `<small class="text-muted"> â€¢ ${Math.round(a.size/1024)} KB</small>` : ''}</div>`;
          }
        });
        adj += '</div>';
      }
      div.innerHTML = meta + txt + adj;
      body.appendChild(div);
    });
    body.scrollTop = body.scrollHeight;
  }

  async function cargarYo(){ const info = await getJSON('/usuario-actual'); yo = info.usuario || 'Desconocido'; document.getElementById('yoEmail').textContent = yo; }
  async function cargarHilos(){ try{ const data = await getJSON('/chat/hilos'); renderHilos(data.hilos || []); } catch(e){ console.error(e); alert('No se pudieron cargar los hilos.'); } }
  async function cargarMensajes(){
    if(!con) return;
    try{
      const data = await getJSON(`/chat/mensajes?con=${encodeURIComponent(con)}&limit=100`);
      renderMensajes(data.mensajes || []);
      await marcarLeidos(con);
      await cargarNoLeidos();
    }catch(e){ console.error(e); alert('No se pudieron cargar los mensajes.'); }
  }

  async function abrirChat(email){
    try{
      await postJSON('/chat/abrir', { con: email });
      con = email; document.getElementById('conEmail').textContent = con;
      setActiveHilo(con);
      await marcarLeidos(con);
      await cargarMensajes();
      await cargarHilos();
      iniciarAutoRefresh();
    }catch(e){ console.error(e); alert('No se pudo abrir el chat.'); }
  }
  async function ocultar(email){
    if(!email) return;
    if(!confirm('Â¿Eliminar chat? Esto solo lo ocultarÃ¡ de tu lista, no borra mensajes.')) return;
    try{
      await postJSON('/chat/ocultar', { con: email });
      if(con === email){
        con=null; document.getElementById('conEmail').textContent='â€”';
        document.getElementById('chatBody').innerHTML='<div class="empty">SeleccionÃ¡ una conversaciÃ³n o creÃ¡ una nueva desde la izquierda.</div>';
        if(refresco) clearInterval(refresco);
      }
      await cargarHilos(); await cargarNoLeidos();
    }catch(e){ console.error(e); alert('No se pudo eliminar el chat.'); }
  }
  async function marcarLeidos(remitente){ if(!remitente) return; try{ await postJSON('/chat/marcar-leidos', { de: remitente }); }catch(e){} }

  /* ===== EnvÃ­o de mensajes y adjuntos ===== */
  const $files = document.getElementById('inputFiles');
  const $drop  = document.getElementById('drop');
  const $chips = document.getElementById('chips');
  const $btnPick = document.getElementById('btnPick');
  const $totals = document.getElementById('totals');

  $btnPick.onclick = () => $files.click();
  $drop.onclick = () => $files.click();
  ['dragenter','dragover'].forEach(ev=> $drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(ev=>  $drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove('dragover'); }));
  $drop.addEventListener('drop', (e)=>{ const files=[...(e.dataTransfer?.files||[])]; if(!files.length) return; addFiles(files); });
  $files.addEventListener('change', ()=>{ addFiles([...( $files.files || [] )]); $files.value=''; });

  function addFiles(files){
    for(const f of files){
      if(!extPermitida(f.name)){ alert(`Tipo no permitido: ${f.name}`); continue; }
      if(selectedFiles.length >= CONFIG.max_files){ alert(`MÃ¡ximo ${CONFIG.max_files} archivos por mensaje.`); break; }
      selectedFiles.push(f);
    }
    limitTotal(); renderChips(); renderTotals();
  }
  function limitTotal(){
    const maxBytes = CONFIG.max_total_mb*1024*1024;
    while(selectedFiles.reduce((a,b)=>a+b.size,0) > maxBytes){ selectedFiles.pop(); }
  }
  function renderTotals(){
    if(!selectedFiles.length){ $totals.textContent=''; return; }
    const total = selectedFiles.reduce((a,b)=>a+b.size,0);
    const mb = total/1024/1024;
    $totals.textContent = `Archivos seleccionados: ${selectedFiles.length} â€¢ Total: ${mb.toFixed(2)} MB (lÃ­mite ${CONFIG.max_total_mb} MB)`;
  }
  function renderChips(){
    $chips.innerHTML=''; if(!selectedFiles.length) return;
    selectedFiles.forEach((f, idx)=>{
      const chip=document.createElement('span'); chip.className='chip-file';
      if(isImage(f.name)){
        const img=document.createElement('img'); img.className='chip-thumb'; img.alt=f.name;
        const fr=new FileReader(); fr.onload=e=> img.src=e.target.result; fr.readAsDataURL(f); chip.appendChild(img);
      }
      const label=document.createElement('span'); label.innerHTML=`${escapeHtml(f.name)} <small class="muted">${Math.round(f.size/1024)} KB</small>`;
      const btn=document.createElement('button'); btn.title='Quitar'; btn.setAttribute('aria-label','Quitar'); btn.innerHTML='&times;';
      btn.onclick=()=>{ selectedFiles.splice(idx,1); renderChips(); renderTotals(); };
      chip.appendChild(label); chip.appendChild(btn); $chips.appendChild(chip);
    });
  }

  async function enviar(){
    const input=document.getElementById('inputMsg');
    const texto=(input.value||'').trim();
    if(!con){ alert('ElegÃ­ un contacto o buscÃ¡ uno con @.'); return; }
    if(selectedFiles.length){ await enviarArchivos(texto); return; }
    if(!texto) return;
    try{
      await postJSON('/chat/enviar', { para: con, texto });
      input.value=''; await cargarMensajes(); await cargarHilos();
    }catch(e){ console.error(e); alert('No se pudo enviar el mensaje.'); }
  }
  async function enviarArchivos(texto){
    if(!con){ alert('ElegÃ­ un contacto antes de enviar.'); return; }
    const fd=new FormData();
    fd.append('para', con);
    fd.append('texto', texto || '');
    selectedFiles.forEach(f => fd.append('archivos', f));
    toggleSending(true);
    try{
      const resp=await fetch('/chat/enviar-archivos', { method:'POST', body: fd });
      if(!resp.ok){
        let msg=''; try{ msg=(await resp.json()).error||''; }catch(_){}
        if(!msg){ try{ msg=await resp.text(); }catch(_){} }
        throw new Error(msg || 'No se pudo enviar los adjuntos.');
      }
      selectedFiles=[]; renderChips(); renderTotals(); document.getElementById('inputMsg').value='';
      await cargarMensajes(); await cargarHilos();
    }catch(e){ console.error(e); alert(e.message || 'No se pudo enviar los adjuntos.'); }
    finally{ toggleSending(false); }
  }
  function toggleSending(sending){ const btn=document.getElementById('btnEnviar'); btn.disabled=sending; btn.textContent = sending ? 'Enviandoâ€¦' : 'Enviar'; }

  // Eventos envÃ­o
  document.getElementById('btnEnviar').onclick = enviar;
  document.getElementById('inputMsg').addEventListener('keypress', (e)=>{ if(e.key === 'Enter') enviar(); });
  document.getElementById('btnRefrescar').onclick = ()=> { cargarMensajes(); cargarHilos(); };
  document.getElementById('btnAbrir').onclick = ()=>{ const email = $input.value.trim(); if(!email) return; abrirChat(email); };
  document.getElementById('btnEliminarChat').onclick = ()=> ocultar(con);

  /* ===== No leÃ­dos + auto refresh ===== */
  async function cargarNoLeidos(){
    try{
      const data = await getJSON('/chat/no-leidos');
      const n = (data && typeof data.no_leidos === 'number') ? data.no_leidos : 0;
      const badge = document.getElementById('noLeidosBadge');
      badge.textContent = n;
      badge.classList.toggle('bg-danger', n > 0);
      badge.classList.toggle('bg-secondary', n === 0);
      document.title = (n > 0 ? `(${n}) ` : '') + 'Chat interno';
    }catch(e){}
  }
  function iniciarAutoRefresh(){ if(refresco) clearInterval(refresco); refresco = setInterval(cargarMensajes, 5000); }
  function iniciarAutoNoLeidos(){ if(refrescoNoLeidos) clearInterval(refrescoNoLeidos); refrescoNoLeidos = setInterval(cargarNoLeidos, 10000); }

  /* ===== Notificaciones flotantes (campana) ===== */
  function showToast({title="Aviso", body="", icon="info"}){
    const container=document.getElementById('toastContainer'); if(!container) return;
    const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
    el.innerHTML=`<div class="toast-header">
      <i class="bi bi-${icon} me-1"></i>
      <strong class="me-auto">${title}</strong>
      <small>Ahora</small>
      <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div><div class="toast-body">${body}</div>`;
    container.appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast',()=>el.remove());
  }
  let notifOpen=false;
  function toggleNotifPanel(){ notifOpen=!notifOpen; const p=document.getElementById('notif-panel'); if(p) p.style.display = notifOpen ? 'block':'none'; }
  function renderBadge(n){
    const b=document.getElementById('notif-badge');
    if(!b) return;
    if(n>0){ b.style.display='inline-block'; b.textContent=n; } else { b.style.display='none'; }
  }
  function renderNotifs(items){
    const list=document.getElementById('notif-list'); if(!list) return; list.innerHTML='';
    if(!items?.length){ list.innerHTML='<div class="p-3 text-muted">Sin notificaciones</div>'; return; }
    items.forEach(n=>{
      const div=document.createElement('div'); div.className='item '+(!n.leida?'unread':''); div.style.padding='10px 12px'; div.style.borderBottom='1px solid #f0f2f5';
      div.innerHTML=`<div style="font-weight:600">${escapeHtml(n.titulo||'NotificaciÃ³n')}</div>
                     <div class="small">${escapeHtml(n.cuerpo||'')}</div>
                     <div class="small text-muted">${escapeHtml(n.fecha_legible||'')}</div>`;
      list.appendChild(div);
    });
  }
  async function fetchNotifs(){
    try{
      const r=await fetch('/notificaciones?limit=20'); if(!r.ok) return;
      const data=await r.json();
      renderNotifs(data.items||[]);
      renderBadge(data.total_unread||0);
    }catch(e){}
  }

  /* ===== Boot ===== */
  (async ()=>{
    await cargarYo();
    await cargarHilos();
    await cargarNoLeidos();
    iniciarAutoNoLeidos();
    // Estado del chat IA (topbar) â€“ la lÃ³gica ya estÃ¡ en base.html
    fetchNotifs();
    setInterval(fetchNotifs, 30000);
  })();
</script>
{% endblock %}
