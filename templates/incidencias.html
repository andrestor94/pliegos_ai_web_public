{% extends "base.html" %}
{% block title %}Incidencias – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ——— Encabezado + coherencia visual ——— */
  .inc-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .inc-head .hero-title{ margin:0; }
  .subtle{ color:var(--muted,#667085); }

  /* Campos “neo” */
  .form-neo .form-control,
  .form-neo .form-select,
  .form-neo textarea {
    border-radius:14px;
    border:1px solid var(--border);
    background:var(--input-bg,#fff);
    color:var(--input-text,var(--text));
    box-shadow:0 1px 0 rgba(15,18,34,.02);
  }
  .form-neo .form-control::placeholder,
  .form-neo textarea::placeholder{ color:var(--input-placeholder,var(--text-2)); }
  .form-neo .form-control:focus,
  .form-neo .form-select:focus,
  .form-neo textarea:focus {
    border-color:rgba(139,92,246,.55);
    box-shadow:0 0 0 .25rem rgba(139,92,246,.18);
  }

  /* Botones */
  .btn-primary{
    border:none; border-radius:12px;
    background:linear-gradient(135deg, var(--accent-a, var(--brand-500)), var(--accent-b, var(--brand-600)));
    box-shadow:0 10px 24px rgba(139,92,246,.24);
    color:#fff;
  }
  .btn-outline-primary{
    border-radius:12px; border-color:var(--accent-a, var(--brand-500)); color:var(--accent-a, var(--brand-500));
  }
  .btn-outline-primary:hover{
    color:#fff; background:linear-gradient(135deg, var(--accent-a, var(--brand-500)), var(--accent-b, var(--brand-600))); border-color:transparent;
  }
  .btn-soft{ border-radius:12px; border:1px solid var(--border); background:var(--muted,#f6f8ff); }

  /* Tabla & chips de adjuntos */
  .table thead th{ position:sticky; top:0; background:var(--surface,#fff); z-index:1; user-select:none; cursor:default; }
  .table th.sortable{ cursor:pointer; }
  .table th.sortable .bi{ opacity:.35; }
  .table th.sortable.active .bi{ opacity:1; }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; background:var(--surface,#fff);
    border:1px solid var(--border); font-size:12px;
  }
  .chip a{ text-decoration:none; }
  .chip .bi{ font-size:14px; }

  /* Badges de estado */
  .badge-state{ border-radius:999px; font-weight:600; padding:.35rem .6rem; }
  .badge-abierto{ background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
  .badge-cerrado{ background:#ecfdf5; color:#065f46; border:1px solid #b7f0db; }

  /* Filtros / búsqueda */
  #filterInput{ max-width:260px; }
  .inc-toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .inc-toolbar .form-select, .inc-toolbar .form-control{ border-radius:12px; }
  .result-count{ color:var(--muted); }
  mark.hl{ background:#fff3bf; padding:0 .15em; border-radius:4px; }

  /* Paginación */
  .inc-pager{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px; }
  .inc-pager .range{ color:var(--muted); }
  .pagination .page-link{ border-radius:10px; }

  .file-hint{ color:var(--muted); }
  .file-list{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
  .file-item{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:4px 8px; background:var(--surface,#fff); }
  .file-item .rm{ border:none; background:transparent; margin-left:6px; cursor:pointer; }
  .char-count{ font-size:.9rem; color:var(--muted); }

  /* Clicabilidad extra dentro de esta vista */
  .cardx button,
  .cardx [role="button"],
  .cardx a.btn{ pointer-events:auto !important; position:relative; z-index:1; }
</style>
{% endblock %}

{% block content %}
<div class="py-3" data-route="/incidencias">
  <div class="inc-head mb-3">
    <h1 class="hero-title"><i class="bi bi-tools me-2"></i> Gestión de incidencias</h1>
    <a href="/" class="btn btn-soft">← Volver</a>
  </div>

  <!-- Crear incidencia -->
  <div class="cardx mb-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="title"><i class="bi bi-wrench-adjustable-circle"></i> Nueva incidencia</div>
      <span class="subtle">Reportá un problema o solicitud</span>
    </div>

    <form method="post" action="/incidencias" enctype="multipart/form-data"
          class="row g-3 form-neo" id="formInc" autocomplete="off" novalidate>
      <div class="col-12 col-md-6">
        <label for="titulo" class="form-label">Título</label>
        <input type="text" class="form-control" id="titulo" name="titulo"
               placeholder="Ej: No puedo subir pliegos…" required maxlength="200">
      </div>

      <div class="col-12 col-md-3">
        <label for="tipo" class="form-label">Categoría</label>
        <select class="form-select" id="tipo" name="tipo" required>
          <option value="Técnica" selected>Técnica</option>
          <option value="Acceso">Acceso</option>
          <option value="Datos">Datos</option>
          <option value="Solicitud">Solicitud</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="col-12">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea class="form-control" id="descripcion" name="descripcion" rows="6"
          placeholder="Contanos qué pasó, pasos para reproducir y qué esperabas que suceda…" required maxlength="4000"></textarea>
        <div class="char-count"><span id="descCnt">0</span>/4000</div>
      </div>

      <div class="col-12">
        <label for="archivo" class="form-label">Adjuntar archivos (opcional)</label>
        <input class="form-control" type="file" name="archivos" id="archivo" multiple
               accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.txt,.csv,.xlsx,.xls,.docx,.doc,.pptx">
        <div class="form-text file-hint">Imágenes, PDF, Word, Excel, etc. Máx. 10 archivos • 25 MB totales.</div>
        <div id="selFiles" class="file-list" aria-live="polite"></div>
      </div>

      <div class="col-12 d-flex gap-2">
        <!-- Blindado: aunque el botón se mueva, siempre envía #formInc -->
        <button type="submit" class="btn btn-primary"
                form="formInc" data-submit="#formInc">
          <i class="bi bi-plus-circle me-1"></i> Crear incidencia
        </button>
        <button type="reset" class="btn btn-outline-secondary">
          <i class="bi bi-eraser me-1"></i> Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- Listado -->
  <div class="cardx">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="title d-flex align-items-center gap-2">
        <i class="bi bi-journal-text"></i>
        <span>Incidencias registradas</span>
        <small id="resultCnt" class="result-count"></small>
      </div>
      <div class="inc-toolbar">
        <input id="filterInput" class="form-control form-control-sm" placeholder="Filtrar por texto…" title="Buscar en todas las columnas" autocomplete="off">
        <select id="filterEstado" class="form-select form-select-sm" title="Filtrar por estado">
          <option value="">Estado: Todos</option>
          <option value="Abierto">Abierto</option>
          <option value="Cerrado">Cerrado</option>
        </select>
        <select id="filterTipo" class="form-select form-select-sm" title="Filtrar por categoría">
          <option value="">Categoría: Todas</option>
          <option value="Técnica">Técnica</option>
          <option value="Acceso">Acceso</option>
          <option value="Datos">Datos</option>
          <option value="Solicitud">Solicitud</option>
          <option value="Otro">Otro</option>
        </select>
        <select id="pageSize" class="form-select form-select-sm" title="Ítems por página">
          <option>10</option><option selected>25</option><option>50</option><option>100</option>
        </select>
        <button id="btnExport" class="btn btn-outline-primary btn-sm"><i class="bi bi-download me-1"></i> Exportar</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0" id="incTable">
        <thead>
          <tr>
            <th class="text-nowrap sortable" data-sort="id">ID <i class="bi bi-arrow-down-up"></i></th>
            <th class="text-nowrap sortable" data-sort="usuario">Usuario <i class="bi bi-arrow-down-up"></i></th>
            <th class="text-nowrap sortable" data-sort="titulo">Título <i class="bi bi-arrow-down-up"></i></th>
            <th>Descripción</th>
            <th class="text-nowrap sortable" data-sort="tipo">Categoría <i class="bi bi-arrow-down-up"></i></th>
            <th class="text-nowrap sortable" data-sort="fecha">Fecha <i class="bi bi-arrow-down-up"></i></th>
            <th class="text-nowrap">Adjuntos</th>
            <th class="text-nowrap sortable" data-sort="estado">Estado <i class="bi bi-arrow-down-up"></i></th>
            <th class="text-nowrap">Acciones</th>
          </tr>
        </thead>
        <tbody id="incTableBody">
          {% for ticket in tickets %}
          <tr data-id="{{ ticket.id }}"
              data-usuario="{{ ticket.usuario | e }}"
              data-titulo="{{ ticket.titulo | e }}"
              data-descripcion="{{ ticket.descripcion | e }}"
              data-tipo="{{ ticket.tipo | e }}"
              data-fecha="{{ ticket.fecha_legible | e }}"
              data-estado="{{ ticket.estado | e }}">
            <td class="text-muted td-id">{{ ticket.id }}</td>
            <td class="campo-usuario">{{ ticket.usuario }}</td>
            <td class="fw-semibold campo-titulo">{{ ticket.titulo }}</td>
            <td class="small campo-descripcion">{{ ticket.descripcion }}</td>
            <td><span class="badge bg-primary-subtle text-primary campo-tipo">{{ ticket.tipo }}</span></td>
            <td class="text-nowrap campo-fecha">{{ ticket.fecha_legible }}</td>

            {# ——— Adjuntos: se pasan crudos y se renderizan en el front ——— #}
            <td class="small campo-adjuntos"
                data-adj='{{ (ticket.adjuntos or ticket.archivos) | tojson | safe }}'>
              <span class="text-muted">—</span>
            </td>

            <td class="td-estado">
              {% if ticket.estado == 'Cerrado' %}
                <span class="badge-state badge-cerrado">Cerrado</span>
              {% else %}
                <span class="badge-state badge-abierto">Abierto</span>
              {% endif %}
            </td>
            <td class="text-nowrap">
              {% if ticket.estado != 'Cerrado' %}
              <form method="post" action="/incidencias/cerrar/{{ ticket.id }}" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-success action-cerrar">
                  <i class="bi bi-check2-circle me-1"></i> Cerrar
                </button>
              </form>
              {% else %}
              <span class="text-muted small">—</span>
              {% endif %}

              {% if usuario_actual.rol == 'admin' %}
              <form method="post" action="/incidencias/eliminar/{{ ticket.id }}" class="d-inline ms-1"
                    onsubmit="return confirm('¿Eliminar incidencia #{{ ticket.id }}?');">
                <button type="submit" class="btn btn-sm btn-outline-danger action-eliminar">
                  <i class="bi bi-trash me-1"></i> Eliminar
                </button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if tickets|length == 0 %}
      <div class="text-center text-body-secondary py-3">No hay incidencias registradas.</div>
    {% endif %}

    <div class="inc-pager">
      <div id="rangeInfo" class="range">—</div>
      <nav aria-label="Paginación incidencias">
        <ul id="pager" class="pagination pagination-sm mb-0"></ul>
      </nav>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Airbag local para [data-submit] ===== */
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('[data-submit]');
    if (!btn) return;
    const sel = btn.getAttribute('data-submit');
    const form = sel ? document.querySelector(sel) : null;
    if (form) {
      if (form.reportValidity && !form.reportValidity()) return;
      if (form.requestSubmit) form.requestSubmit();
      else form.submit();
    }
  });

  /* ====== Helpers ====== */
  const $ = (s,sc)=> (sc||document).querySelector(s);
  const $$ = (s,sc)=> Array.from((sc||document).querySelectorAll(s));
  const escHTML = s => (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  function showToastSafe(t,b,icon){ if(window.showToast) showToast({title:t, body:b||'', icon:icon||'info'}); }

  /* ====== Adjuntos: render robusto desde data-adj ====== */
  function renderAdjuntos(){
    document.querySelectorAll('#incTableBody tr .campo-adjuntos').forEach(cell=>{
      let raw = cell.getAttribute('data-adj');
      let val = null;
      try { val = raw ? JSON.parse(raw) : null; } catch(_){ val = raw; }

      // Soporta: array real, string JSON (p.ej. '["a","b"]'), string simple (una ruta)
      let arr = [];
      if (Array.isArray(val)) {
        arr = val;
      } else if (typeof val === 'string' && val.trim()) {
        try {
          const maybe = JSON.parse(val);
          arr = Array.isArray(maybe) ? maybe : [val];
        } catch(_) {
          arr = [val];
        }
      }

      if(!arr.length){
        cell.innerHTML = '<span class="text-muted">—</span>';
        return;
      }

      const wrap = document.createElement('div');
      wrap.className = 'chips';

      arr.forEach(url=>{
        const s = String(url||'').trim();
        if(!s) return;
        const name = s.split(/[\\/]/).pop();  // basename
        const href = (/^https?:\/\//i.test(s) || s.startsWith('/')) ? s : ('/static/adjuntos_incidencias/' + encodeURIComponent(name));

        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = '<i class="bi bi-paperclip"></i> <a target="_blank" rel="noopener"></a>';
        const a = chip.querySelector('a');
        a.href = href;
        a.textContent = name;
        wrap.appendChild(chip);
      });

      cell.innerHTML = '';
      cell.appendChild(wrap);
    });
  }

  /* ====== Form: contador y validación de adjuntos ====== */
  (function(){
    const $desc = $('#descripcion'), $cnt = $('#descCnt');
    if($desc && $cnt){
      const upd=()=>{ $cnt.textContent = String(($desc.value||'').length); };
      $desc.addEventListener('input', upd); upd();
    }

    const MAX_FILES=10, MAX_TOTAL_MB=25, ALLOWED=/\.(png|jpe?g|gif|webp|pdf|txt|csv|xlsx?|docx?|pptx)$/i;
    const $file = $('#archivo'), $list = $('#selFiles');

    function renderList(files){
      $list.innerHTML = '';
      [...files].forEach((f,i)=>{
        const it = document.createElement('span'); it.className='file-item';
        it.innerHTML = `${escHTML(f.name)} <small class="text-muted">• ${Math.round(f.size/1024)} KB</small> <button type="button" class="rm" title="Quitar" aria-label="Quitar">&times;</button>`;
        it.querySelector('.rm').onclick = ()=>{
          const dt=new DataTransfer();
          [...$file.files].forEach((ff,idx)=>{ if(idx!==i) dt.items.add(ff); });
          $file.files = dt.files; renderList($file.files);
        };
        $list.appendChild(it);
      });
    }

    $file?.addEventListener('change', ()=>{
      const files=[...$file.files];
      const wrong = files.filter(f=>!ALLOWED.test(f.name));
      if(wrong.length){
        showToastSafe('Archivos no permitidos', wrong.map(f=>f.name).join(', '), 'exclamation-triangle');
      }
      const tooMany = files.length > MAX_FILES;
      const totalMB = files.reduce((a,b)=>a+b.size,0)/1024/1024;
      const tooBig  = totalMB > MAX_TOTAL_MB;
      if(tooMany || tooBig || wrong.length){
        const dt=new DataTransfer();
        files.forEach(f=>{ if(ALLOWED.test(f.name)) dt.items.add(f); });
        while(dt.files.length > MAX_FILES) dt.items.remove(dt.files.length-1);
        while([...dt.files].reduce((a,b)=>a+b.size,0)/1024/1024 > MAX_TOTAL_MB && dt.files.length>0){
          dt.items.remove(dt.files.length-1);
        }
        $file.files = dt.files;
      }
      renderList($file.files);
    });

    $('#formInc')?.addEventListener('submit', ()=>{
      const btn = $('#formInc button[type="submit"]');
      if(btn){ btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enviando…'; }
    });
  })();

  /* ====== Listado: búsqueda + filtros + orden + paginación + export ====== */
  const rowsAll = () => $$('#incTableBody tr').map(tr => ({
    tr,
    id: Number(tr.dataset.id || tr.querySelector('.td-id')?.textContent || 0),
    usuario: (tr.dataset.usuario || tr.querySelector('.campo-usuario')?.textContent || '').trim(),
    titulo: (tr.dataset.titulo || tr.querySelector('.campo-titulo')?.textContent || '').trim(),
    descripcion: (tr.dataset.descripcion || tr.querySelector('.campo-descripcion')?.textContent || '').trim(),
    tipo: (tr.dataset.tipo || tr.querySelector('.campo-tipo')?.textContent || '').trim(),
    fecha: (tr.dataset.fecha || tr.querySelector('.campo-fecha')?.textContent || '').trim(),
    estado: (tr.dataset.estado || tr.querySelector('.td-estado')?.textContent || '').trim()
  }));

  const STATE = { term:'', estado:'', tipo:'', order:{by:'fecha', dir:'desc'}, pageSize: parseInt($('#pageSize')?.value||'25',10), page:1, filtered: [] };

  function clearMarksIn(tr){ tr.querySelectorAll('mark.hl').forEach(m=> m.replaceWith(document.createTextNode(m.textContent))); }
  function highlightRow(tr, term){
    if(!term) return;
    const re = new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig');
    ['.campo-usuario','.campo-titulo','.campo-descripcion','.campo-tipo','.campo-fecha'].forEach(sel=>{
      const n = tr.querySelector(sel); if(!n) return;
      n.innerHTML = escHTML(n.textContent).replace(re,'<mark class="hl">$1</mark>');
    });
  }

  function applyFilters(){
    const all = rowsAll();
    const term = (STATE.term||'').toLowerCase().trim();
    const out = all.filter(r=>{
      if(STATE.estado && r.estado.toLowerCase() !== STATE.estado.toLowerCase()) return false;
      if(STATE.tipo && r.tipo.toLowerCase() !== STATE.tipo.toLowerCase()) return false;
      if(term){
        const hay = (r.usuario+' '+r.titulo+' '+r.descripcion+' '+r.tipo+' '+r.fecha+' '+r.estado+' '+r.id).toLowerCase();
        if(!hay.includes(term)) return false;
      }
      return true;
    });

    out.sort((a,b)=>{
      const dir = STATE.order.dir === 'asc' ? 1 : -1;
      const by = STATE.order.by;
      if(by === 'id'){ return (a.id - b.id) * dir; }
      if(by === 'usuario' || by === 'titulo' || by === 'tipo' || by === 'estado'){ return a[by].localeCompare(b[by]) * dir; }
      if(by === 'fecha'){ return a.fecha.localeCompare(b.fecha) * dir; }
      return 0;
    });

    STATE.filtered = out;
    STATE.page = 1;
    render();
  }

  function paginate(arr, page, size){ const i=(page-1)*size; return arr.slice(i, i+size); }

  function render(){
    rowsAll().forEach(r=>{ r.tr.style.display='none'; clearMarksIn(r.tr); });

    const total = STATE.filtered.length;
    const ps = STATE.pageSize;
    const pages = Math.max(1, Math.ceil(total/ps));
    STATE.page = Math.min(STATE.page, pages);

    const pageRows = paginate(STATE.filtered, STATE.page, ps);
    pageRows.forEach(r=>{ r.tr.style.display=''; highlightRow(r.tr, STATE.term); });

    $('#resultCnt').textContent = total ? `(${total} ítems)` : '(0 ítems)';

    const start = total ? ((STATE.page-1)*ps + 1) : 0;
    const end   = total ? Math.min(STATE.page*ps, total) : 0;
    $('#rangeInfo').textContent = total ? `Mostrando ${start}-${end} de ${total}` : '—';

    renderPager(pages);

    $$('#incTable thead th.sortable').forEach(th=>{
      th.classList.toggle('active', th.dataset.sort === STATE.order.by);
      const icon = th.querySelector('.bi');
      if(icon){ icon.className = STATE.order.dir === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'; }
    });
  }

  function renderPager(pages){
    const $pager = $('#pager'); $pager.innerHTML = '';
    const make = (label, page, disabled=false, active=false)=>{
      const li = document.createElement('li'); li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
      const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=label;
      a.onclick=(e)=>{ e.preventDefault(); if(!disabled){ STATE.page = page; render(); } };
      li.appendChild(a); return li;
    };
    $pager.appendChild(make('«', 1, STATE.page===1));
    $pager.appendChild(make('‹', Math.max(1, STATE.page-1), STATE.page===1));
    const win=3, s=Math.max(1, STATE.page-win), e=Math.min(pages, STATE.page+win);
    for(let p=s;p<=e;p++) $pager.appendChild(make(String(p), p, false, p===STATE.page));
    $pager.appendChild(make('›', Math.min(pages, STATE.page+1), STATE.page===pages));
    $pager.appendChild(make('»', pages, STATE.page===pages));
  }

  // Export CSV
  $('#btnExport').addEventListener('click', ()=>{
    const rows = STATE.filtered.map(r=>({ id:r.id, usuario:r.usuario, titulo:r.titulo, descripcion:r.descripcion, tipo:r.tipo, fecha:r.fecha, estado:r.estado }));
    if(!rows.length){ showToastSafe('Exportar', 'No hay resultados para exportar', 'exclamation-triangle'); return; }
    const headers = Object.keys(rows[0]);
    const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
    const csv = [headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`incidencias_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`; a.click(); URL.revokeObjectURL(url);
    showToastSafe('Exportado', 'Se descargó el CSV del filtro actual', 'check2-circle');
  });

  // Restaurar/persistir filtros en hash
  (function(){
    const $q = $('#filterInput');
    let dId=null;
    $q.addEventListener('input', ()=>{ clearTimeout(dId); dId=setTimeout(()=>{ STATE.term = $q.value || ''; applyFilters(); }, 160); });
    $('#filterEstado').addEventListener('change', e=>{ STATE.estado = e.target.value || ''; applyFilters(); });
    $('#filterTipo').addEventListener('change', e=>{ STATE.tipo = e.target.value || ''; applyFilters(); });
    $('#pageSize').addEventListener('change', e=>{ STATE.pageSize = parseInt(e.target.value,10)||25; STATE.page=1; render(); });

    $$('#incTable thead th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const by = th.dataset.sort;
        if(STATE.order.by === by){ STATE.order.dir = (STATE.order.dir === 'asc' ? 'desc' : 'asc'); }
        else { STATE.order.by = by; STATE.order.dir = (by==='id' ? 'desc' : 'asc'); }
        applyFilters();
      });
    });

    try{
      const h = new URLSearchParams(location.hash.replace(/^#/,''));
      if(h.get('q')){ $q.value = decodeURIComponent(h.get('q')); STATE.term = $q.value; }
      if(h.get('estado')){ $('#filterEstado').value = h.get('estado'); STATE.estado = h.get('estado'); }
      if(h.get('tipo')){ $('#filterTipo').value = h.get('tipo'); STATE.tipo = h.get('tipo'); }
    }catch(_){}
    const persistHash = ()=>{
      const p = new URLSearchParams();
      if(STATE.term) p.set('q', STATE.term);
      if(STATE.estado) p.set('estado', STATE.estado);
      if(STATE.tipo) p.set('tipo', STATE.tipo);
      history.replaceState(null,'', '#'+p.toString());
    };
    const _apply = applyFilters;
    applyFilters = function(){ _apply(); persistHash(); };
    _apply();
  })();

  /* ====== Cerrar / Eliminar con fetch + fallback a submit ====== */
  (function(){
    const tbody = document.getElementById('incTableBody');
    if(!tbody) return;

    function busy(btn, on){
      if(!btn) return;
      btn.disabled = !!on;
      if(on){
        btn.dataset._html = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>' + (btn.textContent || '').trim();
      }else if(btn.dataset._html){
        btn.innerHTML = btn.dataset._html;
        delete btn.dataset._html;
      }
    }

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button.action-cerrar, button.action-eliminar');
      if(!btn) return;

      const form = btn.closest('form[action^="/incidencias/"]');
      if(!form) return;

      e.preventDefault(); // intentamos vía fetch primero
      const action = form.action || form.getAttribute('action') || '';
      const method = (form.method || 'POST').toUpperCase();
      const isDelete = /\/eliminar\//.test(action);
      const tr = form.closest('tr');

      try{
        busy(btn, true);
        const headers = { 'X-Requested-With': 'fetch' };
        // Si usás CSRF y lo exponés en base.html: <meta name="csrf-token" content="...">
        const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
        if(csrf) headers['X-CSRF-Token'] = csrf;

        const res = await fetch(action, {
          method,
          credentials: 'same-origin',
          headers
        });

        // Si el backend redirige después de operar, seguimos esa URL
        if(res.redirected){
          location.href = res.url;
          return;
        }

        let data=null; try{ data = await res.clone().json(); }catch(_){}
        if(!res.ok || (data && data.ok === false)){
          throw new Error((data && data.error) || ('HTTP '+res.status));
        }

        if(isDelete){
          tr?.remove();
          showToastSafe('Incidencias', 'Incidencia eliminada', 'check2-circle');
        }else{
          const estadoCell = tr?.querySelector('.td-estado');
          if(estadoCell){
            estadoCell.innerHTML = '<span class="badge-state badge-cerrado">Cerrado</span>';
          }
          form.remove?.();
          showToastSafe('Incidencias', 'Incidencia cerrada', 'check2-circle');
        }

        applyFilters(); // recalcular vista/paginación
      }catch(err){
        // Plan B: envío normal del form
        try{ form.submit(); }catch(__){}
      }finally{
        busy(btn, false);
      }
    }, false);
  })();

  // Al cargar: pintar adjuntos.
  document.addEventListener('DOMContentLoaded', renderAdjuntos);
</script>
{% endblock %}
