{% extends "base.html" %}
{% block title %}Incidencias – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ——— Encabezado + coherencia visual con el home ——— */
  .inc-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .inc-head .hero-title{ margin:0; }

  /* Campos “neo” como el home */
  .form-neo .form-control,
  .form-neo .form-select,
  .form-neo textarea {
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
    box-shadow:0 1px 0 rgba(15,18,34,.02);
  }
  .form-neo .form-control:focus,
  .form-neo .form-select:focus,
  .form-neo textarea:focus {
    border-color:rgba(139,92,246,.55);
    box-shadow:0 0 0 .25rem rgba(139,92,246,.18);
  }

  /* Botones a juego con el home */
  .btn-primary{
    border:none; border-radius:12px;
    background:linear-gradient(135deg, var(--accent-a), var(--accent-b));
    box-shadow:0 10px 24px rgba(139,92,246,.24);
  }
  .btn-outline-primary{
    border-radius:12px; border-color:var(--accent-a); color:var(--accent-a);
  }
  .btn-outline-primary:hover{
    color:#fff; background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); border-color:transparent;
  }
  .btn-soft{ border-radius:12px; border:1px solid var(--border); background:#f6f8ff; }

  /* Tabla & chips de adjuntos */
  .table thead th{ position:sticky; top:0; background:#fff; z-index:1; }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; background:#fff;
    border:1px solid var(--border); font-size:12px;
  }
  .chip a{ text-decoration:none; }
  .chip .bi{ font-size:14px; }

  /* Badges de estado */
  .badge-state{ border-radius:999px; font-weight:600; padding:.35rem .6rem; }
  .badge-abierto{ background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
  .badge-cerrado{ background:#ecfdf5; color:#065f46; border:1px solid #b7f0db; }

  /* Filtro */
  #filterInput{ max-width:260px; }
  mark.hl{ background:#fff3bf; padding:0 .15em; border-radius:4px; }

  .file-hint{ color:var(--muted); }
</style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="inc-head mb-3">
    <h1 class="hero-title"><i class="bi bi-tools me-2"></i> Gestión de incidencias</h1>
    <a href="/" class="btn btn-soft">← Volver</a>
  </div>

  <!-- Crear incidencia -->
  <div class="cardx mb-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="title"><i class="bi bi-wrench-adjustable-circle"></i> Nueva incidencia</div>
      <span class="subtle">Reportá un problema o solicitud</span>
    </div>

    <form method="post" action="/incidencias" enctype="multipart/form-data" class="row g-3 form-neo">
      <div class="col-12 col-md-6">
        <label for="titulo" class="form-label">Título</label>
        <input type="text" class="form-control" id="titulo" name="titulo" placeholder="Ej: No puedo subir pliegos…" required>
      </div>

      <div class="col-12 col-md-3">
        <label for="tipo" class="form-label">Categoría</label>
        <select class="form-select" id="tipo" name="tipo" required>
          <option value="Técnica" selected>Técnica</option>
          <option value="Acceso">Acceso</option>
          <option value="Datos">Datos</option>
          <option value="Solicitud">Solicitud</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="col-12">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea class="form-control" id="descripcion" name="descripcion" rows="6"
          placeholder="Contanos qué pasó, pasos para reproducir y qué esperabas que suceda…" required></textarea>
      </div>

      <div class="col-12">
        <label for="archivo" class="form-label">Adjuntar archivos (opcional)</label>
        <input class="form-control" type="file" name="archivos" id="archivo" multiple
               accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.txt,.csv,.xlsx,.xls,.docx,.doc,.pptx">
        <div class="form-text file-hint">Imágenes, PDF, Word, Excel, etc.</div>
      </div>

      <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i> Crear incidencia</button>
        <button type="reset" class="btn btn-outline-secondary"><i class="bi bi-eraser me-1"></i> Limpiar</button>
      </div>
    </form>
  </div>

  <!-- Listado -->
  <div class="cardx">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="title"><i class="bi bi-journal-text"></i> Incidencias registradas</div>
      <input id="filterInput" class="form-control form-control-sm" placeholder="Filtrar por texto…">
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th class="text-nowrap">ID</th>
            <th class="text-nowrap">Usuario</th>
            <th class="text-nowrap">Título</th>
            <th>Descripción</th>
            <th class="text-nowrap">Categoría</th>
            <th class="text-nowrap">Fecha</th>
            <th class="text-nowrap">Adjuntos</th>
            <th class="text-nowrap">Estado</th>
            <th class="text-nowrap">Acciones</th>
          </tr>
        </thead>
        <tbody id="incTableBody">
          {% for ticket in tickets %}
          <tr>
            <td class="text-muted">{{ ticket.id }}</td>
            <td class="campo-usuario">{{ ticket.usuario }}</td>
            <td class="fw-semibold campo-titulo">{{ ticket.titulo }}</td>
            <td class="small campo-descripcion">{{ ticket.descripcion }}</td>
            <td><span class="badge bg-primary-subtle text-primary campo-tipo">{{ ticket.tipo }}</span></td>
            <td class="text-nowrap campo-fecha">{{ ticket.fecha_legible }}</td>
            <td class="small campo-adjuntos">
              {% if ticket.adjuntos %}
                <div class="chips">
                  {% for file in ticket.adjuntos %}
                    <span class="chip">
                      <i class="bi bi-paperclip"></i>
                      <a href="/static/adjuntos_incidencias/{{ file }}" target="_blank" rel="noopener">
                        {{ file.split('_')[-1] }}
                      </a>
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if ticket.estado == 'Cerrado' %}
                <span class="badge-state badge-cerrado">Cerrado</span>
              {% else %}
                <span class="badge-state badge-abierto">Abierto</span>
              {% endif %}
            </td>
            <td class="text-nowrap">
              {% if ticket.estado != 'Cerrado' %}
              <form method="post" action="/incidencias/cerrar/{{ ticket.id }}" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-success">
                  <i class="bi bi-check2-circle me-1"></i> Cerrar
                </button>
              </form>
              {% else %}
              <span class="text-muted small">—</span>
              {% endif %}

              {% if usuario_actual.rol == 'admin' %}
              <form method="post" action="/incidencias/eliminar/{{ ticket.id }}" class="d-inline ms-1"
                    onsubmit="return confirm('¿Eliminar incidencia #{{ ticket.id }}?');">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash me-1"></i> Eliminar
                </button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if tickets|length == 0 %}
      <div class="text-center text-body-secondary py-3">No hay incidencias registradas.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Filtro con resaltado ===== */
  (function(){
    const $input = document.getElementById('filterInput');
    const $body  = document.getElementById('incTableBody');
    if(!$input || !$body) return;

    let t;
    const esc = s => (s||'').toString().replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const clearMarks = tr => tr.querySelectorAll('mark.hl').forEach(m=> m.replaceWith(document.createTextNode(m.textContent)));
    const highlight = (el, term) => {
      if(!term) return;
      const re = new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig');
      ['.campo-usuario','.campo-titulo','.campo-descripcion','.campo-tipo','.campo-fecha'].forEach(sel=>{
        const n = el.querySelector(sel); if(!n) return;
        n.innerHTML = esc(n.textContent).replace(re,'<mark class="hl">$1</mark>');
      });
    };

    function apply(){
      const q = ($input.value||'').trim().toLowerCase();
      $body.querySelectorAll('tr').forEach(tr=>{
        clearMarks(tr);
        const show = !q || tr.innerText.toLowerCase().includes(q);
        tr.style.display = show ? '' : 'none';
        if(show && q) highlight(tr, q);
      });
    }
    $input.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(apply, 160); });
  })();

  /* Toasts por querystring (opcional) */
  (function(){
    const p = new URLSearchParams(location.search);
    if(p.get('created')==='1')  showToast({title:'Incidencia creada', body:'Se registró correctamente.', icon:'check2-circle'});
    if(p.get('closed')==='1')   showToast({title:'Incidencia cerrada', body:'Se marcó como resuelta.', icon:'check2-circle'});
    if(p.get('deleted')==='1')  showToast({title:'Incidencia eliminada', body:'Se eliminó correctamente.', icon:'trash'});
  })();
</script>
{% endblock %}
