{% extends "base.html" %}
{% block title %}Incidencias ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  .inc-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .inc-head .hero-title{ margin:0; }

  .file-hint{ color:var(--text-2); }

  /* Tabla & chips de adjuntos */
  .table thead th{ position:sticky; top:0; background:#fff; z-index:1; }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; background:var(--bg-soft);
    border:1px solid var(--border);
    font-size:12px;
  }
  .chip a{ text-decoration:none; }
  .chip .bi{ font-size:14px; }

  /* Filtro */
  #filterInput{ max-width:260px; }
  mark.hl{ background:#fff3bf; padding:0 .15em; border-radius:4px; }
</style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="inc-head mb-3">
    <h1 class="hero-title"><i class="bi bi-tools me-2"></i> Gesti√≥n de incidencias</h1>
    <a href="/" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
  </div>

  <!-- Crear incidencia -->
  <div class="card card-clean shadow-hover mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>Nueva incidencia</strong>
      <span class="subtle">Report√° un problema o solicitud</span>
    </div>
    <div class="card-body">
      <form method="post" action="/incidencias" enctype="multipart/form-data" class="row g-3">
        <div class="col-12 col-md-6">
          <label for="titulo" class="form-label">T√≠tulo</label>
          <input type="text" class="form-control" id="titulo" name="titulo" required>
        </div>
        <div class="col-12 col-md-3">
          <label for="tipo" class="form-label">Categor√≠a</label>
          <select class="form-select" id="tipo" name="tipo" required>
            <option value="T√©cnica">T√©cnica</option>
            <option value="Acceso">Acceso</option>
            <option value="Datos">Datos</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="col-12">
          <label for="descripcion" class="form-label">Descripci√≥n</label>
          <textarea class="form-control" id="descripcion" name="descripcion" rows="4" required></textarea>
        </div>
        <div class="col-12">
          <label for="archivo" class="form-label">Adjuntar archivos (opcional)</label>
          <input class="form-control" type="file" name="archivos" id="archivo" multiple>
          <div class="form-text file-hint">Im√°genes, PDF, Word, Excel, etc.</div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Crear incidencia</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Listado -->
  <div class="card card-clean shadow-hover">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>üìã Incidencias registradas</strong>
      <div class="d-flex gap-2 align-items-center">
        <input id="filterInput" class="form-control form-control-sm" placeholder="Filtrar por texto‚Ä¶">
      </div>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th class="text-nowrap">ID</th>
              <th class="text-nowrap">Usuario</th>
              <th class="text-nowrap">T√≠tulo</th>
              <th>Descripci√≥n</th>
              <th class="text-nowrap">Categor√≠a</th>
              <th class="text-nowrap">Fecha</th>
              <th class="text-nowrap">Adjuntos</th>
              <th class="text-nowrap">Estado</th>
              <th class="text-nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="incTableBody">
            {% for ticket in tickets %}
            <tr>
              <td class="text-muted">{{ ticket.id }}</td>
              <td class="campo-usuario">{{ ticket.usuario }}</td>
              <td class="fw-semibold campo-titulo">{{ ticket.titulo }}</td>
              <td class="small campo-descripcion">{{ ticket.descripcion }}</td>
              <td><span class="badge bg-primary-subtle text-primary campo-tipo">{{ ticket.tipo }}</span></td>
              <td class="text-nowrap campo-fecha">{{ ticket.fecha_legible }}</td>
              <td class="small campo-adjuntos">
                {% if ticket.adjuntos %}
                  <div class="chips">
                    {% for file in ticket.adjuntos %}
                      <span class="chip">
                        <i class="bi bi-paperclip"></i>
                        <a href="/static/adjuntos_incidencias/{{ file }}" download>
                          {{ file[ file.find('_', file.find('_')+1)+1: ] }}
                        </a>
                      </span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>
                {% if ticket.estado == 'Abierto' %}
                  <span class="badge bg-warning-subtle text-warning">Abierto</span>
                {% else %}
                  <span class="badge bg-success-subtle text-success">Resuelto</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% if ticket.estado == 'Abierto' %}
                <form method="post" action="/incidencias/cerrar/{{ ticket.id }}" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-outline-success">Cerrar</button>
                </form>
                {% else %}
                <span class="text-muted small">‚Äî</span>
                {% endif %}

                {% if usuario_actual.rol == 'admin' %}
                <form method="post" action="/incidencias/eliminar/{{ ticket.id }}" class="d-inline ms-1" onsubmit="return confirm('¬øEliminar incidencia #{{ ticket.id }}?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if tickets|length == 0 %}
        <div class="text-center text-body-secondary py-3">No hay incidencias registradas.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ====== Filtro con resaltado ====== */
  (function(){
    const $input = document.getElementById('filterInput');
    const $body  = document.getElementById('incTableBody');
    if(!$input || !$body) return;

    let t;
    const escapeHtml = s => (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const clearMarks = tr => tr.querySelectorAll('mark.hl').forEach(m=> m.replaceWith(document.createTextNode(m.textContent)));
    const highlight = (el, term) => {
      if(!term) return;
      const re = new RegExp('('+term.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')+')','ig');
      ['.campo-usuario','.campo-titulo','.campo-descripcion','.campo-tipo','.campo-fecha'].forEach(sel=>{
        const n = el.querySelector(sel); if(!n) return;
        n.innerHTML = escapeHtml(n.textContent).replace(re,'<mark class="hl">$1</mark>');
      });
    };

    function applyFilter(){
      const q = ($input.value||'').trim().toLowerCase();
      $body.querySelectorAll('tr').forEach(tr=>{
        clearMarks(tr);
        const text = tr.innerText.toLowerCase();
        const show = !q || text.includes(q);
        tr.style.display = show ? '' : 'none';
        if(show && q) highlight(tr, q);
      });
    }
    $input.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(applyFilter, 160); });
  })();

  /* ====== Toasts por querystring ====== */
  (function(){
    const p = new URLSearchParams(location.search);
    if(p.get('created')==='1')  showToast({title:'Incidencia creada', body:'Se registr√≥ correctamente.', icon:'check2-circle'});
    if(p.get('closed')==='1')   showToast({title:'Incidencia cerrada', body:'Se marc√≥ como resuelta.', icon:'check2-circle'});
    if(p.get('deleted')==='1')  showToast({title:'Incidencia eliminada', body:'Se elimin√≥ correctamente.', icon:'trash'});
  })();
</script>
{% endblock %}
