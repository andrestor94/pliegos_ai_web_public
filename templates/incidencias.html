{% extends "base.html" %}
{% block title %}Incidencias ‚Äì Suizo Argentina{% endblock %}

{% block content %}
<div class="py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="hero-title mb-0"><i class="bi bi-tools me-2"></i> Gesti√≥n de incidencias</h1>
    <a href="/" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
  </div>

  <!-- Crear incidencia -->
  <div class="card card-clean shadow-hover mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>Nueva incidencia</strong>
      <span class="subtle">Report√° un problema o solicitud</span>
    </div>
    <div class="card-body">
      <form method="post" action="/incidencias" enctype="multipart/form-data" class="row g-3">
        <div class="col-12 col-md-6">
          <label for="titulo" class="form-label">T√≠tulo</label>
          <input type="text" class="form-control" id="titulo" name="titulo" required>
        </div>
        <div class="col-12 col-md-3">
          <label for="tipo" class="form-label">Categor√≠a</label>
          <select class="form-select" id="tipo" name="tipo" required>
            <option value="T√©cnica">T√©cnica</option>
            <option value="Acceso">Acceso</option>
            <option value="Datos">Datos</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="col-12">
          <label for="descripcion" class="form-label">Descripci√≥n</label>
          <textarea class="form-control" id="descripcion" name="descripcion" rows="4" required></textarea>
        </div>
        <div class="col-12">
          <label for="archivo" class="form-label">Adjuntar archivos (opcional)</label>
          <input class="form-control" type="file" name="archivos" id="archivo" multiple>
          <div class="form-text">Im√°genes, PDF, Word, Excel, etc.</div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Crear incidencia</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Listado -->
  <div class="card card-clean shadow-hover">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>üìã Incidencias registradas</strong>
      <div class="d-flex gap-2 align-items-center">
        <input id="filterInput" class="form-control form-control-sm" placeholder="Filtrar por texto..." style="max-width:240px">
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th class="text-nowrap">ID</th>
              <th class="text-nowrap">Usuario</th>
              <th class="text-nowrap">T√≠tulo</th>
              <th>Descripci√≥n</th>
              <th class="text-nowrap">Categor√≠a</th>
              <th class="text-nowrap">Fecha</th>
              <th class="text-nowrap">Adjuntos</th>
              <th class="text-nowrap">Estado</th>
              <th class="text-nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="incTableBody">
            {% for ticket in tickets %}
            <tr>
              <td class="text-muted">{{ ticket.id }}</td>
              <td>{{ ticket.usuario }}</td>
              <td class="fw-semibold">{{ ticket.titulo }}</td>
              <td class="small">{{ ticket.descripcion }}</td>
              <td><span class="badge bg-primary-subtle text-primary">{{ ticket.tipo }}</span></td>
              <td class="text-nowrap">{{ ticket.fecha_legible }}</td>
              <td class="small">
                {% if ticket.adjuntos %}
                  {% for file in ticket.adjuntos %}
                    <a class="d-block" href="/static/adjuntos_incidencias/{{ file }}" download>
                      üìé {{ file[ file.find('_', file.find('_')+1)+1: ] }}
                    </a>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>
                {% if ticket.estado == 'Abierto' %}
                  <span class="badge bg-warning-subtle text-warning">Abierto</span>
                {% else %}
                  <span class="badge bg-success-subtle text-success">Resuelto</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% if ticket.estado == 'Abierto' %}
                <form method="post" action="/incidencias/cerrar/{{ ticket.id }}" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-outline-success">Cerrar</button>
                </form>
                {% else %}
                <span class="text-muted small">‚Äî</span>
                {% endif %}

                {% if usuario_actual.rol == 'admin' %}
                <form method="post" action="/incidencias/eliminar/{{ ticket.id }}" class="d-inline ms-1" onsubmit="return confirm('¬øEliminar incidencia #{{ ticket.id }}?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if tickets|length == 0 %}
        <div class="text-center text-body-secondary py-3">No hay incidencias registradas.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Filtro simple por texto en el listado
  (function(){
    const input = document.getElementById('filterInput');
    const body  = document.getElementById('incTableBody');
    if(!input || !body) return;
    input.addEventListener('input', ()=>{
      const q = input.value.toLowerCase();
      body.querySelectorAll('tr').forEach(tr=>{
        tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  })();
</script>
{% endblock %}
