<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}Suizo Argentina – Licitaciones IA{% endblock %}</title>

  <!-- Aplica tema ANTES de pintar para evitar FOUC -->
  <script>
    (function(){
      try{
        const t = localStorage.getItem('theme'); // 'light' | 'dark' | null(sistema)
        if(t === 'light' || t === 'dark'){
          document.documentElement.setAttribute('data-theme', t);
        }else{
          document.documentElement.removeAttribute('data-theme'); // sistema
        }
      }catch(_){}
    })();
  </script>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <style>
    :root{
      --grad-a:#7c3aed; --grad-b:#ec4899; --grad-c:#2563eb;
      --panel:#ffffff; --ink:#0f1222; --muted:#667085; --border:#e7e9f2;
      --accent-a:#8b5cf6; --accent-b:#f472b6; --accent-c:#22d3ee;
      --pill:#f0f3ff; --radius:22px; --shadow:0 12px 32px rgba(20,15,55,.16);
      --bg-body:#f7f8ff;
      --sidebar-grad-a:#0f172a; --sidebar-grad-b:#0b1220;
      --chip-bg:#f6f7fe;
      --sidebar-w: 74px;
      --drawer-w: 280px; /* ancho del drawer en móviles/tablets */
      --header-h: 76px;
    }
    /* Modo oscuro global (forzado por atributo) */
    [data-theme="dark"]{
      --panel:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2a44;
      --pill:#111a33; --shadow:0 12px 32px rgba(0,0,0,.45);
      --bg-body:#0b1328;
      --sidebar-grad-a:#0a0f20; --sidebar-grad-b:#070c18;
      --chip-bg:#0f172a;
    }

    html, body { height:100%; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      overflow:hidden;
      background:var(--panel);
    }

    /* ===== Shell / Layout normal ===== */
    .shell{ width:100vw; height:100vh; margin:0; background:var(--panel); border-radius:0; border:none; box-shadow:none; overflow:hidden; display:block; }
    .app{
      height:100%;
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-rows: var(--header-h) 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar content";
    }

    /* ===== Sidebar ===== */
    .sidebar{
      grid-area:sidebar;
      display:flex; flex-direction:column; align-items:center;
      width:var(--sidebar-w); padding:14px 8px;
      background: linear-gradient(180deg, var(--sidebar-grad-a), var(--sidebar-grad-b));
      border-radius: 0 26px 26px 0;
      box-shadow: 0 10px 26px rgba(2,6,23,.34), inset 0 0 0 1px rgba(255,255,255,.04);
      color:#fff;
      height: calc(100% - 10vh);
      margin: auto 0;
      z-index: 1020;
    }
    [data-theme="dark"] .sidebar{
      box-shadow: 0 10px 26px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .side-logo{
      width:46px; height:46px; border-radius:12px;
      background:#fff; display:grid; place-items:center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .side-logo img{ width:30px; height:30px; object-fit:contain; }

    .side-nav{ display:flex; flex-direction:column; gap:8px; align-items:center; width:100%; margin-top:8px; }

    .side-btn{
      width:44px; height:44px;
      border-radius:12px; display:grid; place-items:center;
      color:#cbd5e1; font-size:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
      text-decoration:none;
    }
    .side-btn:hover{ transform:translateY(-2px); color:#fff; box-shadow:0 12px 22px rgba(0,0,0,.28); background:rgba(255,255,255,.08); }
    .side-btn.active{ color:#fff; background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); border-color:transparent; box-shadow:0 10px 22px rgba(139,92,246,.35); }

    .side-spacer{ flex:1; }
    .side-small{ color:#94a3b8; font-size:11px; }

    /* ===== Header ===== */
    .header{
      grid-area:header;
      display:flex; align-items:center; gap:12px;
      padding:12px 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.92), rgba(255,255,255,.92));
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 1030;
    }
    [data-theme="dark"] .header{
      background:linear-gradient(0deg, rgba(11,18,32,.92), rgba(11,18,32,.92));
    }

    /* Botón hamburguesa (visible en móviles/tablets) */
    .menu-btn{
      display:none;
      width:42px; height:42px; border-radius:12px;
      border:1px solid var(--border);
      background:#fff; color:var(--ink);
      align-items:center; justify-content:center;
    }
    [data-theme="dark"] .menu-btn{ background:#0b1220; color:#e5e7eb; }
    @media (max-width: 992px){
      .menu-btn{ display:inline-flex; }
    }

    /* Brand: sólo logo + “Licitaciones IA” */
    .brand{ display:flex; align-items:center; gap:14px; padding:8px 14px; border-radius:16px; border:1px solid var(--border); background:#fff; }
    .brand img{ height:34px; width:auto; object-fit:contain; }
    .brand .brand-title{ font-weight:700; letter-spacing:.2px; }
    [data-theme="dark"] .brand{ background:#0b1220; }

    .header-actions{ margin-left:auto; display:flex; align-items:center; gap:10px; }
    .pill{ position:relative; border-radius:999px; padding:.55rem 1rem; border:1px solid var(--border); background:var(--pill); color:var(--ink); font-weight:500; text-decoration:none; }
    .pill-grad{ border:none; color:#fff; background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); box-shadow:0 12px 26px rgba(139,92,246,.32); }
    .pill-icon{ display:inline-flex; align-items:center; gap:.5rem; }
    .icon-btn{ position:relative; width:44px; height:44px; display:grid; place-items:center; border-radius:14px; border:1px solid var(--border); background:#fff; color:var(--ink); }
    [data-theme="dark"] .icon-btn{ background:#0b1220; color:#e5e7eb; border-color:var(--border); }
    .icon-badge{
      position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; padding:0 4px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:11px; line-height:18px; text-align:center;
      display:none;
    }
    /* Badge para “Chat interno” */
    .chat-badge{
      position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 4px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:11px; line-height:18px; text-align:center;
      display:none;
    }

    /* Usuario (nombre + avatar) */
    .user-box{ display:flex; align-items:center; gap:10px; margin-left:6px; }
    .user-name{ font-weight:600; color:var(--ink); }
    .user-avatar{
      width:40px; height:40px; border-radius:999px; overflow:hidden; position:relative;
      border:1px solid var(--border); background:#e2e8f0; display:grid; place-items:center; cursor:pointer;
      user-select:none;
    }
    .user-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .user-avatar .initials{ font-weight:700; color:#334155; }
    [data-theme="dark"] .user-avatar{ background:#111827; }
    .user-avatar:hover{ box-shadow:0 8px 20px rgba(0,0,0,.12); }

    /* ===== Content ===== */
    .content{
      grid-area:content;
      position:relative;
      padding:24px;
      min-height:0;
      height:100%;
      overflow:auto;
      background:
        radial-gradient(900px 660px at 16% 16%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(1000px 720px at 84% 80%, rgba(236,72,153,.12), transparent 60%),
        radial-gradient(780px 560px at 76% 8%, rgba(124,58,237,.10), transparent 60%),
        var(--bg-body);
    }
    [data-theme="dark"] .content{
      background:
        radial-gradient(900px 660px at 16% 16%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(1000px 720px at 84% 80%, rgba(236,72,153,.14), transparent 60%),
        radial-gradient(780px 560px at 76% 8%, rgba(124,58,237,.12), transparent 60%),
        var(--bg-body);
    }

    .cardx{ background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:16px; position:relative; }
    .cardx .title{ font-weight:700; display:flex; align-items:center; gap:8px; }
    [data-theme="dark"] .cardx{ background:#0b1220; }

    .muted{ color:var(--muted); }
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .col-3{ grid-column: span 3; } .col-4{ grid-column: span 4; } .col-5{ grid-column: span 5; }
    .col-6{ grid-column: span 6; } .col-7{ grid-column: span 7; } .col-8{ grid-column: span 8; } .col-12{ grid-column: span 12; }

    @media (max-width: 1200px){ .col-5,.col-4,.col-3{ grid-column: span 6; } }

    /* ====== Drawer Mobile / Tablet ======
       En < 992px la sidebar pasa a drawer deslizante, con overlay.
    */
    @media (max-width: 991.98px){
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: var(--header-h) 1fr;
        grid-template-areas:
          "header"
          "content";
      }
      .sidebar{
        position: fixed;
        top: 0; left: 0;
        height: 100dvh;
        width: min(var(--drawer-w), 88vw);
        max-width: 92vw;
        padding: 16px 10px;
        margin: 0;
        border-radius: 0 22px 22px 0;
        transform: translateX(-100%);
        transition: transform .25s ease;
      }
      .sidebar.open{ transform: translateX(0); }
      .sidebar .close-drawer{
        display: inline-flex;
        align-items:center; justify-content:center;
        width:36px; height:36px; border-radius:10px;
        border:1px solid rgba(255,255,255,.12);
        color:#fff; background:rgba(255,255,255,.06);
        margin: 2px 0 10px auto;
      }
      .sidebar-overlay{
        position: fixed;
        inset: 0;
        background: rgba(15,18,34,.35);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity .2s ease;
        z-index: 1010;
      }
      .sidebar-overlay.open{
        opacity: 1;
        pointer-events: auto;
      }
    }

    /* Inputs y tablas en dark/light */
    input.form-control, select.form-select, textarea.form-control{
      background:#fff; color:#111827; border:1px solid var(--border); border-radius:12px;
    }
    [data-theme="dark"] input.form-control,
    [data-theme="dark"] select.form-select,
    [data-theme="dark"] textarea.form-control{
      background:#0b1220; color:#e5e7eb; border:1px solid var(--border);
    }
    .table thead{ background:#f6f7fe; }
    [data-theme="dark"] .table thead{ background:#0f172a; }

    /* Toasts */
    .toast-container{ position:fixed; right:16px; bottom:16px; z-index:1200; }
    .toast{ border-radius:12px; box-shadow:var(--shadow); }
    .toast-header{ border-bottom:none; }

    /* ===== LOGIN / AUTH MODE ===== */
    body[data-auth="1"] .app{ grid-template-columns: 1fr; grid-template-rows: 1fr; grid-template-areas: "content"; }
    body[data-auth="1"] .sidebar, body[data-auth="1"] .header{ display:none !important; }
    body[data-auth="1"] .content{
      display:grid; place-items:center; padding:24px;
      background: linear-gradient(180deg,#f6f8ff 0%, #eef3ff 100%);
    }
    @media (prefers-color-scheme: dark){
      body[data-auth="1"] .content{ background: linear-gradient(180deg,#0b1020 0%, #0b1328 100%); }
    }

    /* ===== Chat IA (drawer derecho) ===== */
    .chat-ia-overlay{
      position:fixed; inset:0; background:rgba(15,18,34,.28); backdrop-filter: blur(2px);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:1200;
    }
    .chat-ia{
      position:fixed; top:0; right:-480px; height:100%; width:480px; max-width:100%;
      background:#fff; border-left:1px solid var(--border); box-shadow: var(--shadow);
      display:flex; flex-direction:column; transition:right .28s ease; z-index:1201;
    }
    [data-theme="dark"] .chat-ia{ background:#0b1220; }
    .chat-ia.open{ right:0; }
    .chat-ia-overlay.open{ opacity:1; pointer-events:auto; }

    .chat-ia__header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.96), rgba(255,255,255,.96));
    }
    [data-theme="dark"] .chat-ia__header{
      background:linear-gradient(0deg, rgba(11,18,32,.96), rgba(11,18,32,.96));
    }
    .chat-ia__title{ font-weight:700; display:flex; align-items:center; gap:8px; }
    .chat-ia__close{ border:1px solid var(--border); background:#fff; border-radius:10px; width:36px; height:36px; display:grid; place-items:center; }
    [data-theme="dark"] .chat-ia__close{ background:#0b1220; color:#e5e7eb; }

    .chat-ia__body{
      flex:1; overflow:auto; padding:14px; background:
      radial-gradient(700px 520px at 84% 12%, rgba(236,72,153,.10), transparent 60%),
      radial-gradient(600px 420px at 8% 88%, rgba(37,99,235,.10), transparent 60%),
      #f8f9ff;
      scroll-behavior: smooth;
    }
    [data-theme="dark"] .chat-ia__body{
      background:
      radial-gradient(700px 520px at 84% 12%, rgba(236,72,153,.12), transparent 60%),
      radial-gradient(600px 420px at 8% 88%, rgba(37,99,235,.12), transparent 60%),
      #0b1328;
    }
    .msg{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:10px 12px; margin-bottom:10px; }
    .msg.ai{ background:linear-gradient(180deg,#ffffff,#fbfdff); }
    .msg.me{ background:#eff4ff; border-color:#dfe6ff; }
    [data-theme="dark"] .msg{ background:#0f172a; }

    .msg.typing{ display:flex; align-items:center; gap:8px; }
    .typing-dot{
      display:inline-block; width:6px; height:6px; border-radius:50%;
      background:#94a3b8; opacity:.6; animation: blink 1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes blink{
      0%, 60%, 100%{ transform: translateY(0); opacity:.35; }
      30%{ transform: translateY(-3px); opacity:.9; }
    }

    .chat-ia__composer{
      padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; background:#fff;
    }
    [data-theme="dark"] .chat-ia__composer{ background:#0b1220; }
    .chat-ia__composer textarea{
      resize:none; height:46px; flex:1; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; color:#111827;
    }
    [data-theme="dark"] .chat-ia__composer textarea{ background:#0b1220; color:#e5e7eb; }

    .chat-ia__send{
      border:none; border-radius:999px; padding:0 16px; min-width:120px;
      background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); color:#fff;
      box-shadow:0 12px 26px rgba(139,92,246,.22);
    }

    /* ===== FullCalendar (si se usa) ===== */
    .fc { --fc-border-color: var(--border); --fc-page-bg-color: transparent; }
    .fc .fc-toolbar-title{ font-weight:700; color:#111827; }
    [data-theme="dark"] .fc .fc-toolbar-title{ color:#e5e7eb; }
    .fc .fc-button{
      background: linear-gradient(135deg, var(--accent-a), var(--accent-b));
      border-color: transparent; color:#fff; box-shadow: 0 6px 16px rgba(139,92,246,.22);
    }
    .fc .fc-button:disabled{ opacity:.55; }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active{
      background: linear-gradient(135deg, var(--accent-b), var(--accent-a)); border-color: transparent;
    }
    .fc .fc-daygrid-day-number{ color:#475569; font-weight:600; }
    [data-theme="dark"] .fc .fc-daygrid-day-number{ color:#cbd5e1; }
    .fc .fc-daygrid-day.fc-day-today{
      background: linear-gradient(180deg, #fff, #fbfdff); box-shadow: inset 0 0 0 1px var(--border);
    }
    [data-theme="dark"] .fc .fc-daygrid-day.fc-day-today{
      background: linear-gradient(180deg, #0b1220, #0f172a);
    }
    .fc .fc-highlight{ background: rgba(139,92,246,.16); }

    /* Ocultar FAB externo si existe */
    #chatOpenAiFab, .chat-openai-fab, [data-chat-fab]{ display:none !important; }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body data-auth="{{ '1' if request and request.url.path.startswith('/login') else '' }}"
      data-route="{{ request.url.path if request else '' }}">

  <script>
    (function(){
      try{
        var r = document.body.getAttribute('data-route') || location.pathname;
        if (r.indexOf('/login') === 0) document.body.setAttribute('data-auth','1');
      }catch(e){}
    })();
  </script>

  <div class="shell">
    <div class="app">
      <!-- ===== Sidebar (drawer en mobile) ===== -->
      <aside class="sidebar" id="sidebar" aria-hidden="false" aria-label="Navegación lateral">
        <!-- Botón cerrar (solo visible en mobile) -->
        <button class="close-drawer d-none d-lg-none" id="btnCloseDrawer" aria-label="Cerrar menú">
          <i class="bi bi-x-lg"></i>
        </button>

        <div class="side-logo" title="Suizo Argentina">
          <img src="/static/logo-suizo.png" alt="Suizo"/>
        </div>

        <nav class="side-nav">
          <a class="side-btn" data-match="/"               href="/"               title="Inicio"><i class="bi bi-house"></i></a>
          <a class="side-btn" data-match="/chat"           href="/chat"           title="Chat interno"><i class="bi bi-chat-dots"></i></a>
          <a class="side-btn" data-match="/incidencias"    href="/incidencias"    title="Incidencias"><i class="bi bi-bug"></i></a>
          <a class="side-btn" data-match="/calendario"     href="/calendario"     title="Calendario"><i class="bi bi-calendar-event"></i></a>

          <!-- Historial: usa ruta alias; si ya estamos en Home, hacemos scroll sin recargar -->
          <a class="side-btn" id="btnHistorial" href="/historia" title="Historial">
            <i class="bi bi-clock-history"></i>
          </a>

          {# ✅ SOLO ADMIN: Auditoría y Admin #}
          {% if request.session.get('rol', 'usuario') == 'admin' %}
            <a class="side-btn" data-match="/auditoria" href="/auditoria" title="Auditoría" data-admin-only>
              <i class="bi bi-clipboard-data"></i>
            </a>
            <a class="side-btn" data-match="/admin" href="/admin" title="Admin" data-admin-only>
              <i class="bi bi-gear"></i>
            </a>
          {% endif %}
        </nav>

        <div class="side-spacer"></div>

        <a class="side-btn" data-match="/cambiar-password" href="/cambiar-password" title="Cambiar contraseña"><i class="bi bi-key"></i></a>
        <a class="side-btn" href="#" id="btnSalir" title="Salir"><i class="bi bi-box-arrow-right"></i></a>
        <div class="side-small">v1</div>
      </aside>

      <!-- Overlay del drawer (solo mobile) -->
      <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

      <!-- ===== Header ===== -->
      <header class="header">
        <!-- Botón hamburguesa (abre drawer en mobile/tablet) -->
        <button class="menu-btn" id="btnOpenDrawer" aria-label="Abrir menú" aria-controls="sidebar" aria-expanded="false">
          <i class="bi bi-list"></i>
        </button>

        <!-- Brand -->
        <div class="brand">
          <img src="/static/logo-suizo.png" alt="Logo Suizo">
          <div class="brand-title">Licitaciones IA</div>
        </div>

        <div class="header-actions">
          <!-- Selector de tema global -->
          <button class="icon-btn" id="btnTheme" title="Tema: Sistema">
            <i id="icoTheme" class="bi bi-circle-half"></i>
          </button>

          <!-- Usuarios activos -->
          <button class="icon-btn" id="btnPresence" title="Usuarios activos">
            <i class="bi bi-people"></i>
            <span id="presenceBadge" class="icon-badge">0</span>
          </button>

          <!-- Notificaciones -->
          <button class="icon-btn" id="btnNotif" title="Notificaciones">
            <i class="bi bi-bell"></i>
            <span id="notifBadge" class="icon-badge">0</span>
          </button>

          <!-- Chat interno con badge de no leídos -->
          <a class="pill pill-icon" href="/chat" id="btnChat">
            <i class="bi bi-chat-dots"></i> Chat interno
            <span id="chatBadge" class="chat-badge">0</span>
          </a>

          <button class="pill pill-grad pill-icon" onclick="openChatAndExpand()"><i class="bi bi-robot"></i> Chat OpenAI</button>

          <!-- Usuario actual: nombre + avatar -->
          <div class="user-box">
            <div class="user-name" id="userName">—</div>
            <div class="user-avatar" id="avatarBtn" title="Cambiar foto de perfil">
              <span class="initials" id="avatarInitials">?</span>
              <img id="avatarImg" alt="Avatar" style="display:none;">
            </div>
            <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/webp" hidden>
          </div>
        </div>
      </header>

      <!-- ===== Área de contenido ===== -->
      <main class="content">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Panel notificaciones -->
  <div id="notif-panel" class="cardx position-fixed" style="right:22px; top:22px; width:340px; display:none; z-index:999;">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <strong>Notificaciones</strong>
      <button class="btn btn-sm btn-outline-secondary" id="btnMarkRead">Marcar leídas</button>
    </div>
    <div id="notif-list" class="small muted">Sin notificaciones</div>
    <div class="text-end mt-2"><a href="/notificaciones" class="small">Ver todas</a></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- ===== Drawer Chat IA ===== -->
  <div id="chatIaOverlay" class="chat-ia-overlay"></div>
  <aside id="chatIa" class="chat-ia" aria-hidden="true">
    <div class="chat-ia__header">
      <div class="chat-ia__title"><i class="bi bi-robot"></i> Chat OpenAI</div>
      <button id="chatIaClose" class="chat-ia__close" title="Cerrar"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="chatIaBody" class="chat-ia__body">
      <div class="msg ai"><b>IA:</b> ¿En qué te ayudo con licitaciones?</div>
    </div>
    <form id="chatIaForm" class="chat-ia__composer">
      <textarea id="chatIaInput" placeholder="Escribe tu mensaje…" enterkeyhint="send"></textarea>
      <button class="chat-ia__send" type="submit"><i class="bi bi-send"></i> Enviar</button>
    </form>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* Fallback de rol en el cliente: elimina cualquier marca admin-only si el rol no es admin */
    (function(){
      try{
        var role = "{{ request.session.get('rol', 'usuario') }}";
        if(role !== 'admin'){
          document.querySelectorAll('[data-admin-only]').forEach(function(el){ el.remove(); });
        }
      }catch(_){}
    })();

    /* Usuario en header (nombre + avatar) */
    function initialsFromName(n){
      n = (n||'').trim();
      if(!n) return '?';
      const parts = n.split(/\s+/).filter(Boolean);
      const a = (parts[0]||'').charAt(0);
      const b = (parts[1]||'').charAt(0);
      return (a + (b||'')).toUpperCase();
    }

    async function getUsuario(){
      try{
        const r=await fetch('/usuario-actual'); if(!r.ok) return;
        const d=await r.json();
        const name = d?.nombre || d?.usuario || 'Usuario';
        const avatar = d?.avatar_url || '';
        const nameEl = document.getElementById('userName');
        const imgEl  = document.getElementById('avatarImg');
        const iniEl  = document.getElementById('avatarInitials');

        if(nameEl) nameEl.textContent = name;
        if(avatar){
          imgEl.src = avatar;
          imgEl.style.display = 'block';
          if(iniEl) iniEl.style.display = 'none';
        }else{
          if(imgEl){ imgEl.removeAttribute('src'); imgEl.style.display='none'; }
          if(iniEl){ iniEl.textContent = initialsFromName(name); iniEl.style.display='block'; }
        }
      }catch(_){}
    }

    /* Subida de avatar */
    const avatarBtn   = document.getElementById('avatarBtn');
    const avatarInput = document.getElementById('avatarInput');
    avatarBtn?.addEventListener('click', ()=> avatarInput?.click());
    avatarInput?.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      if(f.size > 2*1024*1024){ showToast({title:'Avatar', body:'Máximo 2 MB', icon:'exclamation-triangle'}); return; }

      const fd = new FormData(); fd.append('avatar', f);
      try{
        const r = await fetch('/perfil/avatar', { method:'POST', body: fd });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j.ok){ throw new Error(j?.error || 'No se pudo actualizar el avatar'); }
        showToast({title:'Perfil', body:'Avatar actualizado', icon:'person-check'});
        const url = j.avatar_url + '?t=' + Date.now();
        const imgEl  = document.getElementById('avatarImg');
        const iniEl  = document.getElementById('avatarInitials');
        if(imgEl){ imgEl.src = url; imgEl.style.display='block'; }
        if(iniEl){ iniEl.style.display='none'; }
      }catch(err){
        showToast({title:'Perfil', body:String(err?.message||'Error'), icon:'exclamation-triangle'});
      }finally{
        try{ avatarInput.value=''; }catch(_){}
      }
    });

    /* Logout */
    function logout(){ fetch('/logout',{method:'POST'}).then(()=> location.href='/login?logout=1'); }
    document.getElementById('btnSalir')?.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

    /* Notificaciones (panel + badge) */
    const notifBtn = document.getElementById('btnNotif');
    const notifPanel = document.getElementById('notif-panel');
    const notifBadge = document.getElementById('notifBadge');

    async function refreshNotif(){
      try{
        const r = await fetch('/notificaciones');
        const j = await r.json();
        const n = Number(j?.total_unread||0);
        if(notifBadge){
          notifBadge.textContent = n>99 ? '99+' : String(n);
          notifBadge.style.display = n>0 ? 'inline-block' : 'none';
        }
        const list = document.getElementById('notif-list');
        if(Array.isArray(j.items) && list){
          list.innerHTML = j.items.length
            ? j.items.map(it => `<div class="mb-2"><b>${it.titulo}</b><div class="text-muted">${it.cuerpo||''}</div><div class="small text-muted">${it.fecha_legible||''}</div></div>`).join('')
            : 'Sin notificaciones';
        }
      }catch(_){}
    }

    notifBtn?.addEventListener('click', ()=>{
      if(!notifPanel) return;
      notifPanel.style.display = (notifPanel.style.display==='block'?'none':'block');
      if(notifPanel.style.display==='block') refreshNotif();
    });
    document.addEventListener('click', (e)=>{
      if(!notifPanel) return;
      if(!e.target.closest('#notif-panel') && !e.target.closest('#btnNotif')) notifPanel.style.display='none';
    });
    document.getElementById('btnMarkRead')?.addEventListener('click', async ()=>{
      try{
        await fetch('/notificaciones/marcar-leidas',{method:'POST'});
        refreshNotif();
        showToast({title:'Notificaciones', body:'Marcadas como leídas', icon:'check2-circle'});
      }catch(_){}
    });

    /* ====== Drawer Sidebar (mobile/tablet) ====== */
    const mqDesktop = window.matchMedia('(min-width: 992px)');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const btnOpen = document.getElementById('btnOpenDrawer');
    const btnClose = document.getElementById('btnCloseDrawer');

    function isDesktop(){ return mqDesktop.matches; }

    function openSidebarMobile(){
      if(isDesktop()) return;
      sidebar.classList.add('open');
      overlay.classList.add('open');
      sidebar.setAttribute('aria-hidden','false');
      btnOpen?.setAttribute('aria-expanded','true');
      // focus first interactive (logo siguiente o nav)
      const first = sidebar.querySelector('a,button,[tabindex]:not([tabindex="-1"])');
      if(first) try{ first.focus(); }catch(_){}
    }
    function closeSidebarMobile(){
      if(isDesktop()){
        // en desktop la sidebar es fija
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
        sidebar.setAttribute('aria-hidden','false');
        btnOpen?.setAttribute('aria-expanded','false');
        return;
      }
      sidebar.classList.remove('open');
      overlay.classList.remove('open');
      sidebar.setAttribute('aria-hidden','true');
      btnOpen?.setAttribute('aria-expanded','false');
      btnOpen?.focus?.();
    }

    btnOpen?.addEventListener('click', openSidebarMobile);
    btnClose?.addEventListener('click', closeSidebarMobile);
    overlay?.addEventListener('click', closeSidebarMobile);
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') closeSidebarMobile();
    });

    function applySidebarMode(){
      if(isDesktop()){
        // Modo fijo
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
        sidebar.setAttribute('aria-hidden','false');
        btnOpen?.setAttribute('aria-expanded','false');
      }else{
        // Modo drawer cerrado por defecto
        sidebar.setAttribute('aria-hidden','true');
      }
    }
    mqDesktop.addEventListener?.('change', applySidebarMode);
    applySidebarMode();

    /* ===== Chat IA (drawer) ===== */
    const CHAT_STATE_KEY = 'chatboxState';
    const chatIa = document.getElementById('chatIa');
    const chatIaOverlay = document.getElementById('chatIaOverlay');
    const chatIaClose = document.getElementById('chatIaClose');
    const chatIaInput = document.getElementById('chatIaInput');
    const chatIaBody  = document.getElementById('chatIaBody');
    const chatIaForm  = document.getElementById('chatIaForm');

    function openChatIA(persist=true){
      if(!chatIa) return;
      chatIa.classList.add('open');
      chatIaOverlay.classList.add('open');
      chatIa.setAttribute('aria-hidden','false');
      setTimeout(()=> chatIaInput?.focus(), 50);
      if(persist) localStorage.setItem(CHAT_STATE_KEY, 'open');
    }
    function closeChatIA(){
      if(!chatIa) return;
      chatIa.classList.remove('open');
      chatIaOverlay.classList.remove('open');
      chatIa.setAttribute('aria-hidden','true');
      localStorage.removeItem(CHAT_STATE_KEY);
    }
    function openChatAndExpand(){ openChatIA(true); }

    window.openChatAndExpand = openChatAndExpand;

    chatIaOverlay?.addEventListener('click', closeChatIA);
    chatIaClose?.addEventListener('click', closeChatIA);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeChatIA(); });

    if(localStorage.getItem(CHAT_STATE_KEY)==='open'){ openChatIA(false); }

    function scrollToBottom(smooth=true){
      try{ chatIaBody.scrollTo({ top: chatIaBody.scrollHeight, behavior: smooth ? 'smooth' : 'auto' }); }
      catch(_){ chatIaBody.scrollTop = chatIaBody.scrollHeight; }
    }

    // Enter = enviar | Shift+Enter = salto de línea
    chatIaInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey && !e.isComposing) {
        e.preventDefault(); chatIaForm?.requestSubmit();
      }
    });

    chatIaForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (chatIaInput?.value || '').trim();
      if(!text) return;

      appendMsg('me', text);
      chatIaInput.value = '';

      const thinkingNode = addTyping();

      try{
        const r = await fetch('/api/chat-openai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text })
        });

        let data = null, bodyText = '';
        try { data = await r.json(); } catch { bodyText = await r.text(); }
        const reply = pickReply(data, bodyText) || 'No recibí respuesta del servidor.';
        replaceMsg(thinkingNode, 'ai', reply);
      }catch(err){
        replaceMsg(thinkingNode, 'ai', 'Hubo un error al contactar la IA.');
      }
    });

    function pickReply(json, fallbackText){
      if(json){
        if(typeof json.reply === 'string') return json.reply;
        if(typeof json.respuesta === 'string') return json.respuesta;
        const c = json.choices?.[0];
        if(c?.message?.content) return c.message.content;
        if(c?.text) return c.text;
        if(json.data?.reply) return json.data.reply;
      }
      if(typeof fallbackText === 'string' && fallbackText.trim()) return fallbackText.trim();
      return '';
    }
    function appendMsg(who, text){
      const el = document.createElement('div');
      el.className = 'msg ' + (who==='ai'?'ai':'me');
      el.innerHTML = (who==='ai' ? '<b>IA:</b> ' : '<b>Yo:</b> ') + escapeHTML(text);
      chatIaBody.appendChild(el);
      scrollToBottom(true);
      return el;
    }
    function addTyping(){
      const el = document.createElement('div');
      el.className = 'msg ai typing';
      el.innerHTML = '<b>IA:</b> ' +
        '<span class="typing-dot"></span>' +
        '<span class="typing-dot"></span>' +
        '<span class="typing-dot"></span>';
      chatIaBody.appendChild(el);
      scrollToBottom(true);
      return el;
    }
    function replaceMsg(node, who, text){
      if(!node) return appendMsg(who, text);
      node.className = 'msg ' + (who==='ai'?'ai':'me');
      node.innerHTML = (who==='ai' ? '<b>IA:</b> ' : '<b>Yo:</b> ') + escapeHTML(text);
      scrollToBottom(true);
    }
    function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* Link activo sidebar */
    (function markActive(){
      const path=location.pathname;
      document.querySelectorAll('.side-btn[data-match]').forEach(a=>{
        const m=a.getAttribute('data-match');
        const on = (m === '/' ? path==='/' : path.startsWith(m));
        if(on) a.classList.add('active');
      });
    })();

    /* Historial en home */
    document.getElementById('btnHistorial')?.addEventListener('click', (e)=>{
      if(location.pathname === '/'){
        e.preventDefault();
        document.getElementById('historial')?.scrollIntoView({behavior:'smooth', block:'start'});
      }
    });

    /* Toast helper */
    function showToast({title='Aviso', body='', icon='info', delay=3200}={}){
      const cont=document.getElementById('toastContainer'); if(!cont) return;
      const esc=(s)=> (s??'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
      el.innerHTML=`<div class="toast-header">
        <i class="bi bi-${esc(icon)} me-1"></i><strong class="me-auto">${esc(title)}</strong>
        <small>Ahora</small><button class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div><div class="toast-body">${esc(body)}</div>`;
      cont.appendChild(el); const t=new bootstrap.Toast(el,{delay}); t.show(); el.addEventListener('hidden.bs.toast',()=> el.remove());
    }

    // Kill-switch FAB externo
    document.querySelectorAll('#chatOpenAiFab, .chat-openai-fab, [data-chat-fab]')
      .forEach(el => { try{ el.remove(); }catch(_){ el.style.display='none'; } });

    getUsuario();
    refreshNotif();

    /* ====== Tema global ====== */
    const btnTheme = document.getElementById('btnTheme');
    const icoTheme = document.getElementById('icoTheme');
    function getTheme(){ try{ return localStorage.getItem('theme'); }catch(_){ return null; } }
    function setTheme(val){
      try{
        if(val){ localStorage.setItem('theme', val); document.documentElement.setAttribute('data-theme', val); }
        else{ localStorage.removeItem('theme'); document.documentElement.removeAttribute('data-theme'); }
      }catch(_){}
      updateThemeBtn();
    }
    function updateThemeBtn(){
      const t = getTheme();
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if(t === 'dark'){ icoTheme.className='bi bi-moon-stars'; btnTheme.title='Tema: Oscuro'; }
      else if(t === 'light'){ icoTheme.className='bi bi-brightness-high'; btnTheme.title='Tema: Claro'; }
      else { icoTheme.className='bi bi-circle-half'; btnTheme.title = 'Tema: Sistema (' + (prefersDark?'Oscuro':'Claro') + ')'; }
    }
    btnTheme?.addEventListener('click', ()=>{
      const t = getTheme();
      if(t === null){ setTheme('dark'); }
      else if(t === 'dark'){ setTheme('light'); }
      else{ setTheme(null); }
    });
    try{
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if(getTheme()===null) updateThemeBtn(); });
    }catch(_){}
    updateThemeBtn();

    /* ====== PRESENCIA (usuarios activos) ====== */
    const presenceBtn   = document.getElementById('btnPresence');
    const presenceBadge = document.getElementById('presenceBadge');
    const isAuthScreen  = document.body.getAttribute('data-auth') === '1';

    presenceBtn?.addEventListener('click', ()=>{ location.href = '/usuarios-activos'; });

    async function presencePing(){
      if(isAuthScreen) return; // no pings en pantalla de login
      try{ await fetch('/presence/ping', { method:'POST' }); }catch(_){}
    }
    async function refreshPresence(){
      if(isAuthScreen) return;
      try{
        const r = await fetch('/presence/online');
        if(!r.ok) return;
        const j = await r.json();
        const n = Array.isArray(j.items) ? j.items.length : 0;
        presenceBadge.textContent = n>99 ? '99+' : String(n);
        presenceBadge.style.display = n>0 ? 'inline-block' : 'none';
        presenceBtn.title = `Usuarios activos: ${n}`;
      }catch(_){}
    }

    if(!isAuthScreen){
      presencePing();
      refreshPresence();
      setInterval(presencePing, 30000);
      setInterval(refreshPresence, 15000);
    }

    /* ====== NO LEÍDOS DEL CHAT (badge global) ====== */
    const chatBadge = document.getElementById('chatBadge');
    async function refreshChatUnread(){
      try{
        const r = await fetch('/chat/no-leidos');
        if(!r.ok) throw 0;
        const j = await r.json();
        const n = Number(j?.no_leidos||0);
        chatBadge.textContent = n>99 ? '99+' : String(n);
        chatBadge.style.display = n>0 ? 'inline-block' : 'none';
      }catch(_){
        chatBadge.style.display='none';
      }
    }
    refreshChatUnread();
    setInterval(refreshChatUnread, 15000);
  </script>

  {% block extra_scripts %}{% endblock %}
</body>
</html>
