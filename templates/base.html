<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>{% block title %}Suizo Argentina – Licitaciones IA{% endblock %}</title>
  <meta name="color-scheme" content="light dark"/>
  <meta name="theme-color" content="#eeede8"/>

  <!-- Aplica tema ANTES de pintar para evitar FOUC (con soporte de “Sistema”) -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if(saved === 'light' || saved === 'dark'){
          document.documentElement.setAttribute('data-theme', saved);
        }else{
          document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }

        var meta = document.querySelector('meta[name="theme-color"]');
        if(!meta){ meta = document.createElement('meta'); meta.name = 'theme-color'; document.head.appendChild(meta); }
        meta.setAttribute('content', (saved ? saved==='dark' : prefersDark) ? '#151B22' : '#eeede8');

        try{
          const mq = window.matchMedia('(prefers-color-scheme: dark)');
          mq.addEventListener && mq.addEventListener('change', function(e){
            const cur = localStorage.getItem('theme');
            if(cur === null){
              document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
              const m = document.querySelector('meta[name="theme-color"]');
              if(m) m.setAttribute('content', e.matches ? '#151B22' : '#eeede8');
            }
          });
        }catch(_){}
      }catch(_){}
    })();
  </script>
  <noscript>
    <style>
      @media (prefers-color-scheme: dark){
        html{ background:#151B22; color:#E5ECF3; }
      }
    </style>
  </noscript>

  <!-- Helper global -->
  <script>
    function escapeHTML(s){
      return (s ?? '').toString().replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
      ));
    }
  </script>

  <!-- Rendimiento -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <!-- Theme -->
  <link rel="stylesheet" href="{{ url_for('static', path='css/app.theme.css') }}?v=20250819">

  <style>
    :root{
      --panel: var(--surface);
      --ink: var(--text);
      --bg-body: var(--bg);
      --chip-bg: var(--brand-100);

      --accent-a: var(--brand-300);
      --accent-b: var(--brand-500);
      --accent-c: var(--brand-500);

      --sidebar-grad-a: var(--brand-700);
      --sidebar-grad-b: var(--brand-500);

      --pill: var(--brand-100);
      --radius:22px;
      --shadow:0 12px 32px rgba(20,15,55,.16);

      --sidebar-w: 74px;
      --drawer-w: 240px;
      --header-h: 76px;

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    [data-theme="dark"]{
      --panel:#151B22;
      --ink:#E5ECF3;
      --bg-body:#0F141A;
      --chip-bg:#0f172a;
      --shadow:0 12px 32px rgba(0,0,0,.45);
      --sidebar-grad-a:#0a0f20;
      --sidebar-grad-b:#070c18;
    }

    html, body { height:100%; }
    html{ scroll-behavior:smooth; }
    html, body{ overflow-x:hidden; }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg-body);
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img, iframe, canvas, video{ max-width:100%; height:auto; }

    @media (prefers-reduced-motion: reduce){
      * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; scroll-behavior: auto !important; }
    }

    .shell{ width:100vw; height:100vh; margin:0; background:var(--bg-body); overflow:hidden; display:block; }
    .app{
      height:100%;
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-rows: var(--header-h) 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar content";
    }

    /* ======= Sidebar ======= */
    .sidebar{
      grid-area:sidebar;
      display:flex; flex-direction:column; align-items:center;
      width:var(--sidebar-w); padding:14px 8px;
      background: linear-gradient(180deg, var(--sidebar-grad-a), var(--sidebar-grad-b));
      border-radius: 0 26px 26px 0;
      box-shadow: 0 10px 26px rgba(2,6,23,.34), inset 0 0 0 1px rgba(255,255,255,.04);
      color:#fff;
      height: calc(100% - 10vh);
      margin: auto 0;
      z-index: 1020;
    }
    [data-theme="dark"] .sidebar{
      box-shadow: 0 10px 26px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .side-logo{ width:46px; height:46px; border-radius:12px; background:#fff; display:grid; place-items:center; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06); }
    .side-logo img{ width:30px; height:30px; object-fit:contain; }
    .side-nav{ display:flex; flex-direction:column; gap:8px; align-items:center; width:100%; margin-top:8px; }
    .side-btn{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      color:#dbe6f2; font-size:18px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
      text-decoration:none;
    }
    .side-btn:hover{ transform:translateY(-2px); color:#fff; box-shadow:0 12px 22px rgba(0,0,0,.28); background:rgba(255,255,255,.12); }
    .side-btn.active{
      color:#fff;
      background:linear-gradient(135deg, var(--accent-a), var(--accent-b));
      border-color:transparent;
      box-shadow:0 10px 22px rgba(82,116,206,.35);
    }
    .side-spacer{ flex:1; }
    .side-small{ color:#c7d2fe; font-size:11px; }

    /* >>> Nueva separación consistente en el bloque inferior */
    .side-bottom{
      display:flex; flex-direction:column; align-items:center; width:100%;
      gap:8px; margin-top:8px;
    }
    .side-bottom .side-btn{ margin:0; }
    /* <<< */

    /* ======= Header ======= */
    .header{
      grid-area:header;
      display:flex; align-items:center; gap:12px;
      padding:12px 18px;
      border-bottom:1px solid var(--bs-border-color, var(--border));
      background:linear-gradient(0deg, rgba(255,255,255,.92), rgba(255,255,255,.92));
      backdrop-filter: blur(6px);
      position: sticky; top: 0;
      z-index: 2040;
    }
    /* HOTFIX: el header y sus hijos siempre clickeables */
    .header, .header *{ pointer-events:auto !important; }

    [data-theme="dark"] .header{ background:linear-gradient(0deg, rgba(21,27,34,.92), rgba(21,27,34,.92)); }

    .menu-btn{ display:none; width:42px; height:42px; border-radius:12px; border:1px solid var(--bs-border-color, var(--border)); background:var(--surface); color:var(--ink); align-items:center; justify-content:center; }
    [data-theme="dark"] .menu-btn{ background:var(--panel); color:var(--ink); }
    @media (max-width: 992px){ .menu-btn{ display:inline-flex; } }

    .brand{ display:flex; align-items:center; gap:14px; padding:8px 14px; border-radius:16px; border:1px solid var(--bs-border-color, var(--border)); background:var(--surface); }
    .brand img{ height:34px; width:auto; object-fit:contain; }
    .brand .brand-title{ font-weight:700; letter-spacing:.2px; color: var(--brand-500); }
    [data-theme="dark"] .brand{ background:var(--panel); }

    .header-actions{
      margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .pill{ position:relative; border-radius:999px; padding:.55rem 1rem; border:1px solid var(--bs-border-color, var(--border)); background:var(--pill); color:var(--ink); font-weight:500; text-decoration:none; }
    .pill-grad{ border:none; color:#fff; background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); box-shadow:0 12px 26px rgba(82,116,206,.32); }
    .pill-icon{ display:inline-flex; align-items:center; gap:.5rem; }
    .icon-btn{
      position:relative; width:44px; height:44px; display:grid; place-items:center;
      border-radius:14px; border:1px solid var(--bs-border-color, var(--border)); background:var(--surface); color:var(--ink);
    }
    [data-theme="dark"] .icon-btn{ background:var(--panel); color:var(--ink); border-color:var(--bs-border-color, var(--border)); }
    .icon-badge, .chat-badge{
      position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 4px; border-radius:999px; background:#ef4444; color:#fff; font-size:11px; line-height:18px; text-align:center; display:none;
    }

    .user-box{ display:flex; align-items:center; gap:10px; margin-left:6px; white-space:nowrap; }
    .user-name{ font-weight:600; color:var(--ink); max-width:28ch; overflow:hidden; text-overflow:ellipsis; }
    .user-avatar{ width:40px; height:40px; border-radius:999px; overflow:hidden; position:relative; border:1px solid var(--bs-border-color, var(--border)); background:#e2e8f0; display:grid; place-items:center; cursor:pointer; user-select:none; }
    .user-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .user-avatar .initials{ font-weight:700; color:#334155; }
    [data-theme="dark"] .user-avatar{ background:#111827; }
    .user-avatar:hover{ box-shadow:0 8px 20px rgba(0,0,0,.12); }

    /* ======= Contenido ======= */
    .content{
      grid-area:content; position:relative; padding:24px; min-height:0;
      height:100%; overflow:auto;
      background:
        radial-gradient(900px 660px at 16% 16%, rgba(82,116,206,.12), transparent 60%),
        radial-gradient(1000px 720px at 84% 80%, rgba(4,67,106,.10), transparent 60%),
        radial-gradient(780px 560px at 76% 8%, rgba(82,116,206,.08), transparent 60%),
        var(--bg-body);
    }
    [data-theme="dark"] .content{
      background:
        radial-gradient(900px 660px at 16% 16%, rgba(82,116,206,.14), transparent 60%),
        radial-gradient(1000px 720px at 84% 80%, rgba(4,67,106,.14), transparent 60%),
        radial-gradient(780px 560px at 76% 8%, rgba(82,116,206,.12), transparent 60%),
        var(--bg-body);
    }

    .content > :first-child:not(.py-3){ padding-top:1rem; padding-bottom:1rem; }
    .content > :first-child:not(.px-1){ padding-left:.25rem; padding-right:.25rem; }
    .content > .no-page-pad:first-child{ padding:0 !important; }

    .cardx{ background:var(--surface); border:1px solid var(--bs-border-color, var(--border)); border-radius:18px; box-shadow:var(--shadow); padding:20px; position:relative; }
    .cardx .title{ font-weight:700; display:flex; align-items:center; gap:8px; }

    /* === Unificación de tarjetas para vistas que usan .card-clean === */
    .card-clean{
      background:var(--surface);
      border:1px solid var(--bs-border-color, var(--border));
      border-radius:18px;
      box-shadow:var(--shadow);
    }
    .card-clean .card-header{
      background:transparent;
      border-bottom:1px solid var(--bs-border-color, var(--border));
      padding:14px 16px;
      border-top-left-radius:18px; border-top-right-radius:18px;
    }
    .card-clean .card-body{ padding:16px; border-bottom-left-radius:18px; border-bottom-right-radius:18px; }

    @media (max-width: 991.98px){
      .shell{ height: 100dvh; }
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: var(--header-h) 1fr;
        grid-template-areas: "header" "content";
      }
      .sidebar{
        position: fixed; top: 0; left: 0; height: 100dvh;
        width: min(var(--drawer-w), 72vw);
        max-width: 80vw;
        padding: 16px 10px; margin: 0; border-radius: 0 22px 22px 0;
        transform: translateX(-100%); transition: transform .25s ease;
      }
      .sidebar.open{ transform: translateX(0); }
      .sidebar .close-drawer{
        display: inline-flex; align-items:center; justify-content:center;
        width:36px; height:36px; border-radius:10px;
        border:1px solid rgba(255,255,255,.12);
        color:#fff; background:rgba(255,255,255,.12);
        margin: 2px 0 10px auto;
      }
      .sidebar-overlay{
        position: fixed; inset: 0; background: rgba(15,18,34,.35); backdrop-filter: blur(2px);
        opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1010;
      }
      .sidebar-overlay.open{ opacity: 1; pointer-events: auto; }

      .content{ padding:16px; }
      .brand{ padding:6px 10px; gap:10px; }
      .brand img{ height:28px; }
      .pill, .icon-btn{ padding:.5rem .75rem; }
    }
    @media (max-width:575.98px){
      .header{ align-items:flex-start; gap:8px; padding:10px 12px; }
      .brand{ flex:0 0 auto; }
      .header-actions{
        flex:1 1 auto; min-width:0; margin-left:auto;
        display:flex; gap:8px; flex-wrap:nowrap;
        overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch;
        scrollbar-width: none;
      }
      .header-actions::-webkit-scrollbar{ display:none; }
      .header-actions > *{ flex:0 0 auto; }
      .user-name{ max-width:22ch; }
    }

    input.form-control, select.form-select, textarea.form-control{
      background:var(--surface); color:var(--ink); border:1px solid var(--bs-border-color, var(--border)); border-radius:12px;
    }
    [data-theme="dark"] input.form-control,
    [data-theme="dark"] select.form-select,
    [data-theme="dark"] textarea.form-control{
      background:var(--panel); color:var(--ink); border:1px solid var(--bs-border-color, var(--border));
    }

    .table thead{ background:var(--muted); }
    [data-theme="dark"] .table thead{ background:#0f172a; }

    .toast-container{ position:fixed; right:16px; bottom:16px; z-index:1200; }
    .toast{ border-radius:12px; box-shadow:var(--shadow); }
    .toast-header{ border-bottom:none; }

    /* Pantalla auth */
    body[data-auth="1"] .app{ grid-template-columns: 1fr; grid-template-rows: 1fr; grid-template-areas: "content"; }
    body[data-auth="1"] .sidebar, body[data-auth="1"] .header{ display:none !important; }
    body[data-auth="1"] .content{
      display:grid; place-items:center; padding:24px;
      background: linear-gradient(180deg, rgba(82,116,206,.10) 0%, rgba(4,67,106,.10) 100%), var(--bg-body);
    }
    @media (prefers-color-scheme: dark){
      body[data-auth="1"] .content{ background: linear-gradient(180deg, rgba(82,116,206,.14) 0%, rgba(4,67,106,.14) 100%), var(--bg-body); }
    }

    /* ===== Drawer Chat IA =====
       Ahora el chat se muestra DEBAJO del header y se puede abrir/cerrar
       con el mismo botón. Además, no se muestra en login. */
    .chat-ia-overlay{
      position:fixed; left:0; right:0; bottom:0; top: var(--header-h);
      background:rgba(15,18,34,.28); backdrop-filter: blur(2px);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:1200;
    }
    .chat-ia{
      position:fixed; top: var(--header-h); right:-480px; height:calc(100% - var(--header-h));
      width:480px; max-width:100%;
      background:var(--surface); border-left:1px solid var(--bs-border-color, var(--border)); box-shadow: var(--shadow);
      display:flex; flex-direction:column; transition:right .28s ease; z-index:1201;
    }
    [data-theme="dark"] .chat-ia{ background:var(--panel); }
    .chat-ia.open{ right:0; }
    .chat-ia-overlay.open{ opacity:1; pointer-events:auto; }
    .chat-ia__header{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--bs-border-color, var(--border));
      background:linear-gradient(0deg, rgba(255,255,255,.96), rgba(255,255,255,.96)); }
    [data-theme="dark"] .chat-ia__header{ background:linear-gradient(0deg, rgba(21,27,34,.96), rgba(21,27,34,.96)); }
    .chat-ia__title{ font-weight:700; display:flex; align-items:center; gap:8px; color: var(--brand-500); }
    .chat-ia__close{ border:1px solid var(--bs-border-color, var(--border)); background:var(--surface); border-radius:10px; width:36px; height:36px; display:grid; place-items:center; }
    [data-theme="dark"] .chat-ia__close{ background:var(--panel); color:var(--ink); }
    .chat-ia__body{
      flex:1; overflow:auto; padding:14px; background:
      radial-gradient(700px 520px at 84% 12%, rgba(82,116,206,.12), transparent 60%),
      radial-gradient(600px 420px at 8% 88%, rgba(4,67,106,.10), transparent 60%),
      var(--bg-body);
      scroll-behavior: smooth;
    }
    [data-theme="dark"] .chat-ia__body{
      background:
      radial-gradient(700px 520px at 84% 12%, rgba(82,116,206,.14), transparent 60%),
      radial-gradient(600px 420px at 8% 88%, rgba(4,67,106,.14), transparent 60%),
      var(--bg-body);
    }
    .msg{ background:var(--surface); border:1px solid var(--bs-border-color, var(--border)); border-radius:14px; padding:10px 12px; margin-bottom:10px; }
    .msg.ai{ background:linear-gradient(180deg,var(--surface),rgba(255,255,255,.96)); }
    .msg.me{ background:#e7ecfa; border-color:#d5ddff; }
    [data-theme="dark"] .msg{ background:#0f172a; }
    .msg.typing{ display:flex; align-items:center; gap:8px; }
    .typing-dot{ display:inline-block; width:6px; height:6px; border-radius:50%; background:#94a3b8; opacity:.6; animation: blink 1s infinite ease-in-out; }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes blink{ 0%, 60%, 100%{ transform: translateY(0); opacity:.35; } 30%{ transform: translateY(-3px); opacity:.9; } }
    .chat-ia__composer{ padding:12px; border-top:1px solid var(--bs-border-color, var(--border)); display:flex; gap:8px; background:var(--surface); }
    [data-theme="dark"] .chat-ia__composer{ background:var(--panel); }
    .chat-ia__composer textarea{ resize:none; height:46px; flex:1; border:1px solid var(--bs-border-color, var(--border)); border-radius:12px; padding:10px 12px; background:var(--surface); color:var(--ink); }
    [data-theme="dark"] .chat-ia__composer textarea{ background:var(--panel); color:var(--ink); }
    .chat-ia__send{
      border:none; border-radius:999px; padding:0 16px; min-width:120px;
      background:linear-gradient(135deg, var(--accent-a), var(--accent-b));
      color:#fff; box-shadow:0 12px 26px rgba(82,116,206,.22);
    }

    .fc { --fc-border-color: var(--bs-border-color, var(--border)); --fc-page-bg-color: transparent; }

    #chatOpenAiFab, .chat-openai-fab, [data-chat-fab]{ display:none !important; }

    /* ==== Estilos rating ==== */
    .rating-stars { display:flex; gap:8px; font-size:28px; cursor:pointer; user-select:none; }
    .rating-stars .star { color:#cbd5e1; transition: transform .06s ease; }
    .rating-stars .star.active { color:#f59e0b; }
    .rating-stars .star:hover { transform: translateY(-1px) scale(1.05); }
    .rating-hint { font-size:12px; color:var(--text-2); }

    /* Banner “Valoración pendiente” */
    .rating-banner{
      position:fixed; left:16px; bottom:16px; z-index:1200;
      background:var(--surface); color:var(--ink); border:1px solid var(--bs-border-color, var(--border));
      border-radius:14px; box-shadow:var(--shadow); padding:10px 12px; display:none;
    }
    .rating-banner .btn{ padding:.35rem .75rem; border-radius:999px; }

    @media (max-width: 575.98px){
      .row > [class*="col-"]{ flex: 0 0 100% !important; max-width: 100% !important; }
      .btn, .btn-chat{ padding:.5rem .9rem; }
      .card, .card-clean, .brand, .pill, .icon-btn{ max-width:100%; }
    }
    [class*="container"], [class*="Container"]{ min-width: 0; }

    /* **Fix login**: ocultar completamente Chat IA en la pantalla de autenticación */
    body[data-auth="1"] #chatIa,
    body[data-auth="1"] #chatIaOverlay{
      display: none !important;
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body data-auth="{{ '1' if request and request.url.path.startswith('/login') else '' }}"
      data-route="{{ request.url.path if request else '' }}"
      data-last-pdf="{{ pdf_nombre or '' }}"
      data-last-ts="{{ timestamp or '' }}">

  <script>
    (function(){
      try{
        var r = document.body.getAttribute('data-route') || location.pathname;
        if (r.indexOf('/login') === 0) document.body.setAttribute('data-auth','1');
      }catch(e){}
    })();
  </script>

  <div class="shell">
    <div class="app">
      <!-- ===== Sidebar ===== -->
      <aside class="sidebar" id="sidebar" aria-hidden="false" aria-label="Navegación lateral">
        <button class="close-drawer d-none d-lg-none" id="btnCloseDrawer" aria-label="Cerrar menú">
          <i class="bi bi-x-lg"></i>
        </button>

        <div class="side-logo" title="Suizo Argentina">
          <img src="/static/logo-suizo.png" alt="Suizo" loading="lazy"/>
        </div>

        <nav class="side-nav">
          <a class="side-btn" data-match="/"               href="/"               title="Inicio" aria-label="Inicio"><i class="bi bi-house"></i></a>
          <a class="side-btn" data-match="/chat"           href="/chat"           title="Chat interno" aria-label="Chat interno"><i class="bi bi-chat-dots"></i></a>
          <a class="side-btn" data-match="/incidencias"    href="/incidencias"    title="Incidencias" aria-label="Incidencias"><i class="bi bi-bug"></i></a>
          <a class="side-btn" data-match="/calendario"     href="/calendario"     title="Calendario" aria-label="Calendario"><i class="bi bi-calendar-event"></i></a>

          <a class="side-btn" id="btnHistorial" href="/historia" title="Historial" aria-label="Historial">
            <i class="bi bi-clock-history"></i>
          </a>

          {% if request.session.get('rol', 'usuario') == 'admin' %}
            <a class="side-btn" data-match="/auditoria" href="/auditoria" title="Auditoría" data-admin-only aria-label="Auditoría">
              <i class="bi bi-clipboard-data"></i>
            </a>
            <a class="side-btn" data-match="/admin" href="/admin" title="Admin" data-admin-only aria-label="Administración">
              <i class="bi bi-gear"></i>
            </a>
          {% endif %}
        </nav>

        <div class="side-spacer"></div>

        <div class="side-bottom">
          <a class="side-btn" data-match="/cambiar-password" href="/cambiar-password" title="Cambiar contraseña" aria-label="Cambiar contraseña"><i class="bi bi-key"></i></a>
          <a class="side-btn" href="#" id="btnSalir" title="Salir" aria-label="Cerrar sesión"><i class="bi bi-box-arrow-right"></i></a>
        </div>
        <div class="side-small">v1</div>

      </aside>

      <!-- Overlay del drawer -->
      <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

      <!-- ===== Header ===== -->
      <header class="header">
        <button class="menu-btn" id="btnOpenDrawer" aria-label="Abrir menú" aria-controls="sidebar" aria-expanded="false">
          <i class="bi bi-list"></i>
        </button>

        <div class="brand">
          <img src="/static/logo-suizo.png" alt="Logo Suizo" loading="lazy">
        </div>

        <div class="header-actions">
          <button class="icon-btn" id="btnTheme" title="Tema: Sistema" aria-label="Cambiar tema">
            <i id="icoTheme" class="bi bi-circle-half"></i>
          </button>

          <button class="icon-btn" id="btnPresence" title="Usuarios activos" aria-label="Usuarios activos">
            <i class="bi bi-people"></i>
            <span id="presenceBadge" class="icon-badge">0</span>
          </button>

          <button class="icon-btn" id="btnNotif" title="Notificaciones" aria-label="Notificaciones" aria-haspopup="true" aria-expanded="false">
            <i class="bi bi-bell"></i>
            <span id="notifBadge" class="icon-badge">0</span>
          </button>

          <a class="pill pill-icon" href="/chat" id="btnChat" aria-label="Ir al chat interno">
            <i class="bi bi-chat-dots"></i> Chat interno
            <span id="chatBadge" class="chat-badge">0</span>
          </a>

          <!-- Botón con toggle (abre/cierra el drawer) -->
          <button class="pill pill-grad pill-icon" id="btnOpenChat" type="button"
                  data-ai-toggle="chat"
                  aria-label="Abrir chat con IA" aria-pressed="false">
            <i class="bi bi-robot"></i> Chat OpenAI
          </button>

          <!-- Usuario -->
          <div class="user-box">
            <div class="user-name" id="userName">—</div>
            <div class="user-avatar" id="avatarBtn" title="Cambiar foto de perfil" role="button" tabindex="0" aria-label="Cambiar foto de perfil">
              <span class="initials" id="avatarInitials">?</span>
              <img id="avatarImg" alt="Avatar" style="display:none;">
            </div>
            <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/webp" hidden>
          </div>
        </div>
      </header>
      <!-- ===== Área de contenido ===== -->
      <main class="content" id="mainContent">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Panel notificaciones -->
  <div id="notif-panel" class="cardx position-fixed" style="right:22px; top:22px; width:340px; max-width:calc(100vw - 44px); display:none; z-index:999;" role="dialog" aria-modal="false" aria-labelledby="notifTitle">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <strong id="notifTitle">Notificaciones</strong>
      <button class="btn btn-sm btn-outline-secondary" id="btnMarkRead">Marcar leídas</button>
    </div>
    <div id="notif-list" class="small muted">Sin notificaciones</div>
    <div class="text-end mt-2"><a href="/notificaciones/todas" class="small">Ver todas</a></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <!-- ===== Drawer Chat IA ===== -->
  <div id="chatIaOverlay" class="chat-ia-overlay"></div>
  <aside id="chatIa" class="chat-ia" aria-hidden="true" aria-label="Chat OpenAI">
    <div class="chat-ia__header">
      <div class="chat-ia__title"><i class="bi bi-robot"></i> Chat OpenAI</div>
      <button id="chatIaClose" class="chat-ia__close" title="Cerrar" aria-label="Cerrar chat IA"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="chatIaBody" class="chat-ia__body">
      <div class="msg ai"><b>IA:</b> ¿En qué te ayudo con licitaciones?</div>
    </div>
    <form id="chatIaForm" class="chat-ia__composer">
      <label for="chatIaInput" class="visualmente-hidden visually-hidden">Escribe tu mensaje</label>
      <textarea id="chatIaInput" placeholder="Escribe tu mensaje…" enterkeyhint="send" aria-label="Escribe tu mensaje al asistente"></textarea>
      <button class="chat-ia__send" type="submit"><i class="bi bi-send"></i> Enviar</button>
    </form>
  </aside>

  <!-- ===== Modal de Valoración ===== -->
  <div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-star-half me-1"></i> Valoración del análisis</h5>
        </div>
        <div class="modal-body">
          <div class="small text-muted mb-2" id="ratingFileInfo">Por favor, calificá el resultado (1 = malo, 5 = excelente).</div>
          <div class="rating-stars mb-2" id="ratingStars" role="radiogroup" aria-label="Valoración en estrellas">
            <i class="bi bi-star star" data-val="1" role="radio" aria-label="1 estrella" aria-checked="false" tabindex="0"></i>
            <i class="bi bi-star star" data-val="2" role="radio" aria-label="2 estrellas" aria-checked="false" tabindex="0"></i>
            <i class="bi bi-star star" data-val="3" role="radio" aria-label="3 estrellas" aria-checked="false" tabindex="0"></i>
            <i class="bi bi-star star" data-val="4" role="radio" aria-label="4 estrellas" aria-checked="false" tabindex="0"></i>
            <i class="bi bi-star star" data-val="5" role="radio" aria-label="5 estrellas" aria-checked="false" tabindex="0"></i>
          </div>
          <div class="rating-hint mb-3" id="ratingHint">Seleccioná una puntuación.</div>
          <label class="form-label" for="ratingComment">Comentario (opcional)</label>
          <textarea id="ratingComment" class="form-control" rows="3" placeholder="¿Qué te gustó o qué mejorarías?"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="ratingSubmit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm me-1 d-none" id="ratingSpinner" role="status" aria-hidden="true"></span>
            <i class="bi bi-send" id="ratingSendIcon"></i> Enviar valoración
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Banner Valoración pendiente -->
  <div id="ratingBanner" class="rating-banner" role="region" aria-label="Valoración pendiente">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-star-fill text-warning" aria-hidden="true"></i>
      <span class="small">Tenés una valoración pendiente.</span>
      <button id="ratingBannerBtn" class="btn btn-sm btn-primary">Valorar ahora</button>
      <button id="ratingBannerClose" class="btn btn-sm btn-outline-secondary">Cerrar</button>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* Fallback rol: oculta admin-only si no sos admin */
    (function(){
      try{
        var role = "{{ request.session.get('rol', 'usuario') }}";
        if(role !== 'admin'){
          document.querySelectorAll('[data-admin-only]').forEach(function(el){ el.remove(); });
        }
      }catch(_){}
    })();

    /* Usuario (nombre + avatar) */
    function initialsFromName(n){
      n = (n||'').trim();
      if(!n) return '?';
      const parts = n.split(/\s+/).filter(Boolean);
      const a = (parts[0]||'').charAt(0);
      const b = (parts[1]||'').charAt(0);
      return (a + (b||'')).toUpperCase();
    }
    async function getUsuario(){
      try{
        const r=await fetch('/usuario-actual'); if(!r.ok) return;
        const d=await r.json();
        const name = d?.nombre || d?.usuario || 'Usuario';
        const avatar = d?.avatar_url || '';
        const nameEl = document.getElementById('userName');
        const imgEl  = document.getElementById('avatarImg');
        const iniEl  = document.getElementById('avatarInitials');

        if(nameEl) nameEl.textContent = name;
        if(avatar){
          imgEl.src = avatar; imgEl.style.display = 'block';
          if(iniEl) iniEl.style.display = 'none';
        }else{
          if(imgEl){ imgEl.removeAttribute('src'); imgEl.style.display='none'; }
          if(iniEl){ iniEl.textContent = initialsFromName(name); iniEl.style.display='block'; }
        }
      }catch(_){}
    }

    /* Subida de avatar */
    const avatarBtn   = document.getElementById('avatarBtn');
    const avatarInput = document.getElementById('avatarInput');
    avatarBtn?.addEventListener('click', ()=> avatarInput?.click());
    avatarBtn?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); avatarInput?.click(); }});
    avatarInput?.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      if(f.size > 2*1024*1024){ showToast({title:'Avatar', body:'Máximo 2 MB', icon:'exclamation-triangle'}); return; }

      const fd = new FormData(); fd.append('avatar', f);
      try{
        const r = await fetch('/perfil/avatar', { method:'POST', body: fd });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j.ok){ throw new Error(j?.error || 'No se pudo actualizar el avatar'); }
        showToast({title:'Perfil', body:'Avatar actualizado', icon:'person-check'});
        const url = j.avatar_url + '?t=' + Date.now();
        const imgEl  = document.getElementById('avatarImg');
        const iniEl  = document.getElementById('avatarInitials');
        if(imgEl){ imgEl.src = url; imgEl.style.display='block'; }
        if(iniEl){ iniEl.style.display='none'; }
      }catch(err){
        showToast({title:'Perfil', body:String(err?.message||'Error'), icon:'exclamation-triangle'});
      }finally{
        try{ avatarInput.value=''; }catch(_){}
      }
    });

    /* Logout */
    function logout(){ fetch('/logout',{method:'POST'}).then(()=> location.href='/login?logout=1'); }
    document.getElementById('btnSalir')?.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

    /* Notificaciones */
    const notifBtn = document.getElementById('btnNotif');
    const notifPanel = document.getElementById('notif-panel');
    const notifBadge = document.getElementById('notifBadge');
    async function refreshNotif(){
      try{
        const r = await fetch('/notificaciones');
        const j = await r.json();
        const n = Number(j?.total_unread||0);
        if(notifBadge){
          notifBadge.textContent = n>99 ? '99+' : String(n);
          notifBadge.style.display = n>0 ? 'inline-block' : 'none';
        }
        const list = document.getElementById('notif-list');
        if(Array.isArray(j.items) && list){
          list.innerHTML = j.items.length
            ? j.items.map(it => `
                <div class="mb-2">
                  <b>${escapeHTML(it.titulo||'')}</b>
                  <div class="text-muted">${escapeHTML(it.cuerpo||'')}</div>
                  <div class="small text-muted">${escapeHTML(it.fecha_legible||'')}</div>
                </div>
              `).join('')
            : 'Sin notificaciones';
        }
      }catch(_){}
    }
    notifBtn?.addEventListener('click', ()=>{
      if(!notifPanel) return;
      const open = notifPanel.style.display==='block';
      notifPanel.style.display = open ? 'none' : 'block';
      notifBtn.setAttribute('aria-expanded', String(!open));
      if(!open) refreshNotif();
    });
    document.addEventListener('click', (e)=>{
      if(!notifPanel) return;
      if(!e.target.closest('#notif-panel') && !e.target.closest('#btnNotif')){
        notifPanel.style.display='none';
        notifBtn?.setAttribute('aria-expanded','false');
      }
    });
    document.getElementById('btnMarkRead')?.addEventListener('click', async ()=>{
      try{
        await fetch('/notificaciones/marcar-leidas',{method:'POST'});
        refreshNotif();
        showToast({title:'Notificaciones', body:'Marcadas como leídas', icon:'check2-circle'});
      }catch(_){}
    });

    /* ===== Drawer Sidebar (mobile/tablet) ===== */
    const mqDesktop = window.matchMedia('(min-width: 992px)');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const btnOpen = document.getElementById('btnOpenDrawer');
    const btnClose = document.getElementById('btnCloseDrawer');

    function isDesktop(){ return mqDesktop.matches; }
    function openSidebarMobile(){
      if(isDesktop()) return;
      sidebar.classList.add('open');
      overlay.classList.add('open');
      sidebar.setAttribute('aria-hidden','false');
      btnOpen?.setAttribute('aria-expanded','true');
      const first = sidebar.querySelector('a,button,[tabindex]:not([tabindex="-1"])');
      if(first) try{ first.focus(); }catch(_){}
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 280);
    }
    function closeSidebarMobile(){
      if(isDesktop()){
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
        sidebar.setAttribute('aria-hidden','false');
        btnOpen?.setAttribute('aria-expanded','false');
        return;
      }
      sidebar.classList.remove('open');
      overlay.classList.remove('open');
      sidebar.setAttribute('aria-hidden','true');
      btnOpen?.setAttribute('aria-expanded','false');
      btnOpen?.focus?.();
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 280);
    }
    btnOpen?.addEventListener('click', openSidebarMobile);
    btnClose?.addEventListener('click', closeSidebarMobile);
    overlay?.addEventListener('click', closeSidebarMobile);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSidebarMobile(); });

    function applySidebarMode(){
      if(isDesktop()){
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
        sidebar.setAttribute('aria-hidden','false');
        btnOpen?.setAttribute('aria-expanded','false');
      }else{
        sidebar.setAttribute('aria-hidden','true');
      }
      window.dispatchEvent(new Event('resize'));
    }
    mqDesktop.addEventListener?.('change', applySidebarMode);
    applySidebarMode();

    /* ===== Chat IA (drawer) ===== */
    const CHAT_STATE_KEY = 'chatboxState';
    const chatIa = document.getElementById('chatIa');
    const chatIaOverlay = document.getElementById('chatIaOverlay');
    const chatIaClose = document.getElementById('chatIaClose');
    const chatIaInput = document.getElementById('chatIaInput');
    const chatIaBody  = document.getElementById('chatIaBody');
    const chatIaForm  = document.getElementById('chatIaForm');
    const chatToggleBtn = document.getElementById('btnOpenChat');

    // Si estamos en login, no dejamos que el chat se muestre ni se autoabra
    const onAuth = document.body.getAttribute('data-auth') === '1';
    if (onAuth) {
      try { localStorage.removeItem(CHAT_STATE_KEY); }catch(_){}
      chatIa?.classList.remove('open');
      chatIaOverlay?.classList.remove('open');
      chatIa?.setAttribute('aria-hidden','true');
    }

    function openChatIA(persist=true){
      if(!chatIa || onAuth) return; // no abrir en login
      chatIa.classList.add('open');
      chatIaOverlay.classList.add('open');
      chatIa.setAttribute('aria-hidden','false');
      setTimeout(()=> chatIaInput?.focus(), 50);
      chatToggleBtn?.setAttribute('aria-pressed','true');
      if(persist) try{ localStorage.setItem(CHAT_STATE_KEY, 'open'); }catch(_){}
    }
    function closeChatIA(){
      if(!chatIa) return;
      chatIa.classList.remove('open');
      chatIaOverlay.classList.remove('open');
      chatIa.setAttribute('aria-hidden','true');
      chatToggleBtn?.setAttribute('aria-pressed','false');
      try{ localStorage.removeItem(CHAT_STATE_KEY); }catch(_){}
    }
    function toggleChatIA(){
      if(onAuth) return;
      const isOpen = chatIa?.classList.contains('open');
      if(isOpen) closeChatIA(); else openChatIA(true);
    }
    // Exponer por compatibilidad si algo lo llama
    function openChatAndExpand(){ openChatIA(true); }
    window.openChatAndExpand = openChatAndExpand;

    // Handlers propios
    chatIaOverlay?.addEventListener('click', closeChatIA);
    chatIaClose?.addEventListener('click', closeChatIA);
    chatToggleBtn?.addEventListener('click', toggleChatIA);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeChatIA(); });

    // ✅ Delegación estricta: solo el botón con data-ai-toggle="chat"
    document.addEventListener('click', function(ev){
      const btn = ev.target.closest('[data-ai-toggle="chat"]');
      if(!btn) return;
      ev.preventDefault();
      ev.stopPropagation();
      toggleChatIA();
    }, true);

    // Restaurar estado (salvo en login)
    if(!onAuth && localStorage.getItem(CHAT_STATE_KEY)==='open'){ openChatIA(false); }

    function scrollToBottom(smooth=true){
      try{ chatIaBody.scrollTo({ top: chatIaBody.scrollHeight, behavior: smooth ? 'smooth' : 'auto' }); }
      catch(_){ chatIaBody.scrollTop = chatIaBody.scrollHeight; }
    }

    // Enter = enviar | Shift+Enter = salto de línea
    chatIaInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey && !e.isComposing) {
        e.preventDefault(); chatIaForm?.requestSubmit();
      }
    });

    chatIaForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (chatIaInput?.value || '').trim();
      if(!text) return;

      appendMsg('me', text);
      chatIaInput.value = '';

      const thinkingNode = addTyping();

      try{
        const r = await fetch('/api/chat-openai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text })
        });

        let data = null, bodyText = '';
        try { data = await r.json(); } catch { bodyText = await r.text(); }
        const reply = pickReply(data, bodyText) || 'No recibí respuesta del servidor.';
        replaceMsg(thinkingNode, 'ai', reply);
      }catch(err){
        replaceMsg(thinkingNode, 'ai', 'Hubo un error al contactar la IA.');
      }
    });

    function pickReply(json, fallbackText){
      if(json){
        if(typeof json.reply === 'string') return json.reply;
        if(typeof json.respuesta === 'string') return json.respuesta;
        const c = json.choices?.[0];
        if(c?.message?.content) return c.message.content;
        if(c?.text) return c.text;
        if(json.data?.reply) return json.data.reply;
      }
      if(typeof fallbackText === 'string' && fallbackText.trim()) return fallbackText.trim();
      return '';
    }
    function appendMsg(who, text){
      const el = document.createElement('div');
      el.className = 'msg ' + (who==='ai'?'ai':'me');
      el.innerHTML = (who==='ai' ? '<b>IA:</b> ' : '<b>Yo:</b> ') + escapeHTML(text);
      const chatIaBody = document.getElementById('chatIaBody');
      chatIaBody.appendChild(el);
      scrollToBottom(true);
      return el;
    }
    function addTyping(){
      const el = document.createElement('div');
      el.className = 'msg ai typing';
      el.innerHTML = '<b>IA:</b> ' +
        '<span class="typing-dot"></span>' +
        '<span class="typing-dot"></span>' +
        '<span class="typing-dot"></span>';
      const chatIaBody = document.getElementById('chatIaBody');
      chatIaBody.appendChild(el);
      scrollToBottom(true);
      return el;
    }
    function replaceMsg(node, who, text){
      if(!node) return appendMsg(who, text);
      node.className = 'msg ' + (who==='ai'?'ai':'me');
      node.innerHTML = (who==='ai' ? '<b>IA:</b> ' : '<b>Yo:</b> ') + escapeHTML(text);
      scrollToBottom(true);
    }

    (function markActive(){
      try{
        const path = location.pathname || '/';
        document.querySelectorAll('.side-btn[data-match]').forEach(a=>{
          const m = a.getAttribute('data-match') || '';
          const on = (m === '/' ? path === '/' : path.startsWith(m));
          if(on) a.classList.add('active');
        });
      }catch(_){}
    })();

    document.getElementById('btnHistorial')?.addEventListener('click', (e)=>{
      if(location.pathname === '/'){
        e.preventDefault();
        document.getElementById('historial')?.scrollIntoView({behavior:'smooth', block:'start'});
      }
    });

    function showToast({title='Aviso', body='', icon='info', delay=3200}={}){
      const cont=document.getElementById('toastContainer'); if(!cont) return;
      const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
      el.innerHTML=`
        <div class="toast-header">
          <i class="bi bi-${escapeHTML(icon)} me-1"></i><strong class="me-auto">${escapeHTML(title)}</strong>
          <small>Ahora</small><button class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
        <div class="toast-body">${escapeHTML(body)}</div>`;
      cont.appendChild(el); const t=new bootstrap.Toast(el,{delay}); t.show(); el.addEventListener('hidden.bs.toast',()=> el.remove());
    }

    /* ===== Tema ===== */
    const btnTheme = document.getElementById('btnTheme');
    const icoTheme = document.getElementById('icoTheme');
    function getTheme(){ try{ return localStorage.getItem('theme'); }catch(_){ return null; } }
    function setTheme(val){
      try{
        if(val){ localStorage.setItem('theme', val); document.documentElement.setAttribute('data-theme', val); }
        else{ localStorage.removeItem('theme');
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }
      }catch(_){}
      updateThemeBtn();
      try{
        const meta = document.querySelector('meta[name="theme-color"]') || (function(){ const m=document.createElement('meta'); m.name='theme-color'; document.head.appendChild(m); return m; })();
        const t = getTheme();
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const isDark = t ? (t==='dark') : prefersDark;
        meta.setAttribute('content', isDark ? '#151B22' : '#eeede8');
      }catch(_){}
    }
    function updateThemeBtn(){
      const t = getTheme();
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if(t === 'dark'){ icoTheme.className='bi bi-moon-stars'; btnTheme.title='Tema: Oscuro'; }
      else if(t === 'light'){ icoTheme.className='bi bi-brightness-high'; btnTheme.title='Tema: Claro'; }
      else { icoTheme.className='bi bi-circle-half'; btnTheme.title = 'Tema: Sistema (' + (prefersDark?'Oscuro':'Claro') + ')'; }
    }
    btnTheme?.addEventListener('click', ()=>{
      const t = getTheme();
      if(t === null){ setTheme('dark'); }
      else if(t === 'dark'){ setTheme('light'); }
      else{ setTheme(null); }
    });
    try{
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if(getTheme()===null) updateThemeBtn(); });
    }catch(_){}
    updateThemeBtn();

    /* ===== PRESENCIA ===== */
    const presenceBtn   = document.getElementById('btnPresence');
    const presenceBadge = document.getElementById('presenceBadge');
    const isAuthScreen  = document.body.getAttribute('data-auth') === '1';

    presenceBtn?.addEventListener('click', ()=>{ location.href = '/usuarios-activos'; });

    async function presencePing(){ if(isAuthScreen) return; try{ await fetch('/presence/ping', { method:'POST' }); }catch(_){ } }
    async function refreshPresence(){
      if(isAuthScreen) return;
      try{
        const r = await fetch('/presence/online');
        if(!r.ok) return;
        const j = await r.json();
        const n = Array.isArray(j.items) ? j.items.length : 0;
        presenceBadge.textContent = n>99 ? '99+' : String(n);
        presenceBadge.style.display = n>0 ? 'inline-block' : 'none';
        presenceBtn.title = `Usuarios activos: ${n}`;
      }catch(_){}
    }
    if(!isAuthScreen){
      presencePing();
      refreshPresence();
      setInterval(presencePing, 30000);
      setInterval(refreshPresence, 15000);
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ presencePing(); refreshPresence(); }});
    }

    /* ===== NO LEÍDOS CHAT ===== */
    const chatBadge = document.getElementById('chatBadge');
    async function refreshChatUnread(){
      try{
        const r = await fetch('/chat/no-leidos');
        if(!r.ok) throw 0;
        const j = await r.json();
        const n = Number(j?.no_leidos||0);
        chatBadge.textContent = n>99 ? '99+' : String(n);
        chatBadge.style.display = n>0 ? 'inline-block' : 'none';
      }catch(_){
        chatBadge.style.display='none';
      }
    }
    refreshChatUnread();
    setInterval(refreshChatUnread, 15000);

    // Kill-switch FAB externo
    document.querySelectorAll('#chatOpenAiFab, .chat-openai-fab, [data-chat-fab]')
      .forEach(el => { try{ el.remove(); }catch(_){ el.style.display='none'; } });

    // Inicializaciones
    getUsuario();
    refreshNotif();

    /* =========================
       === RATING / WS / CAL ===
       ========================= */
    (function ratingInit(){
      const RATING_CFG = { minAutoDelayMs: 90_000, pendingCheckIntervalMs: 45_000 };
      const LS_KEYS = { last: 'lastAnalysisInfo', done: 'ratingDone:' };
      const modalEl = document.getElementById('ratingModal'); if(!modalEl) return;
      const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
      const starsWrap = document.getElementById('ratingStars');
      const hint = document.getElementById('ratingHint');
      const info = document.getElementById('ratingFileInfo');
      const commentEl = document.getElementById('ratingComment');
      const submitBtn = document.getElementById('ratingSubmit');
      const spinner = document.getElementById('ratingSpinner');
      const sendIcon = document.getElementById('ratingSendIcon');
      const banner = document.getElementById('ratingBanner');
      const bannerBtn = document.getElementById('ratingBannerBtn');
      const bannerClose = document.getElementById('ratingBannerClose');
      const state = { score: 0, timestamp: '', nombre_pdf: '' };

      function loadLast(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.last)||'{}')||{}; }catch(_){ return {}; } }
      function saveLast(obj){ try{ localStorage.setItem(LS_KEYS.last, JSON.stringify(obj||{})); }catch(_){ } }
      function setDone(ts){ try{ localStorage.setItem(LS_KEYS.done+ts, '1'); }catch(_){ } }
      function isDone(ts){ try{ return localStorage.getItem(LS_KEYS.done+ts)==='1'; }catch(_){ return false; } }

      function paintStars(n){
        starsWrap.querySelectorAll('.star').forEach(st=>{
          const v = Number(st.getAttribute('data-val'));
          st.classList.toggle('active', v <= n);
          st.setAttribute('aria-checked', String(v === n));
          st.classList.toggle('bi-star', !(v <= n));
          st.classList.toggle('bi-star-fill', v <= n);
        });
        hint.textContent = n ? `Tu valoración: ${n}/5` : 'Seleccioná una puntuación.';
      }

      function openFor(ts, filename){
        state.timestamp = ts || '';
        state.nombre_pdf = filename || '';
        state.score = 0;
        commentEl.value = '';
        info.textContent = filename ? `Archivo: ${filename}. Por favor, calificá el resultado (1 = malo, 5 = excelente).` : 'Por favor, calificá el resultado (1 = malo, 5 = excelente).';
        paintStars(0);
        modal.show();
        setTimeout(()=> starsWrap.querySelector('.star')?.focus(), 150);
      }
      window.promptRatingFor = openFor;

      starsWrap.addEventListener('click', (e)=>{
        const st = e.target.closest('.star'); if(!st) return;
        state.score = Number(st.getAttribute('data-val'))||0; paintStars(state.score);
      });
      starsWrap.addEventListener('keydown', (e)=>{
        const focused = document.activeElement?.closest?.('.star'); if(!focused) return;
        let val = Number(focused.getAttribute('data-val'))||0;
        if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); val = Math.min(5, val+1); }
        if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); val = Math.max(1, val-1); }
        if(e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); state.score = val; }
        paintStars(e.key===' '||e.key==='Enter' ? state.score : val);
      });

      async function sendRating(){
        if(!state.score){
          showToast({title:'Valoración', body:'Seleccioná entre 1 y 5 estrellas.', icon:'exclamation-triangle'});
          return;
        }
        submitBtn.disabled = true; spinner.classList.remove('d-none'); sendIcon.classList.add('d-none');
        try{
          const res = await fetch('/api/rating', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ timestamp: state.timestamp, nombre_pdf: state.nombre_pdf, estrellas: state.score, comentario: commentEl.value || '' })
          });
          const j = await res.json().catch(()=> ({}));
          if(!res.ok || j?.error){ throw new Error(j?.error || 'No se pudo registrar la valoración.'); }
          setDone(state.timestamp);
          try{ bootstrap.Modal.getInstance(modalEl)?.hide(); }catch(_){}
          showToast({title:'¡Gracias!', body:'Tu valoración fue registrada.', icon:'star-fill'});
          hideBanner();
          refreshNotif();
        }catch(err){
          showToast({title:'Valoración', body:String(err?.message||'Error'), icon:'exclamation-triangle'});
        }finally{
          submitBtn.disabled = false; spinner.classList.add('d-none'); sendIcon.classList.remove('d-none');
        }
      }
      document.getElementById('ratingSubmit')?.addEventListener('click', sendRating);

      function showBanner(){ const b=document.getElementById('ratingBanner'); if(b) b.style.display='block'; }
      function hideBanner(){ const b=document.getElementById('ratingBanner'); if(b) b.style.display='none'; }
      bannerBtn?.addEventListener('click', ()=>{ const last = loadLast(); if(last?.ts && !isDone(last.ts)) openFor(last.ts, last.pdf||''); });
      bannerClose?.addEventListener('click', hideBanner);

      function scheduleAutoOpen(){
        const last = loadLast(); if(!last?.ts || isDone(last.ts)) return;
        const elapsed = Date.now() - (last.createdAt||0);
        const wait = Math.max(RATING_CFG.minAutoDelayMs - elapsed, 0);
        clearTimeout(scheduleAutoOpen._t);
        scheduleAutoOpen._t = setTimeout(()=>{
          const again = loadLast();
          if(again?.ts && !isDone(again.ts)){ openFor(again.ts, again.pdf||''); }
        }, wait);
      }
      function markViewed(ts){ const last = loadLast(); if(last?.ts === ts){ last.viewed = true; saveLast(last); } }
      function markDownloaded(ts){ const last = loadLast(); if(last?.ts === ts){ last.downloaded = true; saveLast(last); } }

      document.addEventListener('click', (e)=>{
        const a = e.target.closest('a[href]'); if(!a) return;
        const href = (a.getAttribute('href')||'').trim();
        const m = href.match(/resumen_(\d{14})\.pdf$/i); if(!m) return;
        const ts = m[1];
        if(/\/descargar\//i.test(href)){
          markDownloaded(ts);
          setTimeout(()=>{
            const last = loadLast();
            if(last?.ts === ts && !isDone(last.ts)) openFor(ts, last.pdf||href.split('/').pop());
          }, 800);
        }else{ markViewed(ts); }
      });

      const _origFetch = window.fetch;
      window.fetch = async function(input, init){
        const res = await _origFetch(input, init);
        try{
          const url = (typeof input === 'string') ? input : (input?.url || '');
          if(/\/analizar-pliego\/?$/.test(url)){
            const clone = res.clone();
            const j = await clone.json().catch(()=> ({}));
            if(res.status === 409 || res.headers.get('X-Require-Rating') === '1'){
              const last = j?.last || j?.pending || {};
              if(last?.timestamp){
                saveLast({ ts: last.timestamp, pdf: last.nombre_pdf||'', createdAt: Date.now(), viewed:false, downloaded:false });
                showBanner(); scheduleAutoOpen();
                showToast({title:'Valoración requerida', body:'Podés revisar el análisis y valorarlo cuando quieras.', icon:'star'});
              }
            }else if(j && j.pdf && j.timestamp){
              saveLast({ ts: j.timestamp, pdf: j.pdf, createdAt: Date.now(), viewed:false, downloaded:false });
              showBanner(); scheduleAutoOpen();
              showToast({title:'Análisis listo', body:'Podés revisar/descargar y luego valorarlo.', icon:'check-circle'});
            }
          }
        }catch(_){}
        return res;
      };

      async function checkPending(){
        try{
          const r = await fetch('/api/rating/pending', { headers:{'Accept':'application/json'} });
          if(!r.ok) return;
          const j = await r.json().catch(()=> ({}));
          if(j?.pending || j?.last){
            const last = j.last || j.pending;
            if(last?.timestamp && !isDone(last.timestamp)){
              saveLast({ ts: last.timestamp, pdf: last.nombre_pdf||'', createdAt: Date.now(), viewed:false, downloaded:false });
              showBanner(); scheduleAutoOpen();
            }
          }else{
            hideBanner();
          }
        }catch(_){}
      }
      checkPending();
      setInterval(checkPending, RATING_CFG.pendingCheckIntervalMs);

      document.addEventListener('submit', async (e)=>{
        const form = e.target;
        try{
          const action = (form.getAttribute('action')||'').toLowerCase();
          const method = (form.getAttribute('method')||'get').toLowerCase();
          if(action.includes('/analizar-pliego') && method === 'post'){
            const r = await fetch('/api/rating/pending');
            const j = await r.json().catch(()=> ({}));
            if(j?.pending){
              e.preventDefault();
              const last = j.last || j.pending;
              saveLast({ ts: last?.timestamp||'', pdf: last?.nombre_pdf||'', createdAt: Date.now(), viewed:false, downloaded:false });
              showBanner(); scheduleAutoOpen();
              showToast({title:'Valoración requerida', body:'Calificá el análisis anterior para continuar.', icon:'exclamation-circle'});
            }
          }
        }catch(_){}
      });

      (function syncFromBodyData(){
        const b = document.body; if(!b) return;
        const fname = b.getAttribute('data-last-pdf') || '';
        const ts = b.getAttribute('data-last-ts') || '';
        if(ts){
          saveLast({ ts, pdf: fname||'', createdAt: Date.now(), viewed:false, downloaded:false });
          showBanner(); scheduleAutoOpen();
        }
      })();

      window.__rateLast = async function(){
        const last = loadLast();
        if(last?.ts && !isDone(last.ts)){ openFor(last.ts, last.pdf||''); }
        else{ showToast({title:'Prueba', body:'No hay análisis pendiente para valorar.', icon:'info-circle'}); }
      };
    })();

    /* =========================
       === WebSocket realtime ===
       ========================= */
    (function setupRealtime(){
      if(document.body.getAttribute('data-auth') === '1') return; // no WS en login
      let ws, retry = 0, pingTimer = null, reconnectTimer = null;
      function wsUrl(){ const proto = (location.protocol === 'https:') ? 'wss:' : 'ws:'; return proto + '//' + location.host + '/ws'; }
      function connect(){
        clearTimeout(reconnectTimer);
        try{ ws = new WebSocket(wsUrl()); }catch(_){ scheduleReconnect(); return; }
        ws.addEventListener('open', ()=>{ retry = 0; startPing(); });
        ws.addEventListener('message', (ev)=>{
          let data = null; try{ data = JSON.parse(ev.data); }catch(_){ return; }
          if(!data || !data.event) return;
          if(data.event === 'ws:pong'){ return; }
          if(data.event === 'alert:new'){
            refreshNotif();
            showToast({ title: data.title || 'Notificación', body: data.body || '', icon:'bell' });
          }
          if(data.event === 'chat:new_message'){
            try{
              const nEl = document.getElementById('chatBadge');
              const cur = parseInt(nEl?.textContent||'0',10) || 0;
              const next = Math.min(cur + 1, 999);
              if(nEl){ nEl.textContent = next > 99 ? '99+' : String(next); nEl.style.display = 'inline-block'; }
            }catch(_){}
            if(!location.pathname.startsWith('/chat')){
              const from = data.from || 'Nuevo mensaje';
              const prev = data.preview || '';
              showToast({ title: `Mensaje de ${from}`, body: prev, icon: 'chat-dots' });
            }
          }
        });
        ws.addEventListener('close', ()=>{ stopPing(); scheduleReconnect(); });
        ws.addEventListener('error', ()=>{ try{ ws.close(); }catch(_){ } });
      }
      function scheduleReconnect(){ stopPing(); clearTimeout(reconnectTimer); const backoff = Math.min(30000, 1000 * Math.pow(2, retry++)); reconnectTimer = setTimeout(connect, backoff); }
      function startPing(){ stopPing(); pingTimer = setInterval(()=>{ try{ ws?.readyState===1 && ws.send('ping'); }catch(_){ } }, 25000); }
      function stopPing(){ clearInterval(pingTimer); pingTimer = null; }
      connect();
      window.addEventListener('beforeunload', ()=>{ try{ ws?.close(); }catch(_){ } });
    })();

    /* ==========================================================
       === CALENDARIO GLOBAL (panel + subpáginas) – robusto ===
       ========================================================== */
    (function calendarGlobalControls(){
      const FCv = '6.1.11';
      const FC_CSS = `https://cdn.jsdelivr.net/npm/fullcalendar@${FCv}/index.global.min.css`;
      const FC_JS  = `https://cdn.jsdelivr.net/npm/fullcalendar@${FCv}/index.global.min.js`;
      const FC_LOC = `https://cdn.jsdelivr.net/npm/fullcalendar@${FCv}/locales-all.global.min.js`;

      function addCss(href){ if ([...document.styleSheets].some(s => s.href && s.href.includes('fullcalendar'))) return;
        const l = document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); }
      function addScript(src){
        return new Promise((res, rej)=>{ const s = document.createElement('script'); s.defer = true; s.src = src; s.onload = res; s.onerror = rej; document.head.appendChild(s); });
      }
      async function ensureFullCalendar(){ if (window.FullCalendar?.Calendar) return; addCss(FC_CSS); await addScript(FC_JS); await addScript(FC_LOC); }

      function installFullCalendarHook(){
        const FC = window.FullCalendar; if(!FC || !FC.Calendar || FC.Calendar.__saHooked) return;
        const origRender = FC.Calendar.prototype.render;
        FC.Calendar.prototype.render = function(){
          const out = origRender.apply(this, arguments);
          try{ this.el.__fcCalendar = this; window.AppCalendar = window.AppCalendar || this; window.__calendar = window.__calendar || this; }catch(_){}
          return out;
        };
        FC.Calendar.__saHooked = true;
      }
      function findFcRoot(btn){
        const sel = btn?.getAttribute?.('data-cal-target');
        if (sel){ const t = document.querySelector(sel); if (t) return t.closest('#calendar, .fc, [id]') || t; }
        return document.querySelector('#calendar') || document.querySelector('.fc') || document.body;
      }
      function getCalendarFor(btn){
        const root = findFcRoot(btn);
        if (root?.__fcCalendar) return root.__fcCalendar;
        return window.AppCalendar || window.__calendar || window.calendar || window.fcCalendar || null;
      }
      function ensureDataAttrs(scope){
        const items = (scope || document).querySelectorAll('button, a, [role="button"]');
        const txt = (el)=> (el.textContent||'').trim().toLowerCase();
        items.forEach(el=>{
          const t = txt(el);
          if(!el.hasAttribute('data-cal-view')){
            if(t==='mes') el.setAttribute('data-cal-view','dayGridMonth');
            if(t==='semana') el.setAttribute('data-cal-view','timeGridWeek');
            if(t==='lista') el.setAttribute('data-cal-view','listWeek');
          }
          if(!el.hasAttribute('data-cal-nav')){
            if(t==='hoy') el.setAttribute('data-cal-nav','today');
            const aria = (el.getAttribute('aria-label')||'').toLowerCase();
            if(aria.includes('anterior') || t==='‹' || t==='<') el.setAttribute('data-cal-nav','prev');
            if(aria.includes('siguiente')|| t==='›' || t==='>') el.setAttribute('data-cal-nav','next');
          }
          if(el.tagName==='BUTTON' && el.type!=='button') el.type='button';
          if(el.tagName==='A' && el.getAttribute('href')==='#') el.setAttribute('role','button');
        });
      }
      function highlightActive(cal){
        try{
          const type = cal?.view?.type;
          document.querySelectorAll('[data-cal-view]').forEach(b=>{
            b.classList.toggle('is-active', b.getAttribute('data-cal-view') === type);
          });
        }catch(_){}
      }

      const NAV_SEL  = { prev: '.fc-prev-button', next: '.fc-next-button', today: '.fc-today-button' };
      const VIEW_SEL = { dayGridMonth: '.fc-dayGridMonth-button', timeGridWeek: '.fc-timeGridWeek-button', timeGridDay: '.fc-timeGridDay-button', listWeek: '.fc-listWeek-button' };
      function clickInside(root, sel){
        if(!root) return false;
        const inRoot = root.querySelector(sel) || document.querySelector(sel);
        if(inRoot){ inRoot.click(); return true; }
        return false;
      }

      document.addEventListener('click', function(ev){
        const btn = ev.target.closest?.('[data-cal-nav],[data-cal-view]'); if(!btn) return;
        const href = btn.getAttribute('href'); if(href === '#' || href === '') ev.preventDefault();

        ensureFullCalendar().then(()=>{
          installFullCalendarHook();
          const root = findFcRoot(btn);
          const cal = getCalendarFor(btn);

          const nav = btn.getAttribute('data-cal-nav');
          if(nav){
            if(cal){ if(nav==='prev') cal.prev(); if(nav==='next') cal.next(); if(nav==='today') cal.today(); }
            else { clickInside(root, NAV_SEL[nav]); }
          }
          const view = btn.getAttribute('data-cal-view');
          if(view){
            if(cal){ try{ cal.changeView(view); }catch(_){} highlightActive(cal); }
            else { clickInside(root, VIEW_SEL[view]); }
          }
        }).catch(()=>{ /* ignorar */ });
      }, true);

      window.addEventListener('DOMContentLoaded', ()=>{ ensureDataAttrs(document); });

      window.__calProbe = function(){
        const tgtBtn = document.querySelector('[data-cal-target]');
        const root = tgtBtn ? findFcRoot(tgtBtn) : (document.querySelector('#calendar')||document.querySelector('.fc'));
        const cal = root?.__fcCalendar || window.AppCalendar || null;
        return { hasFC: !!(window.FullCalendar && FullCalendar.Calendar), rootFound: !!root, hasInstance: !!cal, view: cal?.view?.type || null };
      };
    })();

    /* >>> Fallback: asegura que los botones dentro de formularios envían el form */
    document.querySelectorAll('form button:not([type])').forEach(b => b.setAttribute('type','submit'));
    /* <<< */
  </script>
  {% block extra_scripts %}{% endblock %}
</body>
</html>
