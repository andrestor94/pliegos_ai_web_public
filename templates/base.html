<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}Suizo Argentina – Licitaciones IA{% endblock %}</title>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <style>
    :root{
      --grad-a:#7c3aed; --grad-b:#ec4899; --grad-c:#2563eb;
      --panel:#ffffff; --ink:#0f1222; --muted:#667085; --border:#e7e9f2;
      --accent-a:#8b5cf6; --accent-b:#f472b6; --accent-c:#22d3ee;
      --pill:#f0f3ff; --radius:22px; --shadow:0 12px 32px rgba(20,15,55,.16);
    }

    html, body { height:100%; }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      overflow:hidden;
    }

    /* ===== Shell / Layout normal ===== */
    .shell{ width:100vw; height:100vh; margin:0; background:var(--panel); border-radius:0; border:none; box-shadow:none; overflow:hidden; display:block; }
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 74px 1fr;
      grid-template-rows: 76px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar content";
    }

    /* ===== Sidebar más corta y centrada ===== */
    .sidebar{
      grid-area:sidebar;
      display:flex; flex-direction:column; align-items:center;
      width:74px; padding:14px 8px;
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border-radius: 0 26px 26px 0;
      box-shadow: 0 10px 26px rgba(2,6,23,.34), inset 0 0 0 1px rgba(255,255,255,.04);
      color:#fff;
      height: 70%;          /* altura más corta */
      margin: auto 0;       /* centrado vertical con aire arriba/abajo */
    }

    .side-logo{
      width:46px; height:46px; border-radius:12px;
      background:#fff; display:grid; place-items:center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .side-logo img{ width:30px; height:30px; object-fit:contain; }

    .side-nav{ display:flex; flex-direction:column; gap:8px; align-items:center; width:100%; margin-top:8px; }

    .side-btn{
      width:44px; height:44px;
      border-radius:12px; display:grid; place-items:center;
      color:#cbd5e1; font-size:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
      text-decoration:none;
    }
    .side-btn:hover{ transform:translateY(-2px); color:#fff; box-shadow:0 12px 22px rgba(0,0,0,.28); background:rgba(255,255,255,.08); }
    .side-btn.active{ color:#fff; background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); border-color:transparent; box-shadow:0 10px 22px rgba(139,92,246,.35); }

    .side-spacer{ flex:1; }
    .side-small{ color:#94a3b8; font-size:11px; }

    /* Header */
    .header{
      grid-area:header;
      display:flex; align-items:center; gap:12px;
      padding:12px 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.92), rgba(255,255,255,.92));
      backdrop-filter: blur(6px);
    }
    .brand{ display:flex; align-items:center; gap:12px; padding:8px 12px; border-radius:16px; border:1px solid var(--border); background:#fff; }
    .brand img{ height:26px; width:auto; object-fit:contain; }
    .brand b{ font-weight:700; }
    .header-actions{ margin-left:auto; display:flex; align-items:center; gap:10px; }
    .pill{ border-radius:999px; padding:.55rem 1rem; border:1px solid var(--border); background:var(--pill); color:#222; font-weight:500; text-decoration:none; }
    .pill-grad{ border:none; color:#fff; background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); box-shadow:0 12px 26px rgba(139,92,246,.32); }
    .pill-icon{ display:inline-flex; align-items:center; gap:.5rem; }
    .icon-btn{ width:44px; height:44px; display:grid; place-items:center; border-radius:14px; border:1px solid var(--border); background:#fff; }

    /* Content */
    .content{
      grid-area:content;
      position:relative;
      padding:24px;
      min-height:0;
      height:100%;
      overflow:auto;
      background:
        radial-gradient(900px 660px at 16% 16%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(1000px 720px at 84% 80%, rgba(236,72,153,.12), transparent 60%),
        radial-gradient(780px 560px at 76% 8%, rgba(124,58,237,.10), transparent 60%),
        #f7f8ff;
    }

    .cardx{ background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:16px; position:relative; }
    .cardx .title{ font-weight:700; display:flex; align-items:center; gap:8px; }
    .muted{ color:var(--muted); }
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .col-3{ grid-column: span 3; } .col-4{ grid-column: span 4; } .col-5{ grid-column: span 5; }
    .col-6{ grid-column: span 6; } .col-7{ grid-column: span 7; } .col-8{ grid-column: span 8; } .col-12{ grid-column: span 12; }

    @media (max-width: 1200px){ .col-5,.col-4,.col-3{ grid-column: span 6; } }
    @media (max-width: 760px){
      .app{ grid-template-columns: 1fr; grid-template-rows: 76px 1fr; grid-template-areas: "header" "content"; }
      .sidebar{ display:none; }
      .content{ padding:16px; }
      .grid{ grid-template-columns: repeat(6, 1fr); }
      .col-8,.col-7,.col-6,.col-5,.col-4,.col-3{ grid-column: span 6; }
    }

    /* Toasts */
    .toast-container{ position:fixed; right:16px; bottom:16px; z-index:1200; }
    .toast{ border-radius:12px; box-shadow:var(--shadow); }
    .toast-header{ border-bottom:none; }

    /* ===== LOGIN / AUTH MODE ===== */
    body[data-auth="1"] .app{
      grid-template-columns: 1fr; grid-template-rows: 1fr; grid-template-areas: "content";
    }
    body[data-auth="1"] .sidebar, body[data-auth="1"] .header{ display:none !important; }
    body[data-auth="1"] .content{
      display:grid; place-items:center; padding:24px;
      background: linear-gradient(180deg,#f6f8ff 0%, #eef3ff 100%);
    }
    @media (prefers-color-scheme: dark){
      body[data-auth="1"] .content{ background: linear-gradient(180deg,#0b1020 0%, #0b1328 100%); }
    }

    /* ===== Chat IA (drawer derecho) ===== */
    .chat-ia-overlay{
      position:fixed; inset:0; background:rgba(15,18,34,.28); backdrop-filter: blur(2px);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:1200;
    }
    .chat-ia{
      position:fixed; top:0; right:-480px; height:100%; width:480px; max-width:100%;
      background:#fff; border-left:1px solid var(--border); box-shadow: var(--shadow);
      display:flex; flex-direction:column; transition:right .28s ease; z-index:1201;
    }
    .chat-ia.open{ right:0; }
    .chat-ia-overlay.open{ opacity:1; pointer-events:auto; }

    .chat-ia__header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.96), rgba(255,255,255,.96));
    }
    .chat-ia__title{ font-weight:700; display:flex; align-items:center; gap:8px; }
    .chat-ia__close{ border:1px solid var(--border); background:#fff; border-radius:10px; width:36px; height:36px; display:grid; place-items:center; }

    .chat-ia__body{
      flex:1; overflow:auto; padding:14px; background:
      radial-gradient(700px 520px at 84% 12%, rgba(236,72,153,.10), transparent 60%),
      radial-gradient(600px 420px at 8% 88%, rgba(37,99,235,.10), transparent 60%),
      #f8f9ff;
    }
    .msg{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:10px 12px; margin-bottom:10px; }
    .msg.ai{ background:linear-gradient(180deg,#ffffff,#fbfdff); }
    .msg.me{ background:#eff4ff; border-color:#dfe6ff; }

    .chat-ia__composer{
      padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; background:#fff;
    }
    .chat-ia__composer textarea{
      resize:none; height:46px; flex:1; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    .chat-ia__send{
      border:none; border-radius:999px; padding:0 16px; min-width:120px;
      background:linear-gradient(135deg, var(--accent-a), var(--accent-b)); color:#fff;
      box-shadow:0 12px 26px rgba(139,92,246,.22);
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body data-auth="{{ '1' if request and request.url.path.startswith('/login') else '' }}"
      data-route="{{ request.url.path if request else '' }}">

  <script>
    (function(){
      try{
        var r = document.body.getAttribute('data-route') || location.pathname;
        if (r.indexOf('/login') === 0) document.body.setAttribute('data-auth','1');
      }catch(e){}
    })();
  </script>

  <div class="shell">
    <div class="app">
      <!-- ===== Sidebar ===== -->
      <aside class="sidebar">
        <div class="side-logo" title="Suizo Argentina">
          <img src="/static/logo-suizo.png" alt="Suizo"/>
        </div>

        <nav class="side-nav">
          <a class="side-btn" data-match="/"               href="/"               title="Inicio"><i class="bi bi-house"></i></a>
          <a class="side-btn" data-match="/chat"           href="/chat"           title="Chat interno"><i class="bi bi-chat-dots"></i></a>
          <a class="side-btn" data-match="/incidencias"    href="/incidencias"    title="Incidencias"><i class="bi bi-bug"></i></a>
          <a class="side-btn" data-match="/calendario"     href="/calendario"     title="Calendario"><i class="bi bi-calendar-event"></i></a>
          <a class="side-btn" data-match="/historia"       href="/historia"       title="Historial"><i class="bi bi-clock-history"></i></a>
          <a class="side-btn" data-match="/auditoria"      href="/auditoria"      title="Auditoría"><i class="bi bi-clipboard-data"></i></a>
          <a class="side-btn" data-match="/admin"          href="/admin"          title="Admin"><i class="bi bi-gear"></i></a>
        </nav>

        <div class="side-spacer"></div>

        <a class="side-btn" data-match="/cambiar-password" href="/cambiar-password" title="Cambiar contraseña"><i class="bi bi-key"></i></a>
        <a class="side-btn" href="#" id="btnSalir" title="Salir"><i class="bi bi-box-arrow-right"></i></a>
        <div class="side-small">v1</div>
      </aside>

      <!-- ===== Header ===== -->
      <header class="header">
        <div class="brand">
          <img src="/static/logo-suizo.png" alt="Logo Suizo">
          <div><b>Suizo Argentina</b> <span class="muted">— Licitaciones IA</span></div>
        </div>

        <div class="header-actions">
          <button class="icon-btn" id="btnNotif" title="Notificaciones"><i class="bi bi-bell"></i></button>
          <a class="pill pill-icon" href="/chat"><i class="bi bi-chat-dots"></i> Chat interno</a>
          <button class="pill pill-grad pill-icon" onclick="openChatAndExpand()"><i class="bi bi-robot"></i> Chat OpenAI</button>
          <span id="usuario-nombre" class="ms-1 small text-muted"></span>
        </div>
      </header>

      <!-- ===== Área de contenido ===== -->
      <main class="content">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Panel notificaciones -->
  <div id="notif-panel" class="cardx position-fixed" style="right:22px; top:22px; width:340px; display:none; z-index:999;">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <strong>Notificaciones</strong>
      <button class="btn btn-sm btn-outline-secondary" id="btnMarkRead">Marcar leídas</button>
    </div>
    <div id="notif-list" class="small text-muted">Sin notificaciones</div>
    <div class="text-end mt-2"><a href="/notificaciones" class="small">Ver todas</a></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- ===== Drawer Chat IA ===== -->
  <div id="chatIaOverlay" class="chat-ia-overlay"></div>
  <aside id="chatIa" class="chat-ia" aria-hidden="true">
    <div class="chat-ia__header">
      <div class="chat-ia__title"><i class="bi bi-robot"></i> Chat OpenAI</div>
      <button id="chatIaClose" class="chat-ia__close" title="Cerrar"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="chatIaBody" class="chat-ia__body">
      <div class="msg ai"><b>IA:</b> ¿En qué te ayudo con licitaciones?</div>
    </div>
    <form id="chatIaForm" class="chat-ia__composer">
      <textarea id="chatIaInput" placeholder="Escribe tu mensaje…"></textarea>
      <button class="chat-ia__send" type="submit"><i class="bi bi-send"></i> Enviar</button>
    </form>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* Usuario en header */
    async function getUsuario(){
      try{
        const r=await fetch('/usuario-actual'); if(!r.ok) return;
        const d=await r.json();
        const target=document.getElementById('usuario-nombre');
        if(target) target.textContent = d?.usuario ? `· ${d.usuario}` : '';
      }catch(_){}
    }

    /* Logout */
    function logout(){ fetch('/logout',{method:'POST'}).then(()=> location.href='/login?logout=1'); }
    document.getElementById('btnSalir')?.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

    /* Notificaciones */
    const notifBtn = document.getElementById('btnNotif');
    const notifPanel = document.getElementById('notif-panel');
    notifBtn?.addEventListener('click', ()=>{ if(!notifPanel) return; notifPanel.style.display = (notifPanel.style.display==='block'?'none':'block'); });
    document.addEventListener('click', (e)=>{
      if(!notifPanel) return;
      if(!e.target.closest('#notif-panel') && !e.target.closest('#btnNotif')) notifPanel.style.display='none';
    });
    document.getElementById('btnMarkRead')?.addEventListener('click', async ()=>{
      try{
        await fetch('/notificaciones/marcar-leidas',{method:'POST'});
        showToast({title:'Notificaciones', body:'Marcadas como leídas', icon:'check2-circle'});
      }catch(_){}
    });

    /* ===== Chat IA (funcional) ===== */
    const CHAT_STATE_KEY = 'chatboxState';
    const chatIa = document.getElementById('chatIa');
    const chatIaOverlay = document.getElementById('chatIaOverlay');
    const chatIaClose = document.getElementById('chatIaClose');
    const chatIaInput = document.getElementById('chatIaInput');
    const chatIaBody  = document.getElementById('chatIaBody');
    const chatIaForm  = document.getElementById('chatIaForm');

    function openChatIA(persist=true){
      if(!chatIa) return;
      chatIa.classList.add('open');
      chatIaOverlay.classList.add('open');
      chatIa.setAttribute('aria-hidden','false');
      setTimeout(()=> chatIaInput?.focus(), 50);
      if(persist) localStorage.setItem(CHAT_STATE_KEY, 'open');
    }
    function closeChatIA(){
      if(!chatIa) return;
      chatIa.classList.remove('open');
      chatIaOverlay.classList.remove('open');
      chatIa.setAttribute('aria-hidden','true');
      localStorage.removeItem(CHAT_STATE_KEY);
    }
    function openChatAndExpand(){ openChatIA(true); } // usado por el botón del header

    chatIaOverlay?.addEventListener('click', closeChatIA);
    chatIaClose?.addEventListener('click', closeChatIA);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeChatIA(); });

    if(localStorage.getItem(CHAT_STATE_KEY)==='open'){ openChatIA(false); }

    chatIaForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (chatIaInput?.value || '').trim();
      if(!text) return;
      appendMsg('me', text);
      chatIaInput.value = '';
      try{
        const r = await fetch('/api/chat-openai', {   // <-- ajusta si tu endpoint es otro
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text })
        });
        const data = await r.json().catch(()=> ({}));
        appendMsg('ai', data?.reply || 'Listo.');
      }catch(err){
        appendMsg('ai', 'Hubo un error al contactar la IA.');
      }
    });

    function appendMsg(who, text){
      const el = document.createElement('div');
      el.className = 'msg ' + (who==='ai'?'ai':'me');
      el.innerHTML = (who==='ai' ? '<b>IA:</b> ' : '<b>Yo:</b> ') + escapeHTML(text);
      chatIaBody.appendChild(el);
      chatIaBody.scrollTop = chatIaBody.scrollHeight;
    }
    function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* Link activo */
    (function markActive(){
      const path=location.pathname;
      document.querySelectorAll('.side-btn[data-match]').forEach(a=>{
        const m=a.getAttribute('data-match');
        const on = (m === '/' ? path==='/' : path.startsWith(m));
        if(on) a.classList.add('active');
      });
    })();

    /* Toast helper */
    function showToast({title='Aviso', body='', icon='info', delay=3200}={}){
      const cont=document.getElementById('toastContainer'); if(!cont) return;
      const esc=(s)=> (s??'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
      el.innerHTML=`<div class="toast-header">
        <i class="bi bi-${esc(icon)} me-1"></i><strong class="me-auto">${esc(title)}</strong>
        <small>Ahora</small><button class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div><div class="toast-body">${esc(body)}</div>`;
      cont.appendChild(el); const t=new bootstrap.Toast(el,{delay}); t.show(); el.addEventListener('hidden.bs.toast',()=> el.remove());
    }

    getUsuario();
  </script>

  {% block extra_scripts %}{% endblock %}
</body>
</html>
