{% extends "base.html" %}

{% block title %}Panel de Administraci√≥n ¬∑ Suizo Argentina{% endblock %}

{% block extra_head %}
  {# axios solo aqu√≠ (la base no lo carga) #}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    /* --- Estilos SCOPED y alineados al theme --- */
    .admin-actions .btn{ border-radius:12px; }

    /* Badges de rol/estado usando tokens */
    .badge-role{
      background: var(--brand-100);
      color: var(--brand-500);
      border: 1px solid var(--bs-border-color, var(--border));
      font-weight: 600;
    }
    .badge-ok{
      background: #10b981; color: #fff;
      border: 1px solid rgba(0,0,0,.05);
    }
    .badge-off{
      background: var(--muted); color: var(--text-2);
      border: 1px solid var(--bs-border-color, var(--border));
    }

    .hint{ color: var(--text-2); }

    .kpi-box{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border:1px solid var(--bs-border-color, var(--border));
      border-radius:12px;
      background: var(--surface);
      min-width:160px;
      box-shadow: var(--shadow-sm);
    }
    .kpi-num{ font-size:20px; font-weight:800; line-height:1; color: var(--text); }
    .kpi-sub{ font-size:12px; color: var(--text-2); }
  </style>
{% endblock %}

{% block content %}
<div class="container-xxl stack">

  <!-- Encabezado + acciones -->
  <section class="card-clean shadow-hover">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h1 class="h5 m-0 text-brand">
        <i class="bi bi-gear me-1"></i> Administraci√≥n de Usuarios
      </h1>
      <div class="d-flex flex-wrap gap-2">
        <a href="/auditoria/actividad/vista" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-graph-up"></i> Actividad de usuarios
        </a>
        <a href="/usuarios-activos" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-people"></i> Usuarios activos (vivo)
        </a>
        <a href="/auditoria" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-clipboard-data"></i> Ver auditor√≠a
        </a>
        <a href="/" class="btn btn-sm btn-outline-secondary">‚Üê Volver</a>
      </div>
    </div>
  </section>

  <!-- Monitoreo -->
  <section class="card-clean shadow-hover">
    <div class="card-body d-flex align-items-center gap-3 flex-wrap">
      <div class="kpi-box">
        <i class="bi bi-activity fs-5"></i>
        <div>
          <div id="kpiOnline" class="kpi-num">‚Äî</div>
          <div class="kpi-sub">en l√≠nea (√∫lt. 5 min)</div>
        </div>
      </div>
      <div class="hint">
        La auditor√≠a registra inicios/cierres y duraci√≥n por usuario. ‚ÄúUsuarios activos‚Äù muestra qui√©n est√° conectado ahora mismo.
      </div>
    </div>
  </section>

  <!-- Crear usuario -->
  <section class="card-clean shadow-hover">
    <div class="card-header">
      <h2 class="h6 m-0">Crear nuevo usuario</h2>
    </div>
    <div class="card-body">
      <form id="crearUsuarioForm" class="row g-3 input-compact">
        <div class="col-md-4">
          <label class="form-label" for="nombre">Nombre</label>
          <input type="text" class="form-control" id="nombre" required placeholder="Nombre y Apellido">
        </div>
        <div class="col-md-4">
          <label class="form-label" for="email">Email</label>
          <input type="email" class="form-control" id="email" required placeholder="usuario@suizo.com">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="rol">Rol</label>
          <select class="form-select" id="rol">
            <option value="usuario">Usuario</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div class="col-md-1 d-grid">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
      </form>
      <div class="mt-2 hint small">
        Se crea con contrase√±a inicial por defecto (luego pod√©s blanquearla desde la tabla).
      </div>
      <div id="mensaje" class="mt-3"></div>
    </div>
  </section>

  <!-- Lista de usuarios -->
  <section class="card-clean shadow-hover">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h2 class="h6 m-0">Usuarios registrados</h2>
      <div class="d-flex gap-2 align-items-center">
        <input id="filtro" class="form-control form-control-sm" style="max-width:260px" placeholder="Filtrar por nombre o email">
        <button id="btnRefrescar" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-clockwise"></i> Refrescar
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="table-wrap">
        <table class="table align-middle table-hover mb-0">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th style="min-width:340px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaUsuarios"><!-- JS --></tbody>
        </table>
      </div>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const DEFAULT_RESET_PASSWORD = '1234'; // ajust√° si tu backend usa otra por defecto

  /* Utils */
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function toastOk(t,b){ if(window.showToast) showToast({title:t, body:b||'', icon:'check2-circle'}); }
  function toastWarn(t,b){ if(window.showToast) showToast({title:t, body:b||'', icon:'exclamation-triangle'}); }
  function toastInfo(t,b){ if(window.showToast) showToast({title:t, body:b||'', icon:'info'}); }

  /* KPI en l√≠nea */
  async function refreshOnline(){
    try{
      const r = await fetch('/presence/online?minutes=5');
      const j = await r.json();
      document.getElementById('kpiOnline').textContent = (j.items||[]).length ?? 0;
    }catch(_){
      document.getElementById('kpiOnline').textContent = '0';
    }
  }

  /* Cargar usuarios */
  let usuariosCache = [];
  async function cargarUsuarios(){
    const tbody = document.getElementById('tablaUsuarios');
    tbody.innerHTML = `
      <tr><td colspan="5" class="text-center py-4 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div> Cargando‚Ä¶
      </td></tr>`;
    try{
      // API: { items: [...] }
      const res = await axios.get('/api/admin/users');
      usuariosCache = Array.isArray(res?.data?.items) ? res.data.items : [];
      renderUsuarios(usuariosCache);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">No se pudieron cargar los usuarios.</td></tr>`;
    }
  }

  function renderUsuarios(items){
    const tbody = document.getElementById('tablaUsuarios');
    const filtro = (document.getElementById('filtro').value||'').toLowerCase().trim();

    const data = items.filter(u=>{
      if(!filtro) return true;
      const hay = `${u.nombre||''} ${u.email||''}`.toLowerCase();
      return hay.includes(filtro);
    });

    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Sin resultados.</td></tr>`;
      return;
    }

    tbody.innerHTML = '';
    data.forEach(u=>{
      const activo = !!u.activo;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(u.nombre||'-')}</td>
        <td>${escapeHtml(u.email||'-')}</td>
        <td><span class="badge badge-role">${escapeHtml(u.rol||'-')}</span></td>
        <td>
          <span class="badge ${activo?'badge-ok':'badge-off'}">
            ${activo ? 'Activo' : 'Inactivo'}
          </span>
        </td>
        <td class="admin-actions d-flex flex-wrap gap-2">
          ${activo
            ? `<button class="btn btn-sm btn-outline-danger" onclick="toggleUsuario('${encodeURIComponent(u.email)}', false)">‚õî Desactivar</button>`
            : `<button class="btn btn-sm btn-outline-success" onclick="toggleUsuario('${encodeURIComponent(u.email)}', true)">üü¢ Activar</button>`
          }
          <button class="btn btn-sm btn-outline-dark" onclick="blanquearPassword('${encodeURIComponent(u.email)}')">üîë Blanquear contrase√±a</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="reiniciarSesion('${encodeURIComponent(u.email)}')">üîÑ Reset sesi√≥n</button>
          <button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario('${encodeURIComponent(u.email)}')">üóëÔ∏è Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* Acciones CRUD */
  document.getElementById('crearUsuarioForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const nombre = document.getElementById('nombre').value.trim();
    const email  = document.getElementById('email').value.trim();
    const rol    = document.getElementById('rol').value;
    const box = document.getElementById('mensaje'); box.innerHTML = '';

    try{
      const res = await axios.post('/api/admin/users', { nombre, email, rol });
      if(res?.data?.ok){
        box.innerHTML = `<div class="alert alert-success">Usuario creado</div>`;
      }else{
        box.innerHTML = `<div class="alert alert-success">Usuario creado</div>`;
      }
      e.target.reset();
      await cargarUsuarios();
      toastOk('Usuario creado', email);
    }catch(err){
      const msg = err?.response?.data?.error || 'Error al crear el usuario';
      box.innerHTML = `<div class="alert alert-danger">${escapeHtml(msg)}</div>`;
      toastWarn('Error', msg);
    }
  });

  async function blanquearPassword(emailEnc){
    const email = decodeURIComponent(emailEnc);
    try{
      await axios.post('/api/admin/users/password', { email, password: DEFAULT_RESET_PASSWORD });
      toastOk('Password blanqueado', `Usuario: ${email}`);
      alert(`Contrase√±a blanqueada a ${DEFAULT_RESET_PASSWORD}`);
    }catch(_){
      toastWarn('Error', 'No se pudo blanquear la contrase√±a');
    }
  }

  async function toggleUsuario(emailEnc, activar){
    const email = decodeURIComponent(emailEnc);
    try{
      await axios.post('/api/admin/users/toggle', { email, activo: !!activar });
      await cargarUsuarios();
      toastOk(activar?'Usuario activado':'Usuario desactivado', email);
    }catch(_){
      toastWarn('Error', activar?'No se pudo activar':'No se pudo desactivar');
    }
  }

  async function eliminarUsuario(emailEnc){
    const email = decodeURIComponent(emailEnc);
    if(!confirm(`¬øEliminar definitivamente a ${email}?`)) return;
    try{
      await axios.delete(`/api/admin/users/${encodeURIComponent(email)}`); // soft delete por defecto
      await cargarUsuarios();
      toastOk('Usuario eliminado', email);
    }catch(_){
      toastWarn('Error', 'No se pudo eliminar');
    }
  }

  function reiniciarSesion(emailEnc){
    const email = decodeURIComponent(emailEnc);
    // No hay endpoint en backend. Solo avisamos para no confundir.
    toastInfo('Aviso', `Reset de sesi√≥n no implementado para ${email}`);
  }

  /* Eventos UI */
  document.getElementById('btnRefrescar').addEventListener('click', cargarUsuarios);
  document.getElementById('filtro').addEventListener('input', ()=> renderUsuarios(usuariosCache));

  /* Init */
  cargarUsuarios();
  refreshOnline();
  setInterval(refreshOnline, 30000);
</script>
{% endblock %}
