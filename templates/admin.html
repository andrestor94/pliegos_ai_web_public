{% extends "base.html" %}

{% block title %}Panel de Administraci√≥n ¬∑ Suizo Argentina{% endblock %}

{% block extra_head %}
  <!-- Axios para las llamadas del panel -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* Ajustes finos del panel admin (encajan con la UI global) */
    .admin-actions .btn{ border-radius:10px; }
    .badge-role{ background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe; }
    .badge-ok{ background:#10b981; }
    .badge-off{ background:#cbd5e1; color:#334155; }
    .table thead{ background:#f6f7fe; }
    .hint{ color:#667085; }
  </style>
{% endblock %}

{% block content %}
  <div class="grid">
    <section class="cardx col-12">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="title mb-0">
          <i class="bi bi-gear"></i> Administraci√≥n de Usuarios
        </h5>
        <div class="d-flex gap-2">
          <a href="/auditoria" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-clipboard-data"></i> Ver auditor√≠a
          </a>
          <a href="/" class="btn btn-sm btn-outline-secondary">‚Üê Volver</a>
        </div>
      </div>
    </section>

    <!-- Crear usuario -->
    <section class="cardx col-12">
      <h6 class="mb-3">Crear nuevo usuario</h6>
      <form id="crearUsuarioForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label" for="nombre">Nombre</label>
          <input type="text" class="form-control" id="nombre" required placeholder="Nombre y Apellido">
        </div>
        <div class="col-md-4">
          <label class="form-label" for="email">Email</label>
          <input type="email" class="form-control" id="email" required placeholder="usuario@suizo.com">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="rol">Rol</label>
          <select class="form-select" id="rol">
            <option value="usuario">Usuario</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div class="col-md-1 d-grid">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
      </form>
      <div class="mt-2 hint small">El usuario recibir√° acceso inmediato. Pod√©s blanquearle la contrase√±a desde la tabla.</div>
      <div id="mensaje" class="mt-3"></div>
    </section>

    <!-- Lista de usuarios -->
    <section class="cardx col-12">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0">Usuarios registrados</h6>
        <div class="d-flex gap-2">
          <input id="filtro" class="form-control form-control-sm" style="max-width:260px" placeholder="Filtrar por nombre o email">
          <button id="btnRefrescar" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-clockwise"></i> Refrescar
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table align-middle table-hover mb-0">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th style="min-width:300px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaUsuarios"><!-- se llena por JS --></tbody>
        </table>
      </div>
    </section>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* Util */
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* Cargar usuarios */
  let usuariosCache = [];
  async function cargarUsuarios(){
    const tbody = document.getElementById('tablaUsuarios');
    tbody.innerHTML = `
      <tr><td colspan="5" class="text-center py-4 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div> Cargando‚Ä¶
      </td></tr>`;

    try{
      const res = await axios.get('/admin/usuarios');
      usuariosCache = Array.isArray(res.data) ? res.data : [];
      renderUsuarios(usuariosCache);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">No se pudieron cargar los usuarios.</td></tr>`;
    }
  }

  function renderUsuarios(items){
    const tbody = document.getElementById('tablaUsuarios');
    const filtro = (document.getElementById('filtro').value||'').toLowerCase().trim();

    const data = items.filter(u=>{
      if(!filtro) return true;
      const hay = `${u.nombre||''} ${u.email||''}`.toLowerCase();
      return hay.includes(filtro);
    });

    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Sin resultados.</td></tr>`;
      return;
    }

    tbody.innerHTML = '';
    data.forEach(u=>{
      const activo = !!u.activo;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(u.nombre||'-')}</td>
        <td>${escapeHtml(u.email||'-')}</td>
        <td><span class="badge badge-role">${escapeHtml(u.rol||'-')}</span></td>
        <td>
          <span class="badge ${activo?'badge-ok':'badge-off'}">
            ${activo ? 'Activo' : 'Inactivo'}
          </span>
        </td>
        <td class="admin-actions d-flex flex-wrap gap-2">
          ${activo
            ? `<button class="btn btn-sm btn-outline-danger" onclick="desactivarUsuario('${encodeURIComponent(u.email)}')">‚õî Desactivar</button>`
            : `<button class="btn btn-sm btn-outline-success" onclick="activarUsuario('${encodeURIComponent(u.email)}')">üü¢ Activar</button>`
          }
          <button class="btn btn-sm btn-outline-dark" onclick="blanquearPassword('${encodeURIComponent(u.email)}')">üîë Blanquear contrase√±a</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="reiniciarSesion('${encodeURIComponent(u.email)}')">üîÑ Reset sesi√≥n</button>
          <button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario('${encodeURIComponent(u.email)}')">üóëÔ∏è Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* Acciones */
  document.getElementById('crearUsuarioForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const nombre = document.getElementById('nombre').value.trim();
    const email  = document.getElementById('email').value.trim();
    const rol    = document.getElementById('rol').value;

    const box = document.getElementById('mensaje');
    box.innerHTML = '';

    try{
      const res = await axios.post('/admin/crear-usuario', { nombre, email, rol });
      box.innerHTML = `<div class="alert alert-success">${escapeHtml(res?.data?.mensaje || 'Usuario creado')}</div>`;
      e.target.reset();
      await cargarUsuarios();
      showToast({title:'Usuario creado', body: email, icon:'check2-circle'});
    }catch(err){
      const msg = err?.response?.data?.error || 'Error al crear el usuario';
      box.innerHTML = `<div class="alert alert-danger">${escapeHtml(msg)}</div>`;
      showToast({title:'Error', body: msg, icon:'exclamation-triangle'});
    }
  });

  async function blanquearPassword(emailEnc){
    const email = decodeURIComponent(emailEnc);
    try{
      await axios.post('/admin/blanquear-password', { email });
      showToast({title:'Password blanqueado', body:`Usuario: ${email}`, icon:'key'});
      alert('Contrase√±a blanqueada a 1234');
    }catch(_){
      showToast({title:'Error', body:'No se pudo blanquear la contrase√±a', icon:'exclamation-triangle'});
    }
  }

  async function desactivarUsuario(emailEnc){
    const email = decodeURIComponent(emailEnc);
    try{
      await axios.post('/admin/desactivar-usuario', { email });
      await cargarUsuarios();
      showToast({title:'Usuario desactivado', body:email, icon:'person-dash'});
    }catch(_){
      showToast({title:'Error', body:'No se pudo desactivar', icon:'exclamation-triangle'});
    }
  }

  async function activarUsuario(emailEnc){
    const email = decodeURIComponent(emailEnc);
    try{
      await axios.post('/admin/activar-usuario', { email });
      await cargarUsuarios();
      showToast({title:'Usuario activado', body:email, icon:'person-check'});
    }catch(_){
      showToast({title:'Error', body:'No se pudo activar', icon:'exclamation-triangle'});
    }
  }

  async function eliminarUsuario(emailEnc){
    const email = decodeURIComponent(emailEnc);
    if(!confirm(`¬øEliminar definitivamente a ${email}?`)) return;
    try{
      await axios.post('/admin/eliminar-usuario', { email });
      await cargarUsuarios();
      showToast({title:'Usuario eliminado', body:email, icon:'trash'});
    }catch(_){
      showToast({title:'Error', body:'No se pudo eliminar', icon:'exclamation-triangle'});
    }
  }

  // (Opcional) endpoint para cerrar sesiones activas del usuario si lo implementaste en backend
  async function reiniciarSesion(emailEnc){
    const email = decodeURIComponent(emailEnc);
    try{
      await axios.post('/admin/reset-sesion', { email });
      showToast({title:'Sesi√≥n reiniciada', body:email, icon:'arrow-counterclockwise'});
    }catch(_){
      showToast({title:'Aviso', body:'Endpoint /admin/reset-sesion no disponible', icon:'info'});
    }
  }

  /* Eventos UI */
  document.getElementById('btnRefrescar').addEventListener('click', cargarUsuarios);
  document.getElementById('filtro').addEventListener('input', ()=> renderUsuarios(usuariosCache));

  /* Init */
  cargarUsuarios();
</script>
{% endblock %}
