<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registro de Auditor√≠a</title>

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <!-- (Opcional) Tema global si lo us√°s en otras vistas -->
  <link rel="stylesheet" href="{{ url_for('static', path='suizo-theme.css') }}">

  <style>
    :root{
      --color-azul:#044369; --color-azul-sec:#0d6efd; --color-gris:#eceff4; --color-gris-medio:#c8d0df; --color-gris-oscuro:#354151; --color-rojo:#c62828;
      --bg:#f6f8ff; --card:#ffffff; --ink:#0a0a0a; --primary:#2f6adf; --primary-ink:#ffffff; --ring:rgba(47,106,223,.35);
      --shadow:0 10px 30px rgba(0,0,0,.06); --radius:16px; --border:#e9eef5;
    }

    body{ background:var(--bg); color:var(--ink); }
    .container{ max-width:1100px; margin-top:56px; }

    /* Navbar + Offcanvas */
    .navbar-wrap{ background:#fff; border-bottom:1.5px solid var(--color-azul-sec); box-shadow:0 2px 8px rgba(4,67,105,0.05); }
    .navbar-brand{ color:var(--color-azul)!important; font-weight:600; }
    .logo{ height:32px; margin-right:8px; }
    .btn-solid{
      background:var(--primary); color:var(--primary-ink); border:0; padding:.5rem .85rem; border-radius:12px;
      transition:transform .08s ease, box-shadow .2s ease; box-shadow:0 6px 16px rgba(47,106,223,.25);
    }
    .btn-solid:hover{ transform:translateY(-1px); }
    .btn-ghost{ background:transparent; border:1px solid #e5e7eb; padding:.5rem .8rem; border-radius:12px; }
    .btn-ghost:hover{ background:#f3f4f6; }
    .navbar-toggler-icon{
      display:inline-block; width:1.5rem; height:1.5rem;
      background-image:url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath stroke='rgba(0,0,0,.7)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      background-repeat:no-repeat; background-position:center;
    }
    .offcanvas{ border-radius:0 var(--radius) var(--radius) 0; }
    .offcanvas .nav-link-mobile{ display:flex; align-items:center; gap:.6rem; padding:.7rem .8rem; border-radius:12px; color:var(--ink); text-decoration:none; }
    .offcanvas .nav-link-mobile:hover{ background:#f3f4f6; }
    .offcanvas .nav-link-mobile.active{ background:#e8efff; color:#1e40af; }

    /* Cards + tabla */
    .card{ border-radius:18px; border:none; box-shadow:0 4px 24px rgba(4,67,105,0.09); background:var(--card); }
    .table thead{ background:#f3f8fc; position:sticky; top:0; z-index:1; }
    .table th, .table td{ vertical-align:middle; border-bottom:1.5px solid var(--border)!important; }
    .table-responsive{ border-radius:12px; overflow:auto; max-height:65vh; }
    .badge-accion{ background:#e8efff; color:#1e40af; border:1px solid #cfe0ff; border-radius:999px; padding:.35rem .6rem; font-weight:600; font-size:.8rem; }
    .cell-pre{ max-width:280px; }
    .btn-icon{ display:inline-flex; align-items:center; gap:.35rem; }

    /* Filtros */
    .filters .form-control, .filters .form-select{ border-radius:10px; border-color:var(--color-gris-medio)!important; }

    /* Modal JSON */
    pre{ white-space:pre-wrap; font-size:.9rem; margin:0; }
    .json-box{ background:#0f172a; color:#e2e8f0; border-radius:12px; padding:12px; box-shadow:inset 0 0 0 1px #1f2a44; }
    .json-box code{ white-space:pre-wrap; }

    /* Chat flotante */
    #chatbox{
      position:fixed; bottom:20px; right:20px; width:350px; height:450px; border-radius:16px; background:#fff;
      box-shadow:0 0 20px rgba(4,67,105,0.12); display:none; flex-direction:column; overflow:hidden; z-index:1000;
      border:1.5px solid var(--color-azul);
    }
    #chatbox-header{
      background:var(--color-azul); color:#fff; padding:10px; font-weight:600; font-size:1.05em; letter-spacing:.03em;
      display:flex; align-items:center; justify-content:space-between;
    }
    #chat-messages{ flex:1; padding:12px 14px; overflow-y:auto; background:#f7fbff; }
    #chat-input{ border-top:1px solid #e2e5ec; display:flex; }
    #chat-input input{ flex:1; padding:10px; border:none; outline:none; font-size:1em; }
    #chat-input button{ background:var(--color-azul); color:#fff; border:none; padding:10px 16px; border-radius:0 0 12px 0; }
    #chat-fab{
      position:fixed; right:20px; bottom:20px; z-index:999; display:none;
      border-radius:999px; padding:.6rem .9rem; box-shadow:0 8px 18px rgba(4,67,105,0.18);
    }

    /* Notificaciones y Toasts */
    #notif-fab{
      position:fixed; right:20px; bottom:88px; z-index:999; border-radius:999px; padding:.55rem .75rem;
      box-shadow:0 8px 18px rgba(4,67,105,0.18); background:#fff; border:1px solid #e5e7eb;
    }
    #notif-badge{ transform: translate(20%, -40%); }
    #notif-panel{
      position:fixed; right:20px; bottom:148px; width:320px; max-height:50vh; overflow:auto; z-index:1000; background:#fff;
      border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.12); display:none;
    }
    .toast-container{ position: fixed; right: 16px; bottom: 16px; z-index: 1200; }
    .toast{ border-radius:12px; box-shadow:var(--shadow); }
    .toast-header{ border-bottom:none; }

    @media (max-width: 700px){
      .container{ max-width:98vw; }
      #chatbox{ right:5vw; width:94vw; height:60vh; }
      #notif-panel{ right:5vw; width:90vw; }
    }
  </style>
</head>
<body>

  <!-- ====== Header / Navbar ====== -->
  <header class="navbar-wrap sticky-top">
    <nav class="navbar navbar-expand-lg px-3">
      <button class="btn-ghost d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuOffcanvas" aria-controls="menuOffcanvas" aria-label="Abrir men√∫">
        <span class="navbar-toggler-icon"></span>
      </button>

      <a class="navbar-brand d-flex align-items-center" href="/">
        <img src="/static/logo-suizo.png" class="logo" alt="Logo Suizo"/>
        <span>Suizo Argentina <b>- Licitaciones IA</b></span>
      </a>

      <div class="ms-auto d-none d-lg-flex align-items-center gap-2">
        <span id="usuario-nombre" class="small me-2"></span>
        <a href="/chat" class="btn-ghost">üí¨ Chat interno</a>
        <button class="btn-ghost" onclick="openChatAndExpand()"><i class="bi bi-robot"></i> Chat OpenAI</button>
        <a href="/calendario" class="btn-ghost">Calendario</a>
        <a href="/incidencias" class="btn-ghost">Incidencias</a>
        <a href="/cambiar-password" class="btn-ghost">Cambiar contrase√±a</a>
        <a href="/admin" class="btn-ghost" id="admin-link-desktop">Panel Admin</a>
        <button class="btn-ghost text-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Salir</button>
      </div>
    </nav>
  </header>

  <!-- ====== Offcanvas (m√≥vil) ====== -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="menuOffcanvas" aria-labelledby="menuOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 id="menuOffcanvasLabel" class="m-0">Men√∫</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column gap-2">
      <div class="mb-2"><div id="usuario-nombre-mobile" class="small text-muted"></div></div>

      <a class="nav-link-mobile" href="/"><i class="bi bi-house"></i> Inicio</a>
      <a class="nav-link-mobile" href="/historia"><i class="bi bi-clock-history"></i> Historial</a>
      <a class="nav-link-mobile" href="/chat"><i class="bi bi-chat-dots"></i> Chat interno</a>
      <a class="nav-link-mobile" href="/calendario"><i class="bi bi-calendar-event"></i> Calendario</a>
      <a class="nav-link-mobile" href="/incidencias"><i class="bi bi-bug"></i> Incidencias</a>
      <a class="nav-link-mobile" href="/cambiar-password"><i class="bi bi-key"></i> Cambiar contrase√±a</a>
      <a class="nav-link-mobile" id="admin-link-mobile" href="/admin"><i class="bi bi-gear"></i> Administraci√≥n</a>

      <button class="btn-solid mt-3" onclick="openChatAndExpand()"><i class="bi bi-robot"></i> Abrir Chat OpenAI</button>

      <div class="mt-auto pt-3 border-top">
        <button class="nav-link-mobile text-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Salir</button>
      </div>
    </div>
  </div>

  <!-- ====== Contenido ====== -->
  <main class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">üìú Registro de Auditor√≠a</h2>
      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-1"></i>Exportar CSV</button>
        <a href="/admin" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-3 filters">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-4">
            <label class="form-label small text-muted">Buscar (texto libre)</label>
            <input id="freetext" type="text" class="form-control" placeholder="usuario, entidad, IP, etc." />
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Acci√≥n</label>
            <select id="accion" class="form-select">
              <option value="">Todas</option>
              <option>CREAR</option>
              <option>ACTUALIZAR</option>
              <option>ELIMINAR</option>
              <option>LOGIN</option>
              <option>LOGOUT</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted">Desde</label>
            <input id="desde" type="date" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted">Hasta</label>
            <input id="hasta" type="date" class="form-control" />
          </div>
          <div class="col-md-1 d-grid">
            <button id="btnLimpiar" class="btn btn-outline-secondary">Limpiar</button>
          </div>
        </div>
      </div>
    </div>

    {% if logs and logs|length > 0 %}
    <!-- Listado -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">Resultados: <span id="count">0</span></div>
          <div class="d-flex align-items-center gap-2">
            <label class="small text-muted">Por p√°gina:</label>
            <select id="pageSize" class="form-select form-select-sm" style="width:auto">
              <option>10</option><option selected>25</option><option>50</option><option>100</option>
            </select>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Email</th>
                <th>Nombre</th>
                <th>Acci√≥n</th>
                <th>Entidad</th>
                <th>ID</th>
                <th>Antes</th>
                <th>Despu√©s</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody id="tbodyLogs"></tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="small text-muted" id="rangeInfo"></div>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pager"></ul>
          </nav>
        </div>
      </div>
    </div>
    {% else %}
      <div class="alert alert-warning mt-3">‚ö†Ô∏è No hay registros de auditor√≠a disponibles.</div>
    {% endif %}
  </main>

  <!-- ===== Modal JSON ===== -->
  <div class="modal fade" id="jsonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title" id="jsonTitle">Detalles</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="json-box"><code id="jsonCode"></code></div>
        </div>
        <div class="modal-footer">
          <button id="btnCopyJson" class="btn btn-outline-secondary btn-icon"><i class="bi bi-clipboard"></i> Copiar</button>
          <button class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== Chat flotante con OpenAI ====== -->
  <div id="chatbox" aria-live="polite">
    <div id="chatbox-header">
      <span>Chat con OpenAI</span>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-light" title="Minimizar" onclick="minimizeChat()" style="border-radius:8px;">
          <i class="bi bi-dash-lg"></i>
        </button>
        <button class="btn btn-sm btn-light" title="Cerrar" onclick="closeChat()" style="border-radius:8px;">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="chat-text" placeholder="Escribe tu pregunta...">
      <button onclick="enviarChat()">Enviar</button>
    </div>
  </div>
  <button id="chat-fab" class="btn btn-solid" onclick="expandChat()">
    <i class="bi bi-robot"></i> Chat IA
  </button>

  <!-- ===== Notificaciones (campanita + panel) ===== -->
  <button id="notif-fab" class="btn" title="Notificaciones" onclick="toggleNotifPanel()">
    <i class="bi bi-bell"></i>
    <span id="notif-badge" class="badge text-bg-danger rounded-pill" style="display:none;">0</span>
  </button>
  <div id="notif-panel" class="small">
    <div class="p-2 border-bottom d-flex align-items-center justify-content-between">
      <strong>Notificaciones</strong>
      <button class="btn btn-sm btn-ghost" onclick="markAllAsRead()">Marcar le√≠das</button>
    </div>
    <div id="notif-list"></div>
    <div class="p-2 text-center">
      <a href="/notificaciones" class="small">Ver todas</a>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- ====== JS ====== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  {% if logs and logs|length > 0 %}
  <script id="logsData" type="application/json">{{ logs|tojson }}</script>
  {% endif %}

  <script>
    /* ====== Usuario / Navbar ====== */
    async function getUsuario() {
      try{
        const res = await fetch("/usuario-actual");
        const data = await res.json();
        document.getElementById("usuario-nombre").textContent = `üë§ ${data.usuario}`;
        const mobileName = document.getElementById("usuario-nombre-mobile");
        if (mobileName) mobileName.textContent = `üë§ ${data.usuario}`;
        if ((data.rol||'').toLowerCase() === "admin") {
          document.getElementById("admin-link-desktop")?.classList.remove("d-none");
          document.getElementById("admin-link-mobile")?.classList.remove("d-none");
        }
      }catch(e){ console.error(e); }
    }

    // Cerrar offcanvas al clickear un link/bot√≥n
    document.addEventListener('click', (e) => {
      const link = e.target.closest('.offcanvas .nav-link-mobile, .offcanvas .btn, .offcanvas .dropdown-item');
      if (!link) return;
      const offcanvasEl = document.getElementById('menuOffcanvas');
      if (!offcanvasEl) return;
      const offcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
      if (offcanvas) offcanvas.hide();
    });

    function logout(){ fetch("/logout", { method: "POST" }).then(() => window.location.href = "/login"); }

    /* ===== Chat flotante (persistencia) ===== */
    const CHAT_STATE_KEY = 'chatboxState';
    function applyChatState(){
      const state = localStorage.getItem(CHAT_STATE_KEY) || 'closed';
      const box = document.getElementById('chatbox');
      const fab = document.getElementById('chat-fab');
      if (state === 'open'){ box.style.display='flex'; fab.style.display='none'; }
      else if (state === 'min'){ box.style.display='none'; fab.style.display='inline-flex'; }
      else { box.style.display='none'; fab.style.display='none'; }
    }
    function openChatAndExpand(){ localStorage.setItem(CHAT_STATE_KEY,'open'); applyChatState(); }
    function closeChat(){ localStorage.setItem(CHAT_STATE_KEY,'closed'); applyChatState(); }
    function minimizeChat(){ localStorage.setItem(CHAT_STATE_KEY,'min'); applyChatState(); }
    function expandChat(){ localStorage.setItem(CHAT_STATE_KEY,'open'); applyChatState(); }

    async function enviarChat() {
      const input = document.getElementById("chat-text");
      const message = input.value.trim();
      if (!message) return;
      const chat = document.getElementById("chat-messages");
      chat.innerHTML += `<div><b>T√∫:</b> ${escapeHtml(message)}</div>`;
      input.value = "";
      const res = await fetch("/chat-openai", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mensaje: message })
      });
      const data = await res.json();
      chat.innerHTML += `<div><b>IA:</b> ${escapeHtml(data.respuesta || '')}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }
    document.addEventListener('keydown', (e) => { if (e.key === "Enter" && document.activeElement?.id === "chat-text") enviarChat(); });

    /* ===== Notificaciones ===== */
    function showToast({title="Aviso", body="", icon="info"}){
      const container=document.getElementById('toastContainer'); if(!container) return;
      const el=document.createElement('div'); el.className='toast align-items-center'; el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
      el.innerHTML=`<div class="toast-header">
        <i class="bi bi-${icon} me-1"></i>
        <strong class="me-auto">${title}</strong>
        <small>Ahora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div><div class="toast-body">${body}</div>`;
      container.appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast',()=>el.remove());
    }
    let notifOpen=false;
    function toggleNotifPanel(){ notifOpen=!notifOpen; const p=document.getElementById('notif-panel'); if(p) p.style.display = notifOpen ? 'block':'none'; }
    function renderBadge(n){ const b=document.getElementById('notif-badge'); if(!b) return; if(n>0){ b.style.display='inline-block'; b.textContent=n; } else { b.style.display='none'; } }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function renderNotifs(items){
      const list=document.getElementById('notif-list'); if(!list) return; list.innerHTML='';
      if(!items?.length){ list.innerHTML='<div class="p-3 text-muted">Sin notificaciones</div>'; return; }
      items.forEach(n=>{
        const div=document.createElement('div'); div.className='item '+(!n.leida?'unread':''); div.style.padding='10px 12px'; div.style.borderBottom='1px solid #f0f2f5';
        div.innerHTML=`<div style="font-weight:600">${escapeHtml(n.titulo||'Notificaci√≥n')}</div>
                       <div class="small">${escapeHtml(n.cuerpo||'')}</div>
                       <div class="small text-muted">${escapeHtml(n.fecha_legible||'')}</div>`;
        list.appendChild(div);
      });
    }
    async function fetchNotifs(){
      try{
        const r=await fetch('/notificaciones?limit=20'); if(!r.ok) return;
        const data=await r.json();
        renderNotifs(data.items||[]);
        renderBadge(data.total_unread||0);
      }catch(e){}
    }
    async function markAllAsRead(){
      try{
        await fetch('/notificaciones/marcar-leidas',{method:'POST'});
        await fetchNotifs();
        showToast({title:'Notificaciones', body:'Marcadas como le√≠das', icon:'check2-circle'});
      }catch(e){}
    }

    /* ===== Datos y UI Auditor√≠a (cliente) ===== */
    const RAW = (() => {
      const el = document.getElementById('logsData');
      if(!el) return [];
      try{ return JSON.parse(el.textContent || '[]') || []; }catch{ return []; }
    })();

    let STATE = {
      filtered: RAW.slice(),
      page: 1,
      pageSize: 25
    };

    const TBODY = document.getElementById('tbodyLogs');
    const COUNT = document.getElementById('count');
    const PAGER = document.getElementById('pager');
    const RANGE = document.getElementById('rangeInfo');

    function applyFilters(){
      const term = (document.getElementById('freetext').value || '').toLowerCase().trim();
      const acc  = document.getElementById('accion').value;
      const d    = document.getElementById('desde').value;
      const h    = document.getElementById('hasta').value;

      let out = RAW.filter(l => {
        // acci√≥n
        if(acc && (l.accion||'') !== acc) return false;

        // fechas (asumimos log.fecha es string compatible o y-m-d h:m)
        if(d && new Date(l.fecha) < new Date(d)) return false;
        if(h){
          const end = new Date(h); end.setHours(23,59,59,999);
          if(new Date(l.fecha) > end) return false;
        }

        // texto libre sobre campos clave
        if(term){
          const s = [
            l.usuario, l.nombre, l.accion, l.entidad, l.entidad_id, l.ip, l.before, l.after
          ].map(x => (x==null?'':String(x))).join(' ').toLowerCase();
          if(!s.includes(term)) return false;
        }
        return true;
      });

      STATE.filtered = out;
      STATE.page = 1;
      render();
    }

    function paginate(arr, page, pageSize){
      const start = (page-1)*pageSize;
      return arr.slice(start, start+pageSize);
    }

    function render(){
      // page size
      const ps = parseInt(document.getElementById('pageSize').value || '25', 10);
      STATE.pageSize = ps;

      const total = STATE.filtered.length;
      COUNT.textContent = total;

      const pages = Math.max(1, Math.ceil(total / ps));
      STATE.page = Math.min(STATE.page, pages);

      const rows = paginate(STATE.filtered, STATE.page, ps);

      // tbody
      TBODY.innerHTML = '';
      const frag = document.createDocumentFragment();

      rows.forEach((log, idx) => {
        const tr = document.createElement('tr');

        const beforeBtn = (log.before && String(log.before).trim() !== '-') ? `<button class="btn btn-sm btn-outline-secondary btn-icon" data-json='${escapeHtml(JSON.stringify(safeJson(log.before), null, 2))}' data-title="Antes"><i class="bi bi-eye"></i> Ver</button>` : '<span class="text-muted">-</span>';
        const afterBtn  = (log.after  && String(log.after ).trim() !== '-') ? `<button class="btn btn-sm btn-outline-secondary btn-icon" data-json='${escapeHtml(JSON.stringify(safeJson(log.after), null, 2))}' data-title="Despu√©s"><i class="bi bi-eye"></i> Ver</button>` : '<span class="text-muted">-</span>';

        tr.innerHTML = `
          <td>${escapeHtml(log.fecha || '')}</td>
          <td>${escapeHtml(log.usuario || '')}</td>
          <td>${escapeHtml(log.nombre || '-')}</td>
          <td><span class="badge-accion">${escapeHtml(log.accion || '')}</span></td>
          <td>${escapeHtml(log.entidad || '')}</td>
          <td>${escapeHtml(log.entidad_id || '')}</td>
          <td class="cell-pre">${beforeBtn}</td>
          <td class="cell-pre">${afterBtn}</td>
          <td>${escapeHtml(log.ip || '-')}</td>
        `;
        frag.appendChild(tr);
      });

      TBODY.appendChild(frag);

      // rango
      const start = total ? ( (STATE.page-1)*ps + 1 ) : 0;
      const end   = total ? Math.min(STATE.page*ps, total) : 0;
      RANGE.textContent = total ? `Mostrando ${start}-${end} de ${total}` : '‚Äî';

      // pager
      renderPager(pages);
      bindJsonButtons();
    }

    function renderPager(pages){
      PAGER.innerHTML = '';
      const make = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label;
        a.onclick = (e)=>{ e.preventDefault(); if(!disabled){ STATE.page = page; render(); } };
        li.appendChild(a);
        return li;
      };
      PAGER.appendChild(make('¬´', 1, STATE.page===1));
      PAGER.appendChild(make('‚Äπ', Math.max(1, STATE.page-1), STATE.page===1));

      // ventana corta
      const win = 3;
      const start = Math.max(1, STATE.page - win);
      const end   = Math.min(pages, STATE.page + win);
      for(let p=start; p<=end; p++) PAGER.appendChild(make(String(p), p, false, p===STATE.page));

      PAGER.appendChild(make('‚Ä∫', Math.min(pages, STATE.page+1), STATE.page===pages));
      PAGER.appendChild(make('¬ª', pages, STATE.page===pages));
    }

    function safeJson(val){
      // si viene como string, intentar parsear
      if(typeof val === 'string'){
        try{ return JSON.parse(val); }catch{ return val; }
      }
      return val;
    }

    function bindJsonButtons(){
      document.querySelectorAll('[data-json]').forEach(btn=>{
        btn.onclick = ()=>{
          const txt = btn.getAttribute('data-json') || '';
          const title = btn.getAttribute('data-title') || 'Detalles';
          document.getElementById('jsonTitle').textContent = title;
          document.getElementById('jsonCode').textContent = txt;
          const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
          modal.show();
        };
      });
    }

    document.getElementById('btnCopyJson')?.addEventListener('click', async ()=>{
      const txt = document.getElementById('jsonCode').textContent || '';
      try{ await navigator.clipboard.writeText(txt); showToast({title:'Copiado', body:'Contenido copiado al portapapeles.', icon:'clipboard'}); }
      catch{ showToast({title:'Error', body:'No se pudo copiar.', icon:'exclamation-triangle'}); }
    });

    // Filtros events
    document.getElementById('freetext')?.addEventListener('input', debounce(applyFilters, 200));
    document.getElementById('accion')?.addEventListener('change', applyFilters);
    document.getElementById('desde')?.addEventListener('change', applyFilters);
    document.getElementById('hasta')?.addEventListener('change', applyFilters);
    document.getElementById('pageSize')?.addEventListener('change', render);
    document.getElementById('btnLimpiar')?.addEventListener('click', ()=>{
      ['freetext','accion','desde','hasta'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.value = (id==='accion') ? '' : ''; });
      applyFilters();
    });

    // Export CSV
    document.getElementById('btnExport')?.addEventListener('click', ()=>{
      const rows = STATE.filtered.map(l => ({
        fecha: l.fecha || '',
        usuario: l.usuario || '',
        nombre: l.nombre || '',
        accion: l.accion || '',
        entidad: l.entidad || '',
        entidad_id: l.entidad_id || '',
        before: typeof l.before === 'object' ? JSON.stringify(l.before) : (l.before||''),
        after:  typeof l.after  === 'object' ? JSON.stringify(l.after ) : (l.after ||''),
        ip: l.ip || ''
      }));
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `auditoria_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      a.click(); URL.revokeObjectURL(url);
    });

    function toCSV(rows){
      if(!rows.length) return '';
      const headers = Object.keys(rows[0]);
      const esc = v => `"${String(v).replace(/"/g,'""')}"`;
      const lines = [headers.map(esc).join(',')];
      rows.forEach(r => lines.push(headers.map(h => esc(r[h] ?? '')).join(',')));
      return lines.join('\n');
    }

    function debounce(fn, ms){
      let id; return (...args)=>{ clearTimeout(id); id=setTimeout(()=>fn(...args), ms); };
    }

    // Init auditor√≠a
    if(RAW.length){
      applyFilters(); // set filtered + render
    }

    /* ===== Init general ===== */
    window.onload = () => {
      getUsuario();
      applyChatState();
      fetchNotifs();
      setInterval(fetchNotifs, 30000);
    };
  </script>
</body>
</html>
