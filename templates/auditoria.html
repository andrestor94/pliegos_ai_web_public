{% extends "base.html" %}

{% block title %}Registro de Auditoría · Suizo Argentina{% endblock %}

{% block extra_head %}
  <style>
    /* Estilos específicos de Auditoría (compatibles con la UI global) */
    .filters .form-control, .filters .form-select{ border-radius:10px; }
    .table thead{ background:#f6f7fe; position:sticky; top:0; z-index:1; }
    .table-responsive{ border-radius:14px; overflow:auto; max-height:65vh; }
    .badge-accion{
      background:#e8efff; color:#1e40af; border:1px solid #cfe0ff;
      border-radius:999px; padding:.35rem .6rem; font-weight:600; font-size:.8rem;
    }
    .cell-pre{ max-width:280px; }
    .btn-icon{ display:inline-flex; align-items:center; gap:.35rem; }
    /* Modal JSON */
    pre{ white-space:pre-wrap; font-size:.9rem; margin:0; }
    .json-box{ background:#0f172a; color:#e2e8f0; border-radius:12px; padding:12px; box-shadow:inset 0 0 0 1px #1f2a44; }
    .json-box code{ white-space:pre-wrap; }
  </style>
{% endblock %}

{% block content %}
  <div class="grid">
    <section class="cardx col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="title mb-0"><i class="bi bi-clipboard-data"></i> Registro de Auditoría</h5>
        <div class="d-flex gap-2">
          <button id="btnExport" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-download me-1"></i>Exportar CSV
          </button>
          <a href="/admin" class="btn btn-sm btn-outline-secondary">← Volver</a>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="cardx col-12 filters">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label small text-muted">Buscar (texto libre)</label>
          <input id="freetext" type="text" class="form-control" placeholder="usuario, entidad, IP, etc.">
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Acción</label>
          <select id="accion" class="form-select">
            <option value="">Todas</option>
            <option>CREAR</option>
            <option>ACTUALIZAR</option>
            <option>ELIMINAR</option>
            <option>LOGIN</option>
            <option>LOGOUT</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Desde</label>
          <input id="desde" type="date" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Hasta</label>
          <input id="hasta" type="date" class="form-control">
        </div>
        <div class="col-md-1 d-grid">
          <button id="btnLimpiar" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>
    </section>

    {% if logs and logs|length > 0 %}
    <!-- Tabla -->
    <section class="cardx col-12">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="small text-muted">Resultados: <span id="count">0</span></div>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-muted">Por página:</label>
          <select id="pageSize" class="form-select form-select-sm" style="width:auto">
            <option>10</option><option selected>25</option><option>50</option><option>100</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Email</th>
              <th>Nombre</th>
              <th>Acción</th>
              <th>Entidad</th>
              <th>ID</th>
              <th>Antes</th>
              <th>Después</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody id="tbodyLogs"></tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="small text-muted" id="rangeInfo"></div>
        <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
      </div>
    </section>
    {% else %}
      <section class="cardx col-12">
        <div class="alert alert-warning mb-0">⚠️ No hay registros de auditoría disponibles.</div>
      </section>
    {% endif %}
  </div>

  <!-- Modal JSON -->
  <div class="modal fade" id="jsonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title" id="jsonTitle">Detalles</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="json-box"><code id="jsonCode"></code></div>
        </div>
        <div class="modal-footer">
          <button id="btnCopyJson" class="btn btn-outline-secondary btn-icon"><i class="bi bi-clipboard"></i> Copiar</button>
          <button class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* Inyectamos los datos desde el servidor en una constante segura */
  const RAW = {{ (logs or [])|tojson|safe }};

  /* Helpers locales */
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function debounce(fn, ms){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a), ms); }; }

  let STATE = { filtered: RAW.slice(), page: 1, pageSize: 25 };

  const TBODY = document.getElementById('tbodyLogs');
  const COUNT = document.getElementById('count');
  const PAGER = document.getElementById('pager');
  const RANGE = document.getElementById('rangeInfo');

  /* Filtrado */
  function applyFilters(){
    const term = (document.getElementById('freetext')?.value || '').toLowerCase().trim();
    const acc  = document.getElementById('accion')?.value || '';
    const d    = document.getElementById('desde')?.value || '';
    const h    = document.getElementById('hasta')?.value || '';

    const out = RAW.filter(l=>{
      if(acc && (l.accion||'') !== acc) return false;

      if(d && new Date(l.fecha) < new Date(d)) return false;
      if(h){
        const end = new Date(h); end.setHours(23,59,59,999);
        if(new Date(l.fecha) > end) return false;
      }

      if(term){
        const s = [l.usuario,l.nombre,l.accion,l.entidad,l.entidad_id,l.ip,l.before,l.after]
          .map(x=>x==null?'':String(x)).join(' ').toLowerCase();
        if(!s.includes(term)) return false;
      }
      return true;
    });

    STATE.filtered = out;
    STATE.page = 1;
    render();
  }

  function paginate(arr, page, size){ const i=(page-1)*size; return arr.slice(i, i+size); }

  function render(){
    const ps = parseInt(document.getElementById('pageSize')?.value || '25', 10);
    STATE.pageSize = ps;

    const total = STATE.filtered.length;
    if(COUNT) COUNT.textContent = total;

    const pages = Math.max(1, Math.ceil(total / ps));
    STATE.page = Math.min(STATE.page, pages);

    const rows = paginate(STATE.filtered, STATE.page, ps);
    if(TBODY){
      TBODY.innerHTML = '';
      const frag = document.createDocumentFragment();

      rows.forEach(log=>{
        const tr = document.createElement('tr');
        const beforeBtn = (log.before && String(log.before).trim() !== '-') ?
          `<button class="btn btn-sm btn-outline-secondary btn-icon" data-json='${escapeHtml(JSON.stringify(safeJson(log.before), null, 2))}' data-title="Antes"><i class="bi bi-eye"></i> Ver</button>` :
          '<span class="text-muted">-</span>';
        const afterBtn  = (log.after && String(log.after).trim() !== '-') ?
          `<button class="btn btn-sm btn-outline-secondary btn-icon" data-json='${escapeHtml(JSON.stringify(safeJson(log.after), null, 2))}' data-title="Después"><i class="bi bi-eye"></i> Ver</button>` :
          '<span class="text-muted">-</span>';

        tr.innerHTML = `
          <td>${escapeHtml(log.fecha || '')}</td>
          <td>${escapeHtml(log.usuario || '')}</td>
          <td>${escapeHtml(log.nombre || '-')}</td>
          <td><span class="badge-accion">${escapeHtml(log.accion || '')}</span></td>
          <td>${escapeHtml(log.entidad || '')}</td>
          <td>${escapeHtml(log.entidad_id || '')}</td>
          <td class="cell-pre">${beforeBtn}</td>
          <td class="cell-pre">${afterBtn}</td>
          <td>${escapeHtml(log.ip || '-')}</td>
        `;
        frag.appendChild(tr);
      });

      TBODY.appendChild(frag);
      bindJsonButtons();
    }

    const start = total ? ((STATE.page-1)*ps + 1) : 0;
    const end   = total ? Math.min(STATE.page*ps, total) : 0;
    if(RANGE) RANGE.textContent = total ? `Mostrando ${start}-${end} de ${total}` : '—';

    renderPager(pages);
  }

  function renderPager(pages){
    if(!PAGER) return;
    PAGER.innerHTML = '';
    const make = (label, page, disabled=false, active=false)=>{
      const li = document.createElement('li'); li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
      const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=label;
      a.onclick = (e)=>{ e.preventDefault(); if(!disabled){ STATE.page = page; render(); } };
      li.appendChild(a); return li;
    };
    PAGER.appendChild(make('«', 1, STATE.page===1));
    PAGER.appendChild(make('‹', Math.max(1, STATE.page-1), STATE.page===1));

    const win = 3;
    const s = Math.max(1, STATE.page - win);
    const e = Math.min(pages, STATE.page + win);
    for(let p=s; p<=e; p++) PAGER.appendChild(make(String(p), p, false, p===STATE.page));

    PAGER.appendChild(make('›', Math.min(pages, STATE.page+1), STATE.page===pages));
    PAGER.appendChild(make('»', pages, STATE.page===pages));
  }

  function safeJson(val){
    if(typeof val === 'string'){ try{ return JSON.parse(val); }catch{ return val; } }
    return val;
  }

  function bindJsonButtons(){
    document.querySelectorAll('[data-json]').forEach(btn=>{
      btn.onclick = ()=>{
        const txt = btn.getAttribute('data-json') || '';
        const title = btn.getAttribute('data-title') || 'Detalles';
        document.getElementById('jsonTitle').textContent = title;
        document.getElementById('jsonCode').textContent  = txt;
        new bootstrap.Modal(document.getElementById('jsonModal')).show();
      };
    });
  }

  // Copiar JSON
  document.getElementById('btnCopyJson')?.addEventListener('click', async ()=>{
    const txt = document.getElementById('jsonCode')?.textContent || '';
    try{ await navigator.clipboard.writeText(txt); showToast({title:'Copiado', body:'Contenido copiado al portapapeles.', icon:'clipboard'}); }
    catch{ showToast({title:'Error', body:'No se pudo copiar.', icon:'exclamation-triangle'}); }
  });

  // Filtros
  document.getElementById('freetext')?.addEventListener('input', debounce(applyFilters, 200));
  document.getElementById('accion')?.addEventListener('change', applyFilters);
  document.getElementById('desde')?.addEventListener('change', applyFilters);
  document.getElementById('hasta')?.addEventListener('change', applyFilters);
  document.getElementById('pageSize')?.addEventListener('change', render);
  document.getElementById('btnLimpiar')?.addEventListener('click', ()=>{
    ['freetext','accion','desde','hasta'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.value=''; });
    applyFilters();
  });

  // Export CSV
  document.getElementById('btnExport')?.addEventListener('click', ()=>{
    const rows = STATE.filtered.map(l=>({
      fecha:l.fecha||'', usuario:l.usuario||'', nombre:l.nombre||'',
      accion:l.accion||'', entidad:l.entidad||'', entidad_id:l.entidad_id||'',
      before: typeof l.before==='object' ? JSON.stringify(l.before) : (l.before||''),
      after:  typeof l.after ==='object' ? JSON.stringify(l.after ) : (l.after ||''),
      ip:l.ip||''
    }));
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `auditoria_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click(); URL.revokeObjectURL(url);
  });

  function toCSV(rows){
    if(!rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = v => `"${String(v).replace(/"/g,'""')}"`;
    const lines = [headers.map(esc).join(',')];
    rows.forEach(r => lines.push(headers.map(h => esc(r[h] ?? '')).join(',')));
    return lines.join('\n');
  }

  // Inicializar si hay datos
  if(RAW.length){ applyFilters(); }
</script>
{% endblock %}
