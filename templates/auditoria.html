{% extends "base.html" %}

{% block title %}Auditoría — Suizo Argentina{% endblock %}

{% block extra_head %}
  <style>
    /* ===== Estilos específicos de Auditoría (scoped) ===== */
    .auditoria.wrap{ display:grid; gap:.75rem; }

    /* Filtros compactos y redondeados */
    .auditoria .filters .form-control,
    .auditoria .filters .form-select{ border-radius:12px; }

    /* Tabla con header pegajoso y contenedor con scroll */
    .auditoria .table-wrap{
      max-height:65vh;
      border-radius:var(--radius);
      overflow:auto;
    }
    .auditoria thead th{
      position:sticky; top:0; z-index:1;
      background:var(--muted);
    }
    html[data-theme="dark"] .auditoria thead th{ background:#0f172a; }

    /* Celdas & columnas */
    .auditoria .table th, .auditoria .table td{ vertical-align:middle; }
    .auditoria .cell-pre{ max-width:320px; }
    .auditoria .cell-trunc{ max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Pills de acción */
    .auditoria .badge-accion{
      background:var(--brand-100);
      color:var(--brand-500);
      border:1px solid var(--bs-border-color, var(--border));
      border-radius:999px;
      padding:.35rem .6rem;
      font-weight:700;
      font-size:.8rem;
      white-space:nowrap;
    }

    /* JSON modal */
    .auditoria .json-box{
      background:var(--muted);
      color:var(--text);
      border-radius:12px;
      padding:12px;
      box-shadow: inset 0 0 0 1px var(--bs-border-color, var(--border));
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:.9rem; white-space:pre-wrap; overflow-wrap:anywhere;
    }

    /* Botón icono simple */
    .auditoria .btn-icon{ display:inline-flex; align-items:center; gap:.35rem; }
  </style>
{% endblock %}

{% block content %}
<div class="container-xxl auditoria wrap">

  <!-- Header (sin hover) -->
  <section class="card-clean">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h1 class="hero-title m-0"><i class="bi bi-clipboard-data me-1"></i> Auditoría</h1>
      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-download me-1"></i> Exportar CSV
        </button>
        <a href="/admin" class="btn btn-sm btn-outline-secondary">← Volver</a>
      </div>
    </div>
  </section>

  <!-- Filtros (sin hover) -->
  <section class="card-clean filters">
    <div class="card-body">
      <div class="row g-2 align-items-end input-compact">
        <div class="col-md-4">
          <label class="form-label small text-muted" for="freetext">Buscar (texto libre)</label>
          <input id="freetext" type="text" class="form-control" placeholder="usuario, entidad, IP, etc.">
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted" for="accion">Acción</label>
          <select id="accion" class="form-select">
            <option value="">Todas</option>
            <option>CREAR</option>
            <option>ACTUALIZAR</option>
            <option>ELIMINAR</option>
            <option>LOGIN</option>
            <option>LOGOUT</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted" for="desde">Desde</label>
          <input id="desde" type="date" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted" for="hasta">Hasta</label>
          <input id="hasta" type="date" class="form-control">
        </div>
        <div class="col-md-1 d-grid">
          <button id="btnLimpiar" class="btn btn-outline-secondary" type="button">Limpiar</button>
        </div>
      </div>
    </div>
  </section>

  {% if logs and logs|length > 0 %}
  <!-- Tabla (sin hover) -->
  <section class="card-clean">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div class="small subtle">
        Resultados: <span id="count" aria-live="polite">0</span>
        · <span class="text-uppercase">Auditoría inmutable</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label for="pageSize" class="small subtle">Por página:</label>
        <select id="pageSize" class="form-select form-select-sm" style="width:auto">
          <option>10</option><option selected>25</option><option>50</option><option>100</option>
        </select>
      </div>
    </div>

    <div class="card-body pt-2">
      <div class="table-wrap">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="cell-trunc">Usuario</th>
              <th class="cell-trunc">Nombre</th>
              <th>Acción</th>
              <th class="cell-trunc">Entidad</th>
              <th class="cell-trunc">ID</th>
              <th>Antes</th>
              <th>Después</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody id="tbodyLogs"></tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="small subtle" id="rangeInfo" aria-live="polite">—</div>
        <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
      </div>
    </div>
  </section>
  {% else %}
    <section class="card-clean">
      <div class="card-body">
        <div class="alert alert-warning mb-0">⚠️ No hay registros de auditoría disponibles.</div>
      </div>
    </section>
  {% endif %}
</div>

<!-- Modal JSON -->
<div class="modal fade" id="jsonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="jsonTitle">Detalles</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="json-box auditoria"><code id="jsonCode"></code></div>
      </div>
      <div class="modal-footer">
        <button id="btnCopyJson" class="btn btn-outline-secondary btn-icon" type="button"><i class="bi bi-clipboard"></i> Copiar</button>
        <button class="btn btn-primary" data-bs-dismiss="modal" type="button">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* Datos inyectados por servidor (cada log debe tener un 'id' único numérico o string) */
  const RAW = {{ (logs or [])|tojson|safe }};

  /* ===== Helpers ===== */
  const $  = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>[...root.querySelectorAll(sel)];
  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function toCSV(rows){
    if(!rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
    const lines = [headers.map(esc).join(',')];
    rows.forEach(r => lines.push(headers.map(h => esc(r[h])).join(',')));
    // BOM para Excel
    return '\uFEFF' + lines.join('\n');
  }

  /* ===== Estado & refs ===== */
  let STATE = { filtered: RAW.slice(), page: 1, pageSize: 25 };
  const TBODY = $('#tbodyLogs');
  const COUNT = $('#count');
  const PAGER = $('#pager');
  const RANGE = $('#rangeInfo');

  /* ===== Filtrado ===== */
  function applyFilters(){
    const term = ($('#freetext')?.value || '').toLowerCase().trim();
    const acc  = ($('#accion')?.value || '').toUpperCase();
    const d    = $('#desde')?.value || '';
    const h    = $('#hasta')?.value || '';

    const out = RAW.filter(l=>{
      const action = String(l.accion||'').toUpperCase();
      if(acc && action !== acc) return false;

      if(d && new Date(l.fecha) < new Date(d)) return false;
      if(h){
        const end = new Date(h); end.setHours(23,59,59,999);
        if(new Date(l.fecha) > end) return false;
      }

      if(term){
        const s = [
          l.usuario, l.nombre, l.accion, l.entidad, l.entidad_id, l.ip,
          typeof l.before==='object' ? JSON.stringify(l.before) : l.before,
          typeof l.after==='object'  ? JSON.stringify(l.after)  : l.after
        ].map(x => x==null ? '' : String(x)).join(' ').toLowerCase();
        if(!s.includes(term)) return false;
      }
      return true;
    });

    STATE.filtered = out;
    STATE.page = 1;
    render();
  }

  function paginate(arr, page, size){ const i=(page-1)*size; return arr.slice(i, i+size); }

  /* ===== Render ===== */
  function render(){
    const ps = parseInt($('#pageSize')?.value || '25', 10);
    STATE.pageSize = ps;

    const total = STATE.filtered.length;
    if(COUNT) COUNT.textContent = total;

    const pages = Math.max(1, Math.ceil(total / ps));
    STATE.page = Math.min(STATE.page, pages);

    const rows = paginate(STATE.filtered, STATE.page, ps);
    if(TBODY){
      TBODY.innerHTML = '';
      const frag = document.createDocumentFragment();

      rows.forEach(log=>{
        const tr = document.createElement('tr');

        const beforeBtn = (log.before && String(log.before).trim() !== '-') ?
          `<button class="btn btn-sm btn-outline-secondary btn-icon" data-json='${escapeHtml(JSON.stringify(safeJson(log.before), null, 2))}' data-title="Antes" type="button"><i class="bi bi-eye"></i> Ver</button>` :
          '<span class="subtle">-</span>';

        const afterBtn  = (log.after && String(log.after).trim() !== '-') ?
          `<button class="btn btn-sm btn-outline-secondary btn-icon" data-json='${escapeHtml(JSON.stringify(safeJson(log.after), null, 2))}' data-title="Después" type="button"><i class="bi bi-eye"></i> Ver</button>` :
          '<span class="subtle">-</span>';

        tr.innerHTML = `
          <td>${escapeHtml(log.fecha || '')}</td>
          <td class="cell-trunc" title="${escapeHtml(log.usuario||'')}">${escapeHtml(log.usuario || '')}</td>
          <td class="cell-trunc" title="${escapeHtml(log.nombre||'')}">${escapeHtml(log.nombre || '-')}</td>
          <td><span class="badge-accion">${escapeHtml(log.accion || '')}</span></td>
          <td class="cell-trunc" title="${escapeHtml(log.entidad||'')}">${escapeHtml(log.entidad || '')}</td>
          <td class="cell-trunc" title="${escapeHtml(log.entidad_id||'')}">${escapeHtml(log.entidad_id || '')}</td>
          <td class="cell-pre">${beforeBtn}</td>
          <td class="cell-pre">${afterBtn}</td>
          <td>${escapeHtml(log.ip || '-')}</td>
        `;
        frag.appendChild(tr);
      });

      TBODY.appendChild(frag);
      bindJsonButtons();
    }

    const start = total ? ((STATE.page-1)*ps + 1) : 0;
    const end   = total ? Math.min(STATE.page*ps, total) : 0;
    if(RANGE) RANGE.textContent = total ? `Mostrando ${start}-${end} de ${total}` : '—';

    renderPager(pages);
  }

  function renderPager(pages){
    if(!PAGER) return;
    PAGER.innerHTML = '';
    const make = (label, page, disabled=false, active=false)=>{
      const li = document.createElement('li'); li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
      const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=label;
      a.onclick = (e)=>{ e.preventDefault(); if(!disabled){ STATE.page = page; render(); } };
      li.appendChild(a); return li;
    };
    PAGER.appendChild(make('«', 1, STATE.page===1));
    PAGER.appendChild(make('‹', Math.max(1, STATE.page-1), STATE.page===1));

    const win = 3;
    const s = Math.max(1, STATE.page - win);
    const e = Math.min(pages, STATE.page + win);
    for(let p=s; p<=e; p++) PAGER.appendChild(make(String(p), p, false, p===STATE.page));

    PAGER.appendChild(make('›', Math.min(pages, STATE.page+1), STATE.page===pages));
    PAGER.appendChild(make('»', pages, STATE.page===pages));
  }

  function safeJson(val){
    if(typeof val === 'string'){ try{ return JSON.parse(val); }catch{ return val; } }
    return val;
  }

  function bindJsonButtons(){
    $$('#tbodyLogs [data-json]').forEach(btn=>{
      btn.onclick = ()=>{
        const txt = btn.getAttribute('data-json') || '';
        const title = btn.getAttribute('data-title') || 'Detalles';
        $('#jsonTitle').textContent = title;
        $('#jsonCode').textContent  = txt;
        new bootstrap.Modal($('#jsonModal')).show();
      };
    });
  }

  /* Copiar JSON */
  $('#btnCopyJson')?.addEventListener('click', async ()=>{
    const txt = $('#jsonCode')?.textContent || '';
    try{ await navigator.clipboard.writeText(txt); showToast?.({title:'Copiado', body:'Contenido copiado al portapapeles.', icon:'clipboard'}); }
    catch{ showToast?.({title:'Error', body:'No se pudo copiar.', icon:'exclamation-triangle'}); }
  });

  /* Filtros */
  $('#freetext')?.addEventListener('input', debounce(applyFilters, 200));
  $('#accion')?.addEventListener('change', applyFilters);
  $('#desde')?.addEventListener('change', applyFilters);
  $('#hasta')?.addEventListener('change', applyFilters);
  $('#pageSize')?.addEventListener('change', render);
  $('#btnLimpiar')?.addEventListener('click', ()=>{
    ['freetext','accion','desde','hasta'].forEach(id=>{ const el=$(`#${id}`); if(el) el.value=''; });
    applyFilters();
  });

  /* Export CSV */
  $('#btnExport')?.addEventListener('click', ()=>{
    const rows = STATE.filtered.map(l=>({
      id: l.id ?? '',
      fecha: l.fecha||'',
      usuario: l.usuario||'',
      nombre: l.nombre||'',
      accion: l.accion||'',
      entidad: l.entidad||'',
      entidad_id: l.entidad_id||'',
      before: typeof l.before==='object' ? JSON.stringify(l.before) : (l.before||''),
      after:  typeof l.after ==='object' ? JSON.stringify(l.after ) : (l.after ||''),
      ip: l.ip||''
    }));
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `auditoria_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click(); URL.revokeObjectURL(url);
  });

  /* Init (solo si hay datos) */
  if(RAW.length){ applyFilters(); }
</script>
{% endblock %}
