{% extends "base.html" %}
{% block title %}Iniciar sesión – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  .login-wrap{ width:min(440px, 92vw); position:relative; margin: 0 auto; }
  .brand-login{
    display:flex; align-items:center; justify-content:center; gap:.6rem;
    margin-bottom:12px; color:var(--text); font-weight:700; letter-spacing:.2px;
  }
  .brand-login img{ height:42px; width:auto; }

  .cardx { background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
  .cardx .cardx-body{ padding:22px; }

  .form-control, .form-select{ border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .form-control:focus, .form-select:focus{
    border-color: var(--accent-a);
    box-shadow: 0 0 0 .15rem rgba(139,92,246,.20);
  }

  .input-group .form-control{ border-top-left-radius:12px; border-bottom-left-radius:12px; }
  .input-group .input-group-text{
    border-top-right-radius:12px; border-bottom-right-radius:12px;
    cursor:pointer; background:var(--card); border:1px solid var(--border);
  }

  .btn-grad{
    border:none; border-radius:12px;
    background:linear-gradient(135deg, var(--accent-a), var(--accent-b));
    color:#fff; box-shadow:0 12px 26px rgba(139,92,246,.22);
    padding:.65rem 1rem;
  }
  .btn-grad:hover{ filter:brightness(.98); }

  .muted{ color:var(--muted); }
  .caps-hint{ display:none; color:#b45309; font-size:.9rem; }
  .caps-hint.show{ display:block; }

  .foot{ text-align:center; color:var(--muted); font-size:.85rem; margin-top:12px; }
  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

  .links-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .link-small{ font-size:.9rem; }
  .offline-banner{
    display:none; margin-top:10px; border:1px dashed #f59e0b; color:#92400e;
    background:#fff7ed; padding:8px 10px; border-radius:10px; font-size:.9rem;
  }
  .offline-banner.show{ display:block; }
</style>
{% endblock %}

{% block content %}
<div class="login-wrap">
  <div class="brand-login" aria-label="Marca">
    <img src="/static/logo-suizo.png" alt="Logo Suizo"/>
  </div>

  {% if mensaje %}<div class="alert alert-success mb-3" role="alert">{{ mensaje }}</div>{% endif %}
  {% if error %}  <div class="alert alert-danger mb-3" role="alert">{{ error }}</div>{% endif %}

  <div id="offlineNote" class="offline-banner" role="status" aria-live="polite">
    <i class="bi bi-wifi-off"></i> Estás sin conexión. Comprobá tu red antes de ingresar.
  </div>

  <div class="cardx">
    <div class="cardx-body">
      <h4 class="mb-3 text-center">Inicio de sesión</h4>

      <div id="status" class="sr-only" aria-live="polite"></div>

      <form id="loginForm" method="post" action="/login" novalidate>
        {% if csrf_token is defined %}
          <input type="hidden" name="csrf_token"
                 value="{{ csrf_token() if csrf_token is callable else csrf_token }}">
        {% endif %}

        <div class="mb-3">
          <label class="form-label" for="email">Correo electrónico</label>
          <input autofocus type="email" class="form-control" id="email" name="email"
                 placeholder="usuario@suizo.com" required autocomplete="username" inputmode="email" aria-describedby="emailHelp">
          <div id="emailHelp" class="form-text muted">Usá tu correo corporativo. Si escribís solo el usuario, se completa @suizo.com automáticamente.</div>
          <div class="invalid-feedback">Ingresá un email válido.</div>
        </div>

        <div class="mb-1">
          <label class="form-label" for="password">Contraseña</label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" name="password"
                   placeholder="••••••••" required autocomplete="current-password" aria-describedby="capsHint" enterkeyhint="go">
            <button class="input-group-text" type="button" onclick="toggleVis(this)"
                    onpointerdown="pressShow(event)" onpointerup="releaseShow()" onpointerleave="releaseShow()"
                    title="Mostrar/ocultar contraseña" aria-label="Mostrar u ocultar contraseña">
              <i class="bi bi-eye" aria-hidden="true"></i>
            </button>
            <div class="invalid-feedback">Ingresá tu contraseña.</div>
          </div>
        </div>
        <div id="capsHint" class="caps-hint mb-2"><i class="bi bi-exclamation-triangle"></i> Bloq Mayús está activado.</div>

        {% if require_otp %}
        <div class="mb-3">
          <label class="form-label" for="otp">Código 2FA</label>
          <input type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                 class="form-control" id="otp" name="otp" placeholder="000000" autocomplete="one-time-code">
          <div class="form-text muted">Ingresá el código del autenticador.</div>
          <div class="invalid-feedback">Ingresá un código de 6 dígitos.</div>
        </div>
        {% endif %}

        <div class="links-row mb-3">
          <div class="form-check m-0">
            <input class="form-check-input" type="checkbox" id="remember" name="remember" value="on">
            <label class="form-check-label" for="remember">Recordarme</label>
          </div>
          <a class="link-small" href="/cambiar-password">¿Olvidaste tu contraseña?</a>
        </div>

        <button id="loginBtn" type="submit" class="btn btn-grad w-100" aria-describedby="status">
          <span class="btn-text">Ingresar</span>
          <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
      </form>
    </div>
  </div>

  <div class="foot">© <span id="yy"></span> Suizo Argentina</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  byId('yy').textContent = new Date().getFullYear();

  /* ===== requestSubmit fallback (iOS/Safari viejos) ===== */
  if (!HTMLFormElement.prototype.requestSubmit) {
    HTMLFormElement.prototype.requestSubmit = function() { this.submit(); };
  }

  /* ===== Password show/hide ===== */
  function toggleVis(el){
    const i = byId('password'); const pass = i.type === 'password';
    i.type = pass ? 'text' : 'password';
    const ic = el.querySelector('i'); if(ic) ic.className = pass ? 'bi bi-eye-slash' : 'bi bi-eye';
    i.focus();
  }
  let _pressTimer=null;
  function pressShow(e){
    const i=byId('password');
    if(i.type==='password'){ i.type='text'; e.currentTarget.querySelector('i').className='bi bi-eye-slash'; }
    clearTimeout(_pressTimer); _pressTimer=setTimeout(()=>{},1500);
  }
  function releaseShow(){
    clearTimeout(_pressTimer);
    const i=byId('password'); const btn=document.querySelector('.input-group-text i');
    if(i.type==='text'){ i.type='password'; if(btn) btn.className='bi bi-eye'; }
  }

  /* ===== CapsLock hint ===== */
  const capsHint = byId('capsHint');
  byId('password').addEventListener('keyup', e=>{
    const caps = e.getModifierState && e.getModifierState('CapsLock');
    capsHint.classList.toggle('show', !!caps);
  });

  /* ===== Keyboard UX ===== */
  byId('password').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); byId('loginForm').requestSubmit(); }
  });
  byId('email').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); byId('password').focus(); }
  });
  {% if require_otp %}
  const otp = byId('otp');
  if(otp){
    otp.addEventListener('input', ()=>{ otp.value = otp.value.replace(/\D/g,'').slice(0,6); });
    otp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); byId('loginForm').requestSubmit(); } });
  }
  {% endif %}

  /* ===== Remember email ===== */
  const LS='suizo_login_email';
  window.addEventListener('load',()=>{
    const s=localStorage.getItem(LS);
    if(s){ byId('email').value=s; byId('remember').checked=true; }
  });

  /* ===== Auto-completar dominio si falta ===== */
  const emailEl = byId('email');
  emailEl.addEventListener('blur',()=>{
    const v = emailEl.value.trim();
    if(v && !v.includes('@') && v.indexOf(' ')===-1) emailEl.value = v + '@suizo.com';
  });

  /* ===== Offline awareness (solo aviso; NO bloquea el submit) ===== */
  const offlineNote = byId('offlineNote');
  function updateOnlineUI(){
    offlineNote.classList.toggle('show', !navigator.onLine);
  }
  window.addEventListener('online',  ()=>{ updateOnlineUI(); window.showToast?.({title:'Conexión restablecida', icon:'wifi'}); });
  window.addEventListener('offline', ()=>{ updateOnlineUI(); window.showToast?.({title:'Sin conexión', body:'Revisá tu red.', icon:'wifi-off'}); });
  updateOnlineUI();

  /* ===== Submit control ===== */
  const form = byId('loginForm'); const btn = byId('loginBtn'); const status = byId('status');

  // Failsafe: asegurar que la action/method sean las del backend
  function ensureFormAction(){
    if (form.getAttribute('action') !== '/login') form.setAttribute('action','/login');
    if ((form.getAttribute('method')||'').toLowerCase() !== 'post') form.setAttribute('method','post');
  }
  ensureFormAction();

  // Si algún script externo llamara preventDefault accidentalmente, forzamos submit real con un microtask
  form.addEventListener('submit', e=>{
    // validación básica HTML5
    if(!form.checkValidity()){
      e.preventDefault(); e.stopPropagation(); form.classList.add('was-validated'); return;
    }
    {% if require_otp %}
    if(otp && !/^[0-9]{6}$/.test(otp.value||'')){ e.preventDefault(); form.classList.add('was-validated'); otp.focus(); return; }
    {% endif %}

    if(byId('remember').checked) localStorage.setItem(LS, (emailEl.value||'').trim());
    else localStorage.removeItem(LS);

    btn.disabled = true;
    btn.querySelector('.btn-text').textContent='Ingresando...';
    btn.querySelector('.spinner-border').classList.remove('d-none');
    status.textContent='Enviando…';

    ensureFormAction();
    // No cancelamos el submit; si alguien lo canceló antes en fase de captura, reintentar:
    Promise.resolve().then(()=>{
      // Si seguimos en la misma URL después de 500ms, forzar submit (defensa extra)
      setTimeout(()=>{
        try{
          if (!document.body || location.pathname.endsWith('/login')) {
            // Evita loops: solo fuerza si seguimos “parados” en /login
            form.submit();
          }
        }catch(_){}
      }, 500);
    });
  }, false);

  /* ===== Querystring toasts (opcional) ===== */
  (function(){
    const p = new URLSearchParams(location.search);
    if(p.get('loggedout')==='1') window.showToast?.({title:'Sesión cerrada', icon:'door-closed'});
    if(p.get('expired')==='1')   window.showToast?.({title:'Sesión expirada', body:'Volvé a ingresar.', icon:'hourglass-top'});
    if(p.get('error')==='1')     window.showToast?.({title:'Error de login', body:'Revisá tus credenciales.', icon:'exclamation-triangle'});
  })();
</script>
{% endblock %}
