{% extends "base.html" %}
{% block title %}Inicio ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet"/>
  <style>
    .segmented .btn{ border-radius:999px; }
    .segmented .btn.active{ background:var(--brand-soft); border-color:var(--brand); color:var(--brand); }
    .fab{
      position:fixed; right:20px; bottom:20px; z-index:999;
      border-radius:999px; box-shadow:var(--shadow);
    }
    /* calendario dentro de card */
    #calendar .fc .fc-toolbar-title{ font-weight:700; color:var(--brand); }
    #calendar .fc .fc-button{ border-radius:10px; }
  </style>
{% endblock %}

{% block content %}
<div class="py-3">
  <!-- Encabezado + selector de vista -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="hero-title mb-1">Panel principal</h1>
      <div class="subtle" id="todayLabel"></div>
    </div>
    <div class="segmented">
      <button class="btn btn-sm btn-light active" data-calview="dayGridMonth">Mes</button>
      <button class="btn btn-sm btn-light" data-calview="timeGridWeek">Semana</button>
      <button class="btn btn-sm btn-light" data-calview="listWeek">Lista</button>
    </div>
  </div>

  <div class="row g-3">
    <!-- Calendario -->
    <div class="col-lg-8">
      <div class="card card-clean shadow-hover">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong><i class="bi bi-calendar3 me-2"></i> Calendario</strong>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="prevBtn"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-sm btn-outline-secondary" id="todayBtn">Hoy</button>
            <button class="btn btn-sm btn-outline-secondary" id="nextBtn"><i class="bi bi-chevron-right"></i></button>
          </div>
        </div>
        <div class="card-body p-2">
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    <!-- Acciones + Resumen -->
    <div class="col-lg-4">
      <div class="card card-clean mb-3 shadow-hover">
        <div class="card-header"><strong>Acciones r√°pidas</strong></div>
        <div class="card-body d-grid gap-2">
          <a class="btn btn-primary" href="/incidencias"><i class="bi bi-tools me-1"></i> Crear incidencia</a>
          <a class="btn btn-outline-primary" href="/chat"><i class="bi bi-chat-dots me-1"></i> Abrir chat interno</a>
          <a class="btn btn-outline-primary" href="/report"><i class="bi bi-file-earmark-text me-1"></i> Nuevo an√°lisis de pliego</a>
        </div>
      </div>
      <div class="card card-clean shadow-hover">
        <div class="card-header"><strong>Resumen</strong></div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="mb-2"><span class="badge bg-primary-subtle text-primary me-2">‚Ä¢</span> Incidencias abiertas: <strong>{{ incidencias_abiertas or 0 }}</strong></li>
            <li class="mb-2"><span class="badge bg-warning-subtle text-warning me-2">‚Ä¢</span> Eventos esta semana: <strong id="kpiSemana">‚Äî</strong></li>
            <li><span class="badge bg-success-subtle text-success me-2">‚Ä¢</span> √öltimo an√°lisis: <strong>{{ ultimo_analisis or '‚Äî' }}</strong></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Subir pliegos para an√°lisis -->
    <div class="col-12">
      <div class="card card-clean shadow-hover">
        <div class="card-header"><strong><i class="bi bi-upload me-2"></i>Subir pliegos para an√°lisis</strong></div>
        <div class="card-body">
          <form id="form-analyze" class="mb-2">
            <input type="file" id="file-hidden" class="form-control d-none" multiple>
            <div class="mb-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="agregarArchivos()">+ Agregar archivo</button>
            </div>
            <ul id="lista-archivos" class="list-group mb-3"></ul>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" id="analyze-btn" class="btn btn-primary">Analizar</button>
              <button type="button" id="generate-btn" class="btn btn-outline-primary">Descargar √∫ltimo PDF</button>
              <button type="button" class="btn btn-outline-secondary" onclick="limpiar()">Limpiar</button>
            </div>
          </form>
          <div id="result"></div>
        </div>
      </div>
    </div>

    <!-- Historial -->
    <div class="col-12">
      <div class="card card-clean shadow-hover">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>üìö Historial de an√°lisis</strong>
          <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar en el historial..." style="max-width:260px"/>
        </div>
        <div class="card-body">
          <div id="historial-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FAB Chat OpenAI -->
<button class="btn btn-primary fab" onclick="openChatAndExpand()"><i class="bi bi-robot me-2"></i>Chat OpenAI</button>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>
<script>
  // Fecha de hoy
  (function(){
    const el=document.getElementById('todayLabel');
    const fmt=new Intl.DateTimeFormat('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    el.textContent = fmt.format(new Date());
  })();

  // FullCalendar
  let calendar;
  (function(){
    const el=document.getElementById('calendar');
    if(!el) return;
    calendar = new FullCalendar.Calendar(el, {
      height:'auto',
      initialView:'dayGridMonth',
      headerToolbar:false,
      locale:'es',
      nowIndicator:true,
      firstDay:1,
      navLinks:true,
      events: async (info, successCallback) => {
        try{
          const r = await fetch('/api/calendar/events');
          const j = await r.json();
          successCallback(j.events || []);
          // KPI semana
          const start=new Date(); const end=new Date(); end.setDate(start.getDate()+7);
          const cnt=(j.events||[]).filter(e=>{const d=new Date(e.start||e.date); return d>=start && d<=end;}).length;
          document.getElementById('kpiSemana').textContent = cnt;
        }catch(e){
          successCallback([]); document.getElementById('kpiSemana').textContent='0';
        }
      },
      eventTimeFormat:{hour:'2-digit',minute:'2-digit',meridiem:false},
    });
    calendar.render();

    // Controles
    document.querySelectorAll('[data-calview]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('[data-calview]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        calendar.changeView(btn.getAttribute('data-calview'));
      });
    });
    document.getElementById('prevBtn').addEventListener('click',()=>calendar.prev());
    document.getElementById('nextBtn').addEventListener('click',()=>calendar.next());
    document.getElementById('todayBtn').addEventListener('click',()=>calendar.today());
  })();

  // ====== M√≥dulo an√°lisis ======
  let resumenGlobal="", ultimoPDF="", archivosSeleccionados=[];

  function agregarArchivos(){
    const input=document.getElementById("file-hidden");
    input.value="";
    input.onchange=()=>{ for(const a of input.files) archivosSeleccionados.push(a); actualizarListaArchivos(); };
    input.click();
  }
  function actualizarListaArchivos(){
    const lista=document.getElementById("lista-archivos");
    lista.innerHTML="";
    archivosSeleccionados.forEach((archivo, idx)=>{
      const li=document.createElement("li");
      li.className="list-group-item d-flex justify-content-between align-items-center";
      li.textContent=archivo.name;
      const btn=document.createElement("button");
      btn.className="btn btn-sm btn-outline-danger";
      btn.textContent="Eliminar";
      btn.onclick=()=>{ archivosSeleccionados.splice(idx,1); actualizarListaArchivos(); };
      li.appendChild(btn); lista.appendChild(li);
    });
  }

  document.getElementById("analyze-btn").addEventListener("click", async ()=>{
    if(!archivosSeleccionados.length){
      document.getElementById("result").innerHTML='<div class="alert alert-danger">‚ùå Seleccion√° al menos un archivo.</div>';
      return;
    }
    const fd=new FormData(); archivosSeleccionados.forEach(f=>fd.append("archivos",f));
    document.getElementById("result").innerHTML='<div class="alert alert-info">‚è≥ Analizando pliegos...</div>';
    const r = await fetch("/analizar-pliego",{method:"POST", body:fd});
    const j = await r.json();
    if(r.ok){
      resumenGlobal=j.resumen; ultimoPDF=j.pdf;
      document.getElementById("result").innerHTML = `<div class="alert alert-success"><strong>‚úÖ An√°lisis completo.</strong><br><br>${resumenGlobal}</div>`;
      await loadHistorial();
    }else{
      document.getElementById("result").innerHTML = `<div class="alert alert-danger">‚ùå ${j.error||'No se pudo analizar.'}</div>`;
    }
  });

  document.getElementById("generate-btn").addEventListener("click", ()=>{
    if(!ultimoPDF){
      document.getElementById("result").innerHTML='<div class="alert alert-danger">‚ùå Primero analiz√° un pliego.</div>';
      return;
    }
    window.location.href = `/descargar/${ultimoPDF}`;
  });

  async function loadHistorial(){
    const r = await fetch("/historial");
    const hist = await r.json();
    const cont = document.getElementById("historial-list");
    cont.innerHTML="";
    hist.forEach(entry=>{
      const fecha=entry.fecha_legible || "‚Äî";
      const div=document.createElement("div");
      div.className="mb-3 p-3 border rounded-3";
      div.style.borderColor="var(--border)";
      div.innerHTML = `
        <div><strong>üìÑ Archivo:</strong> ${entry.nombre_archivo}</div>
        <div><strong>üïì Fecha:</strong> ${fecha}</div>
        <div><strong>üë§ Usuario:</strong> ${entry.usuario}</div>
        <div class="d-flex gap-2 mt-2">
          <a href="/descargar/${entry.ruta_pdf.split('/').pop()}" class="btn btn-sm btn-primary">Descargar PDF</a>
          <button class="btn btn-sm btn-outline-danger" onclick="eliminarHist('${entry.timestamp}')">Eliminar</button>
        </div>`;
      cont.appendChild(div);
    });
  }
  async function eliminarHist(ts){
    await fetch(`/eliminar/${ts}`,{method:"DELETE"});
    await loadHistorial();
  }
  function limpiar(){
    archivosSeleccionados=[]; document.getElementById("lista-archivos").innerHTML="";
    document.getElementById("result").innerHTML=""; resumenGlobal=""; ultimoPDF="";
  }

  // Buscador en historial
  document.addEventListener("input", (e)=>{
    if(e.target?.id!=="search-input") return;
    const q=e.target.value.toLowerCase();
    document.querySelectorAll("#historial-list > div").forEach(node=>{
      node.style.display = node.textContent.toLowerCase().includes(q) ? "" : "none";
    });
  });

  // Init
  window.addEventListener('load', ()=>{
    loadHistorial();
  });
</script>
{% endblock %}
