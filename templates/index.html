{% extends "base.html" %}
{% block title %}Inicio ‚Äì Suizo Argentina{% endblock %}

{% block extra_head %}
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet"/>
  <style>
    .segmented .btn{ border-radius:999px; }
    .segmented .btn.active{ background:var(--pill); border-color:var(--accent-a); color:var(--accent-a); }

    /* ‚úÖ asegura altura visible del calendario en todas las vistas */
    #calMini{ min-height:360px; }
    #calMini .fc .fc-view-harness{ min-height:420px !important; }

    /* Compactado de la toolbar interna */
    #calMini.calendar-compact .fc .fc-toolbar{ margin:8px 0 12px; }
  </style>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="d-flex align-items-center justify-content-between mb-3 px-1">
    <div>
      <h1 class="hero-title mb-1">Panel principal</h1>
      <div class="subtle" id="todayLabel"></div>
    </div>
  </div>

  <div class="row g-3 px-1">

    <!-- 1) Analizar -->
    <div class="col-12" id="analisis">
      <div class="cardx">
        <div class="title mb-2"><i class="bi bi-upload me-2"></i> Subir pliegos para an√°lisis</div>
        <form id="form-analyze" class="mb-2">
          <input type="file" id="file-hidden" class="form-control d-none" multiple>
          <div class="mb-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="agregarArchivos()">+ Agregar archivo</button>
          </div>
          <small class="text-muted d-block mb-2">Tama√±o m√°ximo recomendado por archivo: 25 MB</small>
          <ul id="lista-archivos" class="list-group mb-3"></ul>
          <div class="d-flex flex-wrap gap-2">
            <button type="button" id="analyze-btn" class="btn btn-primary"><i class="bi bi-rocket-takeoff me-1"></i> Analizar</button>
            <button type="button" id="generate-btn" class="btn btn-outline-primary"><i class="bi bi-file-earmark-arrow-down me-1"></i> Descargar √∫ltimo PDF</button>
            <button type="button" class="btn btn-outline-secondary" onclick="limpiar()">Limpiar</button>
          </div>
        </form>
        <div id="result"></div>
      </div>
    </div>

    <!-- 2) Historial -->
    <div class="col-12" id="historial">
      <div class="cardx">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="title"><i class="bi bi-clock-history me-2"></i> Historial de an√°lisis</div>
          <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar en el historial..." style="max-width:260px"/>
        </div>
        <div id="historial-list"></div>
      </div>
    </div>

    <!-- 3) Calendario + Acciones -->
    <div class="col-12 col-xl-8">
      <div class="cardx calendar-card">
        <div class="title mb-2"><i class="bi bi-calendar3 me-2"></i> Calendario</div>

        <!-- Contenedor del mini-calendario -->
        <div id="calMini" class="calendar-compact"></div>

        <!-- Controles externos -->
        <div class="d-flex align-items-center gap-2 mt-2">
          <div class="segmented">
            <button class="btn btn-sm btn-light active"
                    type="button"
                    data-cal-view="dayGridMonth"
                    data-cal-target="#calMini">Mes</button>
            <button class="btn btn-sm btn-light"
                    type="button"
                    data-cal-view="timeGridWeek"
                    data-cal-target="#calMini">Semana</button>
            <button class="btn btn-sm btn-light"
                    type="button"
                    data-cal-view="listWeek"
                    data-cal-target="#calMini">Lista</button>
          </div>
          <div class="ms-auto d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    aria-label="Anterior"
                    data-cal-nav="prev"
                    data-cal-target="#calMini"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-cal-nav="today"
                    data-cal-target="#calMini">Hoy</button>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    aria-label="Siguiente"
                    data-cal-nav="next"
                    data-cal-target="#calMini"><i class="bi bi-chevron-right"></i></button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="cardx mb-3">
        <div class="title mb-2"><i class="bi bi-lightning-charge me-2"></i> Acciones r√°pidas</div>
        <div class="d-grid gap-2">
          <a class="btn btn-primary" href="/incidencias"><i class="bi bi-tools me-1"></i> Crear incidencia</a>
          <a class="btn btn-outline-primary" href="/chat"><i class="bi bi-chat-dots me-1"></i> Abrir chat interno</a>
          <a class="btn btn-outline-primary" href="#analisis"><i class="bi bi-diagram-3 me-1"></i> Nuevo an√°lisis de pliego</a>
        </div>
      </div>

      {% if rol == 'admin' %}
      <div class="cardx mb-3">
        <div class="title mb-2"><i class="bi bi-graph-up me-2"></i> Auditor√≠a & actividad</div>
        <div class="d-grid gap-2">
          <a class="btn btn-outline-primary" href="/auditoria-actividad"><i class="bi bi-activity me-1"></i> Auditor√≠a de actividad</a>
          <a class="btn btn-outline-primary" href="/usuarios-activos"><i class="bi bi-people me-1"></i> Usuarios activos (vivo)</a>
          <a class="btn btn-outline-secondary" href="/auditoria"><i class="bi bi-clipboard-data me-1"></i> Auditor√≠a de eventos</a>
        </div>
      </div>
      {% endif %}

      <div class="cardx">
        <div class="title mb-2"><i class="bi bi-list-check me-2"></i> Resumen</div>
        <ul class="list-unstyled mb-0">
          <li class="mb-1"><span class="badge bg-primary-subtle text-primary me-2">‚Ä¢</span> Incidencias abiertas: <strong>{{ incidencias_abiertas or 0 }}</strong></li>
          <li class="mb-1"><span class="badge bg-warning-subtle text-warning me-2">‚Ä¢</span> Eventos esta semana: <strong id="kpiSemana">‚Äî</strong></li>
          <li><span class="badge bg-success-subtle text-success me-2">‚Ä¢</span> √öltimo an√°lisis: <strong>{{ ultimo_analisis or '‚Äî' }}</strong></li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>
<script>
  // Fecha de hoy
  (function(){
    const el=document.getElementById('todayLabel');
    const fmt=new Intl.DateTimeFormat('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    if(el) el.textContent = fmt.format(new Date());
  })();

  // ===== FullCalendar (mini en panel) =====
  let calendar;
  (function(){
    const el=document.getElementById('calMini');
    if(!el) return;
    calendar = new FullCalendar.Calendar(el, {
      height:'auto',
      initialView:'dayGridMonth',
      headerToolbar:false,
      locale:'es',
      nowIndicator:true,
      firstDay:1,
      navLinks:true,
      events: async (info, successCallback) => {
        try{
          const r = await fetch('/api/calendar/events');
          const j = await r.json();
          successCallback(j.events || []);
          // KPI semana
          const start=new Date(); const end=new Date(); end.setDate(start.getDate()+7);
          const cnt=(j.events||[]).filter(e=>{
            const d=new Date(e.start||e.date); return d>=start && d<=end;
          }).length;
          document.getElementById('kpiSemana').textContent = cnt;
        }catch(e){
          successCallback([]); document.getElementById('kpiSemana').textContent='0';
        }
      },
      eventTimeFormat:{hour:'2-digit',minute:'2-digit',meridiem:false},
    });
    calendar.render();

    // üëá Exponer instancia para que los botones externos funcionen (manejador global en base.html)
    el.__fcCalendar = calendar;
    window.MiniCalendar = calendar; // opcional: debug

    // fuerza rec√°lculo inicial y en cambios de tama√±o
    setTimeout(()=>{ try{ calendar.updateSize(); }catch(_){} }, 80);
    window.addEventListener('resize', ()=>{ try{ calendar.updateSize(); }catch(_){} });
  })();

  // ===== M√≥dulo an√°lisis =====
  let resumenGlobal="", ultimoPDF="", archivosSeleccionados=[];

  function agregarArchivos(){
    const input=document.getElementById("file-hidden");
    input.value="";
    input.onchange=()=>{ for(const a of input.files) archivosSeleccionados.push(a); actualizarListaArchivos(); };
    input.click();
  }
  function actualizarListaArchivos(){
    const lista=document.getElementById("lista-archivos");
    lista.innerHTML="";
    archivosSeleccionados.forEach((archivo, idx)=>{
      const li=document.createElement("li");
      li.className="list-group-item d-flex justify-content-between align-items-center";
      li.textContent=archivo.name;
      const btn=document.createElement("button");
      btn.className="btn btn-sm btn-outline-danger";
      btn.textContent="Eliminar";
      btn.onclick=()=>{ archivosSeleccionados.splice(idx,1); actualizarListaArchivos(); };
      li.appendChild(btn); lista.appendChild(li);
    });
  }

  document.getElementById("analyze-btn").addEventListener("click", async ()=>{
    if(!archivosSeleccionados.length){
      document.getElementById("result").innerHTML='<div class="alert alert-danger">‚ùå Seleccion√° al menos un archivo.</div>';
      return;
    }
    const fd=new FormData(); archivosSeleccionados.forEach(f=>fd.append("archivos",f));
    document.getElementById("result").innerHTML='<div class="alert alert-info">‚è≥ Analizando pliegos...</div>';
    const r = await fetch("/analizar-pliego",{method:"POST", body:fd});
    const j = await r.json();
    if(r.ok){
      resumenGlobal=j.resumen; ultimoPDF=j.pdf;
      document.getElementById("result").innerHTML = `<div class="alert alert-success"><strong>‚úÖ An√°lisis completo.</strong><br><br>${resumenGlobal}</div>`;
      await loadHistorial();
      document.getElementById('historial')?.scrollIntoView({behavior:'smooth', block:'start'});
    }else{
      document.getElementById("result").innerHTML = `<div class="alert alert-danger">‚ùå ${j.error||'No se pudo analizar.'}</div>`;
    }
  });

  document.getElementById("generate-btn").addEventListener("click", ()=>{
    if(!ultimoPDF){
      document.getElementById("result").innerHTML='<div class="alert alert-danger">‚ùå Primero analiz√° un pliego.</div>';
      return;
    }
    window.location.href = `/descargar/${ultimoPDF}`;
  });

  async function loadHistorial(){
    const r = await fetch("/historial");
    const hist = await r.json();
    const cont = document.getElementById("historial-list");
    cont.innerHTML="";
    if(!Array.isArray(hist) || !hist.length){
      cont.innerHTML = '<div class="text-muted">Sin an√°lisis a√∫n.</div>';
      return;
    }
    hist.forEach(entry=>{
      const fecha=entry.fecha_legible || entry.fecha || "‚Äî";
      const pdfName = (entry.ruta_pdf||'').split('/').pop() || entry.nombre_archivo || '';
      const div=document.createElement("div");
      div.className="mb-3 p-3 border rounded-3";
      div.style.borderColor="var(--border)";
      div.innerHTML = `
        <div><strong>üìÑ Archivo:</strong> ${entry.nombre_archivo}</div>
        <div><strong>üïì Fecha:</strong> ${fecha}</div>
        <div><strong>üë§ Usuario:</strong> ${entry.usuario}</div>
        <div class="d-flex gap-2 mt-2">
          <a href="/descargar/${pdfName}" class="btn btn-sm btn-primary">Descargar PDF</a>
          <button class="btn btn-sm btn-outline-danger" onclick="eliminarHist('${entry.timestamp}')">Eliminar</button>
        </div>`;
      cont.appendChild(div);
    });
  }
  async function eliminarHist(ts){
    await fetch(`/eliminar/${ts}`,{method:"DELETE"});
    await loadHistorial();
  }
  function limpiar(){
    archivosSeleccionados=[]; document.getElementById("lista-archivos").innerHTML="";
    document.getElementById("result").innerHTML=""; resumenGlobal=""; ultimoPDF="";
  }

  // Buscador en historial
  document.addEventListener("input", (e)=>{
    if(e.target?.id!=="search-input") return;
    const q=e.target.value.toLowerCase();
    document.querySelectorAll("#historial-list > div").forEach(node=>{
      node.style.display = node.textContent.toLowerCase().includes(q) ? "" : "none";
    });
  });

  // Scroll por hash / query
  function scrollByAnchorOrQuery(){
    const params = new URLSearchParams(location.search);
    const goto = params.get('goto');
    const fromHash = (location.hash || '').replace('#','');
    const targetId = goto || fromHash;
    if(!targetId) return;
    const el = document.getElementById(targetId);
    if(!el) return;
    setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'start'}), 60);
    if(goto){
      const url = new URL(location.href);
      url.searchParams.delete('goto');
      history.replaceState({}, '', url.pathname + (location.hash || ''));
    }
  }

  // Presencia (ping)
  (async function(){
    try{
      const r = await fetch('/usuario-actual');
      const u = await r.json();
      if (u && u.usuario){
        const ping = () => fetch('/presence/ping', { method:'POST' }).catch(()=>{});
        ping(); setInterval(ping, 30000);
      }
    }catch(_){}
  })();

  window.addEventListener('load', ()=>{
    loadHistorial();
    scrollByAnchorOrQuery();
    // por si el CSS tarda en aplicar alturas, recalcula calendario
    setTimeout(()=>{ try{ calendar && calendar.updateSize(); }catch(_){} }, 200);
  });
</script>
{% endblock %}
