{% extends "base.html" %}
{% block title %}Auditoría de actividad · Suizo Argentina{% endblock %}

{% block extra_head %}
  <style>
    .filters .form-control, .filters .form-select { border-radius: 12px; }
    .table thead{ background:#f6f7fe; }
    .pill{ background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe; padding:2px 8px; border-radius:999px; font-size:12px; }
    .state-activa{ color:#0f766e; background:#ccfbf1; }
    .state-expirada{ color:#92400e; background:#fef3c7; }
    .state-cerrada{ color:#334155; background:#e2e8f0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
  </style>
{% endblock %}

{% block content %}
<div class="grid">
  <section class="cardx col-12">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="title mb-0"><i class="bi bi-graph-up"></i> Auditoría de actividad <span id="chipCount" class="pill">0 sesiones</span></h5>
      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download"></i> Exportar CSV</button>
        <a href="/admin" class="btn btn-sm btn-outline-secondary">← Volver</a>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters row g-2 mb-3">
      <div class="col-12 col-md-4">
        <input id="fUsuario" class="form-control" placeholder="Usuario (email contiene)">
      </div>
      <div class="col-6 col-md-3">
        <input id="fDesde" type="date" class="form-control" placeholder="Desde">
      </div>
      <div class="col-6 col-md-3">
        <input id="fHasta" type="date" class="form-control" placeholder="Hasta">
      </div>
      <div class="col-12 col-md-2 d-flex gap-2">
        <button id="btnBuscar" class="btn btn-primary w-100"><i class="bi bi-search"></i> Buscar</button>
        <button id="btnLimpiar" class="btn btn-outline-secondary w-100">Limpiar</button>
      </div>
      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
          <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table align-middle table-hover">
        <thead>
          <tr>
            <th>Estado</th>
            <th>Usuario</th>
            <th>Nombre</th>
            <th>Inicio</th>
            <th>Último visto</th>
            <th>Cierre</th>
            <th>Duración</th>
            <th>IP</th>
            <th>Agente</th>
            <th>SID</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="10" class="text-center text-muted py-4">Cargando…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="small text-muted mt-2" id="footNote"></div>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const rows = document.getElementById('rows');
  const chip = document.getElementById('chipCount');
  const note = document.getElementById('footNote');

  function fmtLocal(iso){
    if(!iso) return '—';
    const d = new Date(iso);
    if(isNaN(d)) return iso;
    return d.toLocaleString();
  }
  function humanDur(s){
    if(s==null) return '—';
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    const parts=[];
    if(h) parts.push(h+'h');
    if(m) parts.push(m+'m');
    if(!h && !m) parts.push(sec+'s');
    return parts.join(' ');
  }
  function stateBadge(st){
    const cls = st==='activa' ? 'state-activa' : (st==='expirada' ? 'state-expirada':'state-cerrada');
    const label = st.charAt(0).toUpperCase()+st.slice(1);
    return `<span class="pill ${cls}">${label}</span>`;
  }

  async function cargar(){
    const usuario = document.getElementById('fUsuario').value.trim();
    const desde   = document.getElementById('fDesde').value || '';
    const hasta   = document.getElementById('fHasta').value || '';
    const q = new URLSearchParams();
    if(usuario) q.set('usuario', usuario);
    if(desde) q.set('desde', desde);
    if(hasta) q.set('hasta', hasta);

    rows.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">Cargando…</td></tr>`;
    try{
      const r = await fetch('/auditoria/actividad?'+q.toString());
      const j = await r.json();
      const items = j.items||[];
      chip.textContent = `${items.length} sesiones`;
      note.textContent = `Timeout de inactividad: ${j.timeout_min} min · Hora del servidor: ${j.now_utc}`;

      if(!items.length){
        rows.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">Sin coincidencias</td></tr>`;
        return;
      }

      rows.innerHTML = '';
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${stateBadge(it.estado)}</td>
          <td class="mono">${it.usuario}</td>
          <td>${it.nombre||'—'}</td>
          <td class="mono">${fmtLocal(it.login_at)}</td>
          <td class="mono">${fmtLocal(it.last_seen)}</td>
          <td class="mono">${fmtLocal(it.logout_at)}</td>
          <td>${humanDur(it.duracion_seg)}</td>
          <td class="mono">${it.ip||'—'}</td>
          <td class="mono" title="${it.ua||''}">${(it.ua||'—').slice(0,32)}${(it.ua&&it.ua.length>32)?'…':''}</td>
          <td class="mono">${it.id}</td>
        `;
        rows.appendChild(tr);
      });
    }catch(e){
      rows.innerHTML = `<tr><td colspan="10" class="text-center text-danger py-4">Error al cargar</td></tr>`;
    }
  }

  document.getElementById('btnBuscar').addEventListener('click', cargar);
  document.getElementById('btnLimpiar').addEventListener('click', ()=>{
    document.getElementById('fUsuario').value='';
    document.getElementById('fDesde').value='';
    document.getElementById('fHasta').value='';
    cargar();
  });
  // Export CSV rápido
  document.getElementById('btnExport').addEventListener('click', ()=>{
    const rowsEls = [...document.querySelectorAll('#rows tr')];
    if(!rowsEls.length) return;
    const headers = ['Estado','Usuario','Nombre','Inicio','Último visto','Cierre','Duración','IP','Agente','SID'];
    const data = rowsEls.map(tr=>[...tr.children].map(td=>td.innerText.replace(/\n/g,' ').trim()));
    const csv = [headers, ...data].map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'auditoria_actividad.csv';
    a.click();
  });

  // auto refresh
  setInterval(()=>{ if(document.getElementById('autoRefresh').checked) cargar(); }, 15000);

  // init
  cargar();
</script>
{% endblock %}
