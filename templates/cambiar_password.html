{% extends "base.html" %}
{% block title %}Cambiar contraseña — Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* ===== Estilos locales (alineados al theme global) ===== */
  .pw-meter{ height:10px; border-radius:999px; background:var(--muted); overflow:hidden; }
  .pw-meter > div{ height:100%; width:0%; transition:width .25s ease; }
  .pw-weak{ background:#ef4444; }
  .pw-fair{ background:#f59e0b; }
  .pw-good{ background:#10b981; }
  .pw-strong{ background:#0ea5e9; }

  .req-list{ list-style:none; padding-left:0; margin:10px 0 0 0; }
  .req-list li{ display:flex; align-items:center; gap:.5rem; font-size:.92rem; color:var(--text-2); }
  .req-list li.valid{ color:#198754; }
  .req-list .bi{ width:18px; }

  .caps-hint{ display:none; color:#b45309; font-size:.9rem; }
  .caps-hint.show{ display:block; }

  /* Compacto y redondeado para inputs, consistente con otras vistas */
  .input-compact .form-control{ border-radius:12px; }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-md-7 col-lg-5">
      <section class="card-clean shadow-hover">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong class="d-flex align-items-center gap-2">
            <i class="bi bi-key"></i> Cambiar contraseña
          </strong>
          <a href="/" class="btn btn-sm btn-outline-secondary">← Volver</a>
        </div>

        <div class="card-body">
          {% if ok %}
            <div class="alert alert-success">Tu contraseña fue actualizada correctamente.</div>
          {% endif %}
          {% if mensaje %}
            <div class="alert alert-success">{{ mensaje }}</div>
          {% endif %}
          {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
          {% endif %}

          <form id="pwForm" method="post" action="/cambiar-password" novalidate class="input-compact">
            <!-- Actual -->
            <div class="mb-3">
              <label for="actual" class="form-label">Contraseña actual</label>
              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  id="actual"
                  name="actual"
                  required
                  autocomplete="current-password"
                  aria-describedby="capsActual"
                >
                <button class="btn btn-outline-secondary" type="button" onclick="toggleVis('actual', this)" title="Mostrar/ocultar">
                  <i class="bi bi-eye" aria-hidden="true"></i><span class="visually-hidden">Mostrar/ocultar</span>
                </button>
              </div>
              <div id="capsActual" class="caps-hint mt-1"><i class="bi bi-exclamation-triangle"></i> Bloq Mayús está activado.</div>
            </div>

            <!-- Nueva -->
            <div class="mb-2">
              <label for="nueva" class="form-label">Nueva contraseña</label>
              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  id="nueva"
                  name="nueva"
                  required
                  minlength="8"
                  pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}"
                  title="Al menos 8 caracteres, con mayúsculas, minúsculas, número y símbolo."
                  autocomplete="new-password"
                  aria-describedby="capsNueva pwStrengthLabel reqList"
                >
                <button class="btn btn-outline-secondary" type="button" onclick="toggleVis('nueva', this)" title="Mostrar/ocultar">
                  <i class="bi bi-eye" aria-hidden="true"></i><span class="visually-hidden">Mostrar/ocultar</span>
                </button>
              </div>
              <div id="capsNueva" class="caps-hint mt-1"><i class="bi bi-exclamation-triangle"></i> Bloq Mayús está activado.</div>
            </div>

            <!-- Medidor fuerza -->
            <div class="pw-meter my-2" aria-hidden="true"><div id="pwBar" class="pw-weak" style="width:0%"></div></div>
            <div class="small text-muted" id="pwStrengthLabel" role="status" aria-live="polite">Fuerza: —</div>

            <!-- Requisitos -->
            <ul class="req-list" id="reqList" aria-live="polite">
              <li id="reqLen"><i class="bi bi-dot"></i> Mínimo 8 caracteres</li>
              <li id="reqUpper"><i class="bi bi-dot"></i> Al menos 1 mayúscula</li>
              <li id="reqLower"><i class="bi bi-dot"></i> Al menos 1 minúscula</li>
              <li id="reqNum"><i class="bi bi-dot"></i> Al menos 1 número</li>
              <li id="reqSym"><i class="bi bi-dot"></i> Al menos 1 símbolo (!@#$%^&*…)</li>
            </ul>

            <!-- Confirmación -->
            <div class="mt-3">
              <label for="confirmar" class="form-label">Confirmar nueva contraseña</label>
              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  id="confirmar"
                  name="confirmar"
                  required
                  autocomplete="new-password"
                  aria-describedby="capsConfirm matchHelp"
                >
                <button class="btn btn-outline-secondary" type="button" onclick="toggleVis('confirmar', this)" title="Mostrar/ocultar">
                  <i class="bi bi-eye" aria-hidden="true"></i><span class="visually-hidden">Mostrar/ocultar</span>
                </button>
              </div>
              <div id="capsConfirm" class="caps-hint mt-1"><i class="bi bi-exclamation-triangle"></i> Bloq Mayús está activado.</div>
              <div id="matchHelp" class="form-text text-danger d-none">Las contraseñas no coinciden.</div>
            </div>

            <button id="submitBtn" type="submit" class="btn btn-primary w-100 mt-3">
              <span class="btn-text">Actualizar contraseña</span>
              <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ===== Toggle visibilidad ===== */
  function toggleVis(id, btn){
    const input = document.getElementById(id);
    if(!input) return;
    const isPass = input.type === 'password';
    input.type = isPass ? 'text' : 'password';
    const icon = btn.querySelector('i');
    if(icon) icon.className = isPass ? 'bi bi-eye-slash' : 'bi bi-eye';
    input.focus();
  }

  /* ===== Caps Lock hints ===== */
  function bindCapsHint(inputId, hintId){
    const input = document.getElementById(inputId);
    const hint  = document.getElementById(hintId);
    if(!input || !hint) return;
    const upd = (e)=>{ const caps = e.getModifierState && e.getModifierState('CapsLock'); hint.classList.toggle('show', !!caps); };
    ['keydown','keyup','focus','blur'].forEach(ev=> input.addEventListener(ev, upd));
  }
  bindCapsHint('actual','capsActual');
  bindCapsHint('nueva','capsNueva');
  bindCapsHint('confirmar','capsConfirm');

  /* ===== Checklist + fuerza ===== */
  const newPw   = document.getElementById('nueva');
  const confPw  = document.getElementById('confirmar');
  const bar     = document.getElementById('pwBar');
  const lbl     = document.getElementById('pwStrengthLabel');
  const submitBtn = document.getElementById('submitBtn');

  function setReq(id, ok){
    const li = document.getElementById(id);
    if(!li) return;
    li.classList.toggle('valid', ok);
    const icon = li.querySelector('.bi');
    if(icon) icon.className = ok ? 'bi bi-check2-circle' : 'bi bi-dot';
  }

  function updateReqs(pw){
    const reqs = {
      len: pw.length >= 8,
      upper: /[A-Z]/.test(pw),
      lower: /[a-z]/.test(pw),
      num: /\d/.test(pw),
      sym: /[^A-Za-z0-9]/.test(pw)
    };
    setReq('reqLen',   reqs.len);
    setReq('reqUpper', reqs.upper);
    setReq('reqLower', reqs.lower);
    setReq('reqNum',   reqs.num);
    setReq('reqSym',   reqs.sym);
    return Object.values(reqs).filter(Boolean).length;
  }

  function scorePassword(pw){
    if(!pw) return 0;
    let score = 0;
    const uniq = new Set(pw).size; score += Math.min(uniq, 10);
    if(/[a-z]/.test(pw)) score += 5;
    if(/[A-Z]/.test(pw)) score += 5;
    if(/\d/.test(pw))    score += 5;
    if(/[^A-Za-z0-9]/.test(pw)) score += 7;
    if(pw.length>=12) score += 8;
    if(pw.length>=16) score += 10;
    if(/(1234|abcd|qwer|password|admin|suizo)/i.test(pw)) score -= 12;
    return Math.max(0, Math.min(50, score));
  }

  function renderMeter(pw){
    updateReqs(pw);
    const pct = Math.round((scorePassword(pw)/50)*100);
    bar.style.width = pct + '%';
    bar.className = '';
    if (pct < 35){ bar.classList.add('pw-weak');  lbl.textContent='Fuerza: débil'; }
    else if (pct < 60){ bar.classList.add('pw-fair'); lbl.textContent='Fuerza: media'; }
    else if (pct < 80){ bar.classList.add('pw-good'); lbl.textContent='Fuerza: buena'; }
    else { bar.classList.add('pw-strong'); lbl.textContent='Fuerza: excelente'; }

    const matchHelp = document.getElementById('matchHelp');
    if (confPw.value && confPw.value !== pw) matchHelp.classList.remove('d-none');
    else matchHelp.classList.add('d-none');
  }

  newPw.addEventListener('input', e => renderMeter(e.target.value));
  confPw.addEventListener('input', () => {
    const matchHelp=document.getElementById('matchHelp');
    if (confPw.value && confPw.value !== newPw.value) matchHelp.classList.remove('d-none');
    else matchHelp.classList.add('d-none');
  });

  /* ===== Submit UX / validaciones ===== */
  document.getElementById('pwForm').addEventListener('submit', (e)=>{
    const pw = (newPw.value||'').trim();
    const allReqs = updateReqs(pw) === 5;
    const matches = confPw.value === pw;

    // Respetar también el pattern HTML si existe
    const patternOk = newPw.checkValidity();

    if(!allReqs || !matches || !patternOk){
      e.preventDefault();
      const msg = !matches
        ? 'Las contraseñas no coinciden.'
        : 'La nueva contraseña no cumple todos los requisitos.';
      if(window.showToast){ showToast({title:'Validación', body: msg, icon:'exclamation-triangle'}); }
      else alert(msg);
      return;
    }
    submitBtn.disabled = true;
    submitBtn.querySelector('.btn-text').textContent = 'Actualizando...';
    submitBtn.querySelector('.spinner-border').classList.remove('d-none');
  });

  // Accesibilidad extra: Enter en campos avanza
  document.getElementById('actual').addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); newPw.focus(); }
  });
  newPw.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); confPw.focus(); }
  });
</script>
{% endblock %}
