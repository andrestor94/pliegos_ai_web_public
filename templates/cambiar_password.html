{% extends "base.html" %}
{% block title %}Cambiar contraseña – Suizo Argentina{% endblock %}

{% block extra_head %}
<style>
  /* Mini estilos locales para el medidor y la checklist */
  .pw-meter{ height:10px; border-radius:999px; background:var(--muted); overflow:hidden; }
  .pw-meter > div{ height:100%; width:0%; transition:width .25s ease; }
  .pw-weak{ background:#ef4444; }
  .pw-fair{ background:#f59e0b; }
  .pw-good{ background:#10b981; }
  .pw-strong{ background:#0ea5e9; }
  .req-list{ list-style:none; padding-left:0; margin:10px 0 0 0; }
  .req-list li{ display:flex; align-items:center; gap:.5rem; font-size:.92rem; color:var(--text-2); }
  .req-list li.valid{ color:#198754; }
  .req-list .bi{ width:18px; }
</style>
{% endblock %}

{% block content %}
<div class="py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-md-7 col-lg-5">
      <div class="card card-clean shadow-hover">
        <div class="card-header text-center">
          <strong><i class="bi bi-key me-2"></i>Cambiar contraseña</strong>
        </div>
        <div class="card-body">
          {% if mensaje %}
            <div class="alert alert-success">{{ mensaje }}</div>
          {% endif %}
          {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
          {% endif %}

          <form id="pwForm" method="post" action="/cambiar-password" novalidate>
            <div class="mb-3">
              <label for="old_password" class="form-label">Contraseña actual</label>
              <div class="input-group">
                <input type="password" class="form-control" id="old_password" name="old_password" required autocomplete="current-password">
                <button class="btn btn-outline-secondary" type="button" onclick="toggleVis('old_password', this)" title="Mostrar/ocultar">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </div>

            <div class="mb-2">
              <label for="new_password" class="form-label">Nueva contraseña</label>
              <div class="input-group">
                <input type="password" class="form-control" id="new_password" name="new_password" required autocomplete="new-password" minlength="8">
                <button class="btn btn-outline-secondary" type="button" onclick="toggleVis('new_password', this)" title="Mostrar/ocultar">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </div>

            <!-- Medidor fuerza -->
            <div class="pw-meter my-2" aria-hidden="true"><div id="pwBar" class="pw-weak" style="width:0%"></div></div>
            <div class="small subtle" id="pwStrengthLabel">Fuerza: —</div>

            <!-- Requisitos -->
            <ul class="req-list" id="reqList">
              <li id="reqLen"><i class="bi bi-dot"></i> Mínimo 8 caracteres</li>
              <li id="reqUpper"><i class="bi bi-dot"></i> Al menos 1 mayúscula</li>
              <li id="reqLower"><i class="bi bi-dot"></i> Al menos 1 minúscula</li>
              <li id="reqNum"><i class="bi bi-dot"></i> Al menos 1 número</li>
              <li id="reqSym"><i class="bi bi-dot"></i> Al menos 1 símbolo (!@#$%^&*…)</li>
            </ul>

            <div class="mt-3">
              <label for="confirm_password" class="form-label">Confirmar nueva contraseña</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required autocomplete="new-password">
                <button class="btn btn-outline-secondary" type="button" onclick="toggleVis('confirm_password', this)" title="Mostrar/ocultar">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div id="matchHelp" class="form-text text-danger d-none">Las contraseñas no coinciden.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">Actualizar contraseña</button>
          </form>

          <div class="mt-3 text-center">
            <a href="/" class="btn btn-link">← Volver</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Toggle visibilidad
  function toggleVis(id, btn){
    const input = document.getElementById(id);
    const isPass = input.type === 'password';
    input.type = isPass ? 'text' : 'password';
    const icon = btn.querySelector('i');
    icon.className = isPass ? 'bi bi-eye-slash' : 'bi bi-eye';
  }

  // Checklist + fuerza
  const newPw = document.getElementById('new_password');
  const confPw = document.getElementById('confirm_password');
  const bar = document.getElementById('pwBar');
  const lbl = document.getElementById('pwStrengthLabel');

  function setReq(id, ok){
    const li = document.getElementById(id);
    li.classList.toggle('valid', ok);
    li.querySelector('.bi').className = ok ? 'bi bi-check2-circle' : 'bi bi-dot';
  }

  function updateReqs(pw){
    const reqs = {
      len: pw.length >= 8,
      upper: /[A-Z]/.test(pw),
      lower: /[a-z]/.test(pw),
      num: /\d/.test(pw),
      sym: /[^A-Za-z0-9]/.test(pw)
    };
    setReq('reqLen', reqs.len);
    setReq('reqUpper', reqs.upper);
    setReq('reqLower', reqs.lower);
    setReq('reqNum', reqs.num);
    setReq('reqSym', reqs.sym);
    return Object.values(reqs).filter(Boolean).length;
  }

  function scorePassword(pw){
    if(!pw) return 0;
    let score=0;
    const uniq=new Set(pw).size; score+=Math.min(uniq,10);
    if(/[a-z]/.test(pw)) score+=5;
    if(/[A-Z]/.test(pw)) score+=5;
    if(/\d/.test(pw)) score+=5;
    if(/[^A-Za-z0-9]/.test(pw)) score+=7;
    if(pw.length>=12) score+=8;
    if(pw.length>=16) score+=10;
    if(/(1234|abcd|qwer|password|admin|suizo)/i.test(pw)) score-=12; // penaliza obvios
    return Math.max(0, Math.min(50, score));
  }

  function renderMeter(pw){
    updateReqs(pw);
    const pct = Math.round((scorePassword(pw)/50)*100);
    bar.style.width = pct + '%';
    bar.className = '';
    if (pct < 35){ bar.classList.add('pw-weak');  lbl.textContent='Fuerza: débil'; }
    else if (pct < 60){ bar.classList.add('pw-fair'); lbl.textContent='Fuerza: media'; }
    else if (pct < 80){ bar.classList.add('pw-good'); lbl.textContent='Fuerza: buena'; }
    else { bar.classList.add('pw-strong'); lbl.textContent='Fuerza: excelente'; }

    // Coincidencia
    const matchHelp=document.getElementById('matchHelp');
    if (confPw.value && confPw.value !== pw) matchHelp.classList.remove('d-none');
    else matchHelp.classList.add('d-none');
  }

  newPw.addEventListener('input', e => renderMeter(e.target.value));
  confPw.addEventListener('input', () => {
    const matchHelp=document.getElementById('matchHelp');
    if (confPw.value && confPw.value !== newPw.value) matchHelp.classList.remove('d-none');
    else matchHelp.classList.add('d-none');
  });

  // Validación final
  document.getElementById('pwForm').addEventListener('submit', (e)=>{
    const pw = newPw.value.trim();
    const allReqs = updateReqs(pw) === 5;
    const matches = confPw.value === pw;
    if(!allReqs || !matches){
      e.preventDefault();
      // feedback simple
      alert(!allReqs ? 'La nueva contraseña no cumple todos los requisitos.' : 'Las contraseñas no coinciden.');
    }
  });
</script>
{% endblock %}
